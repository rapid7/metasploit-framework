<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>
  Class: Rex::Post::Meterpreter::Extensions::Stdapi::Railgun::Library
  
    &mdash; Documentation by YARD 0.9.37
  
</title>

  <link rel="stylesheet" href="../../../../../../css/style.css" type="text/css" />

  <link rel="stylesheet" href="../../../../../../css/common.css" type="text/css" />

<script type="text/javascript">
  pathId = "Rex::Post::Meterpreter::Extensions::Stdapi::Railgun::Library";
  relpath = '../../../../../../';
</script>


  <script type="text/javascript" charset="utf-8" src="../../../../../../js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="../../../../../../js/app.js"></script>


  </head>
  <body>
    <div class="nav_wrap">
      <iframe id="nav" src="../../../../../../class_list.html?1"></iframe>
      <div id="resizer"></div>
    </div>

    <div id="main" tabindex="-1">
      <div id="header">
        <div id="menu">
  
    <a href="../../../../../../_index.html">Index (L)</a> &raquo;
    <span class='title'><span class='object_link'><a href="../../../../../../Rex.html" title="Rex (module)">Rex</a></span></span> &raquo; <span class='title'><span class='object_link'><a href="../../../../../Post.html" title="Rex::Post (module)">Post</a></span></span> &raquo; <span class='title'><span class='object_link'><a href="../../../../Meterpreter.html" title="Rex::Post::Meterpreter (module)">Meterpreter</a></span></span> &raquo; <span class='title'><span class='object_link'><a href="../../../Extensions.html" title="Rex::Post::Meterpreter::Extensions (module)">Extensions</a></span></span> &raquo; <span class='title'><span class='object_link'><a href="../../Stdapi.html" title="Rex::Post::Meterpreter::Extensions::Stdapi (module)">Stdapi</a></span></span> &raquo; <span class='title'><span class='object_link'><a href="../Railgun.html" title="Rex::Post::Meterpreter::Extensions::Stdapi::Railgun (module)">Railgun</a></span></span>
     &raquo; 
    <span class="title">Library</span>
  
</div>

        <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="../../../../../../class_list.html">

        <svg width="24" height="24">
          <rect x="0" y="4" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="12" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="20" width="24" height="4" rx="1" ry="1"></rect>
        </svg>
    </a>
  
</div>
        <div class="clear"></div>
      </div>

      <div id="content"><h1>Class: Rex::Post::Meterpreter::Extensions::Stdapi::Railgun::Library
  
  
  
</h1>
<div class="box_info">
  
  <dl>
    <dt>Inherits:</dt>
    <dd>
      <span class="inheritName">Object</span>
      
        <ul class="fullTree">
          <li>Object</li>
          
            <li class="next">Rex::Post::Meterpreter::Extensions::Stdapi::Railgun::Library</li>
          
        </ul>
        <a href="#" class="inheritanceTree">show all</a>
      
    </dd>
  </dl>
  

  
  
  
  
  <dl>
      <dt>Includes:</dt>
      <dd><span class='object_link'><a href="LibraryHelper.html" title="Rex::Post::Meterpreter::Extensions::Stdapi::Railgun::LibraryHelper (module)">LibraryHelper</a></span></dd>
  </dl>
  
  

  

  
  <dl>
    <dt>Defined in:</dt>
    <dd>lib/rex/post/meterpreter/extensions/stdapi/railgun/library.rb</dd>
  </dl>
  
</div>

<h2>Overview</h2><div class="docstring">
  <div class="discussion">
    
<p>Represents a library, e.g. kernel32.dll</p>


  </div>
</div>
<div class="tags">
  

</div>
  
    <h2>
      Constant Summary
      <small><a href="#" class="constants_summary_toggle">collapse</a></small>
    </h2>

    <dl class="constants">
      
        <dt id="datatype_map-classvariable" class="">@@datatype_map =
          
        </dt>
        <dd><pre class="code"><span class='lbrace'>{</span>
  <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>HANDLE</span><span class='tstring_end'>&#39;</span></span>   <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>LPVOID</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span>
  <span class='comment'># really should be PVOID* but LPVOID is handled specially with the &#39;L&#39; prefix to *not* treat it as a pointer, and
</span>  <span class='comment'># for railgun&#39;s purposes LPVOID == ULONG_PTR
</span>  <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>PHANDLE</span><span class='tstring_end'>&#39;</span></span>  <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>PULONG_PTR</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span>
  <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>SIZE_T</span><span class='tstring_end'>&#39;</span></span>   <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>ULONG_PTR</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span>
  <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>PSIZE_T</span><span class='tstring_end'>&#39;</span></span>  <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>PULONG_PTR</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span>
  <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>PLPVOID</span><span class='tstring_end'>&#39;</span></span>  <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>PULONG_PTR</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span>
  <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>ULONG</span><span class='tstring_end'>&#39;</span></span>    <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>DWORD</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span>
  <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>PULONG</span><span class='tstring_end'>&#39;</span></span>   <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>PDWORD</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span>
  <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>NTSTATUS</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>DWORD</span><span class='tstring_end'>&#39;</span></span>
<span class='rbrace'>}</span><span class='period'>.</span><span class='id identifier rubyid_freeze'>freeze</span></pre></dd>
      
    </dl>
  




  <h2>Instance Attribute Summary <small><a href="#" class="summary_toggle">collapse</a></small></h2>
  <ul class="summary">
    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#functions-instance_method" title="#functions (instance method)">#<strong>functions</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Returns the value of attribute functions.</p>
</div></span>
  
</li>

    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#library_path-instance_method" title="#library_path (instance method)">#<strong>library_path</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
    
      <span class="note title readonly">readonly</span>
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Returns the value of attribute library_path.</p>
</div></span>
  
</li>

    
  </ul>




  
    <h2>
      Instance Method Summary
      <small><a href="#" class="summary_toggle">collapse</a></small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#add_function-instance_method" title="#add_function (instance method)">#<strong>add_function</strong>(name, return_type, params, remote_name = nil, calling_conv = &#39;stdcall&#39;)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Define a function for this library.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#build_packet_and_layouts-instance_method" title="#build_packet_and_layouts (instance method)">#<strong>build_packet_and_layouts</strong>(packet, function, args, arch)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#build_response-instance_method" title="#build_response (instance method)">#<strong>build_response</strong>(packet, function, layouts, client)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#call_function-instance_method" title="#call_function (instance method)">#<strong>call_function</strong>(function, args, client)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Perform a function call in this library on the remote system.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#get_function-instance_method" title="#get_function (instance method)">#<strong>get_function</strong>(name)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#initialize-instance_method" title="#initialize (instance method)">#<strong>initialize</strong>(library_path, consts_mgr)  &#x21d2; Library </a>
    

    
  </span>
  
  
    <span class="note title constructor">constructor</span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>A new instance of Library.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#known_function_names-instance_method" title="#known_function_names (instance method)">#<strong>known_function_names</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
    </ul>
  


  
  
  
  
  
  
  
  
  <h3 class="inherited">Methods included from <span class='object_link'><a href="LibraryHelper.html" title="Rex::Post::Meterpreter::Extensions::Stdapi::Railgun::LibraryHelper (module)">LibraryHelper</a></span></h3>
  <p class="inherited"><span class='object_link'><a href="LibraryHelper.html#asciiz_to_str-instance_method" title="Rex::Post::Meterpreter::Extensions::Stdapi::Railgun::LibraryHelper#asciiz_to_str (method)">#asciiz_to_str</a></span>, <span class='object_link'><a href="LibraryHelper.html#assemble_buffer-instance_method" title="Rex::Post::Meterpreter::Extensions::Stdapi::Railgun::LibraryHelper#assemble_buffer (method)">#assemble_buffer</a></span>, <span class='object_link'><a href="LibraryHelper.html#param_to_number-instance_method" title="Rex::Post::Meterpreter::Extensions::Stdapi::Railgun::LibraryHelper#param_to_number (method)">#param_to_number</a></span>, <span class='object_link'><a href="LibraryHelper.html#str_to_ascii_z-instance_method" title="Rex::Post::Meterpreter::Extensions::Stdapi::Railgun::LibraryHelper#str_to_ascii_z (method)">#str_to_ascii_z</a></span>, <span class='object_link'><a href="LibraryHelper.html#str_to_uni_z-instance_method" title="Rex::Post::Meterpreter::Extensions::Stdapi::Railgun::LibraryHelper#str_to_uni_z (method)">#str_to_uni_z</a></span>, <span class='object_link'><a href="LibraryHelper.html#uniz_to_str-instance_method" title="Rex::Post::Meterpreter::Extensions::Stdapi::Railgun::LibraryHelper#uniz_to_str (method)">#uniz_to_str</a></span></p>
<div id="constructor_details" class="method_details_list">
  <h2>Constructor Details</h2>
  
    <div class="method_details first">
  <h3 class="signature first" id="initialize-instance_method">
  
    #<strong>initialize</strong>(library_path, consts_mgr)  &#x21d2; <tt><span class='object_link'><a href="" title="Rex::Post::Meterpreter::Extensions::Stdapi::Railgun::Library (class)">Library</a></span></tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Returns a new instance of Library.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


62
63
64
65
66
67
68
69</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/rex/post/meterpreter/extensions/stdapi/railgun/library.rb', line 62</span>

<span class='kw'>def</span> <span class='id identifier rubyid_initialize'>initialize</span><span class='lparen'>(</span><span class='id identifier rubyid_library_path'>library_path</span><span class='comma'>,</span> <span class='id identifier rubyid_consts_mgr'>consts_mgr</span><span class='rparen'>)</span>
  <span class='ivar'>@library_path</span> <span class='op'>=</span> <span class='id identifier rubyid_library_path'>library_path</span>

  <span class='comment'># needed by LibraryHelper
</span>  <span class='ivar'>@consts_mgr</span> <span class='op'>=</span> <span class='id identifier rubyid_consts_mgr'>consts_mgr</span>

  <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_functions'>functions</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='rbrace'>}</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
  
</div>

  <div id="instance_attr_details" class="attr_details">
    <h2>Instance Attribute Details</h2>
    
      
      <span id="functions=-instance_method"></span>
      <div class="method_details first">
  <h3 class="signature first" id="functions-instance_method">
  
    #<strong>functions</strong>  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Returns the value of attribute functions.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


59
60
61</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/rex/post/meterpreter/extensions/stdapi/railgun/library.rb', line 59</span>

<span class='kw'>def</span> <span class='id identifier rubyid_functions'>functions</span>
  <span class='ivar'>@functions</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      
      <span id=""></span>
      <div class="method_details ">
  <h3 class="signature " id="library_path-instance_method">
  
    #<strong>library_path</strong>  &#x21d2; <tt>Object</tt>  <span class="extras">(readonly)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Returns the value of attribute library_path.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


60
61
62</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/rex/post/meterpreter/extensions/stdapi/railgun/library.rb', line 60</span>

<span class='kw'>def</span> <span class='id identifier rubyid_library_path'>library_path</span>
  <span class='ivar'>@library_path</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>


  <div id="instance_method_details" class="method_details_list">
    <h2>Instance Method Details</h2>

    
      <div class="method_details first">
  <h3 class="signature first" id="add_function-instance_method">
  
    #<strong>add_function</strong>(name, return_type, params, remote_name = nil, calling_conv = &#39;stdcall&#39;)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Define a function for this library.</p>

<p>Every function argument is described by a tuple (type,name,direction)</p>

<p>Example:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_add_function'>add_function</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>MessageBoxW</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>   <span class='comment'># name
</span>  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>DWORD</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>                    <span class='comment'># return value
</span>  <span class='lbracket'>[</span>                           <span class='comment'># params
</span> <span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>DWORD</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>hWnd</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>in</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='comma'>,</span>
   <span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>PWCHAR</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>lpText</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>in</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='comma'>,</span>
   <span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>PWCHAR</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>lpCaption</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>in</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='comma'>,</span>
   <span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>DWORD</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>uType</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>in</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='comma'>,</span>
  <span class='rbracket'>]</span><span class='rparen'>)</span>
</code></pre>

<p>Use <code>remote_name</code> when the actual library name is different from the ruby variable.  You might need to do this for example when the actual func name is myFunc@4 or when you want to create an alternative version of an existing function.</p>

<p>When the new function is called it will return a list containing the return value and all inout params.  See #call_function.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


125
126
127
128
129
130
131
132</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/rex/post/meterpreter/extensions/stdapi/railgun/library.rb', line 125</span>

<span class='kw'>def</span> <span class='id identifier rubyid_add_function'>add_function</span><span class='lparen'>(</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='id identifier rubyid_return_type'>return_type</span><span class='comma'>,</span> <span class='id identifier rubyid_params'>params</span><span class='comma'>,</span> <span class='id identifier rubyid_remote_name'>remote_name</span><span class='op'>=</span><span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_calling_conv'>calling_conv</span><span class='op'>=</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>stdcall</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
  <span class='id identifier rubyid_return_type'>return_type</span> <span class='op'>=</span> <span class='id identifier rubyid_reduce_type'>reduce_type</span><span class='lparen'>(</span><span class='id identifier rubyid_return_type'>return_type</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_params'>params</span> <span class='op'>=</span> <span class='id identifier rubyid_reduce_parameter_types'>reduce_parameter_types</span><span class='lparen'>(</span><span class='id identifier rubyid_params'>params</span><span class='rparen'>)</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_remote_name'>remote_name</span> <span class='op'>==</span> <span class='kw'>nil</span>
    <span class='id identifier rubyid_remote_name'>remote_name</span> <span class='op'>=</span> <span class='id identifier rubyid_name'>name</span>
  <span class='kw'>end</span>
  <span class='ivar'>@functions</span><span class='lbracket'>[</span><span class='id identifier rubyid_name'>name</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="LibraryFunction.html" title="Rex::Post::Meterpreter::Extensions::Stdapi::Railgun::LibraryFunction (class)">LibraryFunction</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="LibraryFunction.html#initialize-instance_method" title="Rex::Post::Meterpreter::Extensions::Stdapi::Railgun::LibraryFunction#initialize (method)">new</a></span></span><span class='lparen'>(</span><span class='id identifier rubyid_return_type'>return_type</span><span class='comma'>,</span> <span class='id identifier rubyid_params'>params</span><span class='comma'>,</span> <span class='id identifier rubyid_remote_name'>remote_name</span><span class='comma'>,</span> <span class='id identifier rubyid_calling_conv'>calling_conv</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="build_packet_and_layouts-instance_method">
  
    #<strong>build_packet_and_layouts</strong>(packet, function, args, arch)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/rex/post/meterpreter/extensions/stdapi/railgun/library.rb', line 134</span>

<span class='kw'>def</span> <span class='id identifier rubyid_build_packet_and_layouts'>build_packet_and_layouts</span><span class='lparen'>(</span><span class='id identifier rubyid_packet'>packet</span><span class='comma'>,</span> <span class='id identifier rubyid_function'>function</span><span class='comma'>,</span> <span class='id identifier rubyid_args'>args</span><span class='comma'>,</span> <span class='id identifier rubyid_arch'>arch</span><span class='rparen'>)</span>
  <span class='kw'>case</span> <span class='id identifier rubyid_arch'>arch</span>
  <span class='kw'>when</span> <span class='const'>ARCH_X64</span>
    <span class='id identifier rubyid_native'>native</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Q&lt;</span><span class='tstring_end'>&#39;</span></span>
  <span class='kw'>when</span> <span class='const'>ARCH_X86</span>
    <span class='id identifier rubyid_native'>native</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>V</span><span class='tstring_end'>&#39;</span></span>
  <span class='kw'>else</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'>NotImplementedError</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Unsupported architecture (must be ARCH_X86 or ARCH_X64)</span><span class='tstring_end'>&#39;</span></span>
  <span class='kw'>end</span>

  <span class='comment'># We transmit the immediate stack and three heap-buffers:
</span>  <span class='comment'># in, inout and out. The reason behind the separation is bandwidth.
</span>  <span class='comment'># We don&#39;t want to transmit uninitialized data in or no-longer-needed data out.
</span>
  <span class='comment'># out-only-buffers that are ONLY transmitted on the way BACK
</span>  <span class='id identifier rubyid_out_only_layout'>out_only_layout</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='rbrace'>}</span> <span class='comment'># paramName =&gt; BufferItem
</span>  <span class='id identifier rubyid_out_only_size_bytes'>out_only_size_bytes</span> <span class='op'>=</span> <span class='int'>0</span>
  <span class='comment'>#puts &quot; assembling out-only buffer&quot;
</span>  <span class='id identifier rubyid_function'>function</span><span class='period'>.</span><span class='id identifier rubyid_params'>params</span><span class='period'>.</span><span class='id identifier rubyid_each_with_index'>each_with_index</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_param_desc'>param_desc</span><span class='comma'>,</span> <span class='id identifier rubyid_param_idx'>param_idx</span><span class='op'>|</span>
    <span class='comment'>#puts &quot; processing #{param_desc[1]}&quot;
</span>
    <span class='comment'># Special case:
</span>    <span class='comment'># The user can choose to supply a Null pointer instead of a buffer
</span>    <span class='comment'># in this case we don&#39;t need space in any heap buffer
</span>    <span class='kw'>if</span> <span class='id identifier rubyid_param_desc'>param_desc</span><span class='lbracket'>[</span><span class='int'>0</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='int'>0</span><span class='comma'>,</span><span class='int'>1</span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>P</span><span class='tstring_end'>&#39;</span></span> <span class='comment'># type is a pointer (except LPVOID where the L negates this)
</span>      <span class='kw'>if</span> <span class='id identifier rubyid_args'>args</span><span class='lbracket'>[</span><span class='id identifier rubyid_param_idx'>param_idx</span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='kw'>nil</span>
        <span class='kw'>next</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>

    <span class='comment'># we care only about out-only buffers
</span>    <span class='kw'>if</span> <span class='id identifier rubyid_param_desc'>param_desc</span><span class='lbracket'>[</span><span class='int'>2</span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>out</span><span class='tstring_end'>&#39;</span></span>
      <span class='kw'>if</span> <span class='op'>!</span><span class='id identifier rubyid_args'>args</span><span class='lbracket'>[</span><span class='id identifier rubyid_param_idx'>param_idx</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_kind_of?'>kind_of?</span> <span class='const'>Integer</span>
        <span class='id identifier rubyid_raise'>raise</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>error in param </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_param_desc'>param_desc</span><span class='lbracket'>[</span><span class='int'>1</span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_content'>: Out-only buffers must be described by a number indicating their size in bytes</span><span class='tstring_end'>&quot;</span></span>
      <span class='kw'>end</span>
      <span class='id identifier rubyid_buffer_size'>buffer_size</span> <span class='op'>=</span> <span class='id identifier rubyid_args'>args</span><span class='lbracket'>[</span><span class='id identifier rubyid_param_idx'>param_idx</span><span class='rbracket'>]</span>
      <span class='kw'>if</span> <span class='id identifier rubyid_param_desc'>param_desc</span><span class='lbracket'>[</span><span class='int'>0</span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>PULONG_PTR</span><span class='tstring_end'>&#39;</span></span>
        <span class='comment'># bump up the size for an x64 pointer
</span>        <span class='kw'>if</span> <span class='id identifier rubyid_arch'>arch</span> <span class='op'>==</span> <span class='const'>ARCH_X64</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_buffer_size'>buffer_size</span> <span class='op'>==</span> <span class='int'>4</span>
          <span class='id identifier rubyid_buffer_size'>buffer_size</span> <span class='op'>=</span> <span class='id identifier rubyid_args'>args</span><span class='lbracket'>[</span><span class='id identifier rubyid_param_idx'>param_idx</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='int'>8</span>
        <span class='kw'>end</span>

        <span class='kw'>if</span> <span class='id identifier rubyid_arch'>arch</span> <span class='op'>==</span> <span class='const'>ARCH_X64</span>
          <span class='kw'>if</span> <span class='id identifier rubyid_buffer_size'>buffer_size</span> <span class='op'>!=</span> <span class='int'>8</span>
            <span class='id identifier rubyid_raise'>raise</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Please pass 8 for &#39;out&#39; PULONG_PTR, since they require a buffer of size 8</span><span class='tstring_end'>&quot;</span></span>
          <span class='kw'>end</span>
        <span class='kw'>elsif</span> <span class='id identifier rubyid_arch'>arch</span> <span class='op'>==</span> <span class='const'>ARCH_X86</span>
          <span class='kw'>if</span> <span class='id identifier rubyid_buffer_size'>buffer_size</span> <span class='op'>!=</span> <span class='int'>4</span>
            <span class='id identifier rubyid_raise'>raise</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Please pass 4 for &#39;out&#39; PULONG_PTR, since they require a buffer of size 4</span><span class='tstring_end'>&quot;</span></span>
          <span class='kw'>end</span>
        <span class='kw'>end</span>
      <span class='kw'>end</span>

      <span class='id identifier rubyid_out_only_layout'>out_only_layout</span><span class='lbracket'>[</span><span class='id identifier rubyid_param_desc'>param_desc</span><span class='lbracket'>[</span><span class='int'>1</span><span class='rbracket'>]</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="BufferItem.html" title="Rex::Post::Meterpreter::Extensions::Stdapi::Railgun::BufferItem (class)">BufferItem</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="BufferItem.html#initialize-instance_method" title="Rex::Post::Meterpreter::Extensions::Stdapi::Railgun::BufferItem#initialize (method)">new</a></span></span><span class='lparen'>(</span><span class='id identifier rubyid_param_idx'>param_idx</span><span class='comma'>,</span> <span class='id identifier rubyid_out_only_size_bytes'>out_only_size_bytes</span><span class='comma'>,</span> <span class='id identifier rubyid_buffer_size'>buffer_size</span><span class='comma'>,</span> <span class='id identifier rubyid_param_desc'>param_desc</span><span class='lbracket'>[</span><span class='int'>0</span><span class='rbracket'>]</span><span class='rparen'>)</span>
      <span class='id identifier rubyid_out_only_size_bytes'>out_only_size_bytes</span> <span class='op'>+=</span> <span class='id identifier rubyid_buffer_size'>buffer_size</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_in_only_layout'>in_only_layout</span><span class='comma'>,</span> <span class='id identifier rubyid_in_only_buffer'>in_only_buffer</span> <span class='op'>=</span> <span class='id identifier rubyid_assemble_buffer'>assemble_buffer</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>in</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='id identifier rubyid_function'>function</span><span class='comma'>,</span> <span class='id identifier rubyid_args'>args</span><span class='comma'>,</span> <span class='id identifier rubyid_arch'>arch</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_inout_layout'>inout_layout</span><span class='comma'>,</span> <span class='id identifier rubyid_inout_buffer'>inout_buffer</span> <span class='op'>=</span> <span class='id identifier rubyid_assemble_buffer'>assemble_buffer</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>inout</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='id identifier rubyid_function'>function</span><span class='comma'>,</span> <span class='id identifier rubyid_args'>args</span><span class='comma'>,</span> <span class='id identifier rubyid_arch'>arch</span><span class='rparen'>)</span>

  <span class='comment'># now we build the stack
</span>  <span class='comment'># every stack dword will be described by two dwords:
</span>  <span class='comment'># first dword describes second dword:
</span>  <span class='comment'>#	0 - literal,
</span>  <span class='comment'>#	1 = relative to in-only buffer
</span>  <span class='comment'>#	2 = relative to out-only buffer
</span>  <span class='comment'>#	3 = relative to inout buffer
</span>
  <span class='comment'># (literal numbers and pointers to buffers we have created)
</span>  <span class='id identifier rubyid_literal_pairs_blob'>literal_pairs_blob</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_end'>&quot;</span></span>
  <span class='comment'>#puts &quot; assembling literal stack&quot;
</span>  <span class='id identifier rubyid_function'>function</span><span class='period'>.</span><span class='id identifier rubyid_params'>params</span><span class='period'>.</span><span class='id identifier rubyid_each_with_index'>each_with_index</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_param_desc'>param_desc</span><span class='comma'>,</span> <span class='id identifier rubyid_param_idx'>param_idx</span><span class='op'>|</span>
    <span class='comment'>#puts &quot;  processing (#{param_desc[0]}, #{param_desc[1]}, #{param_desc[2]})&quot;
</span>    <span class='id identifier rubyid_buffer'>buffer</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='comment'># is it a pointer to a buffer on our stack
</span>    <span class='kw'>if</span> <span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>PULONG_PTR</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>PDWORD</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>PWCHAR</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>PCHAR</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>PBLOB</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_include?'>include?</span><span class='lparen'>(</span><span class='id identifier rubyid_param_desc'>param_desc</span><span class='lbracket'>[</span><span class='int'>0</span><span class='rbracket'>]</span><span class='rparen'>)</span>
      <span class='kw'>if</span> <span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>PWCHAR</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>PCHAR</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>PBLOB</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_include?'>include?</span><span class='lparen'>(</span><span class='id identifier rubyid_param_desc'>param_desc</span><span class='lbracket'>[</span><span class='int'>0</span><span class='rbracket'>]</span><span class='rparen'>)</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_param_desc'>param_desc</span><span class='lbracket'>[</span><span class='int'>2</span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>in</span><span class='tstring_end'>&#39;</span></span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_args'>args</span><span class='lbracket'>[</span><span class='id identifier rubyid_param_idx'>param_idx</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>Integer</span><span class='rparen'>)</span>
        <span class='comment'># allow PWCHAR, PCHAR and PBLOB to also be passed as a pointer instead of a buffer
</span>        <span class='id identifier rubyid_buffer'>buffer</span>  <span class='op'>=</span> <span class='lbracket'>[</span><span class='int'>0</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_pack'>pack</span><span class='lparen'>(</span><span class='id identifier rubyid_native'>native</span><span class='rparen'>)</span>
        <span class='id identifier rubyid_num'>num</span>     <span class='op'>=</span> <span class='id identifier rubyid_param_to_number'>param_to_number</span><span class='lparen'>(</span><span class='id identifier rubyid_args'>args</span><span class='lbracket'>[</span><span class='id identifier rubyid_param_idx'>param_idx</span><span class='rbracket'>]</span><span class='rparen'>)</span>
        <span class='id identifier rubyid_buffer'>buffer</span> <span class='op'>+=</span> <span class='lbracket'>[</span><span class='id identifier rubyid_num'>num</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_pack'>pack</span><span class='lparen'>(</span><span class='id identifier rubyid_native'>native</span><span class='rparen'>)</span>
      <span class='kw'>elsif</span> <span class='id identifier rubyid_args'>args</span><span class='lbracket'>[</span><span class='id identifier rubyid_param_idx'>param_idx</span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='kw'>nil</span> <span class='comment'># null pointer?
</span>        <span class='id identifier rubyid_buffer'>buffer</span>  <span class='op'>=</span> <span class='lbracket'>[</span><span class='int'>0</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_pack'>pack</span><span class='lparen'>(</span><span class='id identifier rubyid_native'>native</span><span class='rparen'>)</span> <span class='comment'># type: LPVOID  (so the library does not rebase it)
</span>        <span class='id identifier rubyid_buffer'>buffer</span> <span class='op'>+=</span> <span class='lbracket'>[</span><span class='int'>0</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_pack'>pack</span><span class='lparen'>(</span><span class='id identifier rubyid_native'>native</span><span class='rparen'>)</span> <span class='comment'># value: 0
</span>      <span class='kw'>elsif</span> <span class='id identifier rubyid_param_desc'>param_desc</span><span class='lbracket'>[</span><span class='int'>2</span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>in</span><span class='tstring_end'>&#39;</span></span>
        <span class='id identifier rubyid_buffer'>buffer</span>  <span class='op'>=</span> <span class='lbracket'>[</span><span class='int'>1</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_pack'>pack</span><span class='lparen'>(</span><span class='id identifier rubyid_native'>native</span><span class='rparen'>)</span>
        <span class='id identifier rubyid_buffer'>buffer</span> <span class='op'>+=</span> <span class='lbracket'>[</span><span class='id identifier rubyid_in_only_layout'>in_only_layout</span><span class='lbracket'>[</span><span class='id identifier rubyid_param_desc'>param_desc</span><span class='lbracket'>[</span><span class='int'>1</span><span class='rbracket'>]</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_addr'>addr</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_pack'>pack</span><span class='lparen'>(</span><span class='id identifier rubyid_native'>native</span><span class='rparen'>)</span>
      <span class='kw'>elsif</span> <span class='id identifier rubyid_param_desc'>param_desc</span><span class='lbracket'>[</span><span class='int'>2</span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>out</span><span class='tstring_end'>&#39;</span></span>
        <span class='id identifier rubyid_buffer'>buffer</span>  <span class='op'>=</span> <span class='lbracket'>[</span><span class='int'>2</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_pack'>pack</span><span class='lparen'>(</span><span class='id identifier rubyid_native'>native</span><span class='rparen'>)</span>
        <span class='id identifier rubyid_buffer'>buffer</span> <span class='op'>+=</span> <span class='lbracket'>[</span><span class='id identifier rubyid_out_only_layout'>out_only_layout</span><span class='lbracket'>[</span><span class='id identifier rubyid_param_desc'>param_desc</span><span class='lbracket'>[</span><span class='int'>1</span><span class='rbracket'>]</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_addr'>addr</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_pack'>pack</span><span class='lparen'>(</span><span class='id identifier rubyid_native'>native</span><span class='rparen'>)</span>
      <span class='kw'>elsif</span> <span class='id identifier rubyid_param_desc'>param_desc</span><span class='lbracket'>[</span><span class='int'>2</span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>inout</span><span class='tstring_end'>&#39;</span></span>
        <span class='id identifier rubyid_buffer'>buffer</span>  <span class='op'>=</span> <span class='lbracket'>[</span><span class='int'>3</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_pack'>pack</span><span class='lparen'>(</span><span class='id identifier rubyid_native'>native</span><span class='rparen'>)</span>
        <span class='id identifier rubyid_buffer'>buffer</span> <span class='op'>+=</span> <span class='lbracket'>[</span><span class='id identifier rubyid_inout_layout'>inout_layout</span><span class='lbracket'>[</span><span class='id identifier rubyid_param_desc'>param_desc</span><span class='lbracket'>[</span><span class='int'>1</span><span class='rbracket'>]</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_addr'>addr</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_pack'>pack</span><span class='lparen'>(</span><span class='id identifier rubyid_native'>native</span><span class='rparen'>)</span>
      <span class='kw'>else</span>
        <span class='id identifier rubyid_raise'>raise</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>unexpected direction</span><span class='tstring_end'>&#39;</span></span>
      <span class='kw'>end</span>
    <span class='kw'>else</span>
      <span class='comment'>#puts &quot;   not a pointer&quot;
</span>      <span class='comment'># it&#39;s not a pointer (LPVOID is a pointer but is not backed by railgun memory, ala PBLOB)
</span>      <span class='id identifier rubyid_buffer'>buffer</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='int'>0</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_pack'>pack</span><span class='lparen'>(</span><span class='id identifier rubyid_native'>native</span><span class='rparen'>)</span>
      <span class='kw'>case</span> <span class='id identifier rubyid_param_desc'>param_desc</span><span class='lbracket'>[</span><span class='int'>0</span><span class='rbracket'>]</span>
        <span class='kw'>when</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>LPVOID</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>ULONG_PTR</span><span class='tstring_end'>&#39;</span></span>
          <span class='id identifier rubyid_num'>num</span>     <span class='op'>=</span> <span class='id identifier rubyid_param_to_number'>param_to_number</span><span class='lparen'>(</span><span class='id identifier rubyid_args'>args</span><span class='lbracket'>[</span><span class='id identifier rubyid_param_idx'>param_idx</span><span class='rbracket'>]</span><span class='rparen'>)</span>
          <span class='id identifier rubyid_buffer'>buffer</span> <span class='op'>+=</span> <span class='lbracket'>[</span><span class='id identifier rubyid_num'>num</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_pack'>pack</span><span class='lparen'>(</span><span class='id identifier rubyid_native'>native</span><span class='rparen'>)</span>
        <span class='kw'>when</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>DWORD</span><span class='tstring_end'>&#39;</span></span>
          <span class='id identifier rubyid_num'>num</span>     <span class='op'>=</span> <span class='id identifier rubyid_param_to_number'>param_to_number</span><span class='lparen'>(</span><span class='id identifier rubyid_args'>args</span><span class='lbracket'>[</span><span class='id identifier rubyid_param_idx'>param_idx</span><span class='rbracket'>]</span><span class='rparen'>)</span>
          <span class='id identifier rubyid_buffer'>buffer</span> <span class='op'>+=</span> <span class='lbracket'>[</span><span class='id identifier rubyid_num'>num</span> <span class='op'>&amp;</span> <span class='int'>0xffffffff</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_pack'>pack</span><span class='lparen'>(</span><span class='id identifier rubyid_native'>native</span><span class='rparen'>)</span>
        <span class='kw'>when</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>WORD</span><span class='tstring_end'>&#39;</span></span>
          <span class='id identifier rubyid_num'>num</span>     <span class='op'>=</span> <span class='id identifier rubyid_param_to_number'>param_to_number</span><span class='lparen'>(</span><span class='id identifier rubyid_args'>args</span><span class='lbracket'>[</span><span class='id identifier rubyid_param_idx'>param_idx</span><span class='rbracket'>]</span><span class='rparen'>)</span>
          <span class='id identifier rubyid_buffer'>buffer</span> <span class='op'>+=</span> <span class='lbracket'>[</span><span class='id identifier rubyid_num'>num</span> <span class='op'>&amp;</span> <span class='int'>0xffff</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_pack'>pack</span><span class='lparen'>(</span><span class='id identifier rubyid_native'>native</span><span class='rparen'>)</span>
        <span class='kw'>when</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>BYTE</span><span class='tstring_end'>&#39;</span></span>
          <span class='id identifier rubyid_num'>num</span>     <span class='op'>=</span> <span class='id identifier rubyid_param_to_number'>param_to_number</span><span class='lparen'>(</span><span class='id identifier rubyid_args'>args</span><span class='lbracket'>[</span><span class='id identifier rubyid_param_idx'>param_idx</span><span class='rbracket'>]</span><span class='rparen'>)</span>
          <span class='id identifier rubyid_buffer'>buffer</span> <span class='op'>+=</span> <span class='lbracket'>[</span><span class='id identifier rubyid_num'>num</span> <span class='op'>&amp;</span> <span class='int'>0xff</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_pack'>pack</span><span class='lparen'>(</span><span class='id identifier rubyid_native'>native</span><span class='rparen'>)</span>
        <span class='kw'>when</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>BOOL</span><span class='tstring_end'>&#39;</span></span>
          <span class='kw'>case</span> <span class='id identifier rubyid_args'>args</span><span class='lbracket'>[</span><span class='id identifier rubyid_param_idx'>param_idx</span><span class='rbracket'>]</span>
            <span class='kw'>when</span> <span class='kw'>true</span>
              <span class='id identifier rubyid_buffer'>buffer</span> <span class='op'>+=</span> <span class='lbracket'>[</span><span class='int'>1</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_pack'>pack</span><span class='lparen'>(</span><span class='id identifier rubyid_native'>native</span><span class='rparen'>)</span>
            <span class='kw'>when</span> <span class='kw'>false</span>
              <span class='id identifier rubyid_buffer'>buffer</span> <span class='op'>+=</span> <span class='lbracket'>[</span><span class='int'>0</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_pack'>pack</span><span class='lparen'>(</span><span class='id identifier rubyid_native'>native</span><span class='rparen'>)</span>
            <span class='kw'>else</span>
              <span class='id identifier rubyid_raise'>raise</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>param </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_param_desc'>param_desc</span><span class='lbracket'>[</span><span class='int'>1</span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_content'>: true or false expected</span><span class='tstring_end'>&quot;</span></span>
          <span class='kw'>end</span>
        <span class='kw'>else</span>
          <span class='id identifier rubyid_raise'>raise</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>unexpected type for param </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_param_desc'>param_desc</span><span class='lbracket'>[</span><span class='int'>1</span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>

    <span class='comment'>#puts &quot;   adding pair to blob&quot;
</span>    <span class='id identifier rubyid_literal_pairs_blob'>literal_pairs_blob</span> <span class='op'>+=</span> <span class='id identifier rubyid_buffer'>buffer</span>
    <span class='comment'>#puts &quot;   buffer size %X&quot; % buffer.length
</span>    <span class='comment'>#puts &quot;   blob size so far: %X&quot; % literal_pairs_blob.length
</span>  <span class='kw'>end</span>

  <span class='id identifier rubyid_layouts'>layouts</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='label'>in:</span> <span class='id identifier rubyid_in_only_layout'>in_only_layout</span><span class='comma'>,</span> <span class='label'>inout:</span> <span class='id identifier rubyid_inout_layout'>inout_layout</span><span class='comma'>,</span> <span class='label'>out:</span> <span class='id identifier rubyid_out_only_layout'>out_only_layout</span><span class='rbrace'>}</span>

  <span class='id identifier rubyid_packet'>packet</span><span class='period'>.</span><span class='id identifier rubyid_add_tlv'>add_tlv</span><span class='lparen'>(</span><span class='const'><span class='object_link'><a href="../Railgun.html#TLV_TYPE_RAILGUN_SIZE_OUT-constant" title="Rex::Post::Meterpreter::Extensions::Stdapi::Railgun::TLV_TYPE_RAILGUN_SIZE_OUT (constant)">TLV_TYPE_RAILGUN_SIZE_OUT</a></span></span><span class='comma'>,</span> <span class='id identifier rubyid_out_only_size_bytes'>out_only_size_bytes</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_packet'>packet</span><span class='period'>.</span><span class='id identifier rubyid_add_tlv'>add_tlv</span><span class='lparen'>(</span><span class='const'><span class='object_link'><a href="../Railgun.html#TLV_TYPE_RAILGUN_STACKBLOB-constant" title="Rex::Post::Meterpreter::Extensions::Stdapi::Railgun::TLV_TYPE_RAILGUN_STACKBLOB (constant)">TLV_TYPE_RAILGUN_STACKBLOB</a></span></span><span class='comma'>,</span> <span class='id identifier rubyid_literal_pairs_blob'>literal_pairs_blob</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_packet'>packet</span><span class='period'>.</span><span class='id identifier rubyid_add_tlv'>add_tlv</span><span class='lparen'>(</span><span class='const'><span class='object_link'><a href="../Railgun.html#TLV_TYPE_RAILGUN_BUFFERBLOB_IN-constant" title="Rex::Post::Meterpreter::Extensions::Stdapi::Railgun::TLV_TYPE_RAILGUN_BUFFERBLOB_IN (constant)">TLV_TYPE_RAILGUN_BUFFERBLOB_IN</a></span></span><span class='comma'>,</span> <span class='id identifier rubyid_in_only_buffer'>in_only_buffer</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_packet'>packet</span><span class='period'>.</span><span class='id identifier rubyid_add_tlv'>add_tlv</span><span class='lparen'>(</span><span class='const'><span class='object_link'><a href="../Railgun.html#TLV_TYPE_RAILGUN_BUFFERBLOB_INOUT-constant" title="Rex::Post::Meterpreter::Extensions::Stdapi::Railgun::TLV_TYPE_RAILGUN_BUFFERBLOB_INOUT (constant)">TLV_TYPE_RAILGUN_BUFFERBLOB_INOUT</a></span></span><span class='comma'>,</span> <span class='id identifier rubyid_inout_buffer'>inout_buffer</span><span class='rparen'>)</span>

  <span class='id identifier rubyid_packet'>packet</span><span class='period'>.</span><span class='id identifier rubyid_add_tlv'>add_tlv</span><span class='lparen'>(</span><span class='const'><span class='object_link'><a href="../Railgun.html#TLV_TYPE_RAILGUN_LIBNAME-constant" title="Rex::Post::Meterpreter::Extensions::Stdapi::Railgun::TLV_TYPE_RAILGUN_LIBNAME (constant)">TLV_TYPE_RAILGUN_LIBNAME</a></span></span><span class='comma'>,</span> <span class='ivar'>@library_path</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_packet'>packet</span><span class='period'>.</span><span class='id identifier rubyid_add_tlv'>add_tlv</span><span class='lparen'>(</span><span class='const'><span class='object_link'><a href="../Railgun.html#TLV_TYPE_RAILGUN_FUNCNAME-constant" title="Rex::Post::Meterpreter::Extensions::Stdapi::Railgun::TLV_TYPE_RAILGUN_FUNCNAME (constant)">TLV_TYPE_RAILGUN_FUNCNAME</a></span></span><span class='comma'>,</span> <span class='id identifier rubyid_function'>function</span><span class='period'>.</span><span class='id identifier rubyid_remote_name'>remote_name</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_packet'>packet</span><span class='period'>.</span><span class='id identifier rubyid_add_tlv'>add_tlv</span><span class='lparen'>(</span><span class='const'><span class='object_link'><a href="../Railgun.html#TLV_TYPE_RAILGUN_CALLCONV-constant" title="Rex::Post::Meterpreter::Extensions::Stdapi::Railgun::TLV_TYPE_RAILGUN_CALLCONV (constant)">TLV_TYPE_RAILGUN_CALLCONV</a></span></span><span class='comma'>,</span> <span class='id identifier rubyid_function'>function</span><span class='period'>.</span><span class='id identifier rubyid_calling_conv'>calling_conv</span><span class='rparen'>)</span>
  <span class='lbracket'>[</span><span class='id identifier rubyid_packet'>packet</span><span class='comma'>,</span> <span class='id identifier rubyid_layouts'>layouts</span><span class='rbracket'>]</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="build_response-instance_method">
  
    #<strong>build_response</strong>(packet, function, layouts, client)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366
367
368
369
370
371
372
373
374
375
376
377
378
379
380
381</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/rex/post/meterpreter/extensions/stdapi/railgun/library.rb', line 281</span>

<span class='kw'>def</span> <span class='id identifier rubyid_build_response'>build_response</span><span class='lparen'>(</span><span class='id identifier rubyid_packet'>packet</span><span class='comma'>,</span> <span class='id identifier rubyid_function'>function</span><span class='comma'>,</span> <span class='id identifier rubyid_layouts'>layouts</span><span class='comma'>,</span> <span class='id identifier rubyid_client'>client</span><span class='rparen'>)</span>
  <span class='kw'>case</span> <span class='id identifier rubyid_client'>client</span><span class='period'>.</span><span class='id identifier rubyid_native_arch'>native_arch</span>
  <span class='kw'>when</span> <span class='const'>ARCH_X64</span>
    <span class='id identifier rubyid_native'>native</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Q&lt;</span><span class='tstring_end'>&#39;</span></span>
  <span class='kw'>when</span> <span class='const'>ARCH_X86</span>
    <span class='id identifier rubyid_native'>native</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>V</span><span class='tstring_end'>&#39;</span></span>
  <span class='kw'>else</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'>NotImplementedError</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Unsupported architecture (must be ARCH_X86 or ARCH_X64)</span><span class='tstring_end'>&#39;</span></span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_rec_inout_buffers'>rec_inout_buffers</span> <span class='op'>=</span> <span class='id identifier rubyid_packet'>packet</span><span class='period'>.</span><span class='id identifier rubyid_get_tlv_value'>get_tlv_value</span><span class='lparen'>(</span><span class='const'><span class='object_link'><a href="../Railgun.html#TLV_TYPE_RAILGUN_BACK_BUFFERBLOB_INOUT-constant" title="Rex::Post::Meterpreter::Extensions::Stdapi::Railgun::TLV_TYPE_RAILGUN_BACK_BUFFERBLOB_INOUT (constant)">TLV_TYPE_RAILGUN_BACK_BUFFERBLOB_INOUT</a></span></span><span class='rparen'>)</span>
  <span class='id identifier rubyid_rec_out_only_buffers'>rec_out_only_buffers</span> <span class='op'>=</span> <span class='id identifier rubyid_packet'>packet</span><span class='period'>.</span><span class='id identifier rubyid_get_tlv_value'>get_tlv_value</span><span class='lparen'>(</span><span class='const'><span class='object_link'><a href="../Railgun.html#TLV_TYPE_RAILGUN_BACK_BUFFERBLOB_OUT-constant" title="Rex::Post::Meterpreter::Extensions::Stdapi::Railgun::TLV_TYPE_RAILGUN_BACK_BUFFERBLOB_OUT (constant)">TLV_TYPE_RAILGUN_BACK_BUFFERBLOB_OUT</a></span></span><span class='rparen'>)</span>
  <span class='id identifier rubyid_rec_return_value'>rec_return_value</span> <span class='op'>=</span> <span class='id identifier rubyid_packet'>packet</span><span class='period'>.</span><span class='id identifier rubyid_get_tlv_value'>get_tlv_value</span><span class='lparen'>(</span><span class='const'><span class='object_link'><a href="../Railgun.html#TLV_TYPE_RAILGUN_BACK_RET-constant" title="Rex::Post::Meterpreter::Extensions::Stdapi::Railgun::TLV_TYPE_RAILGUN_BACK_RET (constant)">TLV_TYPE_RAILGUN_BACK_RET</a></span></span><span class='rparen'>)</span>
  <span class='id identifier rubyid_rec_last_error'>rec_last_error</span> <span class='op'>=</span> <span class='id identifier rubyid_packet'>packet</span><span class='period'>.</span><span class='id identifier rubyid_get_tlv_value'>get_tlv_value</span><span class='lparen'>(</span><span class='const'><span class='object_link'><a href="../Railgun.html#TLV_TYPE_RAILGUN_BACK_ERR-constant" title="Rex::Post::Meterpreter::Extensions::Stdapi::Railgun::TLV_TYPE_RAILGUN_BACK_ERR (constant)">TLV_TYPE_RAILGUN_BACK_ERR</a></span></span><span class='rparen'>)</span>
  <span class='id identifier rubyid_rec_err_msg'>rec_err_msg</span> <span class='op'>=</span> <span class='id identifier rubyid_packet'>packet</span><span class='period'>.</span><span class='id identifier rubyid_get_tlv_value'>get_tlv_value</span><span class='lparen'>(</span><span class='const'><span class='object_link'><a href="../Railgun.html#TLV_TYPE_RAILGUN_BACK_MSG-constant" title="Rex::Post::Meterpreter::Extensions::Stdapi::Railgun::TLV_TYPE_RAILGUN_BACK_MSG (constant)">TLV_TYPE_RAILGUN_BACK_MSG</a></span></span><span class='rparen'>)</span>

  <span class='comment'># Error messages come back with trailing CRLF, so strip it out if we do get a message.
</span>  <span class='id identifier rubyid_rec_err_msg'>rec_err_msg</span><span class='period'>.</span><span class='id identifier rubyid_strip!'>strip!</span> <span class='kw'>unless</span> <span class='id identifier rubyid_rec_err_msg'>rec_err_msg</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>

  <span class='comment'># the hash the function returns
</span>  <span class='id identifier rubyid_return_hash'>return_hash</span> <span class='op'>=</span> <span class='lbrace'>{</span>
    <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>GetLastError</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_rec_last_error'>rec_last_error</span><span class='comma'>,</span>
    <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>ErrorMessage</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_rec_err_msg'>rec_err_msg</span>
  <span class='rbrace'>}</span>

  <span class='comment'># process return value
</span>  <span class='kw'>case</span> <span class='id identifier rubyid_function'>function</span><span class='period'>.</span><span class='id identifier rubyid_return_type'>return_type</span>
    <span class='kw'>when</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>LPVOID</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>ULONG_PTR</span><span class='tstring_end'>&#39;</span></span>
      <span class='kw'>if</span> <span class='id identifier rubyid_client'>client</span><span class='period'>.</span><span class='id identifier rubyid_native_arch'>native_arch</span> <span class='op'>==</span> <span class='const'>ARCH_X64</span>
        <span class='id identifier rubyid_return_hash'>return_hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>return</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_rec_return_value'>rec_return_value</span>
      <span class='kw'>else</span>
        <span class='id identifier rubyid_return_hash'>return_hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>return</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_rec_return_value'>rec_return_value</span> <span class='op'>&amp;</span> <span class='int'>0xffffffff</span>
      <span class='kw'>end</span>
    <span class='kw'>when</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>DWORD</span><span class='tstring_end'>&#39;</span></span>
      <span class='id identifier rubyid_return_hash'>return_hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>return</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_rec_return_value'>rec_return_value</span> <span class='op'>&amp;</span> <span class='int'>0xffffffff</span>
    <span class='kw'>when</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>WORD</span><span class='tstring_end'>&#39;</span></span>
      <span class='id identifier rubyid_return_hash'>return_hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>return</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_rec_return_value'>rec_return_value</span> <span class='op'>&amp;</span> <span class='int'>0xffff</span>
    <span class='kw'>when</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>BYTE</span><span class='tstring_end'>&#39;</span></span>
      <span class='id identifier rubyid_return_hash'>return_hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>return</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_rec_return_value'>rec_return_value</span> <span class='op'>&amp;</span> <span class='int'>0xff</span>
    <span class='kw'>when</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>BOOL</span><span class='tstring_end'>&#39;</span></span>
      <span class='id identifier rubyid_return_hash'>return_hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>return</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='lparen'>(</span><span class='id identifier rubyid_rec_return_value'>rec_return_value</span> <span class='op'>!=</span> <span class='int'>0</span><span class='rparen'>)</span>
    <span class='kw'>when</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>VOID</span><span class='tstring_end'>&#39;</span></span>
      <span class='id identifier rubyid_return_hash'>return_hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>return</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='kw'>when</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>PCHAR</span><span class='tstring_end'>&#39;</span></span>
      <span class='id identifier rubyid_return_hash'>return_hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>return</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_rec_return_value'>rec_return_value</span> <span class='op'>==</span> <span class='int'>0</span> <span class='op'>?</span> <span class='kw'>nil</span> <span class='op'>:</span> <span class='id identifier rubyid_client'>client</span><span class='period'>.</span><span class='id identifier rubyid_railgun'>railgun</span><span class='period'>.</span><span class='id identifier rubyid_util'>util</span><span class='period'>.</span><span class='id identifier rubyid_read_string'>read_string</span><span class='lparen'>(</span><span class='id identifier rubyid_rec_return_value'>rec_return_value</span><span class='rparen'>)</span>
      <span class='id identifier rubyid_return_hash'>return_hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>&amp;return</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_rec_return_value'>rec_return_value</span>
    <span class='kw'>when</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>PWCHAR</span><span class='tstring_end'>&#39;</span></span>
      <span class='id identifier rubyid_return_hash'>return_hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>return</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_rec_return_value'>rec_return_value</span> <span class='op'>==</span> <span class='int'>0</span> <span class='op'>?</span> <span class='kw'>nil</span> <span class='op'>:</span> <span class='id identifier rubyid_client'>client</span><span class='period'>.</span><span class='id identifier rubyid_railgun'>railgun</span><span class='period'>.</span><span class='id identifier rubyid_util'>util</span><span class='period'>.</span><span class='id identifier rubyid_read_wstring'>read_wstring</span><span class='lparen'>(</span><span class='id identifier rubyid_rec_return_value'>rec_return_value</span><span class='rparen'>)</span>
      <span class='id identifier rubyid_return_hash'>return_hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>&amp;return</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_rec_return_value'>rec_return_value</span>
    <span class='kw'>when</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>PULONG_PTR</span><span class='tstring_end'>&#39;</span></span>
      <span class='kw'>if</span> <span class='id identifier rubyid_client'>client</span><span class='period'>.</span><span class='id identifier rubyid_native_arch'>native_arch</span> <span class='op'>==</span> <span class='const'>ARCH_X64</span>
        <span class='id identifier rubyid_return_hash'>return_hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>return</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_rec_return_value'>rec_return_value</span> <span class='op'>==</span> <span class='int'>0</span> <span class='op'>?</span> <span class='kw'>nil</span> <span class='op'>:</span> <span class='id identifier rubyid_client'>client</span><span class='period'>.</span><span class='id identifier rubyid_railgun'>railgun</span><span class='period'>.</span><span class='id identifier rubyid_util'>util</span><span class='period'>.</span><span class='id identifier rubyid_memread'>memread</span><span class='lparen'>(</span><span class='id identifier rubyid_rec_return_value'>rec_return_value</span><span class='comma'>,</span> <span class='int'>8</span><span class='rparen'>)</span><span class='op'>&amp;.</span><span class='id identifier rubyid_unpack1'>unpack1</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Q&lt;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
        <span class='id identifier rubyid_return_hash'>return_hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>&amp;return</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_rec_return_value'>rec_return_value</span>
      <span class='kw'>else</span>
        <span class='id identifier rubyid_return_hash'>return_hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>return</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_rec_return_value'>rec_return_value</span> <span class='op'>==</span> <span class='int'>0</span> <span class='op'>?</span> <span class='kw'>nil</span> <span class='op'>:</span> <span class='id identifier rubyid_client'>client</span><span class='period'>.</span><span class='id identifier rubyid_railgun'>railgun</span><span class='period'>.</span><span class='id identifier rubyid_util'>util</span><span class='period'>.</span><span class='id identifier rubyid_memread'>memread</span><span class='lparen'>(</span><span class='id identifier rubyid_rec_return_value'>rec_return_value</span><span class='comma'>,</span> <span class='int'>4</span><span class='rparen'>)</span><span class='op'>&amp;.</span><span class='id identifier rubyid_unpack1'>unpack1</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>V</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
        <span class='id identifier rubyid_return_hash'>return_hash</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>&amp;return</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_rec_return_value'>rec_return_value</span>
      <span class='kw'>end</span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>unexpected return type: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_function'>function</span><span class='period'>.</span><span class='id identifier rubyid_return_type'>return_type</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>

  <span class='comment'># process out-only buffers
</span>  <span class='id identifier rubyid_layouts'>layouts</span><span class='lbracket'>[</span><span class='symbol'>:out</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_each_pair'>each_pair</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_param_name'>param_name</span><span class='comma'>,</span> <span class='id identifier rubyid_buffer_item'>buffer_item</span><span class='op'>|</span>
    <span class='id identifier rubyid_buffer'>buffer</span> <span class='op'>=</span> <span class='id identifier rubyid_rec_out_only_buffers'>rec_out_only_buffers</span><span class='lbracket'>[</span><span class='id identifier rubyid_buffer_item'>buffer_item</span><span class='period'>.</span><span class='id identifier rubyid_addr'>addr</span><span class='comma'>,</span> <span class='id identifier rubyid_buffer_item'>buffer_item</span><span class='period'>.</span><span class='id identifier rubyid_length_in_bytes'>length_in_bytes</span><span class='rbracket'>]</span>
    <span class='kw'>case</span> <span class='id identifier rubyid_buffer_item'>buffer_item</span><span class='period'>.</span><span class='id identifier rubyid_datatype'>datatype</span>
      <span class='kw'>when</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>PULONG_PTR</span><span class='tstring_end'>&#39;</span></span>
        <span class='id identifier rubyid_return_hash'>return_hash</span><span class='lbracket'>[</span><span class='id identifier rubyid_param_name'>param_name</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_buffer'>buffer</span><span class='period'>.</span><span class='id identifier rubyid_unpack'>unpack</span><span class='lparen'>(</span><span class='id identifier rubyid_native'>native</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span>
      <span class='kw'>when</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>PDWORD</span><span class='tstring_end'>&#39;</span></span>
        <span class='id identifier rubyid_return_hash'>return_hash</span><span class='lbracket'>[</span><span class='id identifier rubyid_param_name'>param_name</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_buffer'>buffer</span><span class='period'>.</span><span class='id identifier rubyid_unpack'>unpack</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>V</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span>
      <span class='kw'>when</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>PCHAR</span><span class='tstring_end'>&#39;</span></span>
        <span class='id identifier rubyid_return_hash'>return_hash</span><span class='lbracket'>[</span><span class='id identifier rubyid_param_name'>param_name</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_asciiz_to_str'>asciiz_to_str</span><span class='lparen'>(</span><span class='id identifier rubyid_buffer'>buffer</span><span class='rparen'>)</span>
      <span class='kw'>when</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>PWCHAR</span><span class='tstring_end'>&#39;</span></span>
        <span class='id identifier rubyid_return_hash'>return_hash</span><span class='lbracket'>[</span><span class='id identifier rubyid_param_name'>param_name</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_uniz_to_str'>uniz_to_str</span><span class='lparen'>(</span><span class='id identifier rubyid_buffer'>buffer</span><span class='rparen'>)</span>
      <span class='kw'>when</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>PBLOB</span><span class='tstring_end'>&#39;</span></span>
        <span class='id identifier rubyid_return_hash'>return_hash</span><span class='lbracket'>[</span><span class='id identifier rubyid_param_name'>param_name</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_buffer'>buffer</span>
      <span class='kw'>else</span>
        <span class='id identifier rubyid_raise'>raise</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>unexpected type in out-only buffer of </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_param_name'>param_name</span><span class='embexpr_end'>}</span><span class='tstring_content'>: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_buffer_item'>buffer_item</span><span class='period'>.</span><span class='id identifier rubyid_datatype'>datatype</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='comment'># process in-out buffers
</span>  <span class='id identifier rubyid_layouts'>layouts</span><span class='lbracket'>[</span><span class='symbol'>:inout</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_each_pair'>each_pair</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_param_name'>param_name</span><span class='comma'>,</span> <span class='id identifier rubyid_buffer_item'>buffer_item</span><span class='op'>|</span>
    <span class='id identifier rubyid_buffer'>buffer</span> <span class='op'>=</span> <span class='id identifier rubyid_rec_inout_buffers'>rec_inout_buffers</span><span class='lbracket'>[</span><span class='id identifier rubyid_buffer_item'>buffer_item</span><span class='period'>.</span><span class='id identifier rubyid_addr'>addr</span><span class='comma'>,</span> <span class='id identifier rubyid_buffer_item'>buffer_item</span><span class='period'>.</span><span class='id identifier rubyid_length_in_bytes'>length_in_bytes</span><span class='rbracket'>]</span>
    <span class='kw'>case</span> <span class='id identifier rubyid_buffer_item'>buffer_item</span><span class='period'>.</span><span class='id identifier rubyid_datatype'>datatype</span>
      <span class='kw'>when</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>PULONG_PTR</span><span class='tstring_end'>&#39;</span></span>
        <span class='id identifier rubyid_return_hash'>return_hash</span><span class='lbracket'>[</span><span class='id identifier rubyid_param_name'>param_name</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_buffer'>buffer</span><span class='period'>.</span><span class='id identifier rubyid_unpack'>unpack</span><span class='lparen'>(</span><span class='id identifier rubyid_native'>native</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span>
      <span class='kw'>when</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>PDWORD</span><span class='tstring_end'>&#39;</span></span>
        <span class='id identifier rubyid_return_hash'>return_hash</span><span class='lbracket'>[</span><span class='id identifier rubyid_param_name'>param_name</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_buffer'>buffer</span><span class='period'>.</span><span class='id identifier rubyid_unpack'>unpack</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>V</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span>
      <span class='kw'>when</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>PCHAR</span><span class='tstring_end'>&#39;</span></span>
        <span class='id identifier rubyid_return_hash'>return_hash</span><span class='lbracket'>[</span><span class='id identifier rubyid_param_name'>param_name</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_asciiz_to_str'>asciiz_to_str</span><span class='lparen'>(</span><span class='id identifier rubyid_buffer'>buffer</span><span class='rparen'>)</span>
      <span class='kw'>when</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>PWCHAR</span><span class='tstring_end'>&#39;</span></span>
        <span class='id identifier rubyid_return_hash'>return_hash</span><span class='lbracket'>[</span><span class='id identifier rubyid_param_name'>param_name</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_uniz_to_str'>uniz_to_str</span><span class='lparen'>(</span><span class='id identifier rubyid_buffer'>buffer</span><span class='rparen'>)</span>
      <span class='kw'>when</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>PBLOB</span><span class='tstring_end'>&#39;</span></span>
        <span class='id identifier rubyid_return_hash'>return_hash</span><span class='lbracket'>[</span><span class='id identifier rubyid_param_name'>param_name</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_buffer'>buffer</span>
      <span class='kw'>else</span>
        <span class='id identifier rubyid_raise'>raise</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>unexpected type in in-out-buffer of </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_param_name'>param_name</span><span class='embexpr_end'>}</span><span class='tstring_content'>: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_buffer_item'>buffer_item</span><span class='period'>.</span><span class='id identifier rubyid_datatype'>datatype</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_return_hash'>return_hash</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="call_function-instance_method">
  
    #<strong>call_function</strong>(function, args, client)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Perform a function call in this library on the remote system.</p>

<p>Returns a Hash containing the return value, the result of GetLastError(), and any <code>inout</code> parameters.</p>

<p>Raises an exception if <code>function</code> is not a known function in this library, i.e., it hasn’t been defined in a Def.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


88
89
90
91
92
93
94
95
96
97
98
99
100</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/rex/post/meterpreter/extensions/stdapi/railgun/library.rb', line 88</span>

<span class='kw'>def</span> <span class='id identifier rubyid_call_function'>call_function</span><span class='lparen'>(</span><span class='id identifier rubyid_function'>function</span><span class='comma'>,</span> <span class='id identifier rubyid_args'>args</span><span class='comma'>,</span> <span class='id identifier rubyid_client'>client</span><span class='rparen'>)</span>
  <span class='kw'>unless</span> <span class='id identifier rubyid_function'>function</span><span class='period'>.</span><span class='id identifier rubyid_instance_of?'>instance_of?</span> <span class='const'><span class='object_link'><a href="LibraryFunction.html" title="Rex::Post::Meterpreter::Extensions::Stdapi::Railgun::LibraryFunction (class)">LibraryFunction</a></span></span>
    <span class='id identifier rubyid_func_name'>func_name</span> <span class='op'>=</span> <span class='id identifier rubyid_function'>function</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span>

    <span class='kw'>unless</span> <span class='id identifier rubyid_known_function_names'>known_function_names</span><span class='period'>.</span><span class='id identifier rubyid_include?'>include?</span> <span class='id identifier rubyid_func_name'>func_name</span>
      <span class='id identifier rubyid_raise'>raise</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Library-function </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_func_name'>func_name</span><span class='embexpr_end'>}</span><span class='tstring_content'> not found. Known functions: </span><span class='embexpr_beg'>#{</span><span class='const'>PP</span><span class='period'>.</span><span class='id identifier rubyid_pp'>pp</span><span class='lparen'>(</span><span class='id identifier rubyid_known_function_names'>known_function_names</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>

    <span class='id identifier rubyid_function'>function</span> <span class='op'>=</span> <span class='id identifier rubyid_get_function'>get_function</span><span class='lparen'>(</span><span class='id identifier rubyid_func_name'>func_name</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='kw'>return</span> <span class='id identifier rubyid_process_function_call'>process_function_call</span><span class='lparen'>(</span><span class='id identifier rubyid_function'>function</span><span class='comma'>,</span> <span class='id identifier rubyid_args'>args</span><span class='comma'>,</span> <span class='id identifier rubyid_client'>client</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="get_function-instance_method">
  
    #<strong>get_function</strong>(name)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


75
76
77</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/rex/post/meterpreter/extensions/stdapi/railgun/library.rb', line 75</span>

<span class='kw'>def</span> <span class='id identifier rubyid_get_function'>get_function</span><span class='lparen'>(</span><span class='id identifier rubyid_name'>name</span><span class='rparen'>)</span>
  <span class='kw'>return</span> <span class='id identifier rubyid_functions'>functions</span><span class='lbracket'>[</span><span class='id identifier rubyid_name'>name</span><span class='rbracket'>]</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="known_function_names-instance_method">
  
    #<strong>known_function_names</strong>  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


71
72
73</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/rex/post/meterpreter/extensions/stdapi/railgun/library.rb', line 71</span>

<span class='kw'>def</span> <span class='id identifier rubyid_known_function_names'>known_function_names</span>
  <span class='kw'>return</span> <span class='id identifier rubyid_functions'>functions</span><span class='period'>.</span><span class='id identifier rubyid_keys'>keys</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>

      <div id="footer">
  Generated on Fri Oct 31 12:10:52 2025 by
  <a href="https://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.9.37 (ruby-3.1.5).
</div>

    </div>
  </body>
</html>