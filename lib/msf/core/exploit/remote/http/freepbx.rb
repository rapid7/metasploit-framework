# -*- coding: binary -*-

module Msf
  class Exploit
    class Remote
      module HTTP
        #
        # Shared routines for FreePBX modules
        #
        module FreePBX
          # Get the Referer header for FreePBX requests
          #
          # @return [String] Referer URL
          #
          def freepbx_referer
            host = datastore['RHOSTS'] || rhost
            host = '127.0.0.1' if host == '::1' || host == 'localhost'
            "http#{datastore['SSL'] ? 's' : ''}://#{host}:#{rport}#{normalize_uri(target_uri.path, 'admin', 'config.php')}"
          end

          # Authenticate with supplied credentials and return the session cookie.
          #
          # @param username [String] FreePBX username
          # @param password [String] FreePBX password
          # @param timeout [Integer] The maximum number of seconds to wait before the request times out
          # @return [String,nil] the session cookies as a single string on successful login, nil otherwise
          #
          def freepbx_login(username, password, timeout = 20)
            # Get initial session and login page
            res = send_request_cgi({
              'uri' => normalize_uri(target_uri.path, 'admin', 'config.php'),
              'method' => 'GET',
              'headers' => { 'Referer' => freepbx_referer }
            }, timeout)

            return nil unless res

            # Extract session cookie
            cookie = res.get_cookies
            return nil if cookie.empty?

            # Extract CSRF token if present
            token = nil
            if res.body =~ /name="token"\s+value="([^"]+)"/
              token = Regexp.last_match(1)
            end

            # Login POST
            post_data = {
              'username' => username,
              'password' => password
            }
            post_data['token'] = token if token

            res = send_request_cgi({
              'uri' => normalize_uri(target_uri.path, 'admin', 'config.php'),
              'method' => 'POST',
              'cookie' => cookie,
              'headers' => {
                'Referer' => freepbx_referer,
                'Content-Type' => 'application/x-www-form-urlencoded'
              },
              'vars_post' => post_data
            }, timeout)

            return nil unless res

            if res.code == 302 || (res.code == 200 && !res.body.include?('Login'))
              new_cookie = res.get_cookies

              return new_cookie unless new_cookie.empty?

              return cookie
            end

            nil
          end
        end
      end
    end
  end
end
