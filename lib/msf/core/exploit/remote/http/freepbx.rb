# -*- coding: binary -*-

module Msf
  class Exploit
    class Remote
      module HTTP
        #
        # Shared routines for FreePBX modules
        #
        module FreePBX
          # Get the admin config URI
          #
          # @return [String] Admin config URI path
          #
          def freepbx_admin_uri
            normalize_uri(target_uri.path, 'admin', 'config.php')
          end

          # Get the Referer header for FreePBX requests
          #
          # @return [String] Referer URL
          #
          def freepbx_referer
            host = datastore['RHOSTS'] || rhost
            host = '127.0.0.1' if host == '::1' || host == 'localhost'
            protocol = datastore['SSL'] ? 'https' : 'http'
            "#{protocol}://#{host}:#{rport}#{freepbx_admin_uri}"
          end

          # Authenticate with supplied credentials and return the session cookie
          #
          # @param username [String] FreePBX username
          # @param password [String] FreePBX password
          # @param timeout [Integer] The maximum number of seconds to wait before the request times out
          # @return [String,nil] the session cookies as a single string on successful login, nil otherwise
          #
          def freepbx_login(username, password, timeout = 20)
            cache_key = "#{username}:#{password}"
            if @freepbx_auth_cache && @freepbx_auth_cache[cache_key]
              return @freepbx_auth_cache[cache_key]
            end

            data = freepbx_get_login_page_data(timeout)
            res = data[:response]
            return nil unless res

            cookie = res.get_cookies
            return nil if cookie.empty?

            login_response = send_request_cgi({
              'uri' => freepbx_admin_uri,
              'method' => 'POST',
              'cookie' => cookie,
              'headers' => {
                'Referer' => freepbx_referer,
                'Content-Type' => 'application/x-www-form-urlencoded'
              },
              'vars_post' => {
                'username' => username,
                'password' => password
              }
            }, timeout)

            return nil unless login_response

            body_lower = login_response.body.downcase
            if body_lower.include?('invalid username or password') && body_lower.include?('obe_error')
              @freepbx_auth_cache ||= {}
              @freepbx_auth_cache[cache_key] = :auth_failed
              return :auth_failed
            end

            return nil unless login_response.code == 302 || (login_response.code == 200 && !login_response.body.include?('Login'))

            new_cookie = login_response.get_cookies
            result = new_cookie.empty? ? cookie : new_cookie
            @freepbx_auth_cache ||= {}
            @freepbx_auth_cache[cache_key] = result
            result
          end

          # Get or create the login page data
          #
          # @param timeout [Integer] Request timeout
          # @return [Hash] Hash with :response and :detected keys
          #
          def freepbx_get_login_page_data(timeout = 20)
            return @freepbx_login_page if @freepbx_login_page

            res = send_request_cgi({
              'uri' => freepbx_admin_uri,
              'method' => 'GET',
              'headers' => { 'Referer' => freepbx_referer }
            }, timeout)

            body_lower = res&.body&.downcase || ''
            detected = (res&.code == 200) && (
              body_lower.match?(%r{<title>freepbx\s+administration</title>}) ||
              (body_lower.include?('freepbx administration') && body_lower.include?('loginform')) ||
              body_lower.include?('assets/js/freepbx.js') ||
              body_lower.include?('freepbx-navbar') ||
              (body_lower.match?(/id=["']loginform["']/) && body_lower.include?('freepbx'))
            )

            @freepbx_login_page = {
              response: res,
              detected: detected
            }
          end
        end
      end
    end
  end
end
