module Msf::Exploit::Targets
  #
  # Attributes
  #

  # @!attribute [rw] default_target
  #   The default target for this exploit.
  #
  #   @return [String] element of {#targets}.
  attr_accessor :default_target

  # @!attribute [r] targets
  #   The targets for this exploit.
  #
  #   @return [Array<String>]

  #
  # Methods
  #

  # @deprecated Use {#default_target_index} instead.
  # @return (see #default_target_index)
  def default_target
    ActiveSupport::Deprecation.warn "#{self}##{__method__} is deprecated.  Use #{self.class}#default_target_index instead"
    default_target_index
  end

  # The index of the default target as declared with 'DefaultTarget' info key passed to initialize.
  #
  # @return [nil] if 'DefaultTarget' not given.
  # @return [Integer] if 'DefaultTarget' given.
  def default_target_index
    # can't use ||= because it may be nil
    unless instance_variable_defined? :@default_target_index
      default_target_index = module_info['DefaultTarget']

      # don't want to cast nil to 0
      unless default_target_index.nil?
        default_target_index = default_target_index.to_i
      end

      @default_target_index = default_target_index
    end

    @default_target_index
  end

  # Returns the active target for this exploit.  If not target has been
  # defined, nil is returned.  If no target was defined but there is a
  # default target, that one will be automatically used.
  def target
    target_idx = target_index

    return (target_idx) ? targets[target_idx.to_i] : nil
  end

  #
  # The target index that has been selected.
  #
  def target_index
    datastore_target_index = datastore['TARGET']
    target_index = nil

    # Use the default target if one was not supplied.
    if datastore_target_index.nil?
      if default_target_index && default_target_index >= 0
        target_index = default_target_index
      end
    else
      target_index = datastore_target_index.to_i
    end

    target_index
  end

  #
  # Returns the target's platform, or the one assigned to the module itself.
  #
  def target_platform
    (target and target.platform) ? target.platform : platform
  end

  #
  # Returns the target's architecture, or the one assigned to the module
  # itself.
  #
  def target_arch
    (target and target.arch) ? target.arch : (arch == []) ? nil : arch
  end

  def targets
    unless instance_variable_defined? :@targets
      targets = Rex::Transformer.transform(
          module_info['Targets'],
          Array,
          [
              Msf::Module::Target
          ],
          'Targets'
      )

      # assign metasploit_instance so that target can delegate to it for architecture_abbreviations and platform_list
      targets.each do |target|
        target.metasploit_instance = self
      end

      @targets = targets
    end

    @targets
  end
end