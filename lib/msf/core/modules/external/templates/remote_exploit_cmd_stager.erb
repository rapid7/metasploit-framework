require 'msf/core/modules/external/bridge'
require 'msf/core/module/external'

class MetasploitModule < Msf::Exploit::Remote
  Rank = ExcellentRanking

  include Msf::Module::External
  include Msf::Exploit::CmdStager

  def initialize(info = {})
    super(update_info(info,
	  <%= common_metadata meta %>
      'References'  =>
        [
          <%= meta[:references] %>
        ],
      'DisclosureDate' => <%= meta[:date] %>,
      'Privileged'     => <%= meta[:privileged] %>,
      'Platform'       => [<%= meta[:platform] %>],
      'Payload'        =>
        {
          'DisableNops' => true
        },
      'Targets'        =>
        [
          <%= meta[:targets] %>
        ],
      'DefaultTarget'  => 0,
      'DefaultOptions' => { 'WfsDelay' => <%= meta[:wfsdelay] %> }
      ))

      register_options([
        <%= meta[:options] %>
      ])
  end

  <% if meta[:capabilities].include? 'soft_check' %>
  def check
    code = execute_module(<%= meta[:path] %>, method: :soft_check)
    return Msf::Exploit::CheckCode::Codes[code]
  end
  <% end %>

  def execute_command(cmd, opts)
    execute_module(<%= meta[:path] %>, args: datastore.merge(command: cmd))
  end

  def exploit
    print_status("Exploiting...")
    execute_cmdstager({:flavor  => :<%= meta[:command_stager_flavor] %>})
  end
end
