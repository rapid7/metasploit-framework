require 'msf/core/modules/external/bridge'
require 'msf/core/module/external'

class MetasploitModule < Msf::Exploit::Remote
  Rank = <%= meta[:rank] %>

  include Msf::Module::External

  def initialize(info = {})
    super(update_info(info,
      <%= common_metadata meta, default_options: { 'WfsDelay' => meta[:wfsdelay] }  %>
      'References'  =>
        [
          <%= meta[:references] %>
        ],
      'DisclosureDate' => <%= meta[:date] %>,
      'Privileged'     => <%= meta[:privileged] %>,
      'Platform'       => [<%= meta[:platform] %>],
      'Arch'           => [<%= meta[:arch] %>],
      'Targets'        =>
        [
          <%= meta[:targets] %>
        ],
      'DefaultTarget'  => 0,
      ))

      register_options([
        <%= meta[:options] %>
      ])
  end

  <%= common_check meta %>

  def exploit
    args = datastore.merge(
      # XXX: JSON-RPC requires UTF-8, so we Base64-encode the binary payload
      payload_encoded: Rex::Text.encode_base64(payload.encoded)
    )

    execute_module(<%= meta[:path] %>, args: args)
  end
end
