<!DOCTYPE html><html lang="en-US"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=Edge"><link rel="shortcut icon" href="/assets/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/assets/css/just-the-docs-default.css"> <script async src="https://www.googletagmanager.com/gtag/js?id=UA-4622520-7"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-4622520-7', { 'anonymize_ip': true }); </script> <script type="text/javascript" src="/assets/js/vendor/lunr.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mermaid@10.8.0/dist/mermaid.min.js"></script> <script type="text/javascript" src="/assets/js/just-the-docs.js"></script><meta name="viewport" content="width=device-width, initial-scale=1"><title>Vulnerable cert finder | Metasploit Documentation Penetration Testing Software, Pen Testing Security</title><meta name="generator" content="Jekyll v4.3.4" /><meta property="og:title" content="Vulnerable cert finder" /><meta property="og:locale" content="en_US" /><meta name="description" content="View Metasploit Framework Documentation" /><meta property="og:description" content="View Metasploit Framework Documentation" /><link rel="canonical" href="https://rapid7.github.io/metasploit-framework/docs/pentesting/active-directory/ad-certificates/ldap_esc_vulnerable_cert_finder.html" /><meta property="og:url" content="https://rapid7.github.io/metasploit-framework/docs/pentesting/active-directory/ad-certificates/ldap_esc_vulnerable_cert_finder.html" /><meta property="og:site_name" content="Metasploit Documentation Penetration Testing Software, Pen Testing Security" /><meta property="og:type" content="website" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Vulnerable cert finder" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"WebPage","description":"View Metasploit Framework Documentation","headline":"Vulnerable cert finder","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://rapid7.github.io/metasploit-framework/assets/images/favicon.png"}},"url":"https://rapid7.github.io/metasploit-framework/docs/pentesting/active-directory/ad-certificates/ldap_esc_vulnerable_cert_finder.html"}</script><body> <svg xmlns="http://www.w3.org/2000/svg" style="display: none;"> <symbol id="svg-link" viewBox="0 0 24 24"><title>Link</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"><title>Search</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"><title>Menu</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"><title>Expand</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"><polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"><title>Document</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> </svg> <script type="text/javascript" src="/assets/js/toggle_init.js"></script><div class="side-bar"><div class="site-header"> <a href="/" class="site-title lh-tight"><img src="/assets/images/metasploit-logo-dark-external-use.svg" alt="Metasploit Logo" class="title-logo" /> </a> <a href="#" id="menu-button" class="site-button"> <svg viewBox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg> </a></div><nav role="navigation" aria-label="Main" id="site-nav" class="site-nav"><ul class="nav-list"><li class="nav-list-item active"><a href="/" class="nav-list-link">Home</a><li class="nav-list-item active"><a href="/docs/code-of-conduct.html" class="nav-list-link">Code Of Conduct</a><li class="nav-list-item active"><a href="/docs/modules.html" class="nav-list-link">Modules</a><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/pentesting/" class="nav-list-link active">Pentesting</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/pentesting/metasploit-guide-setting-module-options.html" class="nav-list-link">Setting Module Options</a><li class="nav-list-item active"><a href="/docs/pentesting/metasploit-guide-upgrading-shells-to-meterpreter.html" class="nav-list-link">Upgrading Shells to Meterpreter</a><li class="nav-list-item active"><a href="/docs/pentesting/metasploit-guide-post-gather-modules.html" class="nav-list-link">Post Gather Modules</a><li class="nav-list-item active"><a href="/docs/pentesting/metasploit-guide-http.html" class="nav-list-link">HTTP + HTTPS</a><li class="nav-list-item active"><a href="/docs/pentesting/metasploit-guide-kubernetes.html" class="nav-list-link">Kubernetes</a><li class="nav-list-item active"><a href="/docs/pentesting/metasploit-guide-mysql.html" class="nav-list-link">MySQL</a><li class="nav-list-item active"><a href="/docs/pentesting/metasploit-guide-postgresql.html" class="nav-list-link">PostgreSQL</a><li class="nav-list-item active"><a href="/docs/pentesting/metasploit-guide-smb.html" class="nav-list-link">SMB</a><li class="nav-list-item active"><a href="/docs/pentesting/metasploit-guide-ssh.html" class="nav-list-link">SSH</a><li class="nav-list-item active"><a href="/docs/pentesting/metasploit-guide-winrm.html" class="nav-list-link">WinRM</a><li class="nav-list-item active"><a href="/docs/pentesting/metasploit-guide-mssql.html" class="nav-list-link">MSSQL</a><li class="nav-list-item active"><a href="/docs/pentesting/metasploit-guide-ldap.html" class="nav-list-link">LDAP</a><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/pentesting/active-directory/" class="nav-list-link active">Active Directory</a><ul class="nav-list"><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/pentesting/active-directory/ad-certificates/" class="nav-list-link active">AD CS</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/pentesting/active-directory/ad-certificates/overview.html" class="nav-list-link">Overview</a><li class="nav-list-item active"><a href="/docs/pentesting/active-directory/ad-certificates/attacking-ad-cs-esc-vulnerabilities.html" class="nav-list-link">Attacking AD CS ESC Vulnerabilities Using Metasploit</a><li class="nav-list-item active"><a href="/docs/pentesting/active-directory/ad-certificates/ldap_esc_vulnerable_cert_finder.html" class="nav-list-link active">Vulnerable cert finder</a><li class="nav-list-item active"><a href="/docs/pentesting/active-directory/ad-certificates/ad_cs_cert_template.html" class="nav-list-link">Manage certificate templates</a><li class="nav-list-item active"><a href="/docs/pentesting/active-directory/ad-certificates/icpr_cert.html" class="nav-list-link">Request certificates</a></ul><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/pentesting/active-directory/kerberos/" class="nav-list-link">Kerberos</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/pentesting/active-directory/kerberos/overview.html" class="nav-list-link">Overview</a><li class="nav-list-item active"><a href="/docs/pentesting/active-directory/kerberos/service_authentication.html" class="nav-list-link">Authenticating to SMB/WinRM/etc</a><li class="nav-list-item active"><a href="/docs/pentesting/active-directory/kerberos/kerberos_login.html" class="nav-list-link">Kerberos login enumeration and bruteforcing</a><li class="nav-list-item active"><a href="/docs/pentesting/active-directory/kerberos/get_ticket.html" class="nav-list-link">Get Ticket granting tickets and service tickets</a><li class="nav-list-item active"><a href="/docs/pentesting/active-directory/kerberos/ticket_converter.html" class="nav-list-link">Converting kirbi and ccache files</a><li class="nav-list-item active"><a href="/docs/pentesting/active-directory/kerberos/forge_ticket.html" class="nav-list-link">Forging tickets</a><li class="nav-list-item active"><a href="/docs/pentesting/active-directory/kerberos/inspect_ticket.html" class="nav-list-link">Inspecting tickets</a><li class="nav-list-item active"><a href="/docs/pentesting/active-directory/kerberos/kerberoasting.html" class="nav-list-link">Kerberoasting</a><li class="nav-list-item active"><a href="/docs/pentesting/active-directory/kerberos/keytab.html" class="nav-list-link">Keytab support and decrypting wireshark traffic</a><li class="nav-list-item active"><a href="/docs/pentesting/active-directory/kerberos/rbcd.html" class="nav-list-link">Resource-based constrained delegation (RBCD)</a><li class="nav-list-item active"><a href="/docs/pentesting/active-directory/kerberos/unconstrained_delegation.html" class="nav-list-link">Unconstrained delegation</a></ul></ul></ul><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/using-metasploit/" class="nav-list-link">Using Metasploit</a><ul class="nav-list"><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/using-metasploit/getting-started/" class="nav-list-link">Getting Started</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/using-metasploit/getting-started/nightly-installers.html" class="nav-list-link">Nightly Installers</a><li class="nav-list-item active"><a href="/docs/using-metasploit/getting-started/reporting-a-bug.html" class="nav-list-link">Reporting a Bug</a></ul><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/using-metasploit/basics/" class="nav-list-link">Basics</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/using-metasploit/basics/using-metasploit.html" class="nav-list-link">Running modules</a><li class="nav-list-item active"><a href="/docs/using-metasploit/basics/how-to-use-a-metasploit-module-appropriately.html" class="nav-list-link">How to use a Metasploit module appropriately</a><li class="nav-list-item active"><a href="/docs/using-metasploit/basics/how-payloads-work.html" class="nav-list-link">How payloads work</a><li class="nav-list-item active"><a href="/docs/using-metasploit/basics/module-documentation.html" class="nav-list-link">Module Documentation</a><li class="nav-list-item active"><a href="/docs/using-metasploit/basics/how-to-use-a-reverse-shell-in-metasploit.html" class="nav-list-link">How to use a reverse shell in Metasploit</a><li class="nav-list-item active"><a href="/docs/using-metasploit/basics/how-to-use-msfvenom.html" class="nav-list-link">How to use msfvenom</a><li class="nav-list-item active"><a href="/docs/using-metasploit/basics/managing-sessions.html" class="nav-list-link">Managing Sessions</a></ul><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/using-metasploit/intermediate/" class="nav-list-link">Intermediate</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/using-metasploit/intermediate/metasploit-database-support.html" class="nav-list-link">Database Support</a><li class="nav-list-item active"><a href="/docs/using-metasploit/intermediate/evading-anti-virus.html" class="nav-list-link">Evading Anti Virus</a><li class="nav-list-item active"><a href="/docs/using-metasploit/intermediate/exploit-ranking.html" class="nav-list-link">Exploit Ranking</a><li class="nav-list-item active"><a href="/docs/using-metasploit/intermediate/hashes-and-password-cracking.html" class="nav-list-link">Hashes and Password Cracking</a><li class="nav-list-item active"><a href="/docs/using-metasploit/intermediate/how-to-use-plugins.html" class="nav-list-link">Metasploit Plugins</a><li class="nav-list-item active"><a href="/docs/using-metasploit/intermediate/payload-uuid.html" class="nav-list-link">Payload UUID</a><li class="nav-list-item active"><a href="/docs/using-metasploit/intermediate/pivoting-in-metasploit.html" class="nav-list-link">Pivoting in Metasploit</a><li class="nav-list-item active"><a href="/docs/using-metasploit/intermediate/running-private-modules.html" class="nav-list-link">Running Private Modules</a></ul><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/using-metasploit/advanced/" class="nav-list-link">Advanced</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/using-metasploit/advanced/how-to-configure-dns.html" class="nav-list-link">How to Configure DNS</a><li class="nav-list-item active"><a href="/docs/using-metasploit/advanced/metasploit-web-service.html" class="nav-list-link">Metasploit Web Service</a><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/using-metasploit/advanced/meterpreter/" class="nav-list-link">Meterpreter</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/using-metasploit/advanced/meterpreter/meterpreter.html" class="nav-list-link">Overview</a><li class="nav-list-item active"><a href="/docs/using-metasploit/advanced/meterpreter/meterpreter-configuration.html" class="nav-list-link">Configuration</a><li class="nav-list-item active"><a href="/docs/using-metasploit/advanced/meterpreter/debugging-dead-meterpreter-sessions.html" class="nav-list-link">Debugging Dead Meterpreter Sessions</a><li class="nav-list-item active"><a href="/docs/using-metasploit/advanced/meterpreter/meterpreter-debugging-meterpreter-sessions.html" class="nav-list-link">Debugging Meterpreter Sessions</a><li class="nav-list-item active"><a href="/docs/using-metasploit/advanced/meterpreter/meterpreter-executebof-command.html" class="nav-list-link">ExecuteBof Command</a><li class="nav-list-item active"><a href="/docs/using-metasploit/advanced/meterpreter/meterpreter-http-communication.html" class="nav-list-link">HTTP Communication</a><li class="nav-list-item active"><a href="/docs/using-metasploit/advanced/meterpreter/how-to-get-started-with-writing-a-meterpreter-script.html" class="nav-list-link">How to get started with writing a Meterpreter script</a><li class="nav-list-item active"><a href="/docs/using-metasploit/advanced/meterpreter/meterpreter-paranoid-mode.html" class="nav-list-link">Paranoid Mode</a><li class="nav-list-item active"><a href="/docs/using-metasploit/advanced/meterpreter/powershell-extension.html" class="nav-list-link">Powershell Extension</a><li class="nav-list-item active"><a href="/docs/using-metasploit/advanced/meterpreter/python-extension.html" class="nav-list-link">Python Extension</a><li class="nav-list-item active"><a href="/docs/using-metasploit/advanced/meterpreter/meterpreter-reg-command.html" class="nav-list-link">Reg Command</a><li class="nav-list-item active"><a href="/docs/using-metasploit/advanced/meterpreter/meterpreter-reliable-network-communication.html" class="nav-list-link">Reliable Network Communication</a><li class="nav-list-item active"><a href="/docs/using-metasploit/advanced/meterpreter/meterpreter-sleep-control.html" class="nav-list-link">Sleep Control</a><li class="nav-list-item active"><a href="/docs/using-metasploit/advanced/meterpreter/meterpreter-stageless-mode.html" class="nav-list-link">Stageless Mode</a><li class="nav-list-item active"><a href="/docs/using-metasploit/advanced/meterpreter/the-ins-and-outs-of-http-and-https-communications-in-meterpreter-and-metasploit-stagers.html" class="nav-list-link">The ins and outs of HTTP and HTTPS communications in Meterpreter and Metasploit Stagers</a><li class="nav-list-item active"><a href="/docs/using-metasploit/advanced/meterpreter/meterpreter-timeout-control.html" class="nav-list-link">Timeout Control</a><li class="nav-list-item active"><a href="/docs/using-metasploit/advanced/meterpreter/meterpreter-transport-control.html" class="nav-list-link">Transport Control</a><li class="nav-list-item active"><a href="/docs/using-metasploit/advanced/meterpreter/meterpreter-unicode-support.html" class="nav-list-link">Unicode Support</a><li class="nav-list-item active"><a href="/docs/using-metasploit/advanced/meterpreter/meterpreter-wishlist.html" class="nav-list-link">Wishlist</a></ul><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/using-metasploit/advanced/RPC/" class="nav-list-link">RPC</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/using-metasploit/advanced/RPC/how-to-use-metasploit-json-rpc.html" class="nav-list-link">How to use Metasploit JSON RPC</a><li class="nav-list-item active"><a href="/docs/using-metasploit/advanced/RPC/how-to-use-metasploit-messagepack-rpc.html" class="nav-list-link">How to use Metasploit Messagepack RPC</a></ul></ul><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/using-metasploit/other/" class="nav-list-link">Other</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/using-metasploit/other/how-to-use-metasploit-with-ngrok.html" class="nav-list-link">How to use Metasploit with ngrok</a><li class="nav-list-item active"><a href="/docs/using-metasploit/other/how-to-use-the-favorite-command.html" class="nav-list-link">How to use the Favorite command</a><li class="nav-list-item active"><a href="/docs/using-metasploit/other/information-about-unmet-browser-exploit-requirements.html" class="nav-list-link">Information About Unmet Browser Exploit Requirements</a><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/using-metasploit/other/oracle-support/" class="nav-list-link">Oracle Support</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/using-metasploit/other/oracle-support/how-to-get-oracle-support-working-with-kali-linux.html" class="nav-list-link">How to get Oracle Support working with Kali Linux</a><li class="nav-list-item active"><a href="/docs/using-metasploit/other/oracle-support/oracle-usage.html" class="nav-list-link">Oracle Usage</a></ul><li class="nav-list-item active"><a href="/docs/using-metasploit/other/why-cve-is-not-available.html" class="nav-list-link">Why CVE is not available</a></ul></ul><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/development/" class="nav-list-link">Development</a><ul class="nav-list"><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/development/get-started/" class="nav-list-link">Get Started</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/development/get-started/contributing-to-metasploit.html" class="nav-list-link">Contributing to Metasploit</a><li class="nav-list-item active"><a href="/docs/development/get-started/creating-your-first-pr.html" class="nav-list-link">Creating Your First PR</a><li class="nav-list-item active"><a href="/docs/development/get-started/setting-up-a-metasploit-development-environment.html" class="nav-list-link">Setting Up a Metasploit Development Environment</a><li class="nav-list-item active"><a href="/docs/development/get-started/sanitizing-pcaps.html" class="nav-list-link">Sanitizing PCAPs</a><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/development/get-started/git/" class="nav-list-link">Git</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/development/get-started/git/git-reference-sites.html" class="nav-list-link">Git Reference Sites</a><li class="nav-list-item active"><a href="/docs/development/get-started/git/git-cheatsheet.html" class="nav-list-link">Git cheatsheet</a><li class="nav-list-item active"><a href="/docs/development/get-started/git/keeping-in-sync-with-rapid7-master.html" class="nav-list-link">Keeping in sync with rapid7 master</a><li class="nav-list-item active"><a href="/docs/development/get-started/git/remote-branch-pruning.html" class="nav-list-link">Remote Branch Pruning</a><li class="nav-list-item active"><a href="/docs/development/get-started/git/using-git.html" class="nav-list-link">Using Git</a></ul><li class="nav-list-item active"><a href="/docs/development/get-started/navigating-and-understanding-metasploits-codebase.html" class="nav-list-link">Navigating the codebase</a></ul><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/development/developing-modules/" class="nav-list-link">Developing Modules</a><ul class="nav-list"><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/development/developing-modules/guides/" class="nav-list-link">Guides</a><ul class="nav-list"><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/development/developing-modules/guides/scanners/" class="nav-list-link">Scanners</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/development/developing-modules/guides/scanners/how-to-write-a-http-loginscanner-module.html" class="nav-list-link">Writing a HTTP LoginScanner</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/guides/scanners/creating-metasploit-framework-loginscanners.html" class="nav-list-link">Writing an FTP LoginScanner</a></ul><li class="nav-list-item active"><a href="/docs/development/developing-modules/guides/how-to-check-microsoft-patch-levels-for-your-exploit.html" class="nav-list-link">How to check Microsoft patch levels for your exploit</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/guides/how-to-use-fetch-payloads.html" class="nav-list-link">How to use Fetch Payloads</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/guides/how-to-use-command-stagers.html" class="nav-list-link">How to use command stagers</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/guides/how-to-write-a-check-method.html" class="nav-list-link">How to write a check method</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/guides/how-to-write-a-cmd-injection-module.html" class="nav-list-link">How to write a cmd injection module</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/guides/how-to-write-a-browser-exploit-using-httpserver.html" class="nav-list-link">Writing a browser exploit</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/guides/how-to-get-started-with-writing-a-post-module.html" class="nav-list-link">Writing a post module</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/guides/how-to-get-started-with-writing-an-auxiliary-module.html" class="nav-list-link">Writing an auxiliary module</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/guides/get-started-writing-an-exploit.html" class="nav-list-link">Writing an exploit</a></ul><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/development/developing-modules/external-modules/" class="nav-list-link">External Modules</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/development/developing-modules/external-modules/writing-external-metasploit-modules.html" class="nav-list-link">Overview</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/external-modules/writing-external-golang-modules.html" class="nav-list-link">Writing GoLang Modules</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/external-modules/writing-external-python-modules.html" class="nav-list-link">Writing Python Modules</a></ul><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/development/developing-modules/module-metadata/" class="nav-list-link">Module metadata</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/development/developing-modules/module-metadata/definition-of-module-reliability-side-effects-and-stability.html" class="nav-list-link">Definition of Module Reliability Side Effects and Stability</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/module-metadata/how-to-use-datastore-options.html" class="nav-list-link">How to use datastore options</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/module-metadata/module-reference-identifiers.html" class="nav-list-link">Module Reference Identifiers</a></ul><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/development/developing-modules/libraries/" class="nav-list-link">Libraries</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/api.html" class="nav-list-link">API</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/how-to-use-msf-auxiliary-authbrute-to-write-a-bruteforcer.html" class="nav-list-link">AuthBrute</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/how-to-cleanup-after-module-execution.html" class="nav-list-link">Cleanup</a><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/development/developing-modules/libraries/c/" class="nav-list-link">Compiling C</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/c/how-to-use-metasploit-framework-compiler-windows-to-compile-c-code.html" class="nav-list-link">Overview</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/c/how-to-decode-base64-with-metasploit-framework-compiler.html" class="nav-list-link">Base64 Support</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/c/how-to-decrypt-rc4-with-metasploit-framework-compiler.html" class="nav-list-link">RC4 Support</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/c/how-to-xor-with-metasploit-framework-compiler.html" class="nav-list-link">XOR Support</a></ul><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/development/developing-modules/libraries/deserialization/" class="nav-list-link">Deserialization</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/deserialization/dot-net-deserialization.html" class="nav-list-link">Dot Net Deserialization</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/deserialization/generating-ysoserial-java-serialized-objects.html" class="nav-list-link">Java Deserialization</a></ul><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/handling-module-failures-with-fail_with.html" class="nav-list-link">Fail_with</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/how-to-use-the-fileformat-mixin-to-create-a-file-format-exploit.html" class="nav-list-link">Fileformat</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/how-to-use-the-git-mixin-to-write-an-exploit-module.html" class="nav-list-link">Git Mixin</a><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/development/developing-modules/libraries/http/" class="nav-list-link">HTTP</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/http/how-to-write-a-browser-exploit-using-browserexploitserver.html" class="nav-list-link">BrowserExploitServer</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/http/how-to-send-an-http-request-using-httpclient.html" class="nav-list-link">How to Send an HTTP Request Using HttpClient</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/http/how-to-parse-an-http-response.html" class="nav-list-link">How to parse an HTTP response</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/http/how-to-send-an-http-request-using-rex-proto-http-client.html" class="nav-list-link">How to send an HTTP request using Rex Proto Http Client</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/http/how-to-write-a-module-using-httpserver-and-httpclient.html" class="nav-list-link">How to write a module using HttpServer and HttpClient</a></ul><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/how-to-log-in-metasploit.html" class="nav-list-link">Logging</a><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/development/developing-modules/libraries/obfuscation/" class="nav-list-link">Obfuscation</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/obfuscation/how-to-use-metasploit-framework-obfuscation-crandomizer.html" class="nav-list-link">C Obfuscation</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/obfuscation/how-to-obfuscate-javascript-in-metasploit.html" class="nav-list-link">JavaScript Obfuscation</a></ul><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/how-to-use-phpexe-to-exploit-an-arbitrary-file-upload-bug.html" class="nav-list-link">PhpExe</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/how-to-use-powershell-in-an-exploit.html" class="nav-list-link">Powershell</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/how-to-use-railgun-for-windows-post-exploitation.html" class="nav-list-link">Railgun</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/using-reflectivedll-injection.html" class="nav-list-link">ReflectiveDLL Injection</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/how-to-do-reporting-or-store-data-in-module-development.html" class="nav-list-link">Reporting and Storing Data</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/how-to-use-the-seh-mixin-to-exploit-an-exception-handler.html" class="nav-list-link">SEH Exploitation</a><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/development/developing-modules/libraries/smb_library/" class="nav-list-link">SMB Library</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/smb_library/guidelines-for-writing-modules-with-smb.html" class="nav-list-link">Guidelines for Writing Modules with SMB</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/smb_library/what-my-rex-proto-smb-error-means.html" class="nav-list-link">What my Rex Proto SMB Error means</a></ul><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/sql-injection-libraries.html" class="nav-list-link">SQL Injection</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/how-to-use-the-msf-exploit-remote-tcp-mixin.html" class="nav-list-link">TCP</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/how-to-use-wbemexec-for-a-write-privilege-attack-on-windows.html" class="nav-list-link">WbemExec</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/how-to-zip-files-with-msf-util-exe-to_zip.html" class="nav-list-link">Zip</a></ul></ul><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/development/google-summer-of-code/" class="nav-list-link">Google Summer of Code</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/development/google-summer-of-code/gsoc-2017-mentor-organization-application.html" class="nav-list-link">2017 Mentor Organization Application</a><li class="nav-list-item active"><a href="/docs/development/google-summer-of-code/gsoc-2017-project-ideas.html" class="nav-list-link">2017 Project Ideas</a><li class="nav-list-item active"><a href="/docs/development/google-summer-of-code/gsoc-2017-student-proposal.html" class="nav-list-link">2017 Student Proposal</a><li class="nav-list-item active"><a href="/docs/development/google-summer-of-code/gsoc-2018-project-ideas.html" class="nav-list-link">2018 Project Ideas</a><li class="nav-list-item active"><a href="/docs/development/google-summer-of-code/gsoc-2019-project-ideas.html" class="nav-list-link">2019 Project Ideas</a><li class="nav-list-item active"><a href="/docs/development/google-summer-of-code/gsoc-2020-project-ideas.html" class="nav-list-link">2020 Project Ideas</a><li class="nav-list-item active"><a href="/docs/development/google-summer-of-code/gsoc-2021-project-ideas.html" class="nav-list-link">2021 Project Ideas</a><li class="nav-list-item active"><a href="/docs/development/google-summer-of-code/gsoc-2022-project-ideas.html" class="nav-list-link">2022 Project Ideas</a><li class="nav-list-item active"><a href="/docs/development/google-summer-of-code/gsoc-2023-project-ideas.html" class="nav-list-link">2023 Project Ideas</a><li class="nav-list-item active"><a href="/docs/development/google-summer-of-code/how-to-apply-to-gsoc.html" class="nav-list-link">How to Apply to GSoC</a></ul><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/development/maintainers/" class="nav-list-link">Maintainers</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/development/maintainers/committer-keys.html" class="nav-list-link">Committer Keys</a><li class="nav-list-item active"><a href="/docs/development/maintainers/committer-rights.html" class="nav-list-link">Committer Rights</a><li class="nav-list-item active"><a href="/docs/development/maintainers/downloads-by-version.html" class="nav-list-link">Downloads by Version</a><li class="nav-list-item active"><a href="/docs/development/maintainers/metasploit-hackathons.html" class="nav-list-link">Metasploit Hackathons</a><li class="nav-list-item active"><a href="/docs/development/maintainers/metasploit-loginpalooza.html" class="nav-list-link">Metasploit Loginpalooza</a><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/development/maintainers/process/" class="nav-list-link">Process</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/development/maintainers/process/assigning-labels.html" class="nav-list-link">Assigning Labels</a><li class="nav-list-item active"><a href="/docs/development/maintainers/process/guidelines-for-accepting-modules-and-enhancements.html" class="nav-list-link">Guidelines for Accepting Modules and Enhancements</a><li class="nav-list-item active"><a href="/docs/development/maintainers/process/how-to-deprecate-a-metasploit-module.html" class="nav-list-link">How to deprecate a Metasploit module</a><li class="nav-list-item active"><a href="/docs/development/maintainers/process/landing-pull-requests.html" class="nav-list-link">Landing Pull Requests</a><li class="nav-list-item active"><a href="/docs/development/maintainers/process/adding-release-notes-to-prs.html" class="nav-list-link">Release Notes</a><li class="nav-list-item active"><a href="/docs/development/maintainers/process/rolling-back-merges.html" class="nav-list-link">Rolling back merges</a><li class="nav-list-item active"><a href="/docs/development/maintainers/process/unstable-modules.html" class="nav-list-link">Unstable Modules</a></ul><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/development/maintainers/ruby-gems/" class="nav-list-link">Ruby Gems</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/development/maintainers/ruby-gems/how-to-add-and-update-gems-in-metasploit-framework.html" class="nav-list-link">Adding and Updating</a><li class="nav-list-item active"><a href="/docs/development/maintainers/ruby-gems/merging-metasploit-payload-gem-updates.html" class="nav-list-link">Merging Metasploit Payload Gem Updates</a><li class="nav-list-item active"><a href="/docs/development/maintainers/ruby-gems/using-local-gems.html" class="nav-list-link">Using local Gems</a></ul></ul><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/development/propsals/" class="nav-list-link">Proposals</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/development/propsals/bundled-modules-proposal.html" class="nav-list-link">Bundled Modules Proposal</a><li class="nav-list-item active"><a href="/docs/development/propsals/java-meterpreter-feature-parity-proposal.html" class="nav-list-link">Java Meterpreter Feature Parity Proposal</a><li class="nav-list-item active"><a href="/docs/development/propsals/msf6-feature-proposals.html" class="nav-list-link">MSF6 Feature Proposals</a><li class="nav-list-item active"><a href="/docs/development/propsals/metasploit-url-support-proposal.html" class="nav-list-link">Metasploit URL support proposal</a><li class="nav-list-item active"><a href="/docs/development/propsals/payload-rename-justification.html" class="nav-list-link">Payload Rename Justification</a><li class="nav-list-item active"><a href="/docs/development/propsals/uberhandler.html" class="nav-list-link">Uberhandler</a><li class="nav-list-item active"><a href="/docs/development/propsals/work-needed-to-allow-msfdb-to-use-postgresql-common.html" class="nav-list-link">Work needed to allow msfdb to use postgresql common</a></ul><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/development/quality/" class="nav-list-link">Quality</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/development/quality/common-metasploit-module-coding-mistakes.html" class="nav-list-link">Common Metasploit Module Coding Mistakes</a><li class="nav-list-item active"><a href="/docs/development/quality/loading-test-modules.html" class="nav-list-link">Loading Test Modules</a><li class="nav-list-item active"><a href="/docs/development/quality/measuring-metasploit-performance.html" class="nav-list-link">Measuring Metasploit Performance</a><li class="nav-list-item active"><a href="/docs/development/quality/msftidy.html" class="nav-list-link">Msftidy</a><li class="nav-list-item active"><a href="/docs/development/quality/payload-testing.html" class="nav-list-link">Payload Testing</a><li class="nav-list-item active"><a href="/docs/development/quality/style-tips.html" class="nav-list-link">Style Tips</a><li class="nav-list-item active"><a href="/docs/development/quality/using-rubocop.html" class="nav-list-link">Using Rubocop</a><li class="nav-list-item active"><a href="/docs/development/quality/writing-module-documentation.html" class="nav-list-link">Writing Module Documentation</a></ul><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/development/roadmap/" class="nav-list-link">Roadmap</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/development/roadmap/2017-roadmap.html" class="nav-list-link">2017 Roadmap</a><li class="nav-list-item active"><a href="/docs/development/roadmap/2017-roadmap-review.html" class="nav-list-link">2017 Roadmap Review</a><li class="nav-list-item active"><a href="/docs/development/roadmap/metasploit-breaking-changes.html" class="nav-list-link">Metasploit Breaking Changes</a><li class="nav-list-item active"><a href="/docs/development/roadmap/metasploit-data-service-enhancements-goliath.html" class="nav-list-link">Metasploit Data Service</a><li class="nav-list-item active"><a href="/docs/development/roadmap/metasploit-5-release-notes.html" class="nav-list-link">Metasploit Framework 5.0 Release Notes</a><li class="nav-list-item active"><a href="/docs/development/roadmap/metasploit-6-release-notes.html" class="nav-list-link">Metasploit Framework 6.0 Release Notes</a><li class="nav-list-item active"><a href="/docs/development/roadmap/metasploit-framework-wish-list.html" class="nav-list-link">Metasploit Framework Wish List</a></ul></ul><li class="nav-list-item active"><a href="/docs/contact.html" class="nav-list-link">Contact</a></ul></nav><footer class="site-footer"> This site uses <a href="https://github.com/pmarsceill/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll.</footer></div><div class="main" id="top"><div id="main-header" class="main-header"><div class="search"><div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search Metasploit Documentation" aria-label="Search Metasploit Documentation" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label></div><div id="search-results" class="search-results"></div></div><link rel="stylesheet" href="/assets/css/main.css"><nav aria-label="Auxiliary" class="aux-nav"><ul class="aux-nav-list"><li class="aux-nav-list-item"> <a href="//github.com/rapid7/metasploit-framework" class="site-button" target="_blank" rel="noopener noreferrer" > Metasploit Framework on GitHub </a></ul></nav></div><div id="main-content-wrap" class="main-content-wrap"><nav aria-label="Breadcrumb" class="breadcrumb-nav"><ol class="breadcrumb-nav-list"><li class="breadcrumb-nav-list-item"> <a href="/docs/pentesting/">Pentesting</a><li class="breadcrumb-nav-list-item"> <a href="/docs/pentesting/active-directory/">Active Directory</a><li class="breadcrumb-nav-list-item"> <a href="/docs/pentesting/active-directory/ad-certificates/">AD CS</a><li class="breadcrumb-nav-list-item"> <span>Vulnerable cert finder</span></ol></nav><div id="main-content" class="main-content" role="main"><h2 id="vulnerable-application"> <a href="#vulnerable-application" class="anchor-heading" aria-labelledby="vulnerable-application"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Vulnerable Application</h2><p>The <code class="language-plaintext highlighter-rouge">auxiliary/gather/ldap_esc_vulnerable_cert_finder</code> module allows users to query a LDAP server for vulnerable certificate templates and will print these certificates out in a table along with which attack they are vulnerable to and the SIDs that can be used to enroll in that certificate template.</p><p>Additionally the module will also print out a list of known certificate servers along with info about which vulnerable certificate templates the certificate server allows enrollment in and which SIDs are authorized to use that certificate server to perform this enrollment operation.</p><p>Currently the module is capable of checking for certificates that are vulnerable to ESC1, ESC2, ESC3, ESC13, and ESC15. The module is limited to checking for these techniques due to them being identifiable remotely from a normal user account by analyzing the objects in LDAP.</p><h3 id="installing-ad-cs"> <a href="#installing-ad-cs" class="anchor-heading" aria-labelledby="installing-ad-cs"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Installing AD CS</h3><ol><li>Install AD CS on either a new or existing domain controller<li>Open the Server Manager<li>Select Add roles and features<li>Select “Active Directory Certificate Services” under the “Server Roles” section<li>When prompted add all of the features and management tools<li>On the AD CS “Role Services” tab, leave the default selection of only “Certificate Authority”<li>Completion the installation and reboot the server<li>Reopen the Server Manager<li>Go to the AD CS tab and where it says “Configuration Required”, hit “More” then “Configure Active Directory Certificate…”<li>Select “Certificate Authority” in the Role Services tab<li>Keep all of the default settings, noting the “Common name for this CA” value on the “CA Name” tab.<li>Accept the rest of the default settings and complete the configuration</ol><h3 id="setting-up-a-esc1-vulnerable-certificate-template"> <a href="#setting-up-a-esc1-vulnerable-certificate-template" class="anchor-heading" aria-labelledby="setting-up-a-esc1-vulnerable-certificate-template"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Setting up a ESC1 Vulnerable Certificate Template</h3><ol><li>Open up the run prompt and type in <code class="language-plaintext highlighter-rouge">certsrv</code>.<li>In the window that appears you should see your list of certification authorities under <code class="language-plaintext highlighter-rouge">Certification Authority (Local)</code>.<li>Right click on the folder in the drop down marked <code class="language-plaintext highlighter-rouge">Certificate Templates</code> and then click <code class="language-plaintext highlighter-rouge">Manage</code>.<li>Scroll down to the <code class="language-plaintext highlighter-rouge">User</code> certificate. Right click on it and select <code class="language-plaintext highlighter-rouge">Duplicate Template</code>.<li>From here you can refer to https://github.com/RayRRT/Active-Directory-Certificate-Services-abuse/blob/3da1d59f1b66dd0e381b2371b8fb42d87e2c9f82/ADCS.md for screenshots.<li>Select the <code class="language-plaintext highlighter-rouge">General</code> tab and rename this to something meaningful like <code class="language-plaintext highlighter-rouge">ESC1-Template</code>, then click the <code class="language-plaintext highlighter-rouge">Apply</code> button.<li>In the <code class="language-plaintext highlighter-rouge">Subject Name</code> tab, select <code class="language-plaintext highlighter-rouge">Supply in the request</code> and click <code class="language-plaintext highlighter-rouge">Ok</code> on the security warning that appears.<li>Click the <code class="language-plaintext highlighter-rouge">Apply</code> button.<li>Scroll to the <code class="language-plaintext highlighter-rouge">Extensions</code> tab.<li>Under <code class="language-plaintext highlighter-rouge">Application Policies</code> ensure that <code class="language-plaintext highlighter-rouge">Client Authentication</code>, <code class="language-plaintext highlighter-rouge">Server Authentication</code>, <code class="language-plaintext highlighter-rouge">KDC Authentication</code>, or <code class="language-plaintext highlighter-rouge">Smart Card Logon</code> is listed.<li>Click the <code class="language-plaintext highlighter-rouge">Apply</code> button.<li>Under the <code class="language-plaintext highlighter-rouge">Security</code> tab make sure that <code class="language-plaintext highlighter-rouge">Domain Users</code> group listed and the <code class="language-plaintext highlighter-rouge">Enroll</code> permissions is marked as allowed for this group.<li>Under <code class="language-plaintext highlighter-rouge">Issuance Requirements</code> tab, ensure that under <code class="language-plaintext highlighter-rouge">Require the following for enrollment</code> that the <code class="language-plaintext highlighter-rouge">CA certificate manager approval</code> box is unticked, as is the <code class="language-plaintext highlighter-rouge">This number of authorized signatures</code> box.<li>Click <code class="language-plaintext highlighter-rouge">Apply</code> and then <code class="language-plaintext highlighter-rouge">Ok</code><li>Go back to the <code class="language-plaintext highlighter-rouge">certsrv</code> screen and right click on the <code class="language-plaintext highlighter-rouge">Certificate Templates</code> folder. Then click <code class="language-plaintext highlighter-rouge">New</code> followed by <code class="language-plaintext highlighter-rouge">Certificate Template to Issue</code>.<li>Scroll down and select the <code class="language-plaintext highlighter-rouge">ESC1-Template</code> certificate, or whatever you named the ESC1 template you created, and select <code class="language-plaintext highlighter-rouge">OK</code>. The certificate should now be available to be issued by the CA server.</ol><h3 id="setting-up-a-esc2-vulnerable-certificate-template"> <a href="#setting-up-a-esc2-vulnerable-certificate-template" class="anchor-heading" aria-labelledby="setting-up-a-esc2-vulnerable-certificate-template"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Setting up a ESC2 Vulnerable Certificate Template</h3><ol><li>Open up <code class="language-plaintext highlighter-rouge">certsrv</code><li>Scroll down to <code class="language-plaintext highlighter-rouge">Certificate Templates</code> folder, right click on it and select <code class="language-plaintext highlighter-rouge">Manage</code>.<li>Find the <code class="language-plaintext highlighter-rouge">ESC1</code> certificate template you created earlier and right click on that, then select <code class="language-plaintext highlighter-rouge">Duplicate Template</code>.<li>Select the <code class="language-plaintext highlighter-rouge">General</code> tab, and then name the template <code class="language-plaintext highlighter-rouge">ESC2-Template</code>. Then click <code class="language-plaintext highlighter-rouge">Apply</code>.<li>Go to the <code class="language-plaintext highlighter-rouge">Subject Name</code> tab and select <code class="language-plaintext highlighter-rouge">Build from this Active Directory Information</code> and select <code class="language-plaintext highlighter-rouge">Fully distinguished name</code> under the <code class="language-plaintext highlighter-rouge">Subject Name Format</code>. The main idea of setting this option is to prevent being able to supply the subject name in the request as this is more what makes the certificate vulnerable to ESC1. The specific options here I don’t think will matter so much so long as the <code class="language-plaintext highlighter-rouge">Supply in the request</code> option isn’t ticked. Then click <code class="language-plaintext highlighter-rouge">Apply</code>.<li>Go the to <code class="language-plaintext highlighter-rouge">Extensions</code> tab and click on <code class="language-plaintext highlighter-rouge">Application Policies</code>. Then click on <code class="language-plaintext highlighter-rouge">Edit</code>.<li>Delete all the existing application policies by clicking on them one by one and clicking the <code class="language-plaintext highlighter-rouge">Remove</code> button.<li>Click the <code class="language-plaintext highlighter-rouge">Add</code> button and select <code class="language-plaintext highlighter-rouge">Any Purpose</code> from the list that appears. Then click the <code class="language-plaintext highlighter-rouge">OK</code> button.<li>Click the <code class="language-plaintext highlighter-rouge">Apply</code> button, and then <code class="language-plaintext highlighter-rouge">OK</code>. The certificate should now be created.<li>Go back to the <code class="language-plaintext highlighter-rouge">certsrv</code> screen and right click on the <code class="language-plaintext highlighter-rouge">Certificate Templates</code> folder. Then click <code class="language-plaintext highlighter-rouge">New</code> followed by <code class="language-plaintext highlighter-rouge">Certificate Template to Issue</code>.<li>Scroll down and select the <code class="language-plaintext highlighter-rouge">ESC2-Template</code> certificate, or whatever you named the ESC2 template you created, and select <code class="language-plaintext highlighter-rouge">OK</code>. The certificate should now be available to be issued by the CA server.</ol><h3 id="setting-up-a-esc3-template-1-vulnerable-certificate-template"> <a href="#setting-up-a-esc3-template-1-vulnerable-certificate-template" class="anchor-heading" aria-labelledby="setting-up-a-esc3-template-1-vulnerable-certificate-template"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Setting up a ESC3 Template 1 Vulnerable Certificate Template</h3><ol><li>Follow the instructions above to duplicate the ESC2 template and name it <code class="language-plaintext highlighter-rouge">ESC3-Template1</code>, then click <code class="language-plaintext highlighter-rouge">Apply</code>.<li>Go to the <code class="language-plaintext highlighter-rouge">Extensions</code> tab, click the Application Policies entry, click the <code class="language-plaintext highlighter-rouge">Edit</code> button, and remove the <code class="language-plaintext highlighter-rouge">Any Purpose</code> policy and replace it with <code class="language-plaintext highlighter-rouge">Certificate Request Agent</code>, then click <code class="language-plaintext highlighter-rouge">OK</code>.<li>Click <code class="language-plaintext highlighter-rouge">Apply</code>.<li>Go to <code class="language-plaintext highlighter-rouge">Issuance Requirements</code> tab and double check that both <code class="language-plaintext highlighter-rouge">CA certificate manager approval</code> and <code class="language-plaintext highlighter-rouge">This number of authorized signatures</code> are unchecked.<li>Click <code class="language-plaintext highlighter-rouge">Apply</code> if any changes were made or the button is not grey’d out, then click <code class="language-plaintext highlighter-rouge">OK</code> to create the certificate.<li>Go back to the <code class="language-plaintext highlighter-rouge">certsrv</code> screen and right click on the <code class="language-plaintext highlighter-rouge">Certificate Templates</code> folder. Then click <code class="language-plaintext highlighter-rouge">New</code> followed by <code class="language-plaintext highlighter-rouge">Certificate Template to Issue</code>.<li>Scroll down and select the <code class="language-plaintext highlighter-rouge">ESC3-Template1</code> certificate, or whatever you named the ESC3 template number 1 template you just created, and select <code class="language-plaintext highlighter-rouge">OK</code>. The certificate should now be available to be issued by the CA server.</ol><h3 id="setting-up-a-esc3-template-2-vulnerable-certificate-template"> <a href="#setting-up-a-esc3-template-2-vulnerable-certificate-template" class="anchor-heading" aria-labelledby="setting-up-a-esc3-template-2-vulnerable-certificate-template"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Setting up a ESC3 Template 2 Vulnerable Certificate Template</h3><ol><li>Follow the instructions above to duplicate the ESC2 template and name it <code class="language-plaintext highlighter-rouge">ESC3-Template2</code>, then click <code class="language-plaintext highlighter-rouge">Apply</code>.<li>Go to the <code class="language-plaintext highlighter-rouge">Extensions</code> tab, click the Application Policies entry, click the <code class="language-plaintext highlighter-rouge">Edit</code> button, and remove the <code class="language-plaintext highlighter-rouge">Any Purpose</code> policy and replace it with <code class="language-plaintext highlighter-rouge">Client Authentication</code>, then click <code class="language-plaintext highlighter-rouge">OK</code>.<li>Click <code class="language-plaintext highlighter-rouge">Apply</code>.<li>Go to <code class="language-plaintext highlighter-rouge">Issuance Requirements</code> tab and double check that both <code class="language-plaintext highlighter-rouge">CA certificate manager approval</code> is unchecked.<li>Check the <code class="language-plaintext highlighter-rouge">This number of authorized signatures</code> checkbox and ensure the value specified is 1, and that the <code class="language-plaintext highlighter-rouge">Policy type required in signature</code> is set to <code class="language-plaintext highlighter-rouge">Application Policy</code>, and that the <code class="language-plaintext highlighter-rouge">Application policy</code> value is <code class="language-plaintext highlighter-rouge">Certificate Request Agent</code>.<li>Click <code class="language-plaintext highlighter-rouge">Apply</code> and then click <code class="language-plaintext highlighter-rouge">OK</code> to issue the certificate.<li>Go back to the <code class="language-plaintext highlighter-rouge">certsrv</code> screen and right click on the <code class="language-plaintext highlighter-rouge">Certificate Templates</code> folder.<li>Click <code class="language-plaintext highlighter-rouge">New</code> followed by <code class="language-plaintext highlighter-rouge">Certificate Template to Issue</code>.<li>Scroll down and select the <code class="language-plaintext highlighter-rouge">ESC3-Template2</code> certificate, and select <code class="language-plaintext highlighter-rouge">OK</code>.<li>The certificate should now be available to be issued by the CA server.</ol><h3 id="setting-up-a-esc4-vulnerable-certificate-template"> <a href="#setting-up-a-esc4-vulnerable-certificate-template" class="anchor-heading" aria-labelledby="setting-up-a-esc4-vulnerable-certificate-template"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Setting up a ESC4 Vulnerable Certificate Template</h3><ol><li>Follow the instructions above to duplicate the ESC2 template and name it <code class="language-plaintext highlighter-rouge">ESC4-Template</code>, then click <code class="language-plaintext highlighter-rouge">Apply</code>.<li>Go to the <code class="language-plaintext highlighter-rouge">Security</code> tab.<li>Under <code class="language-plaintext highlighter-rouge">Groups or usernames</code> select <code class="language-plaintext highlighter-rouge">Authenticated Users</code><li>Under <code class="language-plaintext highlighter-rouge">Permissions for Authenticated Users</code> select <code class="language-plaintext highlighter-rouge">Write</code> -&gt; <code class="language-plaintext highlighter-rouge">Allow</code>.<li>Click <code class="language-plaintext highlighter-rouge">Apply</code> and then click <code class="language-plaintext highlighter-rouge">OK</code> to issue the certificate.<li>Go back to the <code class="language-plaintext highlighter-rouge">certsrv</code> screen and right click on the <code class="language-plaintext highlighter-rouge">Certificate Templates</code> folder.<li>Click <code class="language-plaintext highlighter-rouge">New</code> followed by <code class="language-plaintext highlighter-rouge">Certificate Template to Issue</code>.<li>Scroll down and select the <code class="language-plaintext highlighter-rouge">ESC3-Template2</code> certificate, and select <code class="language-plaintext highlighter-rouge">OK</code>.<li>The certificate should now be available to be issued by the CA server.</ol><h3 id="setting-up-a-esc8-vulnerable-host"> <a href="#setting-up-a-esc8-vulnerable-host" class="anchor-heading" aria-labelledby="setting-up-a-esc8-vulnerable-host"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Setting up a ESC8 Vulnerable Host</h3><ol><li>Follow instructions for creating an AD CS enabled server<li>Select Add Roles and Features<li>Under “Select Server Roles” expand Active Directory Certificate Services and add <code class="language-plaintext highlighter-rouge">Certificate Enrollment Policy Web Service</code>, <code class="language-plaintext highlighter-rouge">Certificate Enrollment Web Service</code>, and <code class="language-plaintext highlighter-rouge">Certificate Authority Web Enrollment</code>.<li>For each selection, accept the default for any pop-up.<li>Accept the default features and install.<li>When the installation is complete, click on the warning in the Dashboard for post-deployment configuration.<li>Under Credentials, accept the default<li>Under Role Services, select <code class="language-plaintext highlighter-rouge">Certificate Authority Web Enrollment</code>, <code class="language-plaintext highlighter-rouge">Certificate Enrollment Web Service</code>, and <code class="language-plaintext highlighter-rouge">Certificate Enrollment Policy Web Service</code><li>In CA for CES, accept the defaults<li>In Authentication Types, accept the default integrated authentication<li>In Service account for CES, select <code class="language-plaintext highlighter-rouge">Use built-in application pool identity</code><li>Accept default integrated authentication for CEP<li>Select the domain certificate in Server Certificate (the one that starts with the domain name by default) if more than one appears.<li>Accept the remaining defaults.</ol><h3 id="setting-up-a-esc9-vulnerable-certificate-template"> <a href="#setting-up-a-esc9-vulnerable-certificate-template" class="anchor-heading" aria-labelledby="setting-up-a-esc9-vulnerable-certificate-template"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Setting up a ESC9 Vulnerable Certificate Template</h3><ol><li>Open up the run prompt and type in <code class="language-plaintext highlighter-rouge">certsrv</code>.<li>In the window that appears you should see your list of certification authorities under <code class="language-plaintext highlighter-rouge">Certification Authority (Local)</code>.<li>Right click on the folder in the drop down marked <code class="language-plaintext highlighter-rouge">Certificate Templates</code> and then click <code class="language-plaintext highlighter-rouge">Manage</code>.<li>Scroll down to the <code class="language-plaintext highlighter-rouge">User</code> certificate. Right click on it and select <code class="language-plaintext highlighter-rouge">Duplicate Template</code>.<li>The <code class="language-plaintext highlighter-rouge">User</code> certificate already has the <code class="language-plaintext highlighter-rouge">Client Authentication</code> EKU enabled so we can use this as a base template.<li>Select the Subject Name tab and select <code class="language-plaintext highlighter-rouge">Build from this Active Directory Information</code>, under the <code class="language-plaintext highlighter-rouge">Subject Name Format</code> section select <code class="language-plaintext highlighter-rouge">User Principal Name (UPN)</code> (or <code class="language-plaintext highlighter-rouge">DNS Name</code> depending on what scenario you’re attempting to exploit).<li>Under the <code class="language-plaintext highlighter-rouge">Subject Name Format</code> also be sure to unselect <code class="language-plaintext highlighter-rouge">Include e-mail name in subject name</code> and <code class="language-plaintext highlighter-rouge">E-mail name</code>.<li>Select the <code class="language-plaintext highlighter-rouge">General</code> tab and rename this to something meaningful like <code class="language-plaintext highlighter-rouge">ESC9-Template</code>, then click the <code class="language-plaintext highlighter-rouge">Apply</code> button.<li>Select the Security tab and click the <code class="language-plaintext highlighter-rouge">Add</code> button.<li>Enter <code class="language-plaintext highlighter-rouge">user2</code> (or whatever user’s UPN you will be changing for this attack). Click OK.<li>Under Permissions for <code class="language-plaintext highlighter-rouge">user2</code> select <code class="language-plaintext highlighter-rouge">Allow</code> for <code class="language-plaintext highlighter-rouge">Enroll</code> and <code class="language-plaintext highlighter-rouge">Read</code>.<li>Click <code class="language-plaintext highlighter-rouge">Apply</code> and then <code class="language-plaintext highlighter-rouge">OK</code>.<li>Open Active Directory Users and Computers, expand the domain on the left hand side.<li>Enable advanced features to access the security tab by checking “View” &gt; “Advanced Features”<li>Right click <code class="language-plaintext highlighter-rouge">Users</code> and navigate <code class="language-plaintext highlighter-rouge">user2</code> and select <code class="language-plaintext highlighter-rouge">Properties</code>.<li>In the security tab, select <code class="language-plaintext highlighter-rouge">Add</code> and enter <code class="language-plaintext highlighter-rouge">user1</code> (or whatever user you will be using to perform the attack). Click OK.<li>Under Permissions for <code class="language-plaintext highlighter-rouge">user1</code> select <code class="language-plaintext highlighter-rouge">Allow</code> for <code class="language-plaintext highlighter-rouge">Read</code> and <code class="language-plaintext highlighter-rouge">Write</code> (or select <code class="language-plaintext highlighter-rouge">Allow</code> for <code class="language-plaintext highlighter-rouge">Full Control</code>).<li>Open a Powershell prompt as Administrator and run the following (change <code class="language-plaintext highlighter-rouge">kerberos.issue</code> to your domain name):<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$template</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">ADSI</span><span class="p">]</span><span class="s2">"LDAP://CN=ESC9-Template,CN=Certificate Templates,CN=Public Key Services,CN=Services,CN=Configuration,DC=kerberos,DC=issue"</span><span class="w">
</span><span class="nv">$template</span><span class="o">.</span><span class="nf">Put</span><span class="p">(</span><span class="s2">"msPKI-Enrollment-Flag"</span><span class="p">,</span><span class="w"> </span><span class="nx">0x80000</span><span class="p">)</span><span class="w">
</span><span class="nv">$template</span><span class="o">.</span><span class="nf">SetInfo</span><span class="p">()</span><span class="w">
</span></code></pre></div></div><h4 id="configuring-windows-to-be-vulnerable-to-esc9"> <a href="#configuring-windows-to-be-vulnerable-to-esc9" class="anchor-heading" aria-labelledby="configuring-windows-to-be-vulnerable-to-esc9"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Configuring Windows to be Vulnerable to ESC9</h4><li>The template should now be reported as <code class="language-plaintext highlighter-rouge">Potentially Vulnerable</code> by the module.<li>In order to be able to exploit this template run the following Powershell command and ensure <code class="language-plaintext highlighter-rouge">StrongCertificateBindingEnforcement</code> is not set to <code class="language-plaintext highlighter-rouge">2</code> (it should be 1, or 0):<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Set-ItemProperty</span><span class="w"> </span><span class="nt">-Path</span><span class="w"> </span><span class="s2">"HKLM:SYSTEM\CurrentControlSet\Services\Kdc\"</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="nx">StrongCertificateBindingEnforcement</span><span class="w"> </span><span class="nt">-Value</span><span class="w"> </span><span class="nx">1</span><span class="w">
</span><span class="n">Get-ItemProperty</span><span class="w"> </span><span class="nt">-Path</span><span class="w"> </span><span class="s2">"HKLM:SYSTEM\CurrentControlSet\Services\Kdc\"</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="nx">StrongCertificateBindingEnforcement</span><span class="w">
</span></code></pre></div></div></ol><h3 id="setting-up-a-esc10-vulnerable-certificate-template"> <a href="#setting-up-a-esc10-vulnerable-certificate-template" class="anchor-heading" aria-labelledby="setting-up-a-esc10-vulnerable-certificate-template"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Setting up a ESC10 Vulnerable Certificate Template</h3><ol><li>Follow the first 15 steps <code class="language-plaintext highlighter-rouge">Setting up a ESC9 Vulnerable Certificate Template</code> to create the <code class="language-plaintext highlighter-rouge">ESC10-Template</code>.<ol><li>Everything up to and excluding the <code class="language-plaintext highlighter-rouge">msPKI-Enrollment-Flag", 0x80000</code> powershell step.<h4 id="configuring-windows-to-be-vulnerable-to-esc10"> <a href="#configuring-windows-to-be-vulnerable-to-esc10" class="anchor-heading" aria-labelledby="configuring-windows-to-be-vulnerable-to-esc10"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Configuring Windows to be Vulnerable to ESC10</h4></ol><li>The template should now be reported as <code class="language-plaintext highlighter-rouge">Potentially Vulnerable</code> by the module.<h5 id="esc10-case1"> <a href="#esc10-case1" class="anchor-heading" aria-labelledby="esc10-case1"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> ESC10 Case1:</h5><li>In order to be able to exploit this template run the following Powershell command and ensure <code class="language-plaintext highlighter-rouge">StrongCertificateBindingEnforcement</code> is set to <code class="language-plaintext highlighter-rouge">0</code><div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Set-ItemProperty</span><span class="w"> </span><span class="nt">-Path</span><span class="w"> </span><span class="s2">"HKLM:SYSTEM\CurrentControlSet\Services\Kdc\"</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="nx">StrongCertificateBindingEnforcement</span><span class="w"> </span><span class="nt">-Value</span><span class="w"> </span><span class="nx">0</span><span class="w">
</span><span class="n">Get-ItemProperty</span><span class="w"> </span><span class="nt">-Path</span><span class="w"> </span><span class="s2">"HKLM:SYSTEM\CurrentControlSet\Services\Kdc\"</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="nx">StrongCertificateBindingEnforcement</span><span class="w">
</span></code></pre></div></div><h5 id="esc10-case2"> <a href="#esc10-case2" class="anchor-heading" aria-labelledby="esc10-case2"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> ESC10 Case2:</h5><li>In order to be able to exploit this template run the following Powershell command and ensure <code class="language-plaintext highlighter-rouge">CertificateMappingMethods</code> is set to <code class="language-plaintext highlighter-rouge">0x4</code><div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Set-ItemProperty</span><span class="w"> </span><span class="nt">-Path</span><span class="w"> </span><span class="s2">"HKLM:SYSTEM\CurrentControlSet\Control\SecurityProviders\Schannel\"</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="nx">CertificateMappingMethods</span><span class="w"> </span><span class="nt">-Value</span><span class="w"> </span><span class="nx">4</span><span class="w">
</span><span class="n">Get-ItemProperty</span><span class="w"> </span><span class="nt">-Path</span><span class="w"> </span><span class="s2">"HKLM:SYSTEM\CurrentControlSet\Control\SecurityProviders\Schannel\"</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="nx">CertificateMappingMethods</span><span class="w">
</span></code></pre></div></div></ol><h3 id="setting-up-a-esc13-vulnerable-certificate-template"> <a href="#setting-up-a-esc13-vulnerable-certificate-template" class="anchor-heading" aria-labelledby="setting-up-a-esc13-vulnerable-certificate-template"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Setting up a ESC13 Vulnerable Certificate Template</h3><ol><li>Follow the instructions above to duplicate the ESC2 template and name it <code class="language-plaintext highlighter-rouge">ESC13</code>, then click <code class="language-plaintext highlighter-rouge">Apply</code>.<li>Go to the <code class="language-plaintext highlighter-rouge">Extensions</code> tab, click the Issuance Policies entry, click the <code class="language-plaintext highlighter-rouge">Add</code> button, click the <code class="language-plaintext highlighter-rouge">New...</code> button.<li>Name the new issuance policy <code class="language-plaintext highlighter-rouge">ESC13-Issuance-Policy</code>.<li>Copy the Object Identifier as this will be needed later (ex: 11.3.6.1.4.1.311.21.8.12682474.6065318.6963902.6406785.3291287.83.1172775.12545198`).<li>Leave the CPS location field blank.<li>Click <code class="language-plaintext highlighter-rouge">Apply</code>.<li>Open Active Directory Users and Computers, expand the domain on the left hand side.<li>Right click <code class="language-plaintext highlighter-rouge">Users</code> and navigate to New -&gt; Group.<li>Enter <code class="language-plaintext highlighter-rouge">ESC13-Group</code> for the Group Name.<li>Select <code class="language-plaintext highlighter-rouge">Universal</code> for Group scope and <code class="language-plaintext highlighter-rouge">Security</code> for Group type.<li>Click <code class="language-plaintext highlighter-rouge">Apply</code>.<li>Open ADSI Edit.<li>In the left hand side right click <code class="language-plaintext highlighter-rouge">ADSI Edit</code> and select <code class="language-plaintext highlighter-rouge">Connect to...</code>.<li>Under <code class="language-plaintext highlighter-rouge">Select a well known naming context</code> select <code class="language-plaintext highlighter-rouge">Default naming context</code>.<li>Select the newly established connection, select the domain, select <code class="language-plaintext highlighter-rouge">CN=User</code>.<li>On the right hand side find the recently created security group <code class="language-plaintext highlighter-rouge">CN=ESC13-Group</code>, right click select properties.<li>Copy the value of the <code class="language-plaintext highlighter-rouge">distinguishedName</code> attribute, save this as we’ll need it later.<li>Back on the left hand side establish another connection, right click <code class="language-plaintext highlighter-rouge">ADSI Edit</code> and select <code class="language-plaintext highlighter-rouge">Connect to...</code>.<li>This time under <code class="language-plaintext highlighter-rouge">Select a well known naming context</code> select <code class="language-plaintext highlighter-rouge">Configuration</code>.<li>Select the newly established connection, select the domain, select <code class="language-plaintext highlighter-rouge">CN=Services</code> -&gt; <code class="language-plaintext highlighter-rouge">CN=Public Key Services</code> -&gt; <code class="language-plaintext highlighter-rouge">CN=OID</code>.<li>In the right hand side find the object that corresponds to the Object Identifier saved earlier.<li>The OID saved earlier ended in <code class="language-plaintext highlighter-rouge">12545198</code>, the object on the right will start with <code class="language-plaintext highlighter-rouge">CN=12545198.</code> followed by 34 hex characters. ex: <code class="language-plaintext highlighter-rouge">CN=12545198.7BCA239924D9515E63EA6B6F00748837</code>).<li>Once located right click -&gt; properties, select <code class="language-plaintext highlighter-rouge">msDS-OIDToGroupLink</code>.<li>Paste the <code class="language-plaintext highlighter-rouge">distingushedName</code> of the security group saved above (ex: <code class="language-plaintext highlighter-rouge">CN=ESC13-Group,CN=Users,DC=demo,DC=lab</code>).<li>Click <code class="language-plaintext highlighter-rouge">Apply</code>.<li>Go back to the <code class="language-plaintext highlighter-rouge">certsrv</code> screen and right click on the <code class="language-plaintext highlighter-rouge">Certificate Templates</code> folder.<li>Click <code class="language-plaintext highlighter-rouge">New</code> followed by <code class="language-plaintext highlighter-rouge">Certificate Template to Issue</code>.<li>Scroll down and select the <code class="language-plaintext highlighter-rouge">ESC13-Template</code> certificate, and select <code class="language-plaintext highlighter-rouge">OK</code>.<li>The certificate should now be available to be issued by the CA server.</ol><h3 id="setting-up-a-esc15-vulnerable-certificate-template"> <a href="#setting-up-a-esc15-vulnerable-certificate-template" class="anchor-heading" aria-labelledby="setting-up-a-esc15-vulnerable-certificate-template"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Setting up a ESC15 Vulnerable Certificate Template</h3><ol><li>ESC15 depends on the schema version of the template being version 1 - which can no longer be created so we will edit an existing template that is schema version 1.<li>Right click the <code class="language-plaintext highlighter-rouge">WebServer</code> template, select properties.<li>Go to the Security Tab.<li>Under <code class="language-plaintext highlighter-rouge">Groups or usernames</code> select <code class="language-plaintext highlighter-rouge">Authenticated Users</code>.<li>Under <code class="language-plaintext highlighter-rouge">Permissions for Authenticated Users</code> select <code class="language-plaintext highlighter-rouge">Enroll</code> -&gt; <code class="language-plaintext highlighter-rouge">Allow</code>.<li>Click Apply.<li>Go back to the <code class="language-plaintext highlighter-rouge">certsrv</code> screen and right click on the <code class="language-plaintext highlighter-rouge">Certificate Templates</code> folder and ensure <code class="language-plaintext highlighter-rouge">WebServer</code> is listed, if it’s not, add it.<li>The certificate should now be available to be issued by the CA server.</ol><h3 id="setting-up-a-esc16-vulnerable-certificate-template"> <a href="#setting-up-a-esc16-vulnerable-certificate-template" class="anchor-heading" aria-labelledby="setting-up-a-esc16-vulnerable-certificate-template"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Setting up a ESC16 Vulnerable Certificate Template</h3><h4 id="configuring-windows-to-be-vulnerable-to-esc16"> <a href="#configuring-windows-to-be-vulnerable-to-esc16" class="anchor-heading" aria-labelledby="configuring-windows-to-be-vulnerable-to-esc16"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Configuring Windows to be Vulnerable to ESC16</h4><ol><li>There are two ECS16 scenarios and both depend on the CA having the OID: <code class="language-plaintext highlighter-rouge">1.3.6.1.4.1.311.25.2</code> being present in its <code class="language-plaintext highlighter-rouge">policy\DisableExtensionList</code><li>Run the following Powershell snippet to add the OID to the <code class="language-plaintext highlighter-rouge">DisableExtensionList</code> if it is not already present: ```powershell $activePolicyName = Get-ItemProperty -Path “HKLM:\SYSTEM\CurrentControlSet\Services\CertSvc\Configuration*\PolicyModules” -Name “Active” | Select-Object -ExpandProperty Active $disableExtensionList = Get-ItemProperty -Path “HKLM:\SYSTEM\CurrentControlSet\Services\CertSvc\Configuration*\PolicyModules$activePolicyName” -Name “DisableExtensionList” | Select-Object -ExpandProperty DisableExtensionList</ol><p>if (-not ($disableExtensionList -contains “1.3.6.1.4.1.311.25.2”)) { $updatedList = $disableExtensionList + @(“1.3.6.1.4.1.311.25.2”) Set-ItemProperty -Path “HKLM:\SYSTEM\CurrentControlSet\Services\CertSvc\Configuration*\PolicyModules$activePolicyName” -Name “DisableExtensionList” -Value $updatedList Write-Output “OID 1.3.6.1.4.1.311.25.2 has been added to the DisableExtensionList.” } else { Write-Output “OID 1.3.6.1.4.1.311.25.2 is already present in the DisableExtensionList.” }</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#### ESC16 Scenario 1
When a CA has the OID `1.3.6.1.4.1.311.25.2` added to its `policy\DisableExtensionList` registry setting every certificate issued by this CA will lack this SID security extension.
This effectively makes all templates published by this CA behave as if they were individually configured with the `CT_FLAG_NO_SECURITY_EXTENSION` flag (as seen in ESC9).
So if `StrongCertificateBindingEnforcement` is not set to `2` we can exploit this weak mapping.

In order to create a template vulnerable to ESC16 scenario 1, follow the first 15 steps in `Setting up a ESC9 Vulnerable Certificate Template`,
which is all the steps up to and excluding the `msPKI-Enrollment-Flag", 0x80000` powershell step which is how you set the `CT_FLAG_NO_SECURITY_EXTENSION`.
Ensure that `StrongCertificateBindingEnforcement` is set to `0` or `1` (not `2`) by running the following command listed in `Configuring Windows to be Vulnerable to ESC9`

#### ESC16 Scenario 2
When a CA has the OID `1.3.6.1.4.1.311.25.2` added to its `policy\DisableExtensionList` and `StrongCertificateBindingEnforcement` is set to `2`, there is still a way to exploit the template.
If the policy module's `EditFlags` has the `EDITF_ATTRIBUTESUBJECTALTNAME2` flag set (which is essentially ESC6), then the template is vulnerable to ESC16 scenario 2.

Ensure the `EDITF_ATTRIBUTESUBJECTALTNAME2` flag is set by running following PowerShell command:
```powershell
certutil -setreg policy\EditFlags +EDITF_ATTRIBUTESUBJECTALTNAME2
</code></pre></div></div><p>Then restart the Certificate Services service:</p><div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">net</span><span class="w"> </span><span class="nx">stop</span><span class="w"> </span><span class="nx">certsvc</span><span class="w">
</span><span class="n">net</span><span class="w"> </span><span class="nx">start</span><span class="w"> </span><span class="nx">certsvc</span><span class="w">
</span></code></pre></div></div><p>Then vefify the flag is set by running:</p><div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">certutil</span><span class="w"> </span><span class="nt">-getreg</span><span class="w"> </span><span class="nx">policy\EditFlags</span><span class="w">
</span></code></pre></div></div><h2 id="module-usage"> <a href="#module-usage" class="anchor-heading" aria-labelledby="module-usage"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Module usage</h2><ol><li>Do: Start msfconsole<li>Do: <code class="language-plaintext highlighter-rouge">use auxiliary/gather/ldap_esc_vulnerable_cert_finder</code><li>Do: <code class="language-plaintext highlighter-rouge">set BIND_DN &lt;DOMAIN&gt;\\&lt;USERNAME to log in as&gt;</code><li>Do: <code class="language-plaintext highlighter-rouge">set BIND_PW &lt;PASSWORD FOR USER&gt;</code><li>Do: <code class="language-plaintext highlighter-rouge">set RHOSTS &lt;target IP(s)&gt;</code><li>Optional: <code class="language-plaintext highlighter-rouge">set RPORT &lt;target port&gt;</code> if target port is non-default.<li>Optional: <code class="language-plaintext highlighter-rouge">set SSL true</code> if the target port is SSL enabled.<li>Do: <code class="language-plaintext highlighter-rouge">run</code></ol><h2 id="options"> <a href="#options" class="anchor-heading" aria-labelledby="options"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Options</h2><h3 id="report"> <a href="#report" class="anchor-heading" aria-labelledby="report"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> REPORT</h3><p>What templates to report (applies filtering to results).</p><ul><li><strong>all</strong> - Report all certificate templates.<li><strong>published</strong> - Report certificate templates that are published by at least one CA server.<li><strong>enrollable</strong> - Same as above, but omits templates that the user does not have permissions to enroll in.<li><strong>vulnerable</strong> - Report certificate templates where at least one misconfiguration is appears to be present.<li><strong>vulnerable-and-published</strong> - Same as above, but omits templates that are not published by at least one CA server.<li><strong>vulnerable-and-enrollable</strong> - Same as above, but omits templates that the user does not have permissions to enroll in.</ul><h2 id="scenarios"> <a href="#scenarios" class="anchor-heading" aria-labelledby="scenarios"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Scenarios</h2><h3 id="windows-server-2022-with-ad-cs"> <a href="#windows-server-2022-with-ad-cs" class="anchor-heading" aria-labelledby="windows-server-2022-with-ad-cs"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Windows Server 2022 with AD CS</h3><div class="language-msf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="zp">msf</span> auxiliary<span class="p">(</span><span class="kc">gather/ldap_esc_vulnerable_cert_finder</span><span class="p">)</span> <span class="p">&gt;</span> run
<span class="zs">[*]</span> Running module against 192.168.159.10

<span class="zs">[*]</span> Discovering base DN automatically
<span class="zw">[!]</span> Couldn't find any vulnerable ESC13 templates!
<span class="zg">[+]</span> Template: ESC1-Test
<span class="zs">[*]</span>   Distinguished Name: CN=ESC1-Test,CN=Certificate Templates,CN=Public Key Services,CN=Services,CN=Configuration,DC=msflab,DC=local
<span class="zs">[*]</span>   Manager Approval: Disabled
<span class="zs">[*]</span>   Required Signatures: 0
<span class="zg">[+]</span>   Vulnerable to: ESC1
<span class="zs">[*]</span>   Notes: ESC1: Request can specify a subjectAltName (msPKI-Certificate-Name-Flag)
<span class="zs">[*]</span>     Certificate Template Enrollment SIDs:
<span class="zs">[*]</span>       * S-1-5-21-3978004297-3499718965-4169012971-512 (Domain Admins)
<span class="zs">[*]</span>       * S-1-5-21-3978004297-3499718965-4169012971-513 (Domain Users)
<span class="zs">[*]</span>       * S-1-5-21-3978004297-3499718965-4169012971-519 (Enterprise Admins)
<span class="zg">[+]</span>   Issuing CA: msflab-DC-CA (DC.msflab.local)
<span class="zs">[*]</span>     Enrollment SIDs:
<span class="zs">[*]</span>       * S-1-5-11 (Authenticated Users)
<span class="zs">[*]</span>       * S-1-5-21-3978004297-3499718965-4169012971-519 (Enterprise Admins)
<span class="zs">[*]</span>       * S-1-5-21-3978004297-3499718965-4169012971-512 (Domain Admins)
<span class="zg">[+]</span> Template: ESC2-Test
<span class="zs">[*]</span>   Distinguished Name: CN=ESC2-Test,CN=Certificate Templates,CN=Public Key Services,CN=Services,CN=Configuration,DC=msflab,DC=local
<span class="zs">[*]</span>   Manager Approval: Disabled
<span class="zs">[*]</span>   Required Signatures: 0
<span class="zg">[+]</span>   Vulnerable to: ESC2
<span class="zs">[*]</span>   Notes: ESC2: Template defines the Any Purpose OID or no EKUs (PkiExtendedKeyUsage)
<span class="zs">[*]</span>     Certificate Template Enrollment SIDs:
<span class="zs">[*]</span>       * S-1-5-21-3978004297-3499718965-4169012971-512 (Domain Admins)
<span class="zs">[*]</span>       * S-1-5-21-3978004297-3499718965-4169012971-513 (Domain Users)
<span class="zs">[*]</span>       * S-1-5-21-3978004297-3499718965-4169012971-519 (Enterprise Admins)
<span class="zg">[+]</span>   Issuing CA: msflab-DC-CA (DC.msflab.local)
<span class="zs">[*]</span>     Enrollment SIDs:
<span class="zs">[*]</span>       * S-1-5-11 (Authenticated Users)
<span class="zs">[*]</span>       * S-1-5-21-3978004297-3499718965-4169012971-519 (Enterprise Admins)
<span class="zs">[*]</span>       * S-1-5-21-3978004297-3499718965-4169012971-512 (Domain Admins)
<span class="zs">[*]</span> Auxiliary module execution completed
</code></pre></div></div><hr><footer><p><a href="#top" id="back-to-top">Back to top</a></p><p class="text-small text-grey-dk-000 mb-0"> <a href="https://github.com/rapid7/metasploit-framework/tree/master/docs/metasploit-framework.wiki/../../documentation/modules/auxiliary/gather/ldap_esc_vulnerable_cert_finder.md" id="edit-this-page">Edit this page on GitHub</a></p></footer></div></div><div class="search-overlay"></div></div><script type="text/javascript" src="/assets/js/toggle_mode.js"></script> <script> var config = { theme: 'default', logLevel: 'fatal', securityLevel: 'strict', startOnLoad: true, arrowMarkerAbsolute: false, er: { diagramPadding: 20, layoutDirection: 'TB', minEntityWidth: 100, minEntityHeight: 75, entityPadding: 15, stroke: 'gray', fill: 'honeydew', fontSize: 12, useMaxWidth: true, }, flowchart:{ diagramPadding: 8, htmlLabels: true, curve: 'basis', }, sequence: { diagramMarginX: 50, diagramMarginY: 10, actorMargin: 50, width: 150, height: 65, boxMargin: 10, boxTextMargin: 5, noteMargin: 10, messageMargin: 35, messageAlign: 'center', mirrorActors: true, bottomMarginAdj: 1, useMaxWidth: true, rightAngles: false, showSequenceNumbers: false, }, gantt: { titleTopMargin: 25, barHeight: 20, barGap: 4, topPadding: 50, leftPadding: 75, fontSize: 11, gridLineStartPadding: 35, fontFamily: '\'Open Sans\', sans-serif', numberSectionStyles: 4, axisFormat: '%Y-%m-%d', topAxis: false, }, }; mermaid.initialize(config); window.mermaid.init(undefined, document.querySelectorAll('.language-mermaid')); </script>
